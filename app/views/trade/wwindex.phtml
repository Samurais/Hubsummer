<!DOCTYPE html >
<html manifest='defaultapp.manifest'>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
    　<title>近三个月</title>
    <link rel="stylesheet" href="http://cdn.zzgdapp.com/trade/web/css/jquery.mobile-1.3.0.min.css"/>
    <script type="text/javascript" src="http://cdn.zzgdapp.com/trade/web/js/jqmobile.js"></script>
   <!-- <script type="text/javascript" src="http://cdn.zzgdapp.com/trade/web/js/jssdk.js"></script>-->
    <script type="text/javascript" src="http://g.tbcdn.cn/sj/qn/jssdk.js?version=1.0.3"></script>
   <style type="text/css">
.ui-navbar li .ui-btn .ui-btn-inner {padding-top: .3em;padding-bottom: .4em;}
.ui-mini .ui-btn-inner{ margin:0; padding:1px 3px 3px;}
.pcwwtable{background-color:#f6f3f0; font-size:12px;}
.pcwwtable td p{ font-size:12px; color:#a99c8b; text-shadow:none;}
.pcwwtable td h3{ font-size:12px; color:#8c6d23;text-shadow:none;}
.ui-btn-text{font-size:12px; font-weight:normal; text-shadow:none;}
.ddztcheng,.ddztlan,.ddztqing,.ddztzi,.ddzthong,.ddztlv,.ddzthui{ padding:1px 2px;}
.ui-radio{ float:left; position:static; clear:none; margin:0 0 0 5px;}
.ui-radio input{ position:static; width:auto; height:auto; margin:0;}
.dianbiao{ width:27px; height:27px; padding:2px; background-color:#fff; border:1px solid #ccc; border-radius:16px; margin:2px 0 0 2px;}
.daohang{ display:block; background:#e3eaef; border-bottom:1px solid #9cb4c5;}
.dbdh{ display:block; height:28px; border-top:1px solid #9cb4c5; background:#9ab5c6;}
.dbdh ul{ list-style:none;-webkit-margin-before: 0;-webkit-margin-after:0;-webkit-margin-start: 0;-webkit-margin-end: 0;-webkit-padding-start: 0;}
.dbdh ul li{ display:block; width:25%; float:left;}
.dbdh ul li a{ display:block; margin:2px 8px; padding:5px; line-height:14px; text-decoration:none; text-align:center; text-shadow:none; font-size:13px;color: #314965;}
.dbdh ul li a.ui-link:link,.dbdh ul li a.ui-link:visited {color: #314965; text-shadow:none;}
.dbdh ul li a.active:link,.dbdh ul li a.active:visited{ background:#314965; color:#fff; border-radius:3px;}

.div_imgss{width:40px;height:40px;line-height:80px;cursor:pointer;border:solid 1px #eee;text-align:center;font-size:x-small; background-color:#fff;color:#999;}
.div_imgs{width:80px;height:80px;line-height:80px;cursor:pointer;border:solid 1px #eee;text-align:center;font-size:x-small; background-color:#fff;color:#999;}
/*
.jspContainer{overflow:hidden;position:relative;}
.jspPane{position:absolute;}
.jspVerticalBar{position:absolute;top:0;right:0;width:6px;height:100%;background:red;}
.jspHorizontalBar{position:absolute;bottom:0;left:0;width:100%;height:6px;background:red;}
.jspVerticalBar *,.jspHorizontalBar *{margin:0;padding:0;}
.jspCap{display:none;}
.jspHorizontalBar .jspCap{float:left;}
.jspTrack{background:#F2F4F8;position:relative;}
.jspDrag{background:#79a1b5;position:relative;top:0;left:0;cursor:pointer;border:1px solid #56839a;-moz-border-radius:5px;-webkit-border-radius:5px;border-radius:5px;}
.jspHorizontalBar .jspTrack,.jspHorizontalBar .jspDrag{float:left;height:100%;}
.jspArrow{background:#50506d;text-indent:-20000px;display:block;cursor:pointer;}
.jspArrow.jspDisabled{cursor:default;background:#80808d;}
.jspVerticalBar .jspArrow{height:6px;}
.jspHorizontalBar .jspArrow{width:6px;float:left;height:100%;}
.jspVerticalBar .jspArrow:focus{outline:none;}
.jspCorner{background:#eeeef4;float:left;height:100%; }
*/
/* 设置滚动条的样式 */
::-webkit-scrollbar-track-piece{
    background-color:rgba(0,0,0,0.1);/*滚动条的背景颜色*/
    -webkit-border-radius:0;/*滚动条的圆角宽度*/
}
::-webkit-scrollbar{
    width:10px;/*滚动条的宽度*/
    height:8px;/*滚动条的高度*/
}
::-webkit-scrollbar-thumb:vertical{/*垂直滚动条的样式*/
    background-color:rgba(0,0,0,0.2);
    -webkit-border-radius:6px;
    /*outline:2px solid #fff;
    outline-offset:-2px;
    border: 2px solid #fff;*/
}
::-webkit-scrollbar-thumb:hover{/*滚动条的hover样式*/
    background-color:rgba(0,0,0,0.4);
    -webkit-border-radius:6px;
}
::-webkit-scrollbar-thumb:horizontal{/*水平滚动条的样式*/
    width: 10px;
    background-color: rgba(0,0,0,0.2);
    -webkit-border-radius: 6px;
}


#stab{
    margin: 0 0 0 0px;
    padding: 0px;
    font-size: 12px;
    line-height: 30px;
    border-top-style: solid;
    border-top-width: 1px;
	background-color: #E3EAEF;
    white-space: nowrap;
    
}


#stab li {
    list-style-type: none;
    display: inline;
    padding: 5px 5px;
}


#stab li a {
    text-decoration: none;
    font-family: Arial, Helvetica, sans-serif;
     padding: 5px 5px;
    color: #000000;
}
</style>
</head>

<body>
	<div data-role="page">
			<div data-role="header" data-backbtn="false" data-theme="c" data-position="fixed" data-tap-toggle="false" ><!-- id="dht" style="display:none;" -->
				<div  id="act_auto" style="display:none;border-bottom:1px solid #ffca80;background:#FFC;padding:6px;height:20px;line-height:20px;font-size:11px;color:#f30;text-shadow:none;overflow:hidden" >
		</div>
	     <!-- <div  id="newgonggao" style="display:none;border-bottom:1px solid #ffca80;background:#FFC;padding:6px;height:20px;line-height:20px;font-size:11px;color:#f30;text-shadow:none;overflow:hidden" >
<a href="javascript:opengonggao()"  data-position-to="window" style="font-size:12px; text-align:center; font-weight:normal; color:#f00; text-decoration:none; display:block;" ><marquee direction=left behavior=scroll >接单打单发货评价全搞定，买1年送1年，仅1毛钱/天，点击抢购！</marquee></a>
		</div>-->
        <div data-role="navbar">
		<ul>
			<li><a href="#" name='myshow' id='myallshow' onclick="showlist(null,'all');"><span id="all" style="margin:0;padding:0;font-size:12px; font-weight:normal;"   >全部(0)</span></a></li>
			<li><a href="#" id='othershow' name='myshow' class="ui-btn-active ui-state-persist" onclick="showlist(null,'coll');"><span id="coll" style="margin:0;padding:0;font-size:12px; font-weight:normal;"   >未完(0)</span></a></li>
			<li><a href="#" id='succseshow' name='myshow' onclick="showlist(null,'succse');"><span id="succse" style="margin:0;padding:0;font-size:12px; font-weight:normal;"    >已完(0)</span></a></li>
			<li><a href="#" id='closeshow' name='myshow' onclick="showlist(null,'close');"><span id="close"  style="margin:0;padding:0;font-size:12px; font-weight:normal;"  >已关(0)</span></a></li>
		</ul>
	</div>

        <!--<a href="#" data-icon="refresh" data-mini="true" data-theme="c" class="ui-btn-right">刷新</a>-->
        </div>
		<div data-role="content" style="background-color:#cdd8df; margin:0; padding: 0;" id="mylist">

		
       <!--   <div id="dht" style="display:none;">
            <h3 style="font-size:14px; margin:-10px 0 0 0; padding:0;"><span id="nick"></span></h3> 
        <p style="font-size:12px; margin:0;">近3个月成交<span id="gpay" class="monney">0.00</span>元(<span id="gnum">0</span>笔)，关闭<span id="gclosepay" class="monney">0.00</span>元(<span id="gclosenum">0</span>笔)，退款<span id="grefundpay" class="monney">0.00</span>元(<span id="grefundnum">0</span>笔)</p>
         </div>--> <!-- 
         <div data-role="collapsible-set" data-inset="false" data-mini="true" >

			</div>-->
	</div>
					<div id="foot" style="display: none;">
					<p class="ui-body-d" style="padding:0;max-width:228px; margin:10px auto; font-size:12px;border-radius:2em;"><span data-role="button" class="ui-icon-alt" data-inline="true" data-icon="info" data-theme="e" data-iconpos="notext" style="border-radius:1em;">提示</span>该联系人三个月内无此状态订单！</p>
				</div>
	<!-- -<div data-role="footer" data-position="fixed" style="height:21px;" >
	   <ul style="font-weight:normal;margin-top: -3px" id="stab" >
					<li  style="font-weight:normal;font-size:12px">
					<img src="#">
						<a  style="font-weight:normal;font-size:12px"  onclick="lianxikf()" ><span >爱用科技&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></a>
																														&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<a  style="font-weight:normal;font-size:12px" onclick="opentrade();">交易管理</a>
					</li>
		</ul>
	</div>	 -->
	<!-- 核对地址-->
		    <div data-role="popup" id="addrpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">收货地址</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
				<p style="margin: 0; font-size:12px;"><span id="addrtext" ></span></p>

 

	 	<a onclick="copyaddr()" data-inline="true" data-mini="true"  data-role="button" data-mini="true" data-theme="c">
			 <span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">核对地址</span>
	 	</a>

		</div>
		
		</div>

		    <div data-role="popup" id="showaddrpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">收货地址</h1>
                <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" id="pricemsg">
				<p style="margin: 0; font-size:12px;"><span id="showaddrtext"></span></p>


		</div>
		
		</div>
	
		<!-- 修改地址-->

	    <div data-role="popup" id="sendaddrpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">收货地址</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
				<p style="margin: 0; font-size:12px;"><span id="sendaddrtext" ></span></p>
								<div  class="ui-grid-a">
<div class="ui-block-a">
		            	<a onclick="copyaddr()" data-role="button" data-inline="true" data-mini="true" data-theme="c"  >
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">核对地址</span>
						</a>
 </div>
<div class="ui-block-b">
		            	<a onclick="toupaddr()" data-role="button" data-inline="true" data-mini="true" data-theme="c"  >
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">修改地址</span>
						</a>
 </div>
				</div>
	    	
		</div>
		
		</div>
		


		
		
			<!-- 旺旺催付-->

		<div data-role="popup" id="wwpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">催付内容</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
				<ul data-role="listview" data-theme="c" id="wwlist">
					
				
				</ul>

			</div>
		
		</div>
		
					<!-- 修改价格-->

		<div data-role="popup" id="uppricepop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">修改价格</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
			    <div class="content-primary" >
					<div id=pricelist1>
					</div>
         			<div class="gjlist" id="pricelist2">
   					</div>   
					<div id=pricelist3>
					</div>
				</div><!--/content-primary -->	 
			</div>
		
		</div>
							<!-- 修改运费-->

		<div data-role="popup" id="uppostpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">修改运费</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
	    <div class="content-primary" id="postlist">
		    	<div class="formk"> 
		    <label for="username"><span style="margin: 0; font-size:12px;">运费(元)</span></label>
		    <input  type="text" name="post_fee" id="yunfei"   oninput="uppostext(this.value);" onpropertychange="uppostext(this.value)"  class="money" value="" /></div>     	
					<h3 class="gjddyj" style="margin: 0; font-size:12px;" >买家实付:<span id="postall">0.00</span>元</h3>
				<div class="ui-body">
				<fieldset class="ui-grid-a">		            	
						<div class="ui-block-a">
							<a onclick="freeposts()" data-role="button" data-inline="true" data-mini="true" data-theme="c"  >
								<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">免运费</span>
							</a>
						</div>
						<div class="ui-block-b">
							<a onclick="uppost()" data-role="button" data-inline="true" data-mini="true" data-theme="a"  >
								<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确　定</span>
							</a>
					
						</div>
		
			    </fieldset>
				</div>
		</div><!--/content-primary -->
    </div> 
		
		</div>
			
				<!-- 关闭订单 -->

		<div data-role="popup" id="closepop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">关闭订单</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
 <div class="content-primary">
  <ul data-role="listview" data-theme="c" id="closelist">
        </ul>
        <div style="margin-top:20px;" class="formk">
	<p style="margin: 0; font-size:12px;">请您确认已经通知买家，并已达成一致意见。您单方面关闭交易，将可能导致买家投诉，进而影响您使用支付宝的权利。</p>

	

				<select  data-mini="true" name="reason" id="select-choice-b" >
					<option value="0">请选择关闭该交易的理由</option>
					<option >未及时付款</option>
					<option >买家联系不上</option>
					<option >谢绝还价</option>
					<option >商品瑕疵</option>
					<option >协商不一致</option>
					<option >买家不想买</option>
					<option >与买家协商一致</option>
				</select></div>

		<div class="formk">

				<button type="button" onclick="tradeclose();"  data-mini="true" data-ajax="false" data-theme="c"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确定</span></button>

		</div>

    <p style="margin: 0; font-size:12px;">提醒：拍下后减库存的商品，在关闭交易后，系统会自动恢复商品库存，但不会影响已下架商品的状态。</p>


	</div><!--/content-primary -->	  
			</div>
		
		</div>
		
							<!-- 备注-->

		<div data-role="popup" id="beiwpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">卖家备注</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content"  id="addbeiw">

			</div>
		
		</div>
					<!-- 发货-->
		<div data-role="popup" id="sendpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">发货</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
				<ul data-role="listview" data-theme="c" id="sendlist">
        		</ul>
        		<div style="margin-top:30px;" id="sendlist2">
        		</div>
		         <div  >
						<label for="name"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">请选择发货方式：</span></label>
					         <select data-mini="true" id="send_way">
					         <option value='offline'>自己联系</option>
					         <option value='online'>在线下单</option>
					         <option value='notsend'>无需物流</option>
					         </select>
					    
		         
						<div  id="off_line">
						<label for="name"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">请选择物流公司：</span></label>
					         <select data-mini="true" name='offtrade' id='offtrade'>
					         </select>
					   </div>
				</div>
			         <div id="off_other">
			           <!-- 其它物流公司 -->
			         </div>
			         <div id="no_send">
			    <!--    <p>请前往掌中交易-基础插件设置默认物流公司，方便您的发货！</p> --> 

				<div style="padding-top:4px;"><input type="text" name="outid" data-mini="true" placeholder="请填写运单号码" id="offline_out"></div>

			        </div>
         			<div><a type="button" data-role="button"  data-theme="c" data-mini="true" onclick="tosends()" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确认发货</span></a></div>
			</div>
		
		</div>
		
									<!-- 延长收货时间-->
		<div data-role="popup" id="wltimepop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">延长收货时间</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
					<div class="content-primary">
						<p style="margin: 0; font-size:12px;">延长收货时间可以让买家有更多时间来“确定收货”，而不会急于去申请退款。</p>
						<div class="formk">
									<select data-mini="true" name="days" id="select-choice-a" data-native-menu="false">
										<option value="0">延长“确认收货”期限为</option>
										<option value="3">3天</option>
										<option value="5">5天</option>
										<option value="7">7天</option>
										<option value="10">10天</option>
									</select></div>
							<div class="formk">
									<button type="button" onclick="addtime();" data-mini="true" data-theme="c" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确定</span></button>
							</div>
						</div><!--/content-primary -->	

			</div>
		
		</div>
		

							  	 <div data-role="popup" id="wuliulog" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
								<div data-role="header" data-theme="c" class="ui-corner-top">
									<h1 style=" margin:5px; font-size:14px;font-weight:normal;">跟踪物流</h1>
									 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
								</div>
								<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
									<div class="ddmiaoshu detail_div_top" id="wlxx">
								</div>
									<div class="ddmiaoshu detail_div_top" id="wlxq">
									</div>
								</div>
							</div> 
							
							<div data-role="popup" id="bfwuliulog" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
								<div data-role="header" data-theme="c" class="ui-corner-top">
									<h1 style=" margin:5px; font-size:14px;font-weight:normal;">跟踪物流</h1>
									 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
								</div>
								<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
									<div class="detail_div_top" style="margin-bottom: 18px;">
									<select  id="bfselect" >
									</select>
								</div>
									<div class="ddmiaoshu detail_div_top" id="bfwlxx">
								</div>
									<div class="ddmiaoshu detail_div_top" id="bfwlxq">
									</div>
								</div>
							</div> 
							<!-- 货到付款发货-->

		<div data-role="popup" id="codsendpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">货到付款</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
			         <div class="formk">
                          请选择物流公司
	</div>
         <div  id="codon_div">      
         <select data-mini="true" >          
 			<option  value='ZJS'>宅急送</option>
 			<option  value='YTO'>圆通速递</option>
 			<option  value='UAPEX'>全一快递</option>
 			<option  value='SF'>顺丰速递</option>
 			<option  value='FEDEX'>联邦快递</option>
 			<option  value='SCWL'>尚橙物流</option>
 			<option  value='GDEMS'>广东EMS</option>
         </select>

         </div>
  		 <div class="formk">
                         请填写运单号码
         </div>
         <div class="formk">
         <input type="text" data-mini="true" name="codoutid" id="codonline_out"/>
         </div>
         <div class="formk">

			<button type="button" onclick="tocodsends();" data-mini="true" data-theme="c" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确定</span></button>

         </div>

			</div>
		
		</div>
						


												<!-- 发货修改-->
		<div data-role="popup" id="resendpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">发货修改</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
							<div class="formk" id="on_line" >
					         <div class="formk">
					    <span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl"> 请选择物流公司</span>
					         </div>
					         <div  id="on_div">      
					         <select data-mini="true" name='ontrade' id='resendlist'>          
					
					         </select>
					
					         </div>
					  		 <div class="formk">
					     <span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">请填写运单号码</span>
					         </div>
					         <div class="formk">
					         <input data-mini="true" type="text" name="outid" id="outid"/>
					         </div>
					         <div class="formk">

					<button type="button" id="button1" data-mini="true"  data-theme="c" onclick="toresends();" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确认发货</span></button>
					

					         </div>    
					         </div>

			</div>
		
		</div>

													<!-- 评价-->
		<div data-role="popup" id="ratepop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">评价</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
					<div class="content-primary" id="ratelists">
					</div><!--/content-primary -->	
						<button type="button" onclick="traderates();" data-mini="true" data-theme="c" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确定</span></button>


			</div>
		
		</div>
	
															<!-- 收货地址-->
		<div data-role="popup" id="upaddrpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">收货地址</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
				<ul data-role="listview" id="addrlist">
		       </ul>
		    </div>  
		
		</div>

		
		
																	<!-- 退款信息-->
		<div data-role="popup" id="refundpop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">退款信息</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
			<div id="relist">

			</div>
        		<div data-role="collapsible" data-theme="c" data-mini="true" data-content-theme="c" data-collapsed="true" >
				<h3 style=" margin:5px; ; font-size:12px;"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">留言记录</span></h3>

				<div id="rememo" >
			</div>
   		 </div>
		    </div>  
		
		</div>

																			<!-- 退款留言-->
		<div data-role="popup" id="rememopop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">退款留言</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
		        <div class="formk"><textarea cols="40" rows="8" data-mini="true" name="messagetxt" id="messagetxt" placeholder="请再此输入留言,字数不超过200字"></textarea></div>
				<button type="button" onclick="addmemo();" data-theme="c" data-mini="true" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">发表留言</span></button>
		    </div>  
		</div>
		
																					<!-- 退款留言-->
		<div data-role="popup" id="refusepop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">拒绝退款</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
			<div class="formk"><textarea cols="40" rows="8" data-mini="true" name="refusetxt" id="refusetxt" placeholder="请输入拒绝说明，200字以内"></textarea></div>
		       <!-- 	 <div class="formk">
		       		 	
                <p style="margin:0; font-size:12px;">上传图片凭证</p>
                <input  name="file" id='file' type="file" />
                <img id="imgPre" alt="" src="" style="display: none;width: 100px;height: 100px;" />
                <input type='hidden' id="reuid" name="reuid"/>
                <input type="hidden" id="rerid" name='rerid'/>
                <input type="hidden" id='retid' name='retid'/>
                <input type="hidden" id='reoid' name='reoid'/>
		       		 </div> -->	
       				 <div class="formk"><button type="button" onclick="refusememo();" data-mini="true" data-theme="c" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">拒绝退款申请</span></button></div>
        	</div>  
		</div>
		
																							<!-- 退款留言-->
		<div data-role="popup" id="postfreepop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">一键免邮</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >
						<p style="margin:0; font-size:12px;">是否确定使用一键免邮功能?</p>
       				 <div class="formk"><button id="actionpost" type="button" onclick="postfree();" data-mini="true" data-theme="c" ><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确定</span></button></div>
        	</div>  
		</div>
		
				<div data-role="popup" id="upskupop" data-overlay-theme="a" data-theme="c" style="max-width:300px;min-width:220px" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">修改属性</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" data-theme="d" class="ui-corner-bottom ui-content" >

        		<div id="upskulist"></div>
						<label for="name"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">请选择需要修改的属性值：</span></label>
					         <select  data-mini="true" id="skuselect">
					         </select>
					    <p style="margin:0;padding:0; font-size:12px; font-weight:normal;"><span id="sku_quantity">库存:0</span><span style="margin-left: 20px;" id="sku_price">价格:0</span></p>

					   <a type="button" data-role="button"  data-theme="c" data-mini="true" onclick="uptosuk()" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确认修改</span></a>
			</div>

         		
			</div>
			
		<div data-role="popup" id="showvippop" data-overlay-theme="a" data-theme="c" style="max-width:300px;" class="ui-corner-all">
			<div data-role="header" data-theme="c"  class="ui-corner-top">
				<h1 style=" margin:5px; font-size:14px;font-weight:normal;">温馨提示</h1>
				 <a href="#" data-rel="back" data-role="button" data-theme="c" data-icon="delete" data-iconpos="notext" class="ui-btn-right" style="margin-top:-6px;">关闭</a>
			</div>
			<div data-role="content" style="text-align: left;"  data-theme="d" class="ui-corner-bottom ui-content" >
				<center><a onclick="openlines(1);"  type="button" data-role="button"><span style="color: red; font-size: 18px;">99</span><span style="font-size: 20px;">元/年</span>&nbsp;<del>120</del></a>
			 <a onclick="openlines(2);"  type="button" data-role="button"><span style="color: red; font-size: 18px;">56</span><span style="font-size: 20px;">元/半年</span>&nbsp;<del>60</del></a>
			 <a onclick="openlines(3);"  type="button" data-role="button"><span style="color: red; font-size: 18px;">30</span><span style="font-size: 20px;">元/一季度</span>&nbsp;<del>30</del></a>
			 <a onclick="openlines(4);"  type="button" data-role="button"><span style="font-size: 18px;">10元/月</span></a>
			 <p></center>点击订购成功后，请重新打开插件使用高级功能。如需订购爱用商品高级版，请<a onclick="openlines(5);" >点击订购</a>套餐包</p>
				<p style="font-size:11px; margin:.3em 0;color: gray;">如果有问题咨询客服
				<a onclick="wangwangPP('爱用科技');" href="#"><img border="0" src="http://amos.im.alisoft.com/online.aw?v=2&uid=爱用科技&site=cntaobao&s=2&charset=utf-8" alt="点击这里给我发消息" /></a></span>
				</p>			
			</div>  
		</div>
	
</div>
<script LANGUAGE="javascript">
function wangwangPP(pjnick){
	var info  = "";
	var os = navigator.platform;
	var userAgent = navigator.userAgent;
	if(os.indexOf("Win") > -1){
		if(userAgent.indexOf("Windows NT 5.0") > -1){
			info += "Win2000";
		}else if(userAgent.indexOf("Windows NT 5.1") > -1){
			info += "WinXP";
		}else if(userAgent.indexOf("Windows NT 5.2") > -1){
			info += "Win2003";
		}else if(userAgent.indexOf("Windows NT 6.0") > -1){
			info += "WindowsVista";
		}else if(userAgent.indexOf("Windows NT 6.1") > -1 || userAgent.indexOf("Windows 7") > -1){
			info += "Win7";
		}else if(userAgent.indexOf("Windows 8") > -1 || userAgent.indexOf("Windows NT 6.2") > -1){
			info += "Win8";
		}else{
			info += "Other";
		}
	}else if(os.indexOf("Mac") > -1){
		info += "Mac";
	}else if(os.indexOf("X11") > -1){
		info += "Unix";
	}else if(os.indexOf("Linux") > -1){
		info += "Linux";
	}else{
		info += "Other";
	}
	var content='电脑系统【'+info+'】_插件应用：【爱用交易管理】_PC千牛版本：【';
	
  QN.application.invoke({
		  cmd: "getVersion",
		  success: function(e){
			 if(typeof  e=== 'string'){
		          e = JSON.parse(e);
		      }
			 content=content+e.version+'】';
			 wangwangPC(pjnick,content);
		  }
		});
}

function wangwangP(pjnick){
var wangwangnick='cntaobao'+pjnick;
QN.wangwang.invoke({
    "category": 'wangwang', 
    "cmd": 'chat',
    "param": {'uid':wangwangnick},
    "success": function (rsp) {
    },
    "error": function(msp){
        if(typeof msp === 'string'){
            var msp = JSON.parse(msp);
        }else{
            var msp= msp;
        }
        
    }  
});
}
function wangwangPC(pjnickc,contents){
	var wangwangnick='cntaobao'+pjnickc;
	var content=contents;
	QN.wangwang.invoke({
	    "category": 'wangwang', 
	    "cmd": 'chat',
	    "param": {'uid':wangwangnick},
	    "success": function (rsp) {
	    },
	    "error": function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var msp= msp;
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/* $("#hints").html('<p>该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
		 	    showMsg('hint'); */
           }else{
        	    $("#hints").html('<p>操作失败，请重试！</p>');
		 	    showMsg('hint');
            } 
        }  
	});
	setTimeout(function(){
	    	QN.wangwang.invoke({
	 	        category: 'wangwang',
	 	        cmd: 'insertText2Inputbox',
	 	        param: {'uid':wangwangnick,'text':content,'type':0},
	 	        success: function (rsp) {
	 	        },
	 	       error: function(msp){
                   /*请求出错处理 */
                   /* alert(JSON.stringify(msp));*/
                   if(typeof msp === 'string'){
                       var msp = JSON.parse(msp);
                   }else{
                       var msp= msp;
                   }
                   if(msp.sub_code=='subuser.has-no-permission'){
                	  /*  $("#hints").html('<p>该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
      		 	       showMsg('hint'); */
                  }else{
                	  $("#hints").html('<p>操作失败,请重试！</p>');
    		 	      showMsg('hint');
                   }
               }
	 	    });

	},1000);

}
var SumbuyTimes;
function openline(){
	tradePoint(user_nick,'旺旺插件催付付费');
        QN.application.invoke({
      		"cmd" : "browserUrl",
      		"param" : { "url" : "http://fuwu.taobao.com/ser/assembleParam.htm?subParams=itemCode:FW_GOODS-1827490-v2,cycleNum:3,cycleUnit:2"}
      	});
}
/**
  * 订购各种跳转
  * @author wsx
  */
  function openlines(urls){
	  	var buyurl=urls;
		 switch(buyurl){
			case 1:{buyurl='http://qianniu.fuwu.taobao.com/ser/assembleParam.htm?subParams=itemCode:FW_GOODS-1827490-v2,cycleNum:12,cycleUnit:2';tradePoint(user_nick,'旺旺插件催付付费一年');break;}
			case 2:{buyurl='http://qianniu.fuwu.taobao.com/ser/assembleParam.htm?subParams=itemCode:FW_GOODS-1827490-v2,cycleNum:6,cycleUnit:2';tradePoint(user_nick,'旺旺插件催付付费半年');break;}
			case 3:{buyurl='http://qianniu.fuwu.taobao.com/ser/assembleParam.htm?subParams=itemCode:FW_GOODS-1827490-v2,cycleNum:3,cycleUnit:2';tradePoint(user_nick,'旺旺插件催付付费一季度');break;}
			case 4:{buyurl='http://qianniu.fuwu.taobao.com/ser/assembleParam.htm?subParams=itemCode:FW_GOODS-1827490-v2,cycleNum:1,cycleUnit:2';tradePoint(user_nick,'旺旺插件催付付费一个月');break;}
			case 5:{buyurl='http://bangpai.taobao.com/group/thread/15074034-289762745.htm?spm=jiaoyiheshangpin';tradePoint(user_nick,'套餐包');break;}
			}
		 QN.application.invoke({
		   		"cmd" : "browserUrlEmbedded",
		   		"param" : { "url" : buyurl,id : '1', "title" : "订购爱用交易高级版", "width" : '800', "height" : '650' }
		   	}); 
       /*  QN.application.invoke({
       		"cmd" : "browserUrl",
       		"param" : { "url" : buyurl}
       	});*/
 	}

function CountdownTime(TheLastTimes){/*倒计时操作当弹广告页面显示时执行*/
	var TheNowTimes=GetDateStr(0);
	SumbuyTimes=datetime_to_unix(TheLastTimes)-datetime_to_unix(TheNowTimes);
	window.setInterval(SetBuyVipTime,1000);
}
//将时间减去1秒，计算天、时、分、秒 
function SetBuyVipTime() { 	
 if (SumbuyTimes > 0) { //SumbuyTimes 全局变量;
	 SumbuyTimes = SumbuyTimes-1; 
  var second = Math.floor(SumbuyTimes % 60);             // 计算秒     
  var minite = Math.floor((SumbuyTimes / 60) % 60);      //计算分 
  var hour = Math.floor((SumbuyTimes / 3600) % 24);      //计算小时 
  var day = Math.floor((SumbuyTimes / 3600) / 24);        //计算天	
  $('#showvipday').text(day);
  $('#showviphour').text(hour);
  $('#showvipmin').text(minite);
  $('#showvipsec').text(second); 			  	 							
 } else {
	 if(datetime_to_unix(GetDateStr(0))>datetime_to_unix('2014-5-1 00:00:00')){
	 		$('#showvipall').hide();
	 		vipurl="http://bangpai.taobao.com/group/thread/15074034-289230796.htm?spm=pcjccj2";
	 		window.clearInterval(SetBuyVipTime);
	 	}
 } 
}
</script>   
<script>
var gaddrs='';
var wwcuifu='';
var uid;
var version="";
var versionjr=11200;
var vipurl;
var mypicdata='';
var refuse='';
var myArray=new Array();
var mytid;
var  shash=window.location.hash.substr(1);
var params = shash.split('&');
var map = new HashMap();
for (var i in params) {
    var p = params[i].split("=");
    if (p.length == 2) {
        map.put(p[0], p[1]);
    }
}
var chatid = map.get("chatNumId");
var chatnick = map.get("chatNick");
chatnick=decodeURI(chatnick);
var vipuser=map.get("vipuser");
var mynick=map.get("nick");
/*运营写cookie*/
if(mynick!=null){
		mynick=decodeURIComponent(mynick);
		mynick=mynick.split(":")[0];
		document.cookie = "u="+mynick+";path=/;domain=tbmj.net";
		var activedt=map.get('activedt');/*第一次使用时间*/
		var viptimes=map.get('vip_time');
		var vipusers=map.get('vipuser');
		var autorate=map.get('autorate');
		if(vipusers==1){
			document.cookie = "trade_vtime="+viptimes+";path=/;domain=tbmj.net";
		}else{
			document.cookie = "autorate="+autorate+";path=/;domain=tbmj.net";
		}
		if(activedt!='off'){
			document.cookie = "trade_freetime="+activedt+";path=/;domain=tbmj.net";
		}
}
var user_nick=mynick;
if(vipuser==null||vipuser==''){
	vipuser=0;
}
if(vipuser==0){
	/*$('#newgonggao').show();*/
}
var viptime=map.get("vip_time");
if(viptime==null||viptime==''){
	viptime='off';
}


var tasknickr='';
var chatnickrs=chatnick+'l';
if(chatnickrs!='nulll'){
	var r=chatnick.substring(8,chatnick.length);
	tasknickr=decodeURI(r);
 }
window.onload=function (){
	
    window.alert = function(info,time){
        $.mobile.loading('show', {
            text: info,
            textVisible: true,
            textonly:true,
            theme: 'a'
        });
        time = time || 3000;
        setTimeout(function(){
            $.mobile.loading('hide');
        },time);

    };
    	if(datetime_to_unix(GetDateStr(0))>datetime_to_unix('2014-9-9 00:00:00')){
	 		$('#showvipall').hide();
	 		vipurl="http://bangpai.taobao.com/group/thread/15074034-289230796.htm?spm=pcjccj2";
	 		window.clearInterval(SetBuyVipTime);
    	}else{
    		CountdownTime('2014-9-9 00:00:00');
        	vipurl="http://bangpai.taobao.com/group/thread/15074034-289230796.htm?spm=pcjccj";
    	}
    	if(viptime!='off'){
    		var datetime=datetime_to_unix(viptime)-datetime_to_unix(GetDateStr(0));
    		var day=Math.ceil(datetime/86400);
    		if(day<83&&vipuser==1){
        		$('#wwgonggao').show();
    		}


    	}

    setTimeout(userinfo,100);

    setTimeout(changed,100);
    setTimeout(get_userinfo_data,200);
    actionQ();
    actionW();
    actionE();
    actionR();
    actionT();
/*    setTimeout(function(){
    	QN.application.invoke({
    		"cmd": "openAttachWindow",
    		"param": {event:"setting",width:360,height:900,title:"设置页面"}
    	});
    	
    },100)*/
    $(':file').change(function(){
        var file = this.files[0];
        var name = file.name;
        var size = file.size;
        var type = file.type;
        if(size>=130000){
            alert('上传图片不能大于130000字节');
            refuse='big';
            $('#imgPre').hide();
            mypicdata='';
        }else{
            var reader = new FileReader();

            reader.readAsDataURL(this.files[0]);
            reader.onload = function(e) {
                var img = document.getElementById('imgPre');
                img.src = this.result;
                var data=this.result;
                mypicdata=data.substr(23);
                refuse='one';
                $('#imgPre').show();

            }

        }

    });
}
/***核对地址****/
function toaddr(text,tid){
	$('#addrtext').text(text);
	$('#sendaddrtext').text(text);
	$("#addrpop").popup("open");
}
/***核对地址****/
function showaddr(text){
	$('#addrtext').text(text);
	$('#sendaddrtext').text(text);
	$('#showaddrtext').text(text);
	$("#showaddrpop").popup("open");
}
/*****************************************************修改地址****/
function tosendaddr(text,tid){
	mytid=tid;
	$('#addrtext').text(text);
	$('#sendaddrtext').text(text);
	$("#sendaddrpop").popup("open");
}

function toupaddr(text,tid){
	mytid=tid;
	/*alert(mytid);*/
	$("#sendaddrpop").popup("close");

	QN.top.invoke({
		"cmd": "taobao.trade.fullinfo.get",
		"param":{fields:'receiver_district,receiver_city,receiver_state,receiver_zip,receiver_address,receiver_name,receiver_phone,receiver_mobile',tid:tid},
		"method": "get",
		"success": function (rsp){
                if(typeof rsp === 'string'){
                     rsp = JSON.parse(rsp);
                    }
                if(rsp.code!=null){
                    alert(JSON.stringify(rsp));
                }else{
               
               
		    		var datas = {};
		    		var trade=rsp.trade_fullinfo_get_response.trade;
                    if(trade.receiver_district!=''&&trade.receiver_district!=null){
                    	 datas.district=trade.receiver_district;
                     }
                    if(trade.receiver_city!=''&&trade.receiver_city!=null){
                    	 datas.city=trade.receiver_city;
                     }
                    if(trade.receiver_state!=''&&trade.receiver_state!=null){
                    	 datas.state=trade.receiver_state;
                     }
                    pcd=datas.district;
                    pcb=datas.city;
                    pca=datas.state;
                    if(trade.receiver_name!=''&&trade.receiver_name!=null){
                      	 datas.name=trade.receiver_name;
                       }
                       if(trade.receiver_phone!=''&&trade.receiver_phone!=null){
                           datas.phone=trade.receiver_phone;
                           }
                       if(trade.receiver_mobile!=''&&trade.receiver_mobile!=null){
                           datas.mobile=trade.receiver_mobile;
                           }
                       if(trade.receiver_address!=''&&trade.receiver_address!=null){
                           datas.address=trade.receiver_address;
                           }
                       if(trade.receiver_zip!=''&&trade.receiver_zip!=null){
                           datas.zip=trade.receiver_zip;
                           }
		    			$("#addrlist").empty();
                        var source = $("#addrlist_template").html();
                        var template = Handlebars.compile(source);
                        var htmlstr = template(datas);
                        $("#addrlist").append(htmlstr).listview('refresh').trigger("create");
                        initselects();
                }
                       
		},
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			    /*    alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }
                        
 	

	        });
}

function initselects()
{  	
	
	var idata = window.localStorage.getItem('my_address');	
	if(idata!=null){
		loaddatas(idata);
	}else{
		loadaddress();
	}

}
function loadaddress()
{
		$.ajax({
		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getArea',
		     type: 'POST',
		     dataType:'html',
		     data:{},
		     timeout:10000,
		     error: function(){/*获取失败*/
			     alert('数据库连接失败！');
		     },		     
		     success: function(data){/*获取成功	*/	    	
		    	window.localStorage.setItem('my_address',data);
		    	initselects();
		     }
		 });
}
function loaddatas(data){
	$("#p_id").empty();
	$("#c_id").empty();
	$("#d_id").empty();
	var object = eval("(" + data + ")");
	var provinces = object['province'];		
	$("#p_id").append("<select name='p' id='p'></select>");

	var procode ='';
	for(var i=0;i<provinces.length;i++)
	{ 
		if(provinces[i]['address']==pca)
		{   procode = provinces[i]['addcode'];
			$("#p_id select").append("<option selected='selected' value='"+provinces[i]['addcode']+","+provinces[i]['address']+"'>"+provinces[i]['address']+"</option>");
		}else{
			$("#p_id select").append("<option  value='"+provinces[i]['addcode']+","+provinces[i]['address']+"'>"+provinces[i]['address']+"</option>");
		}
		
	}

	var citys = object['citys'][procode];
    $("#c_id").append("<select name='c' id='c'></select>");
	var citycode = '';
	for(var i=0;i<citys.length;i++)
	{ 
		if(citys[i]['address']==pcb)
		{   citycode = citys[i]['addcode'];
			$("#c_id select").append("<option selected='selected' value='"+citys[i]['addcode']+","+citys[i]['address']+"'>"+citys[i]['address']+"</option>");
		}else{
			$("#c_id select").append("<option  value='"+citys[i]['addcode']+","+citys[i]['address']+"'>"+citys[i]['address']+"</option>");
		}
		
	}
	var districts = object['districts'][citycode];
    $("#d_id").append("<select name='d' id='d'></select>");
	
	for(var i=0;i<districts.length;i++)
	{ 
		if(districts[i]['address']==pcd)
		{   
			$("#d_id select").append("<option selected='selected' value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");
		}else{
			$("#d_id select").append("<option  value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");
		}
		
	}
	$("#p_id").trigger("create");
	$("#c_id").trigger("create");
	$("#d_id").trigger("create");
	$('#p').change(p_choice);
	$('#c').change(c_choice);
	 $("#upaddrpop").popup("open");
}

/*省下面的市区*/
function p_choice()
{   
	var sel= $('#p').find('option:selected').val();
	var data = window.localStorage.getItem('my_address');
	if(data!=null)
	{
		var object = eval("(" + data + ")");

		var vals = sel.split(",");
		/*取得城市的父CODE*/
		var citys = object['citys'][vals[0]];
		$("#c_id").empty();		
		$("#c_id").append("<select name='c' id='c'></select>");
		var citycode = '';
		for(var i=0;i<citys.length;i++)
		{ 
			if(i==0)
			{   citycode = citys[i]['addcode'];
				$("#c_id select").append("<option selected='selected' value='"+citys[i]['addcode']+","+citys[i]['address']+"'>"+citys[i]['address']+"</option>");
			}else{
				$("#c_id select").append("<option  value='"+citys[i]['addcode']+","+citys[i]['address']+"'>"+citys[i]['address']+"</option>");
			}
			
		}
		var districts = object['districts'][citycode];
		$("#d_id").empty();	
		$("#d_id").append("<select name='d' id='d'></select>");
		for(var i=0;i<districts.length;i++)
		{ 
			if(i==0)
			{   
				$("#d_id select").append("<option selected='selected' value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");
			}else{
				$("#d_id select").append("<option  value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");
			}
			
		}
		$("#c_id").trigger("create");
		$("#d_id").trigger("create");
		$('#c').change(c_choice);
	}
}
/*市下面的区*/
function c_choice()
{
	var sel= $('#c').find('option:selected').val();
	var data = window.localStorage.getItem('my_address');
	if(data!=null)
	{
		var object = eval("(" + data + ")");

		var vals = sel.split(",");

		var districts = object['districts'][vals[0]];
		$("#d_id").empty();	
		$("#d_id").append("<select name='d' id='d'></select>");
		for(var i=0;i<districts.length;i++)
		{ 
			if(i==0)
			{   
				$("#d_id select").append("<option selected='selected' value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");
			}else{
				$("#d_id select").append("<option  value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");
			}
			
		}
		$("#d_id").trigger("create");
	}
}
function upaddress()
{
	
	var state=$("#p_id select").find("option:selected").text();
	var city=$("#c_id select").find("option:selected").text();
	var district=$("#d_id select").find("option:selected").text();
	   var mobile=$('#receiver_mobile').val();
	   var phone=$('#receiver_phone').val();
	   var zip=$('#receiver_zip').val();
	   var name=$('#receiver_name').val();
	   var address=$('#receiver_address').val();
	   var regzip = /^\d{6}$/;
	   if(district==''){/*默认区为空时*/
		   district='.';
		   }
	   if(zip==''||name==''||address==''){
		   alert('亲，请填写完整的收货信息!');
	   }else if(!regzip.test(zip)&&zip!=''){
			
			alert('邮编只能是6位数字!');
		}else if(address.length<4||address.length>60){
			alert('区县以下的街道地址最少要4个字，最多不能超过60个字');
		}else{
		   var regphone =/[-|\d]{7,16}/; 
		   var regmobile = /^\d\d{7,15}$/;
		   if(mobile==''&&phone==''){
			   alert('亲，电话和手机不能都为空!');

		   }else if(!regmobile.test(mobile)&&mobile!=''){
			   alert('手机号码必须由8到16位数字构成!');
		   }else if(!regphone.test(phone)&&phone!=''){
			   alert('电话号码必须由8到16位数字构成!');
		   }else{
				QN.top.invoke({
					"cmd": "taobao.trade.shippingaddress.update",
					"param": {tid:mytid,receiver_zip:zip,receiver_name:name,receiver_phone:phone, receiver_mobile:mobile,receiver_state:state,receiver_city:city,receiver_district:district,receiver_address:address},
					"method": "get",
					"success": function (rsp){
		                if(typeof rsp === 'string'){
		                    rsp = JSON.parse(rsp);
		                    }
		                if(rsp.code!=null){
		                    alert(JSON.stringify(rsp));
		                }else{
		                    showlist(mytid,gstas);
		                    $("#upaddrpop").popup("close");
		                    alert("修改成功!");
		                }
					},
					"error": function (msg) {
						if(msg.sub_code=='subuser.has-no-permission'){
						       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
						    }else{
						    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
						    }
					    }
		                   		       	
			 		});
				}
		   }
	   

}
function opengonggao(){
	QN.application.invoke({
		   		"cmd" : "openAttachWindow",
		   		"param" : {
		   			event:"gonggao",
		   			width:780,
		   			height:650,
		   			title:'5.27~5.29爱用交易庆400w用户，大回馈买一送一，每天限1000个名额！'
		   			}
		   	});
}
/*****往往崔付******/
function toww(name,tid,nick,seller_nick,buyernick,time){
	if(vipuser==0){
		tradePoint(user_nick,'旺旺插件催付');
				 QN.application.invoke({
		   		"cmd" : "openAttachWindow",
		   		"param" : {
		   			event:"yunyings",
		   			width:780,
		   			height:650,
		   			title:'该功能需订购高级版并重新打开插件才能使用(当前版本:初级版)'
		   			}
		   	});
		return;
	}
	/*$('#wwlist').empty();
	var str1='亲爱的'+nick+'，您拍下的订单'+tid+'我们一直留着，麻烦付款一下。稍后我们会立即为您发货。';
	var str2='亲爱的'+nick+'，您在'+seller_nick+'购买的宝贝还未付款哦，请尽快付款以便我们以最快的速度发货哦！';
	var str3='亲爱的'+nick+'，您下单的宝贝还没付款哦。我们会为您预留1天，每天下午4点前付款会当天发货的哦~';*/
	$.mobile.loading( 'show' );	
	/*if(buyernick==''||buyernick.length<2){
		buyernick=user_nick;
	}*/
	$.ajax({
	     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/fastpay',
	     type: 'POST',
	     dataType:'html',
	     data:{nick:user_nick},
	     timeout:10000,
         success: function(data){
            data=data.replace(/<买家姓名>/g, name);
            data=data.replace(/<卖家旺旺>/g, buyernick);
            data=data.replace(/<订单链接>/g, 'http://trade.taobao.com/trade/detail/trade_item_detail.htm?bizOrderId='+tid);
            data=data.replace(/<买家旺旺>/g, nick);
            data=data.replace(/<订单编号>/g, tid);
            data=data.replace(/<下单时间>/g, time);
            wwcuifu=data;
            copyww(wwcuifu);                       
        },
        error: function(){
            /*请求出错处理 */
            Alert('出错了！');
        }
    });
	
	/*$('#wwlist').append('<li><a onclick=\"copyww(\''+wwcuifu+'\')\"><span class="bblib font_wsl" style="margin:0; font-size:12px; font-weight:normal;">'+wwcuifu+'</span></a></li>');	
	$('#wwlist').append('<li><a onclick=\"copyww(\''+str1+'\')\"><span class="bblib font_wsl" style="margin:0; font-size:12px; font-weight:normal;">'+str1+'</span></a></li>');
	$('#wwlist').append('<li><a onclick=\"copyww(\''+str2+'\')\"><span class="bblib font_wsl" style="margin:0; font-size:12px; font-weight:normal;">'+str2+'</span></a></li>');
	$('#wwlist').append('<li><a onclick=\"copyww(\''+str3+'\')\"><span class="bblib font_wsl" style="margin:0; font-size:12px; font-weight:normal;">'+str3+'</span></a></li>').listview('refresh');
	$("#wwpop").popup("open");*/
}
/****修改价格*****/
function toprice(){
	$("#uppricepop").popup("open");
}
function freeposts(){

	var yunfei=$('#yunfei').val();
	$.mobile.loading( 'show' );
	    	QN.top.invoke({
	    		"cmd":'taobao.trade.postage.update',
	    		"param":{tid:mytid,post_fee:0},
	    		"method":"get",
	    		"success": function (resp){
	    		$.mobile.loading( 'hide' );		     
                if(typeof resp === 'string'){
                    var    rsp = JSON.parse(resp);
                    }else{
                    var	rsp= resp;
                    }
            	$('#yunfei').val("0");
            	var payment=$('#postall').text();
            	var post=$('#post'+mytid).text();
            	$('#price'+mytid).text(payment-post);
            	$('#postall').text($('#price'+mytid).text());
            	$('#post'+mytid).text('0');
                	 alert("操作成功！");
                 },
    		"error": function (msg) {
    			if(msg.sub_code=='subuser.has-no-permission'){
    			      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
    			    }else{
    			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
    			    }
    		    } 
	    	}
                   		       	
	 );

}
function uppostext(yunfei){
	if(yunfei==''||yunfei==null){
		alert('运费不能为空');
	}else if(isNaN(yunfei)==true){
		alert('亲，价格必须是数字!');
	}else{
	var payment=$('#price'+mytid).text();
	var post=$('#post'+mytid).text();
	payment=payment-post;
	var mypay=parseFloat(payment)+parseFloat(yunfei);
	mypay=mypay.toFixed(2);
	$('#postall').text(mypay);
	}
}
function uppost(){

	var yunfei=$('#yunfei').val();
	if(isNaN(yunfei)==true){
		alert('亲，价格必须是数字!');
	}else if(yunfei==''){
		alert('运费不能为空');
	}else{
	$.mobile.loading( 'show' );
	    	QN.top.invoke({
	    		"cmd":'taobao.trade.postage.update',
	    		"param":{tid:mytid,post_fee:yunfei},
	    		"method":"get",
	    		"success": function (resp){
	    		$.mobile.loading( 'hide' );		     
                if(typeof resp === 'string'){
                    var    rsp = JSON.parse(resp);
                    }else{
                    var	rsp= resp;
                    }
            	var payment=$('#price'+mytid).text();
            	var post=$('#post'+mytid).text();
            	payment=payment-post;
            	var mypay=parseFloat(payment)+parseFloat(yunfei);
            	mypay=mypay.toFixed(2);
            	$('#price'+mytid).text(mypay);
            	$('#postall').text(mypay);
            	$('#post'+mytid).text(yunfei);
                	 alert("操作成功！");
                	 $("#uppostpop").popup("close");
                 },
    		"error": function (msg) {
    			if(msg.sub_code=='subuser.has-no-permission'){
    			       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
    			    }else{
    			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
    			    }
    		    } 
	    	}
                   		       	
	 );
	}

}
function showprice(tid)
{
	mytid=tid;
	if(usertype=='B'){
		    	QN.top.invoke({
		    		"cmd": "taobao.trade.get",
		    		"param": {fields:'post_fee,total_fee,payment',tid:tid},
		    		"method": "get",
		    		"success": function (resp){
	                if(typeof resp === 'string'){
	                    var    rsp = JSON.parse(resp);
	                    }else{
	                    var	rsp= resp;
	                    }
			    		
			    		var trade=rsp.trade_get_response.trade;
			    		$('#yunfei').val(trade.post_fee);
			    		$('#postall').text(trade.payment);
			    		$("#uppostpop").popup("open");

	                  	},
	            		"error": function (msg) {
	            			if(msg.sub_code=='subuser.has-no-permission'){
	            			      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
	            			    }else{
	            			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
	            			    }
	            		    }   	

		        });

	}else{
    	QN.component.invoke( {
			category:'updateprice',
			param:{
				uuid:'2314',
				tid:mytid
			},
			error : function(msg, cmd, param) {

			},
			success : function(rsp, cmd, param) {
                showlist(mytid,gstas);
                alert("修改成功!");
			}
		});
		/*QN.application.invoke({
			 "cmd": 'getVersion',
			 "success": function (e){
				 if(typeof  e=== 'string'){
		            	e = JSON.parse(e);
		            }
		            
		            var version=e.version.replace(/[.]/g,"");
		            version=version.replace(/[N]/g,"");
		            if(version<10010){

		            	QN.top.invoke({
		        			"cmd": "taobao.trade.fullinfo.get",
		        			"param": {fields:'tid,discount_fee,post_fee,total_fee,payment,orders.title,orders.sku_properties_name,orders.price,orders.num,orders.oid,orders.adjust_fee,orders.discount_fee,orders.price,promotion_details.discount_fee,promotion_details.id,promotion_details.promotion_name',tid:tid},
		        			"method": "get",
		        			"success": function (rsp){
		        	            if(typeof  rsp=== 'string'){
		        	            	rsp = JSON.parse(rsp);
		        	            }
		        	            if(rsp.code!=null){
		        	                alert(JSON.stringify(rsp));
		        	            }else{
		        				var datas = {};
		        				var trade=rsp.trade_fullinfo_get_response.trade;
		        				datas.tid=trade.tid;
		        				datas.tdiscount_fee=trade.discount_fee;
		        				datas.post_fee=trade.post_fee;
		        				datas.total_fee=trade.total_fee;
		        				datas.payment=trade.payment;
		        		
		        				$("#pricelist1").empty();
		        		            var source = $("#pricelist1_template").html();
		        		
		        		            var template = Handlebars.compile(source);
		        		            var htmlstr = template(datas);
		        		            $("#pricelist1").append(htmlstr).trigger('create');
		        		        $("#pricelist2").empty();
		        		        myArray=[];
		        		        for(index in trade.orders.order){
		        		            var order=trade.orders.order[index];
		        		            datas.title=order.title;
		        		            datas.sku_properties_name=order.sku_properties_name;
		        		            datas.price=order.price;
		        		            datas.num=order.num;
		        		            datas.oid=order.oid;
		        		            myArray[index]=order.oid;
		        		
		        		            datas.adjust_fee=order.adjust_fee;
		        		            datas.discount_fee=order.discount_fee;
		        		            datas.price=order.price;
		        		
		        		            if(datas.adjust_fee-datas.discount_fee==0){
		        		                datas.zhe='';
		        		            }else{
		        		            	
		        		                	datas.zhe=parseFloat(datas.price*datas.num)+parseFloat(datas.adjust_fee)-datas.discount_fee;
		        		                	datas.zhe*=10;
		        		                	datas.pn=datas.price*datas.num;
		        		                	datas.zhe/=datas.pn;
		        		                	datas.zhe=datas.zhe.toFixed(2);
		        		                	
		        		            }
		        		            datas.jiage=datas.adjust_fee-datas.discount_fee;
		        		            datas.jiage=datas.jiage.toFixed(2);
		        		            
		        		
		        		            datas.youhui=0;
		        		            datas.youhui=parseFloat(datas.youhui)+parseFloat(datas.discount_fee);
		        		            datas.youhui=datas.youhui.toFixed(2);
		        		
		        		           
		        		            
		        		    		
		        		            var source = $("#pricelist2_template").html();
		        		
		        		            var template = Handlebars.compile(source);
		        		            var htmlstr = template(datas);
		        		            $("#pricelist2").append(htmlstr).trigger('create');
		        		        }
	
		        		        
		        		        if(datas.total_fee-0.7*(datas.total_fee-datas.youhui-trade.discount_fee)>=200){
		        		            datas.min=0-200;
		        		            datas.max=50;
		        		        }else{
		        		            datas.min=0-0.7*(datas.total_fee-datas.youhui-trade.discount_fee);
		        		            datas.max=50;
		        		        }

		        		
		        		
		        		        if(trade.promotion_details!=undefined&&trade.discount_fee!=0){
		        		        	if((trade.discount_fee==trade.promotion_details.promotion_detail[0].discount_fee)&&(trade.tid==trade.promotion_details.promotion_detail[0].id)){
		        		            	datas.yhname=trade.promotion_details.promotion_detail[0].promotion_name;
		        		            }else{
		        		                datasyhname='绯荤粺浼樻儬';
		        		            }
		        		            datas.isyhname=true;
		        		        }else{
		        		            datas.isyhname=false;
		        		        }
		        		        datas.min=parseFloat(datas.min)+parseFloat(datas.post_fee)+parseFloat(datas.total_fee);
		        		        datas.min-=trade.discount_fee;
		        		        datas.max=parseFloat(datas.max)+parseFloat(datas.post_fee)+parseFloat(datas.total_fee);
		        		        datas.max-=trade.discount_fee;
		        		        datas.min=datas.total_fee-datas.min;
		        		        datas.min=datas.min.toFixed(2);
		        		        datas.max=datas.max.toFixed(2);
		        		
		        		
		        		
		        				$("#pricelist3").empty();
		        		        var source = $("#pricelist3_template").html();
		        		
		        		        var template = Handlebars.compile(source);
		        		        var htmlstr = template(datas);
		        		        $("#pricelist3").append(htmlstr).trigger('create');
		        		        toprice();
		        	            }
		        			
		        			},
		        			"error": function (msg) {
		        				if(msg.sub_code=='subuser.has-no-permission'){
		        					alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!');
		        				    }else{
		        				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
		        				    }
		        			    }
		        			});
		            }else{

		            }
			 }
		});*/

	}
}


function updateprice(tid){
	
	var oids='';
	var fess='';
	var post=$('#post_fee').val();
	for(var i=0;i<myArray.length;i++){
		oids+=myArray[i];
		var jg=$("input[name='slider-"+myArray[i]+"']").val();
		if(isNaN(jg)==true){
			alert('亲，价格必须是数字1!');
			/*$("#isNaN").popup("open");*/
			return ;
		}else if(jg==''){
			alert('亲，修改价格不能为空!');
			/*$("#isNum").popup("open");*/
			return ;
		}else{
			fess+=jg;
		}
		if(i<myArray.length-1){
			 oids+=',';
			 fess+=',';
			}
	}
	if(isNaN(post)==true){
		alert('亲，价格必须是数字2!');
		/*$("#isNaN").popup("open");*/

	}else if(post==''){
		alert('亲，修改价格不能为空!');
		/*$("#isNum").popup("open");*/

		}else{
			QN.top.invoke({
				"cmd": "taobao.trade.price.update",
				"param": {tid:tid,oids:oids,adjust_fees:fess,postage_fee:post},
				"method": "get",
				"success": function (rsp){
		            if(typeof  rsp=== 'string'){
		            	rsp = JSON.parse(rsp);
		            }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
						showlist(tid,gstas);
						alert("修改成功！");
						$("#uppricepop").popup("close");
	                }
				
				},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					     /*   alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
				});
	}



}
function freepost(){
	$('#post_fee').val('0');
	alert('操作成功！');
}
/************************************************关闭订单*****/
function toclose(tid){
	mytid=tid;
	$.mobile.loading( 'show' );
	QN.top.invoke({
		"cmd": "taobao.trade.fullinfo.get",
		"param": {fields:'orders.status,orders.pic_path,orders.title,orders.oid,orders.num,orders.total_fee,orders.sku_properties_name,orders.outer_iid,orders.outer_sku_id',tid:tid},
		"method": "get",
		"success": function (rsp){
	            if(typeof  rsp=== 'string'){
	            	rsp = JSON.parse(rsp);
	            }
                	
		  		var datas = {};
		    		
		    		var trade=rsp.trade_fullinfo_get_response.trade;
		    		$("#closelist").empty();
		    		for(index in trade.orders.order){
		    				var order=trade.orders.order[index];
		    				if(order.status=="WAIT_BUYER_PAY"||order.status=="TRADE_NO_CREATE_PAY"){
					    		datas.oid=order.oid;
					    		datas.pic_path=order.pic_path;
					    		datas.title=order.title;
					    		datas.total_fee=order.total_fee;
					    		datas.num=order.num;
					    			    		
					    		if(order.outer_iid!=''||order.outer_sku_id!=''){
		                             if(order.outer_sku_id!=''&& order.outer_sku_id!=null){
		                         		datas.outer_iid='商家编码：'+order.outer_sku_id;
		                         		
		                             }else if(order.outer_iid!=''&&order.outer_iid!=null){
		                            	 datas.outer_iid='商家编码：'+order.outer_iid;		                            	
		                            }		                             
		                         }
					    		
					    		datas.sku_properties_name=order.sku_properties_name;
		                        source = $("#closelist_template").html();
		                        template =Handlebars.compile(source);
		                        htmlstr = template(datas);
		                        $("#closelist").append(htmlstr).trigger('create');
		    				}

		    		}
		    		$.mobile.loading( 'hide' );
		    		$('#closepop').popup("open");	
		},
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
				/* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }

	        });

}
/*添加轻任务*/
var istjtask=true;
function listrws(tid){
    if(istjtask){
        istjtask=false;
        mytid=tid;
        var jsontasklist = [{"biz_id":mytid,"nick":tasknickr}];
        QN.component.invoke({
            category:'qtask_create',
            param:{
                biz_type:'trade',
                items:jsontasklist,
            },
            error : function(msg, cmd, param) {
                istjtask=true;
                setTimeout("showlist('"+tid+"','"+gstas+"')",1000);
            },
            success : function(rsp, cmd, param) {
                istjtask=true;
                alert("创建任务成功！");
                setTimeout("showlist('"+tid+"','"+gstas+"')",1000);
            }
        });

    }
}
/*   			处理任务			*/
var islistcl=true;
function listcl(listid,tid){
    if(islistcl){
        islistcl=false;
		QN.component.invoke({
			category:'qtask_deal',
			param:{
				task_ids:[listid]
				
			},
			error : function(msg, cmd, param) {
                islistcl=true;
                setTimeout("showlist('"+tid+"','"+gstas+"')",1000);
			},
			success : function(rsp, cmd, param) {
                alert("任务处理成功！");
                islistcl=true;
                setTimeout("showlist('"+tid+"','"+gstas+"')",1000);
			}
		});
    }
}
/*   			转发任务			*/
 var islistzj=true;
function listzj(meta_ids,tid){
    if(islistzj){
        islistzj=false;
	QN.component.invoke({
		category:'qtask_transfer',
		param:{
			meta_ids:[meta_ids]				
		},
		error : function(msg, cmd, param) {
            islistzj=true;
            setTimeout("showlist('"+tid+"','"+gstas+"')",1000);
		},
		success : function(rsp, cmd, param) {
            alert("任务转交成功！");
            islistzj=true;
            setTimeout("showlist('"+tid+"','"+gstas+"')",1000);
		}
	});
    }
}


/**
 * 关闭订单
 * 1.判断是否拆单关闭
 * @author Duanhq
 */
function tradeclose(){
	var num=0;
	var tids=new Array();
	var sub_tid='';
	var turn=document.getElementsByName('closecheckcheckbox');
	for(i=0;i<turn.length;i++){ 
		if(turn[i].checked){ 
			tids[num++]=turn[i].value;
		}
	}

    if(num==0){
        alert('请选择需要关闭的订单');
		
    }else{
		if(num==turn.length){
			/*不拆单关闭*/
			tids=new Array([mytid]);
		}
		tradecloses(tids);
    }
    
}
/**
 * 关闭订单
 * 2.确认关闭
 * @aothor Duanhq
 */
function tradecloses(closeid){
	$.mobile.loading( 'show' );	
	var day=$("#select-choice-b").val();
	if(day==0){		
		alert("关闭错误，关闭理由不能为空");
	}else{
		for(index in closeid){
			QN.top.invoke({
				"cmd": "taobao.trade.close",
				"param": {tid:''+closeid[index],close_reason:day},
				"method": "get",
				"success": function (rsp){
		            if(typeof  rsp=== 'string'){
		            	rsp = JSON.parse(rsp);
		            }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
						showlist(mytid,gstas);
						$("#closepop").popup("close");
						alert('操作成功!');
	                }
				
				},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
				});
		}

	}
}
/*********************************************************卖家备注**********/
function tobeiw(){
	$('#beiwpop').popup("open");
			        		QN.application.invoke({
							 "cmd": 'getVersion',
							 "success": function (e){
								 if(typeof  e=== 'string'){
						            	e = JSON.parse(e);
						            }
						            
						            var version=e.version.replace(/[.]/g,"");
						            version=version.replace(/[N]/g,"");
						           /* if(version<10017){*/
							           /**
							           *撤销退款组件
							           */
							           if(version>=20301){
							           		
							           		QN.application.invoke( {

														cmd : 'getFocus',
														
														error : function(msg, cmd, param) {
														
														},
														
														success : function(rsp, cmd, param) {
														$('#textareas').focus();
														
														}
														
													} );
							            }
							 }
						});
}
var bmemo;
var bflag;
function showbeiw(tid){
	QN.top.invoke({
		"cmd": "taobao.trade.fullinfo.get",
		"param": {fields:'tid,seller_flag,seller_memo',tid:tid},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
			var datas = {};
    		
    		var trade=rsp.trade_fullinfo_get_response.trade;
    		datas.flag=trade.seller_flag;
    		flagcss='bw_'+datas.flag;
    		if(datas.flag=='1'){
    			datas.flag1='checked';
    		}
    		if(datas.flag=='2'){
    			datas.flag2='checked';
    		}
    		if(datas.flag=='3'){
    			datas.flag3='checked';
    		}
    		if(datas.flag=='4'){
    			datas.flag4='checked';
    		}
    		if(datas.flag=='5'){
    			datas.flag5='checked';
    		}
    		datas.tid=trade.tid;
    		datas.memo=trade.seller_memo;
    		bmemo=datas.memo;
    		bflag=datas.flag;
    		$("#addbeiw").empty();
    	    var source = $("#addbeiw_template").html();
    	    var template = Handlebars.compile(source);
    	    var htmlstr = template(datas);
    	    $("#addbeiw").append(htmlstr).trigger('create');
    	   	/*console.log('<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getFast?types=fast_beiw&nick='+user_nick);*/
    	    $.ajax({
   		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getFast',
   		     type: 'POST',
   		     dataType:'html',
   		     data:{nick:user_nick,types:'fast_beiw'},
   		     timeout:10000,
			 success:function(rsp){
					rsp=rsp.split('\\n');
					var text='';
					for(index in rsp){/*加载备忘短语*/
							$("#selfastbeiw").append("<option value='"+rsp[index]+"'>"+rsp[index]+"</option>");
					}
				}
        	 });
    	    tobeiw();
            }
		},
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }
		});
}
function changefastbeiw(){
	var fastbeiw=$("#selfastbeiw").find("option:selected").val();
	if(fastbeiw=='' || fastbeiw==null){
		$("#textareas").html('');
	}else{
		$("#textareas").html(fastbeiw);
	}

}
function addbeiw(tid){
	if(bmemo==null&&bflag=='0'){
		var data = $("#textareas").val();
		data=clearBr(data);
		var seltitle = $("input[name='flag']:checked").val();
		if($("input[name='flag']:checked").val()==null){
			seltitle=0;
		}
		if(data.length>500){
			alert('备注内容不能超过500字!',5000);
		}else{

			QN.top.invoke({
				"cmd": "taobao.trade.memo.update",
				"param": {tid:tid,memo:data,flag:seltitle},
				"method": "get",
				"success": function (rsp){
		            if(typeof  rsp=== 'string'){
		            	rsp = JSON.parse(rsp);
		            }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
	                	 showlist(null,gstas);
	                alert('备注成功！');
	                 bmemo=data;
	                 bflag=seltitle;	                
	                 $('#flags'+tid).text(data);
	                 $('#flag'+tid).removeClass(flagcss);
	                 $("#flag"+tid).addClass("bw_"+bflag);
	                 flagcss="bw_"+bflag;
	                 $('#beiwpop').popup("close");
	                }
				
				},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
				});
			
		}
	}else{
		
		var data = $("#textareas").val();
		data=clearBr(data);
		var seltitle = $("input[name='flag']:checked").val();
		if($("input[name='flag']:checked").val()==null){
			seltitle=0;
		}
		if(data.length>500){
			alert('备注内容不能超过500字!',5000);
		}else{
			QN.top.invoke({
				"cmd": "taobao.trade.memo.update",
				"param": {tid:tid,memo:data,flag:seltitle},
				"method": "get",
				"success": function (rsp){
		            if(typeof  rsp=== 'string'){
		            	rsp = JSON.parse(rsp);
		            }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
	                	 showlist(null,gstas);	                	
					alert('备注成功！');
					$('#flags'+tid).text(data);
	                 $('#flag'+tid).removeClass(flagcss);
	                 $("#flag"+tid).addClass("bw_"+seltitle);
	                 flagcss="bw_"+seltitle;
	                 $('#beiwpop').popup("close");
	                }
				
				},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
				});
			
		}
		
	}

}

/*******************************************go send*************/

function tosend(name,tid,nick,seller_nick){
	mytid=tid;
	user_nick=seller_nick;
	showsendlist(tid);
}
/***********************************go codsend******************************/
function tocodsend(name,tid,nick,seller_nick){
	mytid=tid;
	user_nick=seller_nick;
	$('#codsendpop').popup("open");
}
function tocodsends(){
	var outid=$('#codonline_out').val();
	var cycode=$('#codon_div select').find("option:selected").val();
	if(outid==''){
		alert('运单号不能为空');
	}else{
		$.mobile.loading( 'show' );
		refresh();
			QN.top.invoke({
				"cmd": 'taobao.logistics.online.send',
				"param": {tid:mytid,out_sid:outid,company_code:cycode,},
				"method": "get",
				"success": function (resp){
	    		$.mobile.loading( 'hide' );		     
                if(typeof resp === 'string'){
                    var    rsp = JSON.parse(resp);
                    }else{
                    var	rsp= resp;
                    }
                	showlist(mytid,gstas);
                     alert('操作成功!');
                  	$('#codsendpop').popup("close");
                 },
		 			"error": function (msg) {
						if(msg.sub_code=='subuser.has-no-permission'){
						      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
						    }else{
						    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
						    }
					    }
                   		       	
	 });
	}
}
/*******************************************go bfsend*****************/
function tobfsend(tid){
	mytid=tid;
	alert(mytid);
}
/***************************************wltime***********/
function towltime(text,tid){
	$('#wltimepop').popup("open");
	mytid=tid;
}
function addtime(tid){
	var day=$("#select-choice-a").val();
	if(day==0){		
		alert("修改错误，延长天数不能为空");
	}else{
	
		QN.top.invoke({
			"cmd": "taobao.trade.receivetime.delay",
			"param": {tid:mytid,days:day},
			"method": "get",
			"success": function (rsp){
	            if(typeof  rsp=== 'string'){
	            	rsp = JSON.parse(rsp);
	            }                if(rsp.code!=null){
                    alert(JSON.stringify(rsp));
                }else{
	            	 showlist(mytid,gstas);
	            	 $('#wltimepop').popup("close");
	            	 alert('操作成功!');
                }
	             },
		 			"error": function (msg) {
						if(msg.sub_code=='subuser.has-no-permission'){
						       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
						    }else{
						    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
						    }
					    }
	               		       	
	 });	
	}
}
/********************************************show wl*****************/
var wz;
function towl(name,tid,nick,seller_nick){
	wz=name;
	mytid=tid;
	user_nick=seller_nick;
	QN.top.invoke({
		"cmd": "taobao.logistics.orders.get",
		"param": {fields:'tid,order_code,seller_nick,buyer_nick,delivery_start,delivery_end,out_sid,item_title,receiver_name,created,modified,status,type,freight_payer,seller_confirm,company_name,sub_tids,is_spilt',tid:tid},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }                if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
                
                     var orders=rsp.logistics_orders_get_response.shippings.shipping;
                     var datas={};
                     $("#bfwlxx").empty();
                     $("#bfselect").empty();
                     $("#bfwlxq").empty();
                     var i=1;
                     var n=0;
                     if(orders.length<2){
                    	 showwuliu(orders[0].type,orders[0].order_code,orders[0].modified,orders[0].buyer_nick);
                    	 
                     }else{
                   for(index in orders){
                         var item=orders[index];

                         if(item.seller_confirm=="yes"){

            				 	$("#bfselect").append("<option value=\""+index+"\" >包裹"+i+"</option>").trigger("create");
 	    	            		i++;
 	    	            		if(n==0){
 	 	    	            		n++;
            				 	if(item.out_sid!=''&&item.out_sid!=null){
            			    		datas.out_sid=item.out_sid;/*运单号*/
            		    			datas.isoutid=true;
            		    		}else{
            			    		datas.isoutid=false;
            		    		}
            		    		if(item.company_name!=''&&item.company_name!=null){
            			    		datas.company_name=item.company_name;/*物流公司*/
            			    		datas.iscompany=true;
            			    		mycd=true;
            		    		}else{
            		    			datas.iscompany=false;
            		    		}
            		    		datas.buyer_nick=item.buyer_nick;
            		    		datas.order_code=item.order_code;
            		    		datas.texts='';
            		    		if(datas.company_name!=null&&datas.company_name!=''){
            		    		datas.texts+=datas.company_name;
            		    		}
            		    		if(datas.out_sid!=null&&datas.out_sid!=''){
            			    		datas.texts+=','+datas.out_sid;
            		    		}
            		    		
            		    		if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.modified)>=23*60*60+50*60){
            			    		var show_resend=false;

            		    		}else{
            			    		var show_resend=true;
            		    		}
            		    		if(show_resend&&datas.company_name!=null&&wz=='已发货'){
            			    		datas.iscname=true;
            		    		}else{
            			    		datas.iscname=false;
            		    		}
            		    		switch(item.type){/*配送方式*/
            						case 'free':{
            							datas.type='卖家包邮';
            							break;
            						}
            		    			case 'post':{
            		    				datas.type='平邮';
            		    				break;
            		    			}
            		    			case 'express':{
            		    				datas.type='快递';
            		    				break;
            		    			}
            		    			case 'ems':{
            			    			datas.type='EMS';
            			    			break;
            		    			}
            		    			default:{
            			    			datas.type='无需物流';
            		    			}
            		    		}
         	                   datas.bfwul=false;
          	                  $("#bfwlxx").empty();
       		    		 	var source = $("#wllist_template").html();
       	  				 	var template = Handlebars.compile(source);
       	  				 	var  html = template(datas);
       	  				 	$("#bfwlxx").append(html);
       
          				 	datas.sub_tid=item.sub_tids.number;
          				 	mysub_tids=datas.sub_tid;
          				 	QN.top.invoke({
          						"cmd": "taobao.logistics.trace.search",
          						"param": {tid:tid,seller_nick:user_nick,is_split:'1',sub_tid:datas.sub_tid},
          						"method": "get",
          						"success": function (rsp){
          				            if(typeof  rsp=== 'string'){
          				            	rsp = JSON.parse(rsp);
          				            }
          				            if(rsp.code!=null){
          				                alert(JSON.stringify(rsp));
          				            }else{
          						    		var item=rsp.logistics_trace_search_response;
										 	
          									var len=item.trace_list.transit_step_info.length;
          									$("#bfwlxq").empty();
          								 	for (var i=0; i <len;i++){
          								 		var order=item.trace_list.transit_step_info[i];
          									 	datas.status_time=order.status_time;/*状态时间*/
          									 	datas.status_desc=order.status_desc;/*状态描述*/
          									 	if(order.status_time!=null&&order.status_desc!=null){
          										datas.text=datas.status_time+','+datas.status_desc;
          									 	}else{
          									 		datas.text='该订单无流转信息';
          									 	}
          							    		if(i<len-1){
          						    		 	var source = $("#wlxq_template").html();
          									 	var template = Handlebars.compile(source);
          									 	var html = template(datas);
          									 	$("#bfwlxq").append(html);
          							    		}else if(i==len-1){
          							    		 	var source = $("#wlxqz_template").html();
          										 	var template = Handlebars.compile(source);
          										 	var html = template(datas);
          										 	$("#bfwlxq").append(html).trigger("create");
          										 	
          							    		}
          								 	}
          								 	$('#bfwlxx').append(" <h3><span style=\"font-weight:normal;\" >物流跟踪</span><a data-role=\"button\" data-ajax=\"false\" onclick=\"copyww('"+datas.text+"');\" data-inline=\"true\" data-mini=\"true\" data-theme=\"c\" class=\"pro_right\"><span style=\"margin:0; font-size:12px; font-weight:normal;\" class=\"font_wsl\">发送最新物流信息</span></a></h3>").trigger("create");
          				            }


          					    		}
          							}
          					);
                         }
                         }

      				 	
                     }

  				 	
                   $("#bfselect option[value='0']").attr("selected","selected");
                   $('#bfselect').selectmenu('refresh', true);
                   $('#bfselect').change(showbg);
                     $('#bfwuliulog').popup("open");
                     }
                 /*    showwuliu(orders[0].type,orders[0].order_code,orders[0].modified,orders[0].buyer_nick);*/
                 }
		},
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }    		       	
	 });
}
var mysub_tids;
function showbg(){
	var sel=$("#bfselect").find("option:selected").val();
	QN.top.invoke({
		"cmd": "taobao.logistics.orders.get",
		"param": {fields:'tid,order_code,seller_nick,buyer_nick,delivery_start,delivery_end,out_sid,item_title,receiver_name,created,modified,status,type,freight_payer,seller_confirm,company_name,sub_tids,is_spilt',tid:mytid},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }                if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
                
                     var orders=rsp.logistics_orders_get_response.shippings.shipping;
                     var datas={};
                     $("#bfwlxx").empty();
                     $("#bfwlxq").empty();
                  for(index in orders){
                         var item=orders[index];
                         if(sel==index){
            				 	if(item.out_sid!=''&&item.out_sid!=null){
            			    		datas.out_sid=item.out_sid;/*运单号*/
            		    			datas.isoutid=true;
            		    		}else{
            			    		datas.isoutid=false;
            		    		}
            		    		if(item.company_name!=''&&item.company_name!=null){
            			    		datas.company_name=item.company_name;/*物流公司*/
            			    		datas.iscompany=true;
            			    		mycd=true;
            		    		}else{
            		    			datas.iscompany=false;
            		    		}
            		    		datas.buyer_nick=item.buyer_nick;
            		    		datas.order_code=item.order_code;
            		    		datas.texts='';
            		    		if(datas.company_name!=null&&datas.company_name!=''){
            		    		datas.texts+=datas.company_name;
            		    		}
            		    		if(datas.out_sid!=null&&datas.out_sid!=''){
            			    		datas.texts+=','+datas.out_sid;
            		    		}
            		    		
            		    		if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.modified)>=23*60*60+50*60){
            			    		var show_resend=false;

            		    		}else{
            			    		var show_resend=true;
            		    		}
            		    		if(show_resend&&datas.company_name!=null&&wz=='已发货'){
            			    		datas.iscname=true;
            		    		}else{
            			    		datas.iscname=false;
            		    		}
            		    		switch(item.type){/*配送方式*/
            						case 'free':{
            							datas.type='卖家包邮';
            							break;
            						}
            		    			case 'post':{
            		    				datas.type='平邮';
            		    				break;
            		    			}
            		    			case 'express':{
            		    				datas.type='快递';
            		    				break;
            		    			}
            		    			case 'ems':{
            			    			datas.type='EMS';
            			    			break;
            		    			}
            		    			default:{
            			    			datas.type='无需物流';
            		    			}
            		    		}
          				 	datas.sub_tid=item.sub_tids.number;
          				 	mysub_tids=datas.sub_tid;
          				 	QN.top.invoke({
          						"cmd": "taobao.logistics.trace.search",
          						"param": {tid:mytid,seller_nick:user_nick,is_split:'1',sub_tid:datas.sub_tid},
          						"method": "get",
          						"success": function (rsp){
          				            if(typeof  rsp=== 'string'){
          				            	rsp = JSON.parse(rsp);
          				            }
          				            if(rsp.code!=null){
          				                alert(JSON.stringify(rsp));
          				            }else{
          						    		var item=rsp.logistics_trace_search_response;
										 	
          									var len=item.trace_list.transit_step_info.length;
          									$("#bfwlxq").empty();
          								 	for (var i=0; i <len;i++){
          								 		var order=item.trace_list.transit_step_info[i];
          									 	datas.status_time=order.status_time;/*状态时间*/
          									 	datas.status_desc=order.status_desc;/*状态描述*/
          									 	if(order.status_time!=null&&order.status_desc!=null){
              										datas.text=datas.status_time+','+datas.status_desc;
              									 	}else{
              									 		datas.text='该订单无流转信息';
              									 	}
          							    		if(i<len-1){
          						    		 	var source = $("#wlxq_template").html();
          									 	var template = Handlebars.compile(source);
          									 	var html = template(datas);
          									 	$("#bfwlxq").append(html).trigger("create");
          							    		}else if(i==len-1){
          							    		 	var source = $("#wlxqz_template").html();
          										 	var template = Handlebars.compile(source);
          										 	var html = template(datas);
          										 	$("#bfwlxq").append(html).trigger("create");
          										 	
          							    		}
          								 	}
          								 	datas.bfwl=true;
          								 	$("#bfwlxx").empty();
          					    		 	var source = $("#wllist_template").html();
          				  				 	var template = Handlebars.compile(source);
          				  				 	var  html = template(datas);
          				  				 	$("#bfwlxx").append(html).trigger("create");
          				            }


          					    		}
          							}
          					);
                         }

      				 	
                     }

                 /*    showwuliu(orders[0].type,orders[0].order_code,orders[0].modified,orders[0].buyer_nick);*/
                 }
		},
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }    		       	
	 });
}
/*function towls(name,tid,nick,seller_nick){
	wz=name;
	mytid=tid;
	user_nick=seller_nick;
	QN.top.invoke({
		"cmd": "taobao.logistics.orders.get",
		"param": {fields:'type,order_code,modified,seller_nick,buyer_nick',tid:tid},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }                if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
                
                     var orders=rsp.logistics_orders_get_response.shippings.shipping;
                     showwuliu(orders[0].type,orders[0].order_code,orders[0].modified,orders[0].buyer_nick);
                 }
		}    		       	
	 });
}*/
/*呼出交易插件*/
function opentrade(){
	QN.plugin.invoke({
        appkey:'21085840',
        success: function (rsp) {
            },
        error:function(msg){
        	Alert("请求超时!");
		  }
		});
}


/*联系客服*/
function lianxikf(){
	$.get('<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/wwkf',function(data){
			data=eval("("+data+")");
			var kf=data['goname'];
			if(kf==""){
				kf=data['zhname'];
			} 
		 QN.wangwang.invoke({
		     category: 'wangwang', 
		     cmd: 'chat',
		     param: {'uid':"cntaobao"+kf},
		     success: function (rsp) {
		         //alert(JSON.stringify(rsp));
		     },
		     error: function (msg) {		     	
		     }
		 });
		 var info  = "";
			var os = navigator.platform;
			var userAgent = navigator.userAgent;
			if(os.indexOf("Win") > -1){
				if(userAgent.indexOf("Windows NT 5.0") > -1){
					info += "Win2000";
				}else if(userAgent.indexOf("Windows NT 5.1") > -1){
					info += "WinXP";
				}else if(userAgent.indexOf("Windows NT 5.2") > -1){
					info += "Win2003";
				}else if(userAgent.indexOf("Windows NT 6.0") > -1){
					info += "WindowsVista";
				}else if(userAgent.indexOf("Windows NT 6.1") > -1 || userAgent.indexOf("Windows 7") > -1){
					info += "Win7";
				}else if(userAgent.indexOf("Windows 8") > -1 || userAgent.indexOf("Windows NT 6.2") > -1){
					info += "Win8";
				}else{
					info += "Other";
				}
			}else if(os.indexOf("Mac") > -1){
				info += "Mac";
			}else if(os.indexOf("X11") > -1){
				info += "Unix";
			}else if(os.indexOf("Linux") > -1){
				info += "Linux";
			}else{
				info += "Other";
			}
		 setTimeout(function(){
			 QN.application.invoke({
				  cmd: "getVersion",
				  success: function(e){
					 if(typeof  e=== 'string'){
				          e = JSON.parse(e);
				      }
					 QN.wangwang.invoke({
				 	        category: 'wangwang', 
				 	        cmd: 'insertText2Inputbox',
				 	        param: {'uid':"cntaobao"+kf,'text':'【PC千牛-交易管理旺旺插件】系统：'+info+'，千牛：'+e.version,'type':0},
				 	        success: function (rsp) {
				 	        	
				 	        }
				 	    });
				  }
				});
		 },800);
	});
		 
	}


function showwuliu(type,order_code,modified,buyer_nick){
	mycd=false;
	QN.top.invoke({
		"cmd": "taobao.logistics.trace.search",
		"param": {tid:mytid,seller_nick:user_nick},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
		    		var item=rsp.logistics_trace_search_response;
		    		var datas={};
		    		datas.bfwl=true;
		    		if(item.out_sid!=''&&item.out_sid!=null){
			    		datas.out_sid=item.out_sid;/*运单号*/
		    			datas.isoutid=true;
		    		}else{
			    		datas.isoutid=false;
		    		}
		    		if(item.company_name!=''&&item.company_name!=null){
			    		datas.company_name=item.company_name;/*物流公司*/
			    		datas.iscompany=true;
		    		}else{
		    			datas.iscompany=false;
		    		}
		    		datas.buyer_nick=buyer_nick;
		    		datas.order_code=order_code;
		    		datas.texts='';
		    		if(datas.company_name!=null&&datas.company_name!=''){
		    		datas.texts+=datas.company_name;
		    		}
		    		if(datas.out_sid!=null&&datas.out_sid!=''){
			    		datas.texts+=','+datas.out_sid;
		    		}
		    		
		    		if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(modified)>=23*60*60+50*60){
			    		var show_resend=false;

		    		}else{
			    		var show_resend=true;
		    		}
		    		if(show_resend&&datas.company_name!=null&&wz=='已发货'){
			    		datas.iscname=true;
		    		}else{
			    		datas.iscname=false;
		    		}
		    		switch(type){/*配送方式*/
						case 'free':{
							datas.type='卖家包邮';
							break;
						}
		    			case 'post':{
		    				datas.type='平邮';
		    				break;
		    			}
		    			case 'express':{
		    				datas.type='快递';
		    				break;
		    			}
		    			case 'ems':{
			    			datas.type='EMS';
			    			break;
		    			}
		    			default:{
			    			datas.type='无需物流';
		    			}
		    		}

				 	
				 	$("#wlxq").empty();
					var len=item.trace_list.transit_step_info.length;
				 	for (var i=0; i <len;i++){
				 		var order=item.trace_list.transit_step_info[i];
					 	datas.status_time=order.status_time;/*状态时间*/
					 	datas.status_desc=order.status_desc;/*状态描述*/
					 	if(order.status_time!=null&&order.status_desc!=null){
							datas.text=datas.status_time+','+datas.status_desc;
						 	}else{
						 		datas.text='该订单无流转信息';
						 	}
			    		if(i<len-1){
		    		 	var source = $("#wlxq_template").html();
					 	var template = Handlebars.compile(source);
					 	var html = template(datas);
					 	$("#wlxq").append(html).trigger("create");
			    		}else if(i==len-1){
			    		 	var source = $("#wlxqz_template").html();
						 	var template = Handlebars.compile(source);
						 	var html = template(datas);
						 	$("#wlxq").append(html).trigger("create");
						 	
			    		}
				 	}
		    		$("#wlxx").empty();
	    		 	var source = $("#wllist_template").html();
				 	var template = Handlebars.compile(source);
				 	var  html = template(datas);
				 	$("#wlxx").append(html).trigger("create");

				 	$('#wuliulog').popup("open");
            }


	    		},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
			}
	);
}
var mycd;
/**************************************resend*****************/
function toresend(company){
/*alert(company+'>>'+mycd);*/
$('#wuliulog').popup("close");
$('#bfwuliulog').popup("close");
QN.top.invoke({
	"cmd": "taobao.logistics.companies.get",
	"param": {fields:'code,name',is_recommended:true,order_mode:'online'},
	"method": "get",
	"success": function (rsp){
        if(typeof  rsp=== 'string'){
        	rsp = JSON.parse(rsp);
        }
        if(rsp.code!=null){
            alert(JSON.stringify(rsp));
        }else{
    			$('#resendlist').empty();
    			var datas={};
    			 for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
	    			 var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
	    			 datas.name=order.name;
	    			 datas.code=order.code;
	    			 var source = $("#ontrade_template").html();
	    	            var template = Handlebars.compile(source);
	    	            var htmlstr = template(datas);
	    	            $("#resendlist").append(htmlstr);
	    	           		if(datas.name==company){
	    	            		$("#resendlist option[value='"+datas.code+"']").attr("selected","selected");
	    	            	}
    			 }
	    	        $("#resendlist").trigger("create");
	    	        $('#resendlist').selectmenu('refresh', true);
	    	       $('#resendpop').popup("open");
        }

	    	        
	    		
    		},
			"error": function (msg) {
				if(msg.sub_code=='subuser.has-no-permission'){
				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
				    }else{
				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
				    }
			    }
		}
);


}
function toresends(){
	var outid=$('#outid').val();
	var cycode=$('#resendlist').find("option:selected").val();
	if(outid==''){
		alert('修改发货失败,运单号不能为空');
	}else{
		$('#resendpop').popup("close");
		
		if(mycd==true){/*拆单发货*/
			QN.top.invoke({
				"cmd": "taobao.logistics.consign.resend",
				"param": {tid:mytid,out_sid:outid,is_split:'1',sub_tid:mysub_tids,company_code:cycode,},
				"method": "get",
				"success": function (rsp){
		            if(typeof  rsp=== 'string'){
		            	rsp = JSON.parse(rsp);
		            }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
						$('#outid').val(null);
						towl('已发货',mytid,'',user_nick);
	                  	alert('操作成功！');
	                }
	            },
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
	                   		       	
		 });
		}else{
			QN.top.invoke({
				"cmd": "taobao.logistics.consign.resend",
				"param": {tid:mytid,out_sid:outid,company_code:cycode,},
				"method": "get",
				"success": function (rsp){
		            if(typeof  rsp=== 'string'){
		            	rsp = JSON.parse(rsp);
		            }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
						$('#outid').val(null);
						towl('已发货',mytid,'',user_nick);
	                  	alert('操作成功！');
	                }
	            },
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
	                   		       	
		 });
		}
	}
}
/***************************************rates******************/
function torate(text,tid){
	mytid=tid;
	QN.top.invoke({
		"cmd": "taobao.trade.get",
		"param": {fields:'orders.title,orders.sku_properties_name,orders.pic_path,orders.price,orders.num,orders.oid',tid:tid},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
	    		if(rsp.code!=null){
	    			alert(JSON.stringify(rsp));
                }else{          
		    		var datas = {};
		    		$("#ratelists").empty();
		    		myArray=[];
		    		for(i in rsp.trade_get_response.trade.orders.order){
			    		var order=rsp.trade_get_response.trade.orders.order[i];
			    		datas.title=order.title;/*标题*/
			    		datas.sku_properties_name=order.sku_properties_name;/*商品编码*/
			    		datas.pic_path=order.pic_path;/*图片路径*/
			    		datas.price=order.price;/*价格*/
			    		datas.num=order.num;/*数量*/
			    		datas.oid=order.oid;/*子订单编号*/
			    		myArray[i]=order.oid;


                        
                        var source = $("#ratelists_template").html();

                        var template = Handlebars.compile(source);
                        var htmlstr = template(datas);
                        $("#ratelists").append(htmlstr).trigger('create');
		    		}
		    		$('#ratepop').popup("open");

                }


                  	},
        			"error": function (msg) {
        				if(msg.sub_code=='subuser.has-no-permission'){
        				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
        				    }else{
        				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
        				    }
        			    }   	

	        });
	
}
var val=0;
function traderates(){
	val=0;
	for(var i=0;i<myArray.length;i++){
		var result=$("input[name='radio"+myArray[i]+"']:checked").val(),text;
		text=$("textarea[name='content"+myArray[i]+"']").val();
		if(result==null){
			alert("请认真填写各项！");

		}else if(text.length>500){
			alert('评价内容不能超过500字！',5000);
		}else{
			if($("textarea[name='content"+myArray[i]+"']").val()==''){
				switch(result){
					case 'good':{text='好评';break;}
				}
			}else{
				text=$("textarea[name='content"+myArray[i]+"']").val();
			}
			QN.top.invoke({
				"cmd": "taobao.traderate.add",
				"param": {tid:mytid,oid:myArray[i],result:result,role:'seller',content:text,anony:false	},
				"method": "get",
				"success": function (rsp){
					val++;
		            if(typeof  rsp=== 'string'){
		            	rsp = JSON.parse(rsp);
		            }
			    		if(rsp.code!=null){
				    		if(val==myArray.length){
								alert(JSON.stringify(rsp));
				    		}
		                }else{
				    		if(val==myArray.length){
			                	$('#ratepop').popup("close");
			                	showlist(mytid,gstas);
				                alert('操作成功!');
				    		}

		                  	}    	
				},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
					    }
				    }
			        });
		}
		
	}
}
/*****************************************show refund*****************/
function torefund(text,tid){

	QN.application.invoke({
		 "cmd": 'getVersion',
		 "success": function (e){
			 if(typeof  e=== 'string'){
	            	e = JSON.parse(e);
	            }
	            
	            var version=e.version.replace(/[.]/g,"");
	            version=version.replace(/[N]/g,"");
	           /* if(version<10017){*/
		           /**
		           *撤销退款组件
		           */
		           if(version<99999999){
		            /*无法使用退款组件*/
	            	QN.top.invoke({
	            		"cmd": "taobao.trade.fullinfo.get",
	            		"param": {fields:"orders.refund_id",tid:tid},
	            		"method": "get",
	            		"success": function (rsp){
	            			var refundid='';
	                        if(typeof  rsp=== 'string'){
	                        	rsp = JSON.parse(rsp);
	                        }
	                        if(rsp.code!=null){
	                            alert(JSON.stringify(rsp));
	                        }else{
	                      var trade = rsp.trade_fullinfo_get_response.trade;
	                        for(var i in trade.orders.order){
	                            var order=trade.orders.order[i];
	                            if(order.refund_id!=null&&order.refund_id!=''){
	                            	refundid=order.refund_id;
	                            }
	                        }
	                    	QN.top.invoke({
	                    		"cmd": "taobao.refund.get",
	                    		"param": {
		                    				fields:'refund_id,created,order_status,good_status,status,refund_fee,reason,desc,tid,oid,has_good_return,sid',
		                    				refund_id:refundid},
	                    		"method": "get",
	                    		"success": function (rsp){    
	                                    if(typeof rsp === 'string'){
	                                          rsp = JSON.parse(rsp);
	                                        }
	                                    if(rsp.code!=null){
	                                        alert(JSON.stringify(rsp));
	                                    }else{
	                                    	 var refund=rsp.refund_get_response.refund;
	                                    	 var datas={};
	                                    	 datas.tid=refund.tid;
	                                    	 datas.oid=refund.oid;
	                                    	 datas.refund_id=refund.refund_id;/*退款编号*/
	                                    	 datas.created=refund.created;/*申请退款时间*/
	                                    	 datas.order_status=refund.order_status;
	                                    	 switch(refund.order_status){
	                                    	 	 case 'TRADE_NO_CREATE_PAY':{datas.order_status='没有创建支付宝交易';break;}
	                                    	  	 case 'WAIT_BUYER_PAY':{datas.order_status='等待买家付款';break;}
	                                    		 case 'WAIT_SELLER_SEND_GOODS':{datas.order_status='等待卖家发货,';break;}
	                                    		 case 'WAIT_BUYER_CONFIRM_GOODS':{datas.order_status='卖家已发货,';break;}
	                                    		 case 'TRADE_BUYER_SIGNED':{datas.order_status='买家已签收,';break;}
	                                    		 case 'TRADE_FINISHED':{datas.order_status='交易成功,';break;}
	                                    		 case 'TRADE_CLOSED':{datas.order_status='交易关闭,';break;}
	                                    		 case 'TRADE_CLOSED_BY_TAOBAO':{datas.order_status='交易被淘宝关闭,';break;}
	                                    	 }
	                                    	 switch(refund.good_status){
	                                    		 case 'BUYER_NOT_RECEIVED':{
	                                        		 if(refund.order_status=='WAIT_BUYER_CONFIRM_GOODS'){
	                                        			 datas.order_status+='买家未收到货，全额退款 ';
	                                        		 }else{
	                                        		 datas.order_status='卖家未发货，全额退款 ';
	                                        		 }
	                                        		 break;
	                                    		 }
	                                    		 case 'BUYER_RECEIVED':{
	                                        		 if(refund.has_good_return){
	                                            		 datas.order_status="买家已收到货,退货并退款";
	                                        		 }else{
	                                            		 datas.order_status="买家已收到货,不退货仅退款";
	                                        		 }
	                                        		 break;}
	                                    		 case 'BUYER_RETURNED_GOODS':{datas.order_status='买家已退货,全额退款';break;}
	                                    	 }
	                                    	 /*退款类型*/
	                                    	 datas.status=refund.status;/*退款状态*/
	                                    	 switch(refund.status){
	                                    	 	case 'WAIT_SELLER_AGREE':{datas.status='退款申请等待卖家确认中';break;}
	                                		   	 case 'WAIT_BUYER_RETURN_GOODS':{datas.status='卖家已经同意退款，等待买家退货';break;}
	                                		   	 case 'WAIT_SELLER_CONFIRM_GOODS':{datas.status='买家已经退货，等待卖家确认收货';break;}
	                                		   	 case 'SELLER_REFUSE_BUYER':{datas.status='卖家不同意申请，等待买家修改';break;}
	                                	  		 case 'CLOSED':{datas.status='退款关闭';break;}
	                                	  		 case 'SUCCESS':{datas.status='退款成功';break;}
	                                    	 }
	                                    	 
	                                    	 datas.refund_fee=refund.refund_fee;/*退款金额*/
	                                    	 datas.reason=refund.reason;/*退款原因*/
	                                    	 datas.desc=refund.desc;/*退款说明*/
	                                    	 if(refund.status=='WAIT_SELLER_AGREE'){
	                                        	 datas.rebutcal='ui-block-a';
	                                         }else{
	                                             datas.rebutcal='';
	                                         }
	                                    	 
	                    						datas.isjj=false;
	                    						if(refund.order_status!='WAIT_SELLER_SEND_GOODS'){
	                    							if(refund.status=='WAIT_SELLER_AGREE'||(''!=refund.sid&&refund.sid!=null&&refund.status=='WAIT_SELLER_CONFIRM_GOODS')){
	                    								datas.isjj=true;
	                    							}
	                    						}
	                    						if(usertype=='B'){
	                    							datas.isjj=false;
	                    						}
	                                    	 
	                    		    			$("#relist").empty();
	                    		    			
	                                            var source = $("#relist_template").html();

	                                            var template = Handlebars.compile(source);
	                                            var htmlstr = template(datas);
	                                            $("#relist").append(htmlstr).trigger('create');
	                                            getmessage(datas.refund_id);
	                                    }
	                                           
	                                     },
	                         			"error": function (msg) {
	                        				if(msg.sub_code=='subuser.has-no-permission'){
	                        				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
	                        				    }else{
	                        				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
	                        				    }
	                        			    }     	
	                    	 });
	                        }
	            		},
	            		"error": function (msg) {
	            			if(msg.sub_code=='subuser.has-no-permission'){
	            			      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
	            			    }else{
	            			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
	            			    }
	            		    }
	            		});
	            }else{
	            	QN.component.invoke( {
	            		category:'refund',
	            		param:{
	            			uuid:'1234',
	            			bizOrderId:tid
	            		},
	            		error : function(msg, cmd, param) {
	            			alert(JSON.stringify(msg))
	            		},
	            		success : function(rsp, cmd, param) {
	            			alert(JSON.stringify(rsp))
	            		}
	            	});
	            }
		 }
	});
}
function torefundaaaa(text,tid){

	/*alert(tid);*/
	

	
}
function getmessage(refund_id){

	QN.top.invoke({
		"cmd": "taobao.refund.messages.get",
		"param": {fields:'content,owner_role,created,pic_urls',refund_id:refund_id},
		"method": "get",
		"success": function (rsp){
                if(typeof rsp === 'string'){
                   rsp = JSON.parse(rsp);
                    }
                if(rsp.code!=null){
                    alert(JSON.stringify(rsp));
                }else{
                	 var datas={};  
                	 $("#rememo").empty();         	 
                     for(i in rsp.refund_messages_get_response.refund_messages.refund_message){
                         var message=rsp.refund_messages_get_response.refund_messages.refund_message[i];
                        
                         if(message.owner_role=='1'){
                        	 datas.owner_role=true;/*买家1*/
                         }else if(message.owner_role=='2'){
                        	 datas.owner_role=false;/*卖家2*/
                         }
                         datas.tid=i;
                         datas.content=message.content;/*留言内容*/
                         datas.created=message.created;/*留言时间*/

                         var source = $("#rememo_template").html();

                         var template = Handlebars.compile(source);
                         var htmlstr = template(datas);
                         $("#rememo").append(htmlstr).trigger('create');

                          if(message.pic_urls==null){
                           }else{
                            	 for(index in message.pic_urls.pic_url){
                                     var pic=message.pic_urls.pic_url[index];
                                     datas.pic_path=pic.url;
                                     var source = $("#repic_template").html();

                                     var template = Handlebars.compile(source);
                                     var htmlstr = template(datas);
                                     $("#repic"+datas.tid).append(htmlstr).trigger('create');
                                 }
                            }
                            $('#refundpop').popup("open");
                 }
                }
		},
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			     /*   alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }

                   		       	
	 });	
}
function torefuse(refund_id,tid,oid){
	gnum=refund_id;
	mytid=tid;
	wz=oid;
	$('#refundpop').popup("close");
	 setTimeout(function(){
			$('#refusepop').popup("open");
	 },100);
	
}
function torememo(refund_id){
	mytid=refund_id;
	$('#refundpop').popup("close");
	 setTimeout(function(){
			$('#rememopop').popup("open");
	 },100);
}
/******************************发表留言页面************************************/
function addmemo(){
	$('#rememopop').popup("close");
	var data = $("#messagetxt").val();
	data=clearBr(data);
	if(data==""){
		alert("添加留言失败，留言内容不能为空!");
	}else if(data.length>200){
		alert("添加留言失败，留言内容不能超过200个字!",5000);
	}else{
		QN.top.invoke({
			"cmd": "taobao.refund.message.add",
			"param": {refund_id:mytid,content:data},
			"method": "get",
			"success": function (rsp){	     
	                if(typeof rsp === 'string'){
	                    rsp = JSON.parse(rsp);
	                }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
	                $("#messagetxt").val('');
                	alert("发表成功！");
                	getmessage(tid);
	                }
                	
                },
    			"error": function (msg) {
    				if(msg.sub_code=='subuser.has-no-permission'){
    				      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
    				    }else{
    				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
    				    }
    			    }
                
                   		       	
	 });	
	}
}
function refusememo(){
	/*var textContent ='';
	if(refuse=='one'){
        var files = document.getElementById('file').files;
        var file = files[0];
        var readers = new FileReader();
        readers.readAsDataURL(file);
        readers.onloadend = function(evt) {
                 textContent = evt.target.result;
        };
	}*/
	var data = $("#refusetxt").val();
	data=clearBr(data);
	if(data==""){
		alert("拒绝退款申请失败,说明内容不能为空");
	}else if(data.length>200){
		alert("拒绝退款申请失败,说明内容不能超过200个字",5000);
	}else if(refuse=='big'){
		alert('图片不能大于130000字节');
	}else{

		QN.top.invoke({
			"cmd": "taobao.refund.refuse",
			"param": {refund_id:gnum,refuse_message:data,tid:mytid,oid:wz,refuse_proof:mypicdata},
			"method": "post",
			"success": function (rsp){	   
                if(typeof rsp === 'string'){
                    rsp = JSON.parse(rsp);
                    }
                if(rsp.code!=null){
                    alert(JSON.stringify(rsp));
                }else{
                $('#refusepop').popup("close");
                showlist(mytid,gstas);
                     alert('操作成功!');
                }
			},
			"error": function (msg) {
				if(msg.sub_code=='subuser.has-no-permission'){
				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
				    }else{
				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{/*alert('操作失败，请重试');*/alert(JSON.stringify(msg));}
				    }
			    }
                   		       	
	 });	
	}
}
/*************************************************/
function copyaddr(text){
	text=decodeURI(text);
	/*if(vipuser==0){
		$("#showvippop").popup("open");
		return;
	}
	var text=$('#addrtext').text();*/

	text=text.split(',');
	var name='';
	var addr='';
	var zip='';
	var phone='';
	var connent='亲，请核对一下地址/:^_^';
	if(text.length==4){
		name=text[0];
		phone=text[1];
		addr=text[2];
		zip=text[3];
		connent='姓名：'+name+'\n电话：'+phone+'\n地址：'+addr+'\n邮编：'+zip+'\n'+connent;
	}else if(text.length==5){
		name=text[0];
		phone=text[1]+','+text[2];
		addr=text[3];
		zip=text[4];
		connent='姓名：'+name+'\n电话：'+phone+'\n地址：'+addr+'\n邮编：'+zip+'\n'+connent;
	}else if(text.length==3){
		name=text[0];
		phone='不需要联系方式';
		addr=text[1];
		zip=text[2];
		connent=name+'\n'+phone+'\n'+'订单信息:'+text+'\n'+zip+'\n'+connent;
	}else{
		var cont='';
		for(index in text){
			cont+=text[index]+'\n';
		}
		connent=cont+connent;
	}
	 QN.wangwang.invoke({
	        category: 'wangwang', 
	        cmd: 'insertText2Inputbox',
	        param: {'uid':chatnick,'text':connent,'type':0},
	        success: function (rsp) {
	            if(typeof rsp==='string'){
	           	rsp = JSON.parse(rsp);
	        }
	            if(rsp.code!=null){
	                alert(JSON.stringify(rsp));
	            }else{
	   	    	$("#addrpop").popup("close");
		    	$("#sendaddrpop").popup("close");
		    	alert('发送成功！');
	            }
	        },
			"error": function (msg) {
				if(msg.sub_code=='subuser.has-no-permission'){
				      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
				    }else{
				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert(JSON.stringify(msg));}
				    }
			    }
	    });
	 return;
    QN.wangwang.invoke({
        category: 'wangwang',
        cmd:'getActiveUser',
        param: {},
        success: function (rsp) {
            if(typeof rsp==='string'){
        	rsp = JSON.parse(rsp);
            }

	     	    
        },
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert(JSON.stringify(msg));}
			    }
		    }
    });
}



/********************************************************/
function copyww(text){
	if(text==null){
		text='';
	}
/*	var reqJson = { targetID: chatnick, msgContent:text};
	QN.wangwang.invoke({
	    cmd: 'sendMsg',
	    param: reqJson,
	    success: function (rsp) {
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            /*if(rsp.code!=null){
                alert(JSON.stringify(rsp))
            }else{
	    	$("#wwpop").popup("close");
	    	$("#wuliulog").popup("close");
	    	$("#bfwuliulog").popup("close");
	    	alert('发送成功！');
	    	
            };
	    	$("#wwpop").popup("close");
	    	$("#wuliulog").popup("close");
	    	$("#bfwuliulog").popup("close");
	    	alert('发送成功！');
	    },
	    error: function (msg) {
	       if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
	    }
	});*/
    QN.wangwang.invoke({
        category: 'wangwang',
        cmd:'getActiveUser',
        param: {},
        success: function (rsp) {
            if(typeof rsp==='string'){
        	rsp = JSON.parse(rsp);
            }
        	 QN.wangwang.invoke({
     	        category: 'wangwang', 
     	        cmd: 'insertText2Inputbox',
     	        param: {'uid':rsp.uid,'text':text,'type':0},
     	        success: function (rsp) {
     	            if(typeof rsp==='string'){
         	           	rsp = JSON.parse(rsp);
         	        }
     	            if(rsp.code!=null){
     	                alert(JSON.stringify(rsp));
     	            }else{
         	   	    	$("#wwpop").popup("close");
         		    	$("#wuliulog").popup("close");
         		    	$("#bfwuliulog").popup("close");
         		    	alert('发送成功！');
     	            }
     	        },
    			"error": function (msg) {
    				if(msg.sub_code=='subuser.has-no-permission'){
    				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
    				    }else{
    				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
    				    }
    			    }
     	    });
	     	    
        },
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }
    });
}


var flagcss;
var gpayment=0;/*总支付金额*/
var gpay=0;/*成交金额*/
var gclosepay=0;
var grefundpay=0;
var gnum=0;/*总订单*/
var gclosenum=0;
var grefundnum=0;
var pca,pcb,pcd;

function changed(){
	QN.event.regEvent({
		"eventId": "wangwang.active_contact_changed",
		"success": function(e){

		},
		"notify": function (rsp){
			rsp=JSON.parse(rsp);
			chatnick=rsp.newContact;
			chatnick=decodeURI(chatnick);
			var newnick=rsp.newContact.substring(8,rsp.newContact.length);
			newnick=decodeURI(newnick);
            tasknickr=newnick;
            $('#all').text('全部(0)');
	        $('#coll').text('未完(0)'); 
	        $('#succse').text('已完(0)'); 
	        $('#close').text('已关(0)');
			changepage(newnick);
		}
		});
	QN.event.regEvent({
		"eventId": "bench.trade_info",
		"success": function(e){

		},
		"notify": function (rsp){
			/*rsp=JSON.parse(rsp);
			var newnick=rsp.newContact.substring(8,rsp.newContact.length);
			newnick=decodeURI(newnick);
			changepage(newnick);*/
		    $("a[name='myshow']").removeClass("ui-btn-active ui-state-persist");
		    $("#othershow").addClass("ui-btn-active ui-state-persist");
			showlist(null,'coll');
		}
		});
}
var usertype
/******************************查询用户信息*************************************/
function userinfo(){
	/*refresh();*/
	QN.top.invoke({
		"cmd": "taobao.user.seller.get",
		"param": {fields:'type'},
		"method": "get",
		"success": function (resp){
				if(typeof resp==='string'){
					var rsp=JSON.parse(resp);
				}else{
					var rsp=resp;
				}
    	    		var user=rsp.user_seller_get_response.user;
    	    		usertype=user.type;
			},
			"error": function (msg) {
				if(msg.sub_code=='subuser.has-no-permission'){
				      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
				    }else{
				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
				    }
			    }
	}
	);
    QN.application.invoke({
        "cmd": "getVersion",
        "error" : function(msg) {
            /* alert(JSON.stringify(msp));*/
            onclicktid('price-table',tid);
        },
        "success" : function(e) {
            if(typeof  e=== 'string'){
                e = JSON.parse(e);
            }
            var versions=e.version.replace(/[.]/g,"");
            version=versions.replace(/[N]/g,"");
        }
    });
}
var gstas='';
var collnum=0;
var closenum=0;
var succsenum=0;
function showlist(coll,sta){
	gaddrs='';
	if(coll==null){
		if(sta=='all'){
			statis('wwall');
		}else if(sta=='coll'){
			statis('wwwait');
		}else if(sta=='succse'){
			statis('wwsucess');
		}else if(sta=='close'){
			statis('wwclose');
		}
		
	}
	gstas=sta;

	gpayment=0;/*总支付金额*/
	gpay=0;/*成交金额*/
	gclosepay=0;
	grefundpay=0;
	gnum=0;/*总订单*/
	gclosenum=0;
	grefundnum=0;

	$.mobile.loading( 'show' );
		/*QN.event.regEvent( {
			eventId : 'wangwang.active_contact_changed',
			success : function( eventId ) {
				alert(eventId);
				// 注册成功
			},
			error : function(msg, eventId) {
				// 注册失败
			},
			notify : function(data, eventId) {
				// 事件通知
			}
		});*/

		QN.top.invoke({
			"cmd": "taobao.trades.sold.get",
			"param": {
				"fields":"seller_rate,buyer_rate,cod_status,tid,status,title,end_time,pay_time,buyer_nick,post_fee,seller_nick,seller_rate,created,num,payment,pic_path,has_buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.refund_id,orders.adjust_fee,orders.oid,orders.price,orders.sku_properties_name,orders.status,orders.outer_sku_id,orders.outer_iid,orders.pic_path,orders.refund_status,orders.num_iid,orders.num,seller_flag,type",
				 "type":'tmall_i18n,fixed,auction,guarantee_trade,step,independent_simple_trade,independent_shop_trade,auto_delivery,ec,cod,game_equipment,shopex_trade,netcn_trade,external_trade,instant_trade,b2c_cod,hotel_trade,super_market_trade,super_market_cod_trade,taohua,waimai,nopaid,step,eticket',
				"page_no":'1',
				"buyer_nick":decodeURI(r),
				"page_size":'100'
				},
			"method": "get",
			"success": function (rsp){
				
				$.mobile.loading( 'hide' );
	            if(typeof  rsp=== 'string'){
	            	rsp = JSON.parse(rsp);
	            }

	            if(rsp.code!=null){
	            	alert(JSON.stringify(rsp));
	            }else{
				
		        var total_results=rsp.trades_sold_get_response.total_results;
		       
		    	collnum=0;
		    	closenum=0;
		    	succsenum=0;
		    	$('#dht').hide();
		    	$('#foot').hide();
		    	$("#mylist").empty();
		        if(total_results>0){
		        	var orders = rsp.trades_sold_get_response.trades.trade;
		        	/*console.log( JSON.stringify(orders.orders.order));*/		        	
		        	var myindex=0;        	


			        for(index in orders)
		            {		            	
		            	 var order = orders[index];		       	 	          	
		            	 var datas= {};
		            	 datas.bfsend=false;
		            	 
	                     switch (order.status)
	                     {
		                     case 'TRADE_NO_CREATE_PAY':{
	                             datas.stacla='ddztcheng';	
	                             datas.titleinfoQ= '点击发送到聊天窗口，你可以在设置里添加自定义催付内容 ！';                            
	                             datas.status = '待付款';
	                             datas.addrs='收货地址';
	                             datas.addr="toaddr";
	                             datas.but1="旺旺催付";
	                             datas.fun1="toww";	                            
	                             datas.css1="display: block;";
	                             datas.css2=false;
	                             datas.css3=true;
	                             datas.isaddr=true;
	                             break;
	                             }
	                         case 'WAIT_BUYER_PAY':{ 
	                             datas.stacla='ddztcheng';
	                             datas.titleinfoQ= '点击发送到聊天窗口，你可以在设置里添加自定义催付内容 ！';
	                             datas.status = '待付款';
	                             datas.addrs='收货地址';
	                             datas.addr="toaddr";
	                             datas.but1="旺旺催付";
	                             datas.fun1="toww";
	                             datas.css1="display: block;";
	                             datas.css2=false;
	                             datas.css3=true;
	                             datas.isaddr=true;
	                             break;}
	                         case 'WAIT_SELLER_SEND_GOODS':{
                         		if(order.type=='cod'){
                           			if(order.cod_status=='NEW_CREATED'||order.cod_status=='TAKEN_IN_FAILED'){
                                		 datas.stacla='ddztlan';
            	                         	datas.status = '待发货';
            	                         	datas.addrs='修改地址';
            	                         	datas.addr="toupaddr";
            	                         	datas.but1="　发货　";
            	                         	datas.theme="e";
            	                         	datas.fun1="tocodsend";
            	                         	datas.css1="display: none;";
            	                          datas.css2=false;
            	                            datas.css3=true;
            	                            datas.css4=true;
            	                            datas.isaddr=true;
                           			}else{
                                  		 datas.stacla='ddztlan';
          	                         	datas.status = '待发货';
    	                             	datas.css1="display:none;";
    	                                datas.css2=false;
    	                                datas.css3=true;
    	                                datas.css4=true;
    	                                datas.addrs='修改地址';
        	                         	datas.addr="toupaddr";
    	                                datas.but1="跟踪物流";
    	                                datas.fun1="towl";
    	                                datas.isaddr=true;

                           			}
                           		}else{
                              		 datas.stacla='ddztlan';
      	                         	datas.status = '待发货';
      	                         	datas.addrs='修改地址';
      	                         	datas.addr="toupaddr";
      	                         	datas.but1="　发货　";
      	                         	datas.theme="e";
      	                         	datas.fun1="tosend";
      	                         	datas.css1="display: none;";
      	                            datas.css2=false;
        	                        datas.css4=true;
      	                            datas.css3=true;
      	                            datas.isaddr=true;
                           		}
		                        
	                         			break;}
	                         case 'WAIT_BUYER_CONFIRM_GOODS':{datas.stacla='ddztqing';
	                         	datas.status = '已发货';
	                         	datas.addrs='延长收货时间';
	                         	datas.addr="towltime";
	                         	datas.but1="跟踪物流";
	                         	datas.fun1="towl";
	                         	datas.css1="display:none;";
	                         	datas.css2=false;
	                            datas.css3=true;
	                            datas.css4=true;
	                            datas.isaddr=true;
	                         	break;}
	                         case 'TRADE_FINISHED':{
	                        	 gpay=parseFloat(gpay)+parseFloat(order.payment);
	                        	 gnum++;
	                        	 if(order.buyer_rate==false){
	                        	 	datas.issuccess=true;
	                        	 }
	                        	 if(order.buyer_rate==true && order.seller_rate == true)
		 							{
		 								datas.pjtype="评价状态：双方已评";
		 							}else if(order.buyer_rate==true && order.seller_rate == false)
			 							{
			 							datas.pjtype="评价状态：买家已评";
			 							}else if(order.buyer_rate==false && order.seller_rate == true){
			 								datas.pjtype="评价状态：我已评价";
				 						}else{datas.pjtype="评价状态：双方未评";}

	                        		 showmemo();/*加载买家评价*/
		                             if(datetime_to_unix(order.end_time) > datetime_to_unix(GetDateStr(-15))&&order.seller_rate==false){
	                                 datas.stacla='ddztzi';
	                                 datas.status = '待评价';
	                               	datas.addrs='　评价　';
	                             	datas.theme="e";
	                             	datas.addr="torate";
	                                 datas.but1="跟踪物流";
	                               	datas.fun1="towl";
	                               	datas.css1="display:none;";
	                                datas.css2=false;
	                                datas.css3=true;
	                                datas.css4=true;
	                                datas.isaddr=true;
	                                 break;
	                             }else{
	                                 datas.stacla='ddztlv';
	                                 datas.status = '已成功';
	                             	datas.css1="display:none;";
	                                datas.css2=false;
	                                datas.css3=true;
	                                datas.but1="跟踪物流";
	                                datas.fun1="towl";
	                                datas.isaddr=true;
	                                 break;
	                             }	  
	                         }
	                         case 'TRADE_CLOSED':{ datas.stacla='ddzthui';
	                         		gclosenum++;
	                        		gclosepay=parseFloat(gclosepay)+parseFloat(order.payment);
	                         		datas.status = '已关闭';
	                             	datas.css1="display:none;";
	                                datas.css2=false;
	                                datas.css3=false;
	                                datas.isaddr=true;
	                        		 break;
	                         }
	                         case 'TRADE_BUYER_SIGNED':{
	                             datas.stacla='ddztlan';
	                             datas.status='已签收';
	                           	datas.css1="display:none;";
	                            datas.css2=false;
	                            datas.css3=true;
	                            datas.but1="跟踪物流";
	                            datas.fun1="towl";
	                            datas.isaddr=true;
	                             break;
	                         }
	                         case 'SELLER_CONSIGNED_PART':{
	                             datas.stacla='ddztlan';
	                             datas.status='部分发货';
	                           	datas.addrs='延长收货时间';
	                         	datas.addr="towltime";
	                         	datas.but1="跟踪物流";
	                         	datas.fun1="towl";
	                         	datas.css1="display:none;";
	                         	datas.bfsend=true;
	                         	datas.css2=false;
		                        datas.css4=true;
	                            datas.css3=true;
	                            datas.isaddr=true;
	                            break;
	                         }
	                         case 'TRADE_CLOSED_BY_TAOBAO':{
	                             gclosenum++;
	                             gclosepay=parseFloat(gclosepay)+parseFloat(order.payment);
	                             datas.stacla='ddzthui';
	                             datas.status = '已关闭';
	                           	datas.css1="display:none;";
	                            datas.css2=false;
	                            datas.css3=false;
	                            datas.isaddr=true;
	                             break;}
	                     }
		                    if(datas.status!='已成功'&&datas.status!='已关闭'){
			                    collnum++;
		                    }else if(datas.status=='已关闭'){
		                    	closenum++;
		                    }else if(datas.status=='已成功'){
			                    succsenum++;
		                    }
	                    if((sta!='close'&&sta!='succse'&&datas.status!='已成功'&&datas.status!='已关闭')||sta=='all'||(sta=='close'&&datas.status=='已关闭')||(sta=='succse'&&datas.status=='已成功')){
	                     for(var j in order.orders.order){
	                    	 var orderx=order.orders.order[j];
	                         if(orderx.refund_status!=null&&orderx.refund_status!='NO_REFUND'&&orderx.refund_status!='CLOSED'&&orderx.refund_status!='SUCCESS'){
	                             if(datas.status=='待发货'){
	                            	 grefundnum++;
	                          		grefundpay=parseFloat(grefundpay)+parseFloat(order.payment);
	                                 datas.stacla='ddzthong';
	                                 datas.status = '退款中';
	                               	datas.addrs='退款信息';
	                             	datas.addr="torefund";
	                             	datas.css1="display: none;";
      	                         	datas.but1="　发货　";
      	                         	datas.theme="e";
	                                datas.css2=true;
	                                datas.css3=true;
	                                datas.css4=false;
	                                datas.isaddr=true;
	                                 datas.tkzz=true;
	                             }
	                             if(datas.status=='已发货'){
	                            	 grefundnum++;
	                            	 grefundpay=parseFloat(grefundpay)+parseFloat(order.payment);
	                                 datas.stacla='ddzthong';datas.status = '退款中';
	                               	datas.addrs='退款信息';
	                             	datas.addr="torefund";
	                             	datas.but1="跟踪物流";
	                             	datas.fun1="towl";
	                             	datas.css1="display:none;";
	                                datas.css2=true;
	                                datas.css3=true;
	                                datas.css4=false;
	                                datas.isaddr=true;
	                                 datas.tkzz=true;
	                             }
	                         }

	                         

	                     }

	                     datas.tid = order.tid;
		            	/* if(coll==null||coll=='coll'){
			            	 if(myindex==0){
				            	 datas.falses="data-collapsed";
			            	 }else{
			            		 datas.falses="";
			            	 }
		            	 }else{
			            	 if(datas.tid==coll){
				            	 datas.falses="data-collapsed";
			            	 }else{
			            		 datas.falses="";
			            	 }
		            	 }*/
		            	 myindex++;
	                     datas.seller_nick=order.seller_nick;
	                     datas.buyer_nick = order.buyer_nick;
	                     var created = new  Date(Date.parse(order.created.replace(/-/g,"/")));
	                     datas.created = created.format();
	                     if(order.pay_time!=null&&order.pay_time!=''){
	                     	var pay_time = new  Date(Date.parse(order.pay_time.replace(/-/g,"/")));
	                     	datas.pay_time=pay_time.format();
	                     	datas.dispay="block";
	                     }else{
	                    	 datas.dispay="none;";
	                     }
	                     if(order.end_time!=null&&order.end_time!=''){
	                     	var end_time = new  Date(Date.parse(order.end_time.replace(/-/g,"/")));
	                     	datas.end_time=end_time.format();
	                     	if(datas.status!='已成功'&&datas.status!='已关闭'){
		                     	datas.endname="确认时间";
	                     	}else if(datas.status=='已成功'){
	                     		datas.endname="成功时间";
	                     	}else{
	                     		datas.endname="关闭时间";
	                     	}
	                     	datas.disend="block";
	                     }else{
	                    	 datas.disend="none;";
	                     }
	                     datas.num=0;
	                     datas.payment = order.payment;
	                 /*    if(datas.status!='待付款'){
	                     	gpayment=parseFloat(gpayment)+parseFloat(order.payment);
	                     }else{
	                         gnum--;
	                     }
	                */
	                     datas.post_fee=order.post_fee;

	                     if(order.type=='cod'){/*货到付款*/
	                         datas.type=true;
	                     }else{
	                         datas.type=false;
	                     }

	                     if(order.seller_flag==0){
	                         datas.seller_flag='0';
	                     }
	                     if(order.seller_flag==1){
	                         datas.seller_flag='1';
	                     }
	                     if(order.seller_flag==2){
	                         datas.seller_flag='2';
	                     }
	                     if(order.seller_flag==3){
	                         datas.seller_flag='3';
	                     }
	                     if(order.seller_flag==4){
	                         datas.seller_flag='4';
	                     }
	                     if(order.seller_flag==5){
	                         datas.seller_flag='5';
	                     }/*备注旗帜*/
	                     flagcss='bw_'+datas.seller_flag;
	                     datas.text='';
	                     datas.texts_title='收货人信息（点击转发）\n';
	                     if(order.receiver_name!=''&&order.receiver_name!=null){
	                    	 datas.name=order.receiver_name;
	                    	 datas.text+=datas.name+',';
	                    	 datas.isname=true;
	                    	 datas.texts_title+='姓名：'+datas.name+'\n';
	                     }else{
	                         datas.isname=false;
	                         
	                     }
	                     if(order.receiver_phone!=''&&order.receiver_phone!=null){
	                         datas.phone=order.receiver_phone;
	                         datas.text+=datas.phone+',';
	                         datas.isphone=true;
	                         datas.texts_title+='电话：'+datas.phone+'\n';
	                         }else{
	                             datas.isphone=false;
	                             
	                         }
	                     if(order.receiver_mobile!=''&&order.receiver_mobile!=null){
	                         datas.mobile=order.receiver_mobile;
	                         datas.text+=datas.mobile+',';
	                         datas.ismobile=true;
	                         datas.texts_title+='手机：'+datas.mobile+'\n';
	                         }else{
	                             datas.ismobile=false;
	                             
	                         }
	                     if(order.receiver_state!=''&&order.receiver_state!=null){
	                         datas.state=order.receiver_state;

	                         datas.text+=datas.state+' ';
	                         datas.isstate=true;
	                         datas.texts_title+='地址：'+datas.state+'　';
	                         datas.state=datas.state.substring(0,2);
	                         if(datas.state=='黑龙'){
	                        	 datas.state='黑龙江';
	                         }
	                         }else{
	                             datas.isstate=false;
	                             
	                             
	                         }
	                     if(order.receiver_city!=''&&order.receiver_city!=null){
	                         datas.city=order.receiver_city;

	                         datas.text+=datas.city+' ';
	                         datas.texts_title+=datas.city+'　';
	                         datas.iscity=true;
	                         }else{
	                             datas.iscity=false;
	                             
	                         }
	                     if(order.receiver_district!=''&&order.receiver_district!=null){

	                         datas.district=order.receiver_district;
	                         datas.text+=datas.district+' ';
	                         datas.texts_title+=datas.district+'　';
	                         datas.isdistrict=true;
	                         }else{
	                             datas.isdistrict=false;
	                             
	                         }
	                     if(order.receiver_address!=''&&order.receiver_address!=null){
	                         datas.address=order.receiver_address;
	                         datas.text+=datas.address+',';
	                         datas.texts_title+=datas.address+'\n';
	                         datas.isaddress=true;
	                         }else{
	                             datas.isaddress=false;
	                             
	                         }
	                     if(order.receiver_zip!=''&&order.receiver_zip!=null){
	                         datas.zip=order.receiver_zip;
	                         datas.text+=datas.zip;
	                         datas.iszip=true;
	                         datas.texts_title+='邮编：'+datas.zip+'\n';
	                         }else{
	                             datas.iszip=false;
	                         }
	                     datas.texts=datas.text;
	                     if(gaddrs.length<3){
	                     	gaddrs=datas.texts;
	                     	}
	                     datas.texts=encodeURI(datas.texts);
	                    
	                     if(datas.status=="待付款"){
	                         datas.seller_nick=order.title;
	                         datas.isseller_nick=order.seller_nick;
	                     }
	                     if(datas.status =='已发货'||datas.status =='待评价'||datas.status == '已成功'){
	                         datas.text=datas.tid;
	                         datas.name=datas.status;
	                     }
	                     if(datas.status=='部分发货'){
	                    	 datas.name="已发货";
	                     }
								
	                     for(var n in order.orders.order){
	                    	 var orderx=order.orders.order[n];	
									var ss=order.orders.order[n].refund_id;
									if(ss!=undefined){datas.refunid=ss;}
		                     }
	                    
	                   /* console.log(datas.created+"   644");*/
							
			               var source = $("#list_template").html();

	                       var template=Handlebars.compile(source);


	                       var htmlstr = template(datas);

	                       $("#mylist").append(htmlstr).trigger('create');

	                       for(var n in order.orders.order){
	                           var orderx=order.orders.order[n];
	                           datas.outer_sku_id=order.orders.order[n].outer_sku_id;
	                           if(datas.outer_sku_id==''||datas.outer_sku_id==null){
	                               datas.outer_sku_id=order.orders.order[n].outer_iid;
	                           }
	                           datas.title = order.orders.order[n].title;
	                           if(getLength(datas.title)>46){
	                        	   datas.title=datas.title.substring(0,21)+'…';
	                           }
	                           if(order.orders.order[n].adjust_fee!=null&&order.orders.order[n].adjust_fee!=''&&order.orders.order[n].adjust_fee!=0.00){
	                        	   datas.adjust_fee=order.orders.order[n].adjust_fee;
	                           }else{
	                        	   datas.adjustshow='display:none;';
	                           }
	                           datas.oid=order.orders.order[n].oid;
	                           datas.titles=order.orders.order[n].title;
	                           datas.pic_path = order.orders.order[n].pic_path;
	                           datas.price=order.orders.order[n].price;
	                           datas.num=order.orders.order[n].num;
	                           datas.sku_properties_name=order.orders.order[n].sku_properties_name;
	            		       	 if(orderx.refund_status!=null&&orderx.refund_status!='NO_REFUND'){
	            		    		 switch(orderx.refund_status){
	            		  		 		case 'WAIT_SELLER_AGREE':{datas.refund_status='退款中';datas.tkzz=true;break;}
	            		  		 		case 'WAIT_BUYER_RETURN_GOODS':{datas.refund_status='退款中';datas.tkzz=true;break;}
	            		  		 		case 'WAIT_SELLER_CONFIRM_GOODS':{datas.refund_status='退款中';datas.tkzz=true;break;}
	            		  		 		case 'SELLER_REFUSE_BUYER':{datas.refund_status='已拒绝退款';datas.tkzz=true;break;}
	            							case 'CLOSED':{datas.refund_status='退款关闭';break;}
	            							case 'SUCCESS':{datas.refund_status='退款成功';break;}
	            					 	}
	            		    	 }else{
	            		        	 
	            		    		 switch(orderx.status){
	            				  	 case 'TRADE_NO_CREATE_PAY':{datas.refund_status='待付款';break;}
	            					 case 'WAIT_BUYER_PAY':{datas.refund_status='待付款';break;}
	            					 case 'WAIT_SELLER_SEND_GOODS':{datas.refund_status='待发货';datas.isupsku=true;break;}
	            					 case 'WAIT_BUYER_CONFIRM_GOODS':{datas.refund_status='已发货';break;}
	            					 case 'TRADE_BUYER_SIGNED':{datas.refund_status='已签收';break;}
	            					 case 'TRADE_FINISHED':{datas.refund_status='已成功';break;}
	            					 case 'TRADE_CLOSED_BY_TAOBAO':{datas.refund_status="已取消";break;}
	            					 case 'TRADE_CLOSED':{datas.refund_status="已取消";break;}
	            		    		 }
	            	
	            		    	 }
		            		       	datas.num_id=order.orders.order[n].num_iid;
	                           var source = $("#orderlist_template").html();
	                           
	                           var template=Handlebars.compile(source);


	                           var htmlstr = template(datas);

	                           $("#orderlist"+datas.tid).append(htmlstr).trigger('create');
	                       }
	                       getlist(datas.tid);
	                     }
	          
	     	 
		            }
			        $('#all').text('全部('+total_results+')'); 
			        $('#coll').text('未完('+collnum+')'); 
			        $('#succse').text('已完('+succsenum+')'); 
			        $('#close').text('已关('+closenum+')'); 
	/*
		            $('#gpay').text(gpay.toFixed(2));
		            $('#gclosepay').text(gclosepay.toFixed(2));
		            $('#grefundpay').text(grefundpay.toFixed(2));

			          
		            $('#gnum').text(gnum);
		            $('#gclosenum').text(gclosenum);
		            $('#grefundnum').text(grefundnum);*/
		            if(myindex==0){
			            $('#foot').show();
		            }else{
		            	$('#foot').hide();
		            }
		            $('#dht').show();
		        }else{
			        /**该买家没有订单*****/
		        	$('#dht').show();
		            $('#foot').show();
			        /*$('#mylist').append('<div class=\"kbts\" >当前用户三个月内没有订单数据！</div>');*/
		        }
	            }
			},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else if(msg.sub_code=='isv.invalid-parameter:buyer_nick'){
						    alert('该帐号为买家子帐号，无法查询到订单信息')
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_code);}else{alert('操作失败，请重试');}
					    }
				    }
			});

	}


function changepage(myr){
	gaddrs='';
	 $("#showvippop").popup("close");
	 $("#upskupop").popup("close");
	$("#closepop").popup("close");
	$("#uppostpop").popup("close");
	$("#showaddrpop").popup("close");
	$("#sendaddrpop").popup("close");
	$("#wwpop").popup("close");
	$("#uppricepop").popup("close");
	$("#sendpop").popup("close");
	$("#beiwpop").popup("close");
	
	$("#wltimepop").popup("close");
	$("#wuliulog").popup("close");
	$("#bfwuliulog").popup("close");
	$("#codsendpop").popup("close");
	$("#resendpop").popup("close");
	$("#ratepop").popup("close");
	$("#upaddrpop").popup("close");
	$("#refundpop").popup("close");
	$("#rememopop").popup("close");
	$("#refusepop").popup("close");
	$("#postfreepop").popup("close");
	$("#addrpop").popup("close");
	r=decodeURI(myr);
    $("a[name='myshow']").removeClass("ui-btn-active ui-state-persist");
    $("#othershow").addClass("ui-btn-active ui-state-persist");
	$.mobile.loading( 'show' );
	gpayment=0;/*总支付金额*/
	gpay=0;/*成交金额*/
	gclosepay=0;
	grefundpay=0;
	gnum=0;/*总订单*/
	gclosenum=0;
	grefundnum=0;
	QN.top.invoke({
		"cmd": "taobao.trades.sold.get",
		"param": {"fields":"tid,status,title,end_time,pay_time,buyer_nick,post_fee,seller_nick,seller_rate,created,num,payment,pic_path,has_buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.num_iid,orders.price,orders.sku_properties_name,orders.status,orders.outer_sku_id,orders.oid,orders.outer_iid,orders.pic_path,orders.adjust_fee,orders.refund_status,orders.num,seller_flag,type,orders.refund_id",
			 "type":'tmall_i18n,fixed,auction,guarantee_trade,step,independent_simple_trade,independent_shop_trade,auto_delivery,ec,cod,game_equipment,shopex_trade,netcn_trade,external_trade,instant_trade,b2c_cod,hotel_trade,super_market_trade,super_market_cod_trade,taohua,waimai,nopaid,step,eticket',
			"page_no":'1',"buyer_nick":r,"page_size":'100'},
		"method": "get",
		"success": function (rsp){
			$.mobile.loading( 'hide' );
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
			
	        var total_results=rsp.trades_sold_get_response.total_results;
	    	collnum=0;
	    	closenum=0;
	    	succsenum=0;
        	$("#mylist").empty();
        	$('#nick').text(r);
        	$('#dht').hide();
            $('#foot').hide();
	        if(total_results>0){
	        	var orders = rsp.trades_sold_get_response.trades.trade;
	        	var myindex=0;	
	            for(index in orders)
	            {

	            	

	            	 var order = orders[index];
	            	 var datas= {};
	            	 datas.bfsend=false;
                     switch (order.status)
                     {

                     case 'TRADE_NO_CREATE_PAY':{
                         datas.stacla='ddztcheng';
                         datas.status = '待付款';
                         datas.addrs='收货地址';
                         datas.addr="toaddr";
                         datas.but1="旺旺催付";
                         datas.fun1="toww";
                         datas.css1="display: block;";
                         datas.css2=false;
                         datas.css3=true;
                         datas.isaddr=true;
                         break;
                         }
                         case 'WAIT_BUYER_PAY':{ 
                             datas.stacla='ddztcheng';
                             datas.status = '待付款';
                             datas.addrs='收货地址';
                             datas.addr="toaddr";
                             datas.but1="旺旺催付";
                             datas.fun1="toww";
                             datas.css1="display: block;";
                             datas.css2=false;
                             datas.css3=true;
                             datas.isaddr=true;
                             break;
                             }
                         case 'WAIT_SELLER_SEND_GOODS':{
                       		if(order.type=='cod'){
                       			if(order.cod_status=='NEW_CREATED'||order.cod_status=='TAKEN_IN_FAILED'){
                            		 datas.stacla='ddztlan';
        	                         	datas.status = '待发货';
        	                         	datas.addrs='修改地址';
        	                         	datas.addr="toupaddr";
        	                         	datas.but1="　发货　";
        	                         	datas.theme="e";
        	                         	datas.fun1="tocodsend";
        	                         	datas.css1="display: none;";
        	                            datas.css2=false;
        	                            datas.css3=true;
        	                            datas.css4=true;
        	                            datas.isaddr=true;
                       			}else{
                              		 datas.stacla='ddztlan';
      	                         	datas.status = '待发货';
	                             	datas.css1="display:none;";
	                            	datas.addrs='修改地址';
    	                         	datas.addr="toupaddr";
	                                datas.css2=false;
	                                datas.css3=true;
	                                datas.css4=true;
	                                datas.but1="跟踪物流";
	                                datas.fun1="towl";
	                                datas.isaddr=true;

                       			}
                       		}else{
                          		 datas.stacla='ddztlan';
  	                         	datas.status = '待发货';
  	                         	datas.addrs='修改地址';
  	                         	datas.addr="toupaddr";
  	                         	datas.but1="　发货　";
  	                         	datas.theme="e";
  	                         	datas.fun1="tosend";
  	                         	datas.css1="display: none;";
  	                            datas.css2=false;
  	                            datas.css3=true;
    	                         datas.css4=true;
  	                            datas.isaddr=true;
                       		}
                         			break;}
                         case 'WAIT_BUYER_CONFIRM_GOODS':{datas.stacla='ddztqing';
                         	datas.status = '已发货';
                         	datas.addrs='延长收货时间';
                         	datas.addr="towltime";
                         	datas.but1="跟踪物流";
                         	datas.fun1="towl";
                         	datas.css1="display:none;";
                            datas.css2=false;
                            datas.css4=true;
                            datas.css3=true;
                            datas.isaddr=true;
                         	break;}
                         case 'TRADE_FINISHED':{
                        	 gpay=parseFloat(gpay)+parseFloat(order.payment);
                        	 gnum++;
                             if(datetime_to_unix(order.end_time) > datetime_to_unix(GetDateStr(-15))&&order.seller_rate==false){
                                 datas.stacla='ddztzi';
                                 datas.status = '待评价';
                               	datas.addrs='　评价　';
                             	datas.theme="e";
                             	datas.addr="torate";
                                 datas.but1="跟踪物流";
                               	datas.fun1="towl";
                               	datas.css1="display:none;";
                                datas.css2=false;
                                datas.css3=true;
                                datas.css4=true;
                                datas.isaddr=true;
                                 break;
                             }else{
                                 datas.stacla='ddztlv';
                                 datas.status = '已成功';
                             	datas.css1="display:none;";
                                datas.css2=false;
                                datas.css3=true;
                                datas.but1="跟踪物流";
                                datas.fun1="towl";
                                datas.isaddr=true;
                                
                                 break;
                             }
                         }
                         case 'TRADE_CLOSED':{ datas.stacla='ddzthui';
                         		gclosenum++;
                        		gclosepay=parseFloat(gclosepay)+parseFloat(order.payment);
                         		datas.status = '已关闭';
                             	datas.css1="display:none;";
                                datas.css2=false;
                                datas.css3=false;
                                datas.isaddr=true;
                        		 break;
                         }
                         case 'SELLER_CONSIGNED_PART':{
                             datas.stacla='ddztlan';
                             datas.status='部分发货';
                           	datas.addrs='延长收货时间';
                         	datas.addr="towltime";
                         	datas.but1="跟踪物流";
                         	datas.fun1="towl";
                         	datas.css1="display:none;";
                         	datas.bfsend=true;
                        	datas.css2=false;
                            datas.css4=true;
                            datas.css3=true;
                            datas.isaddr=true;
                            break;
                         }
                         case 'TRADE_BUYER_SIGNED':{
                             datas.stacla='ddztlan';
                             datas.status='已签收';
                           	datas.css1="display:none;";
                            datas.css2=false;
                            datas.css3=true;
                            datas.but1="跟踪物流";
                            datas.fun1="towl";
                            datas.isaddr=true;
                             break;
                         }
                         case 'TRADE_CLOSED_BY_TAOBAO':{
                             gclosenum++;
                             gclosepay=parseFloat(gclosepay)+parseFloat(order.payment);
                             datas.stacla='ddzthui';
                             datas.status = '已关闭';
                           	datas.css1="display:none;";
                            datas.css2=false;
                            datas.css3=false;
                            datas.isaddr=true;
                             break;}
                     }
	                    if(datas.status!='已成功'&&datas.status!='已关闭'){
		                    collnum++;
	                    }else if(datas.status=='已关闭'){
	                    	closenum++;
	                    }else if(datas.status=='已成功'){
		                    succsenum++;
	                    }
                     if(datas.status!='已成功'&&datas.status!='已关闭'){
                     for(var j in order.orders.order){
                    	 var orderx=order.orders.order[j];
                         if(orderx.refund_status!=null&&orderx.refund_status!='NO_REFUND'&&orderx.refund_status!='CLOSED'&&orderx.refund_status!='SUCCESS'){
                             if(datas.status=='待发货'){
                            	 grefundnum++;
                          		grefundpay=parseFloat(grefundpay)+parseFloat(order.payment);
                                 datas.stacla='ddzthong';datas.status = '退款中';
                               	datas.addrs='退款信息';
                             	datas.theme="e";
                             	datas.addr="torefund";
                             	datas.css1="display: none;";
  	                         	datas.but1="　发货　";
  	                         	datas.theme="e";
                                datas.css2=true;
                                datas.css3=true;
                                datas.css4=false;
                                datas.isaddr=true;
                                 datas.tkzz=true;
                             }
                             if(datas.status=='已发货'){
                            	 grefundnum++;
                            	 grefundpay=parseFloat(grefundpay)+parseFloat(order.payment);
                                 datas.stacla='ddzthong';datas.status = '退款中';
                               	datas.addrs='退款信息';
                             	datas.theme="e";
                             	datas.addr="torefund";
                             	datas.but1="跟踪物流";
                             	datas.fun1="towl";
                             	datas.css1="display:none;";
                                datas.css2=true;
                                datas.css3=true;
                                datas.css4=false;
                                datas.isaddr=true;
                                 datas.tkzz=true;
                             }
                         }

                     }
	            	/* if(myindex==0){
		            	 datas.falses="data-collapsed";
	            	 }else{
	            		 datas.falses="";
	            	 }*/
	            	 myindex++;
                     datas.tid = order.tid;
                     datas.seller_nick=order.seller_nick;
                     datas.buyer_nick = order.buyer_nick;
                     var created = new  Date(Date.parse(order.created.replace(/-/g,"/")));
                     datas.created = created.format();
                     if(order.pay_time!=null&&order.pay_time!=''){
	                     	var pay_time = new  Date(Date.parse(order.pay_time.replace(/-/g,"/")));
	                     	datas.pay_time=pay_time.format();
	                     	datas.dispay="block";
	                     }else{
	                    	 datas.dispay="none;";
	                     }
	                     if(order.end_time!=null&&order.end_time!=''){
	                     	var end_time = new  Date(Date.parse(order.end_time.replace(/-/g,"/")));
	                     	datas.end_time=end_time.format();
	                     	if(datas.status!='已成功'&&datas.status!='已关闭'){
		                     	datas.endname="确认时间";
	                     	}else if(datas.status=='已成功'){
	                     		datas.endname="成功时间";
	                     	}else{
	                     		datas.endname="关闭时间";
	                     	}
	                     	datas.disend="block";
	                     }else{
	                    	 datas.disend="none;";
	                     }
                     datas.num=0;
                     datas.payment = order.payment;
                 /*    if(datas.status!='待付款'){
                     	gpayment=parseFloat(gpayment)+parseFloat(order.payment);
                     }else{
                         gnum--;
                     }
                */
                     datas.post_fee=order.post_fee;

                     if(order.type=='cod'){/*货到付款*/
                         datas.type=true;
                     }else{
                         datas.type=false;
                     }

                     if(order.seller_flag==0){
                         datas.seller_flag='0';
                     }
                     if(order.seller_flag==1){
                         datas.seller_flag='1';
                     }
                     if(order.seller_flag==2){
                         datas.seller_flag='2';
                     }
                     if(order.seller_flag==3){
                         datas.seller_flag='3';
                     }
                     if(order.seller_flag==4){
                         datas.seller_flag='4';
                     }
                     if(order.seller_flag==5){
                         datas.seller_flag='5';
                     }/*备注旗帜*/
                     flagcss='bw_'+datas.seller_flag;
                     datas.text='';
                     datas.texts_title='收货人信息（点击转发）\n';
                     if(order.receiver_name!=''&&order.receiver_name!=null){
                    	 datas.name=order.receiver_name;
                    	 datas.text+=datas.name+',';
                    	 datas.isname=true;
                    	 datas.texts_title+='姓名：'+datas.name+'\n';
                     }else{
                         datas.isname=false;
                         
                     }
                     if(order.receiver_phone!=''&&order.receiver_phone!=null){
                         datas.phone=order.receiver_phone;
                         datas.text+=datas.phone+',';
                         datas.isphone=true;
                         datas.texts_title+='电话：'+datas.phone+'\n';
                         }else{
                             datas.isphone=false;
                             
                         }
                     if(order.receiver_mobile!=''&&order.receiver_mobile!=null){
                         datas.mobile=order.receiver_mobile;
                         datas.text+=datas.mobile+',';
                         datas.ismobile=true;
                         datas.texts_title+='手机：'+datas.mobile+'\n';
                         }else{
                             datas.ismobile=false;
                             
                         }
                     if(order.receiver_state!=''&&order.receiver_state!=null){
                         datas.state=order.receiver_state;

                         datas.text+=datas.state+' ';
                         datas.isstate=true;
                         datas.texts_title+='地址：'+datas.state+'　';
                         datas.state=datas.state.substring(0,2);
                         if(datas.state=='黑龙'){
                        	 datas.state='黑龙江';
                         }
                         }else{
                             datas.isstate=false;
                             
                             
                         }
                     if(order.receiver_city!=''&&order.receiver_city!=null){
                         datas.city=order.receiver_city;

                         datas.text+=datas.city+' ';
                         datas.texts_title+=datas.city+'　';
                         datas.iscity=true;
                         }else{
                             datas.iscity=false;
                             
                         }
                     if(order.receiver_district!=''&&order.receiver_district!=null){

                         datas.district=order.receiver_district;
                         datas.text+=datas.district+' ';
                         datas.texts_title+=datas.district+'　';
                         datas.isdistrict=true;
                         }else{
                             datas.isdistrict=false;
                             
                         }
                     if(order.receiver_address!=''&&order.receiver_address!=null){
                         datas.address=order.receiver_address;
                         datas.text+=datas.address+',';
                         datas.texts_title+=datas.address+'\n';
                         datas.isaddress=true;
                         }else{
                             datas.isaddress=false;
                             
                         }
                     if(order.receiver_zip!=''&&order.receiver_zip!=null){
                         datas.zip=order.receiver_zip;
                         datas.text+=datas.zip;
                         datas.iszip=true;
                         datas.texts_title+='邮编：'+datas.zip+'\n';
                         }else{
                             datas.iszip=false;
                         }
                     datas.texts=datas.text;
                     if(gaddrs.length<3){
                     	gaddrs=datas.texts;
                     }
                     
                     datas.texts=encodeURI(datas.texts);
                     if(datas.status=="待付款"){
                         datas.seller_nick=order.title;
                     }
                     if(datas.status =='已发货'||datas.status =='待评价'||datas.status == '已成功'){
                         datas.text=datas.tid;
                         datas.name=datas.status;
                     }
                     if(datas.status=='部分发货'){
                    	 datas.name="已发货";
                     }
						
                     for(var n in order.orders.order){
                    	 var orderx=order.orders.order[n];	
								var ss=order.orders.order[n].refund_id;
								if(ss!=undefined){datas.refunid=ss;}
	                     }
	                   var source = $("#list_template").html();

                       var template=Handlebars.compile(source);


                       var htmlstr = template(datas);

                       $("#mylist").append(htmlstr).trigger('create');

                       for(var n in order.orders.order){
                           var orderx=order.orders.order[n];
                           datas.outer_sku_id=order.orders.order[n].outer_sku_id;
                           if(datas.outer_sku_id==''||datas.outer_sku_id==null){
                               datas.outer_sku_id=order.orders.order[n].outer_iid;
                           }
                           datas.oid=order.orders.order[n].oid;
                           datas.title = order.orders.order[n].title;
                           if(getLength(datas.title)>46){
                        	   datas.title=datas.title.substring(0,21)+'…';
                           }
                           if(order.orders.order[n].adjust_fee!=null&&order.orders.order[n].adjust_fee!=''&&order.orders.order[n].adjust_fee!=0.00){
                        	   datas.adjust_fee=order.orders.order[n].adjust_fee;
                           }else{
                               datas.adjustshow='display:none;';
                           }
                           datas.titles=order.orders.order[n].title;
                           datas.pic_path = order.orders.order[n].pic_path;
                           datas.price=order.orders.order[n].price;
                           datas.num=order.orders.order[n].num;
                           datas.sku_properties_name=order.orders.order[n].sku_properties_name;
            		       	 if(orderx.refund_status!=null&&orderx.refund_status!='NO_REFUND'){
            		    		 switch(orderx.refund_status){
            		  		 		case 'WAIT_SELLER_AGREE':{datas.refund_status='退款中';datas.tkzz=true;break;}
            		  		 		case 'WAIT_BUYER_RETURN_GOODS':{datas.refund_status='退款中';datas.tkzz=true;break;}
            		  		 		case 'WAIT_SELLER_CONFIRM_GOODS':{datas.refund_status='退款中';datas.tkzz=true;break;}
            		  		 		case 'SELLER_REFUSE_BUYER':{datas.refund_status='已拒绝退款';datas.tkzz=true;break;}
            							case 'CLOSED':{datas.refund_status='退款关闭';break;}
            							case 'SUCCESS':{datas.refund_status='退款成功';break;}
            					 	}
            		    	 }else{
            		        	 
            		    		 switch(orderx.status){
            				  	 case 'TRADE_NO_CREATE_PAY':{datas.refund_status='待付款';break;}
            					 case 'WAIT_BUYER_PAY':{datas.refund_status='待付款';break;}
            					 case 'WAIT_SELLER_SEND_GOODS':{datas.refund_status='待发货';datas.isupsku=true;break;}
            					 case 'WAIT_BUYER_CONFIRM_GOODS':{datas.refund_status='已发货';break;}
            					 case 'TRADE_BUYER_SIGNED':{datas.refund_status='已签收';break;}
            					 case 'TRADE_FINISHED':{datas.refund_status='已成功';break;}
            					 case 'TRADE_CLOSED_BY_TAOBAO':{datas.refund_status="已取消";break;}
            					 case 'TRADE_CLOSED':{datas.refund_status="已取消";break;}
            		    		 }
            	
            		    	 }
            		    	 datas.num_id=order.orders.order[n].num_iid;
                           var source = $("#orderlist_template").html();
                           
                           var template=Handlebars.compile(source);


                           var htmlstr = template(datas);

                           $("#orderlist"+datas.tid).append(htmlstr).trigger('create');
                       }
                       getlist(datas.tid);
                     }
          
     	 
	            }
		        $('#all').text('全部('+total_results+')'); 
		        $('#coll').text('未完('+collnum+')'); 
		        $('#succse').text('已完('+succsenum+')'); 
		        $('#close').text('已关('+closenum+')'); 
/*
	            $('#gpay').text(gpay.toFixed(2));
	            $('#gclosepay').text(gclosepay.toFixed(2));
	            $('#grefundpay').text(grefundpay.toFixed(2));

	            $('#gnum').text(gnum);
	            $('#gclosenum').text(gclosenum);
	            $('#grefundnum').text(grefundnum);*/
	            $('#dht').show();
	            if(myindex==0){
		            $('#foot').show();
	            }else{
	            	$('#foot').hide();
	            }
	        }else{
		        /**该买家没有订单*****/
	        	$('#dht').hide();
	            $('#foot').show();
		       /* $('#mylist').append('<div class=\"kbts\"  >当前用户三个月内没有订单数据！</div>');*/
	        }
            }
		},
			"error": function (msg) {
				if(msg.sub_code=='subuser.has-no-permission'){
			       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else if(msg.sub_code=='isv.invalid-parameter:buyer_nick'){
				    alert('该帐号为买家子帐号，无法查询到订单信息')
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
			}
		});

}

var listid='';
var meta_ids='';/*任务元id*/
function getlist(tid){
	QN.top.invoke({
		"cmd": "taobao.trade.fullinfo.get",
		"param": {
			fields:"invoice_name,seller_memo,buyer_message,buyer_alipay_no,promotion_details,orders.oid",
			tid:tid
			},
		"method": "get",
		"success": function (rsp){
            if(version>=versionjr){
			QN.top.invoke({
				 "cmd": "taobao.qianniu.tasks.get",
				 "param": {"biz_ids":tid,"fields":"meta,content,gmt_create,receiver_nick,sender_uid,meta.id,memo,receiver_uid,status,id,sender_nick","need_meta":true},
				 "method": "get",
				 "success": function (e){
					 if(typeof  e=== 'string'){ 
			            	e = JSON.parse(e);
			            }
                     var datas={};
                     datas.taskis="";
                     var ismeta=0;
                     datas.taskis="";
                     datas.tid=tid;
                     var index=-1;
                     var myindex="";
                     var taskData;
				if(e.qianniu_tasks_get_response.tasks.q_task){
                    index=0;
                    datas.task="";
                    datas.isck="";
                    datas.iscyc="";
                    taskData=e.qianniu_tasks_get_response.tasks.q_task;
                    for(var i=0;i<taskData.length;i++){
                        if(taskData[i].status!=2&& ismeta==0){

                            ismeta=1;
                            datas.isck=1;
                            datas.dataid=taskData[i].meta.id;
                            index=i;
                        }
                        if(taskData[i].receiver_uid==uid&&taskData[i].status!=2 ){
                            index=i;
                            datas.dataid=taskData[i].meta.id;
                            datas.task=1;
                            datas.idTask=taskData[i].id;
                            switch (taskData[i].status){
                                case 0:
                                    datas.state="未处理";
                                    datas.statecss="ddztcheng";
                                    break;
                                case 1:
                                    datas.state="执行中";
                                    datas.statecss="ddztcheng";
                                    break;
                                case 3:
                                    datas.state="超时";
                                    datas.statecss="ddztcheng";
                                    break;
                                case 4:
                                    datas.state="取消";
                                    datas.statecss="ddztcheng";
                                    break;
                                case 5:
                                    datas.state="忽略";
                                    datas.statecss="ddztcheng";
                                    break;
                                case 6:
                                    datas.state="已转交";
                                    datas.statecss="ddztqing";
                                    break;
                            }
                            break;
                        }
                        if(taskData[i].sender_uid==uid&&taskData[i].status!=2 && taskData[i].status!=6){

                            if(datas.iscyc==""){
                                myindex=i;
                                datas.iscycid=taskData[i].meta.id;
                                datas.iscyc=1;
                                datas.idiscyc=taskData[i].id;
                                switch (taskData[i].status){
                                    case 0:
                                        datas.state="未处理";
                                        datas.statecss="ddztcheng";
                                        break;
                                    case 1:
                                        datas.state="执行中";
                                        datas.statecss="ddztcheng";
                                        break;
                                    case 3:
                                        datas.state="超时";
                                        datas.statecss="ddztcheng";
                                        break;
                                    case 4:
                                        datas.state="取消";
                                        datas.statecss="ddztcheng";
                                        break;
                                    case 5:
                                        datas.state="忽略";
                                        datas.statecss="ddztcheng";
                                        break;
                                }
                         }
                        }

                    }

				 }else{
                    datas.taskis="1";
				 }
                 if(ismeta==0){
                     datas.taskis="1";
                 }
                 if(datas.task==1){
                     datas.iscyc="";
                 }
                 if(datas.iscyc=="1"){
                     index=myindex;
                 }
                 if(datas.state=="已转交"){
                          datas.task="";
                 }
                 if(index!=-1){
                     var datass={};
                     datass.content=taskData[index].meta.content;
                     var num = 33;
                     datass.cons="";
                     if(datass.content.length > num){
                         datass.cons=1;
                         datass.contents="问题描述："+datass.content;
                         datass.content= datass.content.substring(0,num)+"...";
                     }
                     datass.statecontent="处理";
                     switch (taskData[index].status){
                         case 0:
                             datass.state="未处理";
                             datass.statecss="ddztcheng";
                             break;
                         case 1:
                             datass.state="执行中";
                             datass.statecss="ddztcheng";
                             break;
                         case 2:
                             datass.state="已完成";
                             datass.statecss="ddztlv";
                             break;
                         case 3:
                             datass.state="超时";
                             datass.statecss="ddztcheng";
                             break;
                         case 4:
                             datass.state="取消";
                             datass.statecss="ddztcheng";
                             break;
                         case 5:
                             datass.state="忽略";
                             datass.statecss="ddztcheng";
                             break;
                         case 6:
                             datass.state="已转交";
                             datass.statecontent="已转交";
                             datass.statecss="ddztqing";
                             break;
                     }
                     datass.sendnick=decodeURI(taskData[index].sender_nick);
                     datass.recnick=decodeURI(taskData[index].receiver_nick);
                     if(datass.sendnick.indexOf(":") >= 0){
                         datass.sendnick=datass.sendnick.split(":")[1];
                     }
                     if(datass.recnick.indexOf(":") >= 0){
                         datass.recnick=datass.recnick.split(":")[1];
                     }
                     datass.cjtime=taskData[index].gmt_create.substring(5);
                     datass.memo=taskData[index].memo;
                     if(datass.memo==undefined){
                         datass.memo="无";
                     }
                     var sources = $("#selerwslist_template").html();
                     var templates=Handlebars.compile(sources);
                     var htmlstrs = templates(datass);
                     $("#selerws"+tid).html("");
                     $("#selerws"+tid).append(htmlstrs).trigger('create');
                 }

                 var source = $("#addrwslist_template").html();
                 var template=Handlebars.compile(source);
                 var htmlstr = template(datas);
                 $("#addrws"+tid).html("");
                 $("#addrws"+tid).append(htmlstr).trigger('create');
				}
			 });

        }else{
                $("#versionpd"+tid).hide();

            }
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
				var trde=rsp.trade_fullinfo_get_response.trade;
				if(trde.seller_memo!=null && trde.seller_memo!='' && trde.seller_memo.replace(/(^\s*)/g, "")!=''){

					$('#flags'+tid).text(trde.seller_memo);
					
				}else{
					$('#flags'+tid).text('暂无备注');
				}

				if(trde.invoice_name!=null){
					$('#receipt'+tid).text(trde.invoice_name); 
					}else{
						$('#receipt'+tid).text('暂无发票');
					}
				if(trde.buyer_message!=null&&trde.buyer_message!=''){
					$('#memo'+tid).text(trde.buyer_message);
				}else{
					$('#memo'+tid).text("暂无留言");
				}
				if(trde.buyer_alipay_no!=null){
					$('#alipay'+tid).text(trde.buyer_alipay_no);
				}else{
					$('#alipay'+tid).text("帐号暂无");
				}

				if(trde.promotion_details!=null){
					for(index in trde.promotion_details.promotion_detail){
						var promotion=trde.promotion_details.promotion_detail[index];
						if(trde.promotion_details.promotion_detail.length==1){
							if(trde.orders.order.length==1){
								$('#promotion'+promotion.id).text(promotion.promotion_desc);
							}else{
								if(tid==promotion.id){
									$('#promotions'+promotion.id).html('　　　　　'+'<span style="color: red;">'+promotion.promotion_desc+'</span>');
								}else{
									$('#promotion'+promotion.id).text(promotion.promotion_desc);
								}
								
							}
						}else{
							if(tid==promotion.id){
								$('#promotions'+promotion.id).html('　　　　　'+'<span style="color: red;">'+promotion.promotion_desc+'</span>');
							}else{
								$('#promotion'+promotion.id).text(promotion.promotion_desc);
							}
							
						}
					}
				}else{

				}
            }
		},
		"error": function (msg) {

					if(msg.sub_code=='subuser.has-no-permission'){
			      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }
		});
}
function toalipay(tid){
	QN.top.invoke({
		"cmd": "taobao.trade.fullinfo.get",
		"param": {fields:"seller_nick,buyer_alipay_no",tid:tid},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
				var trde=rsp.trade_fullinfo_get_response.trade;
		        //var alipayev=encodeURI(alipayemail);
		        var urlval="https://lab.alipay.com/life/payment/fill.htm?taobaonick="+trde.seller_nick+"&optEmail="+trde.buyer_alipay_no;
		        window.open(urlval);
            }
		},
		"error": function (msg) {

					if(msg.sub_code=='subuser.has-no-permission'){
			       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }
		});
}

/*******一键免邮***********/
function updatepost(tid){
	mytid=tid;
	$("#postfreepop").popup("open");
				        		QN.application.invoke({
							 "cmd": 'getVersion',
							 "success": function (e){
								 if(typeof  e=== 'string'){
						            	e = JSON.parse(e);
						            }
						            
						            var version=e.version.replace(/[.]/g,"");
						            version=version.replace(/[N]/g,"");
						           /* if(version<10017){*/
							           /**
							           *撤销退款组件
							           */
							           if(version>=20301){
							           		
							           		QN.application.invoke( {

														cmd : 'getFocus',
														
														error : function(msg, cmd, param) {
														
														},
														
														success : function(rsp, cmd, param) {
														$('#actionpost').focus();
														
														}
														
													} );
							            }
							 }
						});
	

}
function postfree(){

	QN.top.invoke({
		"cmd": "taobao.trade.postage.update",
		"param": {tid:mytid,post_fee:'0'},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
			var price=$('#price'+mytid).text()-$('#post'+mytid).text();
			price=price.toFixed(2);
			$('#post'+mytid).text(0.00);
			$('#price'+mytid).text(price);
			alert("修改成功!");
			$("#postfreepop").popup("close");
			
			
            }
		
		},
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			     /*   alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
			    }
		    }
		});

	

}
var cdsend;
/******************************send************************************/
function showsendlist(tid)
{
	mytid=tid;
	$("#offtrade").find("option:selected").val(null);
	$("#off_other").empty();
	
	QN.top.invoke({
		"cmd": "taobao.trade.fullinfo.get",
		"param": {fields:'seller_nick,buyer_nick,orders.refund_id,pic_path,orders.pic_path,title,orders.title,orders.oid,orders.status,orders.num,orders.total_fee,orders.sku_properties_name,total_fee,payment,receiver_name,receiver_mobile,receiver_phone,receiver_state,receiver_city,receiver_address,receiver_zip',tid:tid},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
		  		var datas = {};
		    		
		    		var trade=rsp.trade_fullinfo_get_response.trade;
		    		datas.refund_id='';
		    		datas.num=0;
		    		datas.buyer_nick=trade.buyer_nick;
		    		datas.receiver_name=trade.receiver_name;
		    		if(trade.receiver_mobile!=''&&trade.receiver_mobile!=null){
		    			datas.receiver_phone=trade.receiver_mobile+',';
		    		}
		    		if(trade.receiver_phone!=''&&trade.receiver_phone!=null){
		    			datas.receiver_phone=trade.receiver_phone+',';
		    		}
		    		datas.receiver_state=trade.receiver_state;
		    		datas.receiver_city=trade.receiver_city;
		    		datas.receiver_district=trade.receiver_district;
		    		datas.receiver_address=trade.receiver_address;
		    		datas.receiver_zip=trade.receiver_zip;	


		    	var value=0;
		    	$("#sendlist").empty();
		    	$('#sendlist2').empty();
                var source = $("#sendlist2_template").html();

                var template =Handlebars.compile(source);
                var htmlstr = template(datas);
                $("#sendlist2").append(htmlstr);
		    		for(index in trade.orders.order){
			    		var order=trade.orders.order[index];
			    		if(order.status=="WAIT_SELLER_SEND_GOODS"){
				    		datas.oid=order.oid;
				    		datas.value=value;
				    		value++;
				    		datas.pic_path=order.pic_path;
				    		datas.title=order.title;
				    		datas.total_fee=order.total_fee;
				    		datas.num=order.num;
				    		datas.sku_properties_name=order.sku_properties_name;
	                        var source = $("#sendlist_template").html();

	                        var template =Handlebars.compile(source);
	                        var htmlstr = template(datas);
	                        $("#sendlist").append(htmlstr).trigger('create');

	                       $('#send_way').change(a_offline);
			    		}
		    		}
		    		if(value==trade.orders.order.length){
			    		cdsend=value;
		    		}else{
			    		cdsend=0;
		    		}
                    initselect(null);
                    $("input[name='batchcheckbox']").each(
            				function(){
            					$(this).attr("checked", true).checkboxradio("refresh");
            				} );
                	$('#sendpop').popup("open");
/*		    		
		    		if(datas.refund_id!=''){
			    		datas.pic_path=trade.pic_path;
			    		datas.title=trade.title;
			    		datas.num=1;
			    		datas.total_fee=trade.total_fee;
	    			}else{
		    			datas.pic_path=trade.orders.order[0].pic_path;
		    			datas.title=trade.orders.order[0].title;
			    		for(index in trade.orders.order){
				    		var order=trade.orders.order[index];
				    		datas.num=parseFloat(datas.num)+parseFloat(order.num);
			    		}
			    		datas.total_fee=trade.payment;
	    			}*/

		    		
		    		
		    		

            }


                        

                  	},
        			"error": function (msg) {
        				if(msg.sub_code=='subuser.has-no-permission'){
        				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
        				    }else{
        				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
        				    }
        			    }
	        });
	}
/*function initselect(changeoff)
{  	
	
	var data = window.localStorage.getItem('send');	
	if(data!=null){
		loaddata(data,changeoff);
	}else{
		loadsend();
	}

}*/
function initselect(changeoff)
{  	
	

		loadsend(changeoff);

}
function loadsend(changeoff)
{
	var comptydata = window.localStorage.getItem("compty"+user_nick);
    if(comptydata==null||comptydata=="null")
    {
    	$.ajax({
 		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getSend',
 		     type: 'POST',
 		     dataType:'html',
 		     data:{nick:user_nick},
 		     timeout:10000,
		     error: function(){	
		     },		     
		     success: function(data){
		    	 window.localStorage.setItem("compty"+user_nick,data);
		    	 loaddata(data,changeoff);
		     }
		 });
    }else{
    	loaddata(comptydata,changeoff);
        }
	
}
var lastmode='';
function loaddata(data,changeoff){
    data=JSON.parse(data);
    var name='';
    var code='';
    var datas={};
    datas.lastmode=new Array();
	datas.lastmode[0]='offline';
	datas.lastmode[1]='';
    datas.onname='';
    datas.oncode='';
    datas.offname='';
    datas.offcode='';
    for(index in data){
        order=data[index];
        /*在线下单，卖家是否在数据库中存储了默认快递公司*/
        
        	if(order.mode=='online'){
        		if(order.last_way!=null){
        			datas.lastmode=order.last_way.split(",");
        			if(datas.lastmode[1]==null){
        				datas.lastmode[1]='';
        			}
        		}
        		if(order.name!=null){
        			datas.onname=order.name.split(",");/*快递公司名字*/
        			datas.oncode=order.code.split(",");/*快递公司编码*/
        		}
        	}else if(order.mode=='offline'){
        		if(order.name!=null){
        			datas.offname=order.name.split(",");/*快递公司名字*/
        			datas.offcode=order.code.split(",");/*快递公司编码*/
        		}
        	}
        
    }
    lastmode=datas.lastmode[1];
     if(changeoff!=null){
        if(changeoff=='offline'){
            datas.mode='offline';
            if(datas.offname!=''&&datas.offname!=null){
                name=datas.offname;
            }else{
            	name='';
            }
            if(datas.offcode!=''&&datas.offcode!=null){
                code=datas.offcode;
            }else{
            	code='';
            }
            $("#send_way option[value='offline']").attr("selected","selected");
		 	$('#send_way').selectmenu('refresh', true);
		    $("#off_line").show();
		    $("#no_send").show();
        }else if(changeoff=='online'){
            datas.mode='online';
            if(datas.onname!=''&&datas.onname!=null){
                name=datas.onname;
            }else{
            	name='';
            }
            if(datas.oncode!=''&&datas.oncode!=null){
                code=datas.oncode;
            }else{
            	code='';
            }
		 	$("#send_way option[value='online']").attr("selected","selected");
		 	$('#send_way').selectmenu('refresh', true);
		    $("#off_line").show();
		    $("#no_send").show();
        }else if(changeoff=='notsend'){
            name='no';
		    name='no';
		 	$("#send_way option[value='notsend']").attr("selected","selected");
		 	$('#send_way').selectmenu('refresh', true);
        }
    }else{
        if(datas.lastmode[0]=='offline'){
            datas.mode='offline';
            if(datas.offname!=''&&datas.offname!=null){
                name=datas.offname;
            }else{
            	name='';
            }
            if(datas.offcode!=''&&datas.offcode!=null){
                code=datas.offcode;
            }else{
            	code='';
            }
            $("#send_way option[value='offline']").attr("selected","selected");
    	 	$('#send_way').selectmenu('refresh', true);
    	    $("#off_line").show();
    	    $("#no_send").show();
        }else if(datas.lastmode[0]=='online'){
            datas.mode='online';
            if(datas.onname!=''&&datas.onname!=null){
                name=datas.onname;
            }else{
            	name='';
            }
            if(datas.oncode!=''&&datas.oncode!=null){
                code=datas.oncode;
            }else{
            	code='';
            }
		 	$("#send_way option[value='online']").attr("selected","selected");
		 	$('#send_way').selectmenu('refresh', true);
		    $("#off_line").show();
		    $("#no_send").show();
        }else if(datas.lastmode[0]=='notsend'){
            name='no';
		    name='no';
		 	$("#send_way option[value='notsend']").attr("selected","selected");
		 	$('#send_way').selectmenu('refresh', true);
        }else{
            datas.mode='offline';
            if(datas.offname!=''&&datas.offname!=null){
                name=datas.offname;
            }else{
            	name='';
            }
            if(datas.offcode!=''&&datas.offcode!=null){
                code=datas.offcode;
            }else{
            	code='';
            }
            $("#send_way option[value='offline']").attr("selected","selected");
    	 	$('#send_way').selectmenu('refresh', true);
    	    $("#off_line").show();
    	    $("#no_send").show();
        }
    }
    /*默认快递公司不为空,则加载默认快递公司*/
    if(name!=''&&name!='no'){
    	$("#offtrade").empty();
    	for(index in name){
        	datas.name=name[index];
        	datas.code=code[index];
            var source = $("#offtrade_template").html();

            var template = Handlebars.compile(source);
            var htmlstr = template(datas);
            $("#offtrade").append(htmlstr);
            if(datas.lastmode[1]!=''&&datas.lastmode[1]!=null){
           		if(datas.code==datas.lastmode[1]){
            		$("#offtrade option[value='"+datas.code+"']").attr("selected","selected");
            	}
            }else{
        		$("#offtrade option[value='"+code[0]+"']").attr("selected","selected");
            }
    	}
    	if(datas.mode=='offline'){
    		$("#offtrade").append("<option  value='others'>其它物流公司</option>");
    		$('#offtrade').change(c_offline);
    	}
    	if(datas.lastmode[1]=='other'){
    		$("#offtrade option[value='other']").attr("selected","selected");
    		c_offline();
    	}
    	
        $("#offtrade").trigger("create");
        $('#offtrade').selectmenu('refresh', true);
       /* $.mobile.loading('hide');*/
        getaddr();
    }else if(name=='no'){/*上一次选择了无需物流*/
    	
	    $("#off_line").hide();
	    $("#no_send").hide();
	    $("#off_other").empty();
	    getaddr();
    }else{/*默认快递公司为空,则通过条用淘宝接口列出所有快递公司供选择*/
    	QN.top.invoke({
    		"cmd": "taobao.logistics.companies.get",
    		"param": {fields:'code,name',is_recommended:true,order_mode:datas.mode},
    		"method": "get",
    		"success": function (rsp){
                if(typeof  rsp=== 'string'){
                	rsp = JSON.parse(rsp);
                }
                if(rsp.code!=null){
                    alert(JSON.stringify(rsp));
                }else{
    	    			$('#offtrade').empty();
    	    			 for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
        	    			 var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
        	    			 datas.name=order.name;
        	    			 datas.code=order.code;
        	    			 var source = $("#offtrade_template").html();

     	    	            var template = Handlebars.compile(source);
     	    	            var htmlstr = template(datas);
     	    	            $("#offtrade").append(htmlstr);
     	    	            if(datas.lastmode[1]!=''&&datas.lastmode[1]!=null){
     	    	           		if(datas.code==datas.lastmode[1]){
     	    	            		$("#offtrade option[value='"+datas.code+"']").attr("selected","selected");
     	    	            	}
     	    	            }
     	    	           /* if(index==0){
        	    	         $("#offtrade option[value='"+datas.code+"']").attr("selected","selected");
     	    	            }*/
     	    	            /*if(datas.lastmode[1]!=''&&datas.lastmode[1]!=null){
     	    	           		if(datas.code==datas.lastmode[1]){
     	    	            		$("#offtrade option[value='"+datas.code+"']").attr("selected","selected");
     	    	            		$('#offtrade').change(c_offline);
     	    	            	}
     	    	            }*/
    	    			 }
 	    		    	if($("#send_way").find("option:selected").val()=='offline'){
	    		    		$("#offtrade").append("<option  value='other'>其它</option>");
	    		        		$('#offtrade').change(c_offline);
	    		    	}
     	    	        $("#offtrade").trigger("create");
     	    	        $('#offtrade').selectmenu('refresh', true);
                }
     	    	        
        	    		
    	    		},
    				"error": function (msg) {
    					if(msg.sub_code=='subuser.has-no-permission'){
    					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
    					    }else{
    					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
    					    }
    				    }
    			}
    	);
    	getaddr();
    }


}
function getaddr(){


	QN.top.invoke({
		"cmd": "taobao.logistics.address.search",
		"param": {},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
                    if(rsp.logistics_address_search_response.addresses.address_result==null){
                        alert('发货地址、退货地址为空，请至更多>发货设置中进行设置',5000);
                    }else{
                        var getnum=0;
                        var cannum=0;
                    	for(index in rsp.logistics_address_search_response.addresses.address_result){
                            var result=rsp.logistics_address_search_response.addresses.address_result[index];
                            if(result.get_def){
                            	getnum++;
                            }
                            if(result.cancel_def){
                            	cannum++;
                            }
                        }
                        if(getnum==0){
                            alert('发货地址为空，请至更多>发货设置中进行设置',5000);
                         }else if(cannum==0){
                        	 	alert('退货地址为空，请至更多>发货设置中进行设置',5000);
                         }
                    }
            }
                 },
     			"error": function (msg) {
    				if(msg.sub_code=='subuser.has-no-permission'){
    				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
    				    }else{
    				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
    				    }
    			    }
                   		       	
	 });
}
function tosends(){
	var num=0;
	var tids=new Array();
	var sub_tid='';
	$("input[name='batchcheckbox']:checked").each(
			function(){
				tids[num]=$(this).val();
				num++;
			} );
    if(num==0){
        alert('请选择需要发货的订单！')
    }else{
    		for(index in tids){
    			sub_tid+=tids[index]+',';
    		}
    		if(cdsend==0){/*拆单发货*/
    			cdtosendss(sub_tid)
    		}else{
        		if(num==cdsend){/*不拆弹发货*/
            		tosendss();
        		}else{/*拆单发货*/
    			cdtosendss(sub_tid)
        		}
    		}
    		 
    }
    
}
function cdtosendss(sub_tid){
	var mode=$("#send_way").find("option:selected").val();
	var outid=$('#offline_out').val();
	var cycode=$('#offtrade').find("option:selected").val();
	var urlcode=cycode;
	if(cycode=='other'){
		cycode=$('#othercompany').val();
	}
	if(mode=='offline'){
		if(outid==''){
			alert('运单号不能空');
			
			/*alert(outid+','+cycode);*/
		}else if(cycode==''){
			alert('其他物流公司不能为空');
		}else{
	    	QN.top.invoke({
	    		"cmd": "taobao.logistics.offline.send",
	    		"param": {tid:mytid,out_sid:outid,is_split:'1',sub_tid:sub_tid,company_code:cycode},
	    		"method": "get",
	    		"success": function (rsp){
	                if(typeof rsp=== 'string'){
	                	rsp = JSON.parse(rsp);
	                }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
        	    	   	 /*ajax发送值*/
	                	$.ajax({
	            		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/toSend',
	            		     type: 'POST',
	            		     dataType:'html',
	            		     data:{nick:user_nick,mode:mode,offtrade:urlcode},
	            		     timeout:10000,
              		         success: function(data){
             			    	 window.localStorage.removeItem("compty"+user_nick);
              		        	showlist(mytid,gstas);
              		        	$('#offline_out').val(null);
              		        	$("#sendpop").popup("close");
                  		        alert('操作成功!');
              	        	},
              	 	       error: function(){
              	    	        /*请求出错处理 */

              	        	}
        	      	    });
	                }
            	     },
         			"error": function (msg) {
        				if(msg.sub_code=='subuser.has-no-permission'){
        				      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
        				}else if(msg.sub_code=='isv.logistics-offline-service-error:B02'){
        					alert('您的帐号没有发货的权限!');
            			}else if(msg.sub_code=='isv.logistics-offline-service-error:B04'){
            				alert('订单状态不对');
            			}else if(msg.sub_code=='isv.logistics-offline-service-error:B101'){
            				alert('您还没设置默认的退发货地址');
            			}else if(msg.sub_code=='isv.logistics-offline-service-error:B57'){
            				alert('该物流公司不支持自己联系');
            			}else if(msg.sub_code=='isv.logistics-offline-service-error:B55'){
            				alert('该交易状态不正确，不能发货');
            			}else{
        				    if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
        				}
        			}
                   		       	
		 });
		}
	}else if(mode=='online'){
		if(outid==''){
			alert('运单号不能空');
		}else if(cycode==''){
			alert('其他物流公司不能为空');
		}else{
	    	QN.top.invoke({
	    		"cmd": "taobao.logistics.online.send",
	    		"param": {tid:mytid,out_sid:outid,is_split:'1',sub_tid:sub_tid,company_code:cycode},
	    		"method": "get",
	    		"success": function (rsp){
	                if(typeof  rsp=== 'string'){
	                	rsp = JSON.parse(rsp);
	                }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
        	    	   	 /*ajax发送值*/
	                	$.ajax({
	            		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/toSend',
	            		     type: 'POST',
	            		     dataType:'html',
	            		     data:{nick:user_nick,mode:mode,offtrade:urlcode},
	            		     timeout:10000,
              		         success: function(data){
           			    	 window.localStorage.removeItem("compty"+user_nick);
              		        	showlist(mytid,gstas);
              		        	$('#offline_out').val(null);
              		        	$("#sendpop").popup("close");
                  		      	   alert('操作成功!');
              	        	},
              	 	       error: function(){
              	    	        /*请求出错处理 */

              	        	}
        	      	    });
	                }

            	     },
         			"error": function (msg) {
        				if(msg.sub_code=='subuser.has-no-permission'){
        				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
        				    }else{
        				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
        				    }
        			    }
                   		       	
		 });
		}
	}else{

    	QN.top.invoke({
    		"cmd": "taobao.logistics.dummy.send",
    		"param": {tid:mytid},
    		"method": "get",
    		"success": function (rsp){
                if(typeof  rsp=== 'string'){
                	rsp = JSON.parse(rsp);
                }
                if(rsp.code!=null){
                    alert(JSON.stringify(rsp));
                }else{
            	   	 /*ajax发送值*/
                	$.ajax({
              		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/toSend',
              		     type: 'POST',
              		     dataType:'html',
              		     data:{nick:user_nick,mode:mode,offtrade:''},
              		     timeout:10000,
            	         success: function(data){
       			    	 window.localStorage.removeItem("compty"+user_nick);
            	        	showlist(mytid,gstas);
            	        	$('#offline_out').val(null);
            	        	$("#sendpop").popup("close");
              		        alert('操作成功!');
            	        	/*$("#sdDialog").popup("open");*/
            	        },
            	        error: function(){
            	            /*请求出错处理 */


            	        }
            	    });
                }
                 },
     			"error": function (msg) {
    				if(msg.sub_code=='subuser.has-no-permission'){
  				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
  				    }else{
  				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert(msg.sub_code+'#操作失败，请重试');}
  				    }
  			    }
                   		       	
	 });
		
	}
}
function tosendss(){
	var mode=$("#send_way").find("option:selected").val();
	var outid=$('#offline_out').val();
	var cycode=$('#offtrade').find("option:selected").val();
	var urlcode=cycode;
	if(cycode=='other'){
		cycode=$('#othercompany').val();
	}
	if(mode=='offline'){
		if(outid==''){
			alert('运单号不能空');
			
			/*alert(outid+','+cycode);*/
		}else if(cycode==''){
			alert('其他物流公司不能为空');
		}else{
	    	QN.top.invoke({
	    		"cmd": "taobao.logistics.offline.send",
	    		"param": {tid:mytid,out_sid:outid,company_code:cycode},
	    		"method": "get",
	    		"success": function (rsp){
	                if(typeof rsp=== 'string'){
	                	rsp = JSON.parse(rsp);
	                }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp)+'aaaaaa');
	                }else{
        	    	   	 /*ajax发送值*/
	                	$.ajax({
	              		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/toSend',
	              		     type: 'POST',
	              		     dataType:'html',
	              		     data:{nick:user_nick,mode:mode,offtrade:urlcode},
	              		     timeout:10000,
              		         success: function(data){
           			    	 window.localStorage.removeItem("compty"+user_nick);
              		        	showlist(mytid,gstas);
              		        	$('#offline_out').val(null);
              		        	$("#sendpop").popup("close");
                  		        alert('操作成功!');
              	        	},
              	 	       error: function(){
              	    	        /*请求出错处理 */
              	        	}
        	      	    });
	                }
	   	 

            	     },
         			"error": function (msg) {
        				if(msg.sub_code=='subuser.has-no-permission'){
	      				      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
	      				}else if(msg.sub_code=='isv.logistics-offline-service-error:B02'){
	      					alert('您的帐号没有发货的权限!');
	          			}else if(msg.sub_code=='isv.logistics-offline-service-error:B04'){
	          				alert('订单状态不对');
	          			}else if(msg.sub_code=='isv.logistics-offline-service-error:B101'){
	          				alert('您还没设置默认的退发货地址');
	          			}else if(msg.sub_code=='isv.logistics-offline-service-error:B57'){
	          				alert('该物流公司不支持自己联系');
	          			}else if(msg.sub_code=='isv.logistics-offline-service-error:B55'){
	          				alert('该交易状态不正确，不能发货');
	          			}else{
	      				    if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
	      				    }
	      			    }
                   		       	
		 });
		}
	}else if(mode=='online'){
		if(outid==''){
			alert('运单号不能空');
		}else if(cycode==''){
			alert('其他物流公司不能为空');
		}else{
	    	QN.top.invoke({
	    		"cmd": "taobao.logistics.online.send",
	    		"param": {tid:mytid,out_sid:outid,company_code:cycode},
	    		"method": "get",
	    		"success": function (rsp){
	                if(typeof  rsp=== 'string'){
	                	rsp = JSON.parse(rsp);
	                }
	                if(rsp.code!=null){
	                    alert(JSON.stringify(rsp));
	                }else{
        	    	   	 /*ajax发送值*/
	                	$.ajax({
	              		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/toSend',
	              		     type: 'POST',
	              		     dataType:'html',
	              		     data:{nick:user_nick,mode:mode,offtrade:urlcode},
	              		     timeout:10000,
              		         success: function(data){
           			    	 window.localStorage.removeItem("compty"+user_nick);
              		        	showlist(mytid,gstas);
              		        	$('#offline_out').val(null);
              		        	$("#sendpop").popup("close");
                  		      	   alert('操作成功!');
              	    	    	/*$("#sdDialog").popup("open");*/
              	        	},
              	 	       error: function(){
              	    	        /*请求出错处理 */
              	        	}
        	      	    });
	                }

            	     },
         			"error": function (msg) {
        				if(msg.sub_code=='subuser.has-no-permission'){
        				      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
  	      				}else if(msg.sub_code=='isv.logistics-offline-service-error:B02'){
  	      					alert('您的帐号没有发货的权限!');
  	          			}else if(msg.sub_code=='isv.logistics-offline-service-error:B04'){
  	          				alert('订单状态不对');
  	          			}else if(msg.sub_code=='isv.logistics-offline-service-error:B101'){
  	          				alert('您还没设置默认的退发货地址');
  	          			}else if(msg.sub_code=='isv.logistics-online-service-error:B79'){
  	          				alert('该物流公司揽收或派送范围不支持');
  	          			}else if(msg.sub_code=='isv.logistics-offline-service-error:B55'){
  	          				alert('该交易状态不正确，不能发货');
  	          			}else{
  	      				    if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}
  	      				    }
  	      			    }
                   		       	
		 });
		}
	}else{

    	QN.top.invoke({
    		"cmd": "taobao.logistics.dummy.send",
    		"param": {tid:mytid},
    		"method": "get",
    		"success": function (rsp){
                if(typeof  rsp=== 'string'){
                	rsp = JSON.parse(rsp);
                }
                if(rsp.code!=null){
                    alert(JSON.stringify(rsp));
                }else{
            	   	 /*ajax发送值*/
                	$.ajax({
            		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/toSend',
            		     type: 'POST',
            		     dataType:'html',
            		     data:{nick:user_nick,mode:mode,offtrade:''},
            		     timeout:10000,
            	         success: function(data){
       			    	 window.localStorage.removeItem("compty"+user_nick);
            	        	showlist(mytid,gstas);
            	        	$('#offline_out').val(null);
            	        	$("#sendpop").popup("close");
              		        alert('操作成功!');
            	        },
            	        error: function(){
            	            /*请求出错处理 */
            	        }
            	    });
                }
                 },
     			"error": function (msg) {
    				if(msg.sub_code=='subuser.has-no-permission'){
    				      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
    				    }else{
    				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert(msg.sub_code+'#操作失败，请重试');}
    				    }
    			    }
                   		       	
	 });
		
	}
}

/******************************字符串清楚特殊字符*************************************/
function clearBr(key) 
{ 
    key = key.replace(/<\/?.+?>/g,""); 
    key = key.replace(/[\r\n]/g, "");
    key=key.replace(/(^\s*)|(\s*$)/g,""); /*消除首尾空格*/
    return key; 
}
/**************************系统*******************/
/*时间格式化*/
Date.prototype.format = function(format){
    /*
     * eg:format="yyyy-MM-dd hh:mm:ss";
     */
    if(!format){
        format = "yyyy-MM-dd hh:mm:ss";
    }
    var o = {
        "M+": this.getMonth() + 1, /* month*/
        "d+": this.getDate(), /* day*/
        "h+": this.getHours(), /* hour*/
        "m+": this.getMinutes(), /* minute*/
        "s+": this.getSeconds(), /* second*/
        "q+": Math.floor((this.getMonth() + 3) / 3), /* quarter*/
        "S": this.getMilliseconds()

    };
    if (/(y+)/.test(format)) {
        format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
        if (new RegExp("(" + k + ")").test(format)) {
            format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" +o[k]).length));
        }
    }
    return format;
};
/*******************日期时间转换unix时间戳****************/
function datetime_to_unix(datetime){
    var tmp_datetime = datetime.replace(/:/g,'-');
    tmp_datetime = tmp_datetime.replace(/ /g,'-');
    var arr = tmp_datetime.split("-");
    var now = new Date(Date.UTC(arr[0],arr[1]-1,arr[2],arr[3]-8,arr[4],arr[5]));
    return parseInt(now.getTime()/1000);
}
/*******************获取时间,0为今天,-1为一天前****************/
function GetDateStr(AddDayCount){
    var dd = new Date();
    dd.setDate(dd.getDate()+AddDayCount);/*获取AddDayCount天后的日期*/
    var y = dd.getFullYear();
    var m = dd.getMonth()+1;/*获取当前月份的日期*/
    var d = dd.getDate();
    return dd.format();
}


function a_offline(){
	var sel=$('#send_way').find("option:selected").val();
	initselect(sel);
	c_offline();
	if(sel=='notsend'||sel=='online'){
		$("#off_other").empty();
	}
}
function c_offline()
{
	var sel = $("#offtrade").find("option:selected").val();
	if(sel=='other')
	{
		$("#off_other").empty();
		$("#off_other").append("<input type='text' name='othercompany' id='othercompany' placeholder='请输入物流公司'></input>");
		$("#off_other").trigger("create");		
	}else if(sel=='others'){
		d_offline();
	}else{
		$("#off_other").empty();
		}
}
function d_offline(){

	QN.top.invoke({
		"cmd": "taobao.logistics.companies.get",
		"param": {fields:'code,name',is_recommended:true,order_mode:'offline'},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
	    			$('#offtrade').empty();
	    			 for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
    	    			 var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
						var datas={};
    	    			 datas.name=order.name;
    	    			 datas.code=order.code;
    	    			 var source = $("#offtrade_template").html();

 	    	            var template = Handlebars.compile(source);
 	    	            var htmlstr = template(datas);
 	    	            $("#offtrade").append(htmlstr);
 	    	            if(lastmode=''&&lastmode!=null){
 	    	           		if(datas.code==lastmode){
 	    	            		$("#offtrade option[value='"+datas.code+"']").attr("selected","selected");
 	    	            	}
 	    	            }
	    			 }
	    			 $("#offtrade").append("<option  value='POST'>中国邮政平邮</option>");
	    		    	if($("#send_way").find("option:selected").val()=='offline'){
    		    		$("#offtrade").append("<option  value='other'>其它</option>");
    		        		$('#offtrade').change(c_offline);
    		    	}
 	    	        $("#offtrade").trigger("create");
 	    	        $('#offtrade').selectmenu('refresh', true);
            }
 	    	        
	    		},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
						    if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}

					    }
				    }
	});
}
var goid='';
/********************修改sku属性***********************/
function upsku(oid,num_id,skuname,pic){
	goid=oid;
    QN.top.invoke({
        "cmd": "taobao.item.get",
        "param":{
            fields:'sku.properties_name,sku.properties,sku.quantity,sku.price,property_alias,num_iid,title',
            num_iid:num_id
        },
        "method": "get",
        "success" : function(rsp) {
            if(typeof rsp === 'string'){

                var    rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }

            var datas={};

            var propertiename='';
            var provals='';
            var proname='';
            var pronametext='';

            var skus=rsp.item_get_response.item.skus.sku;
            var  property_alias=rsp.item_get_response.item.property_alias;
            datas.num_id=rsp.item_get_response.item.num_iid;
            datas.title=rsp.item_get_response.item.title;
            datas.titles=rsp.item_get_response.item.title;
            datas.pic_path=pic;
            datas.sku_properties_name=skuname;
            property_alias=property_alias.split(';');
            var proalias ={};
            for(var i in property_alias){
                var alias= property_alias[i].split(':');
                var id=''+alias[0]+alias[1];
                proalias[id]=alias[2];
            }
            /* alert(JSON.stringify(proalias));*/
            $('#skuselect').empty();
            for(var index in skus){
                propertiename=skus[index].properties_name;
                provals=propertiename.split(';');
                for(var j in provals){
                    proname=provals[j].split(':');
                    if(proname!=''){
                        if(j!=0){
                            if(proalias[proname[0]+proname[1]]){
                                pronametext+=';'+proname[2]+':'+proalias[''+proname[0]+proname[1]];
                            }else{
                                pronametext+=';'+proname[2]+':'+proname[3];
                            }
                        }else{
                            if(proalias[''+proname[0]+proname[1]]){
                                pronametext=proname[2]+':'+proalias[''+proname[0]+proname[1]];
                            }else{
                                pronametext=proname[2]+':'+proname[3];
                            }
                        }
                    }
                }
                if(skuname==pronametext){
                	$('#skuselect').append("<option  value='"+skus[index].properties+"' selected>"+pronametext+"</option>");
                    $('#sku_price').text('价格:'+skus[index].price);
                    $('#sku_quantity').text('库存:'+skus[index].quantity);
                }else{
                	$('#skuselect').append("<option  value='"+skus[index].properties+"' >"+pronametext+"</option>");
                }
            }

            $("#upskulist").empty();
			 var source = $("#upskulist_template").html();

            var template = Handlebars.compile(source);
            var htmlstr = template(datas);
            $("#upskulist").append(htmlstr);
            
 	        $("#skuselect").trigger("create");
 	        $('#skuselect').selectmenu('refresh', true);
            $('#skuselect').change(function(){
                for(var index in skus){

                    if($('#skuselect').find("option:selected").val()==skus[index].properties){
                        $('#sku_price').text('价格:'+skus[index].price);
                        $('#sku_quantity').text('库存:'+skus[index].quantity);
                    }
                }
            })
            $("#upskupop").popup("open");
        },
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
						    if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}

					    }
				    }
	});
}


/******************确认修改***************/
function uptosuk(){
	$("#upskupop").popup("close");
	$.mobile.loading('show');
	var sel=$('#skuselect').find("option:selected").val();
	QN.top.invoke({
		"cmd": "taobao.trade.ordersku.update",
		"param": {oid:goid,sku_props:sel},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                alert(JSON.stringify(rsp));
            }else{
           	 
                var text=$('#skuselect').find("option:selected").text();
                $('#skuname'+goid).text(text);
               alert('操作成功！');
            }
 	    	        
	    		},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else{
						    if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert('操作失败，请重试');}

					    }
				    }
	});
}
function HashMap(){var size=0;var entry=new Object();this.put=function(key,value){if(!this.containsKey(key)){size++}entry[key]=value};this.get=function(key){if(this.containsKey(key)){return entry[key]}else{return null}};this.remove=function(key){if(delete entry[key]){size--}};this.containsKey=function(key){return(key in entry)};this.containsValue=function(value){for(var prop in entry){if(entry[prop]==value){return true}}return false};this.values=function(){var values=new Array(size);for(var prop in entry){values.push(entry[prop])}return values};this.keys=function(){var keys=new Array(size);for(var prop in entry){keys.push(prop)}return keys};this.size=function(){return size}};
/**
 * 统计埋点
 * @author Duanhq
 */
function statis(type){
	$.ajax({
		  type: 'GET',
		  url: "http://cdn.zzgdapp.com/iysta/trade/"+type,
		  success:function(e){
			  }
		});
}
function get_userinfo_data(){
		var credit="";
		var rate="";
		var cid="";
		var created="";
		var item_score="";
		var service_score="";
		var delivery_score="";
		var mobile_phone="";
		var contact_name="";
		var addr="";
		var ifhaveaddr="";
		statis('wwindex');
	
	 	QN.top.invoke({
		cmd: "taobao.user.seller.get",
		param:{
				"fields":"seller_credit",
					},
		method: "get",
		success: function (rsp){
			 if(typeof rsp === 'string'){
                var    rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
             if(rsp.user_seller_get_response.user.seller_credit){
            		credit=rsp.user_seller_get_response.user.seller_credit.level;
					var total_num =rsp.user_seller_get_response.user.seller_credit.total_num;
					var good_num  =rsp.user_seller_get_response.user.seller_credit.good_num ;
					rate=(good_num/total_num).toFixed(2);
					/*alert(credit+"~~~"+rate);*/
		        }
             QN.application.invoke({
          		 "cmd": "getLoginuser",
          		 "success": function (e){
          			 if(typeof  e=== 'string'){
          	            	e = JSON.parse(e);
          	            }
          		 		nick=decodeURI(e.user_nick);
          		 		refshvip(nick);
                     if(e.sub_user_id==""){
                         uid=e.user_id;
                     }else{
                         uid=e.sub_user_id;
                     }
                     showlist();
	          		 	 QN.top.invoke({
		 		     			cmd: "taobao.shop.get",
		 		     			param:{
		 		     					"fields":"cid,created,shop_score",
		 		     					"nick":nick,
		 		     						},
		 		     			method: "get",
		 		     			success: function (rsp){
		 		     				/*alert(JSON.stringify(rsp));*/
		 		     				 if(typeof rsp === 'string'){
		 		                         var    rsp = JSON.parse(rsp);
		 		                     }else{
		 		                         var	rsp= rsp;
		 		                     }
		 		     	             if(rsp.shop_get_response.shop){
		 			     	            	cid=rsp.shop_get_response.shop.cid;
		 			     	            	created=rsp.shop_get_response.shop.created;
		 			     	            	item_score =rsp.shop_get_response.shop.shop_score.item_score;
		 			     	            	service_score =rsp.shop_get_response.shop.shop_score.service_score;
		 			     	            	delivery_score  =rsp.shop_get_response.shop.shop_score.delivery_score ;
		 			     	            	/*alert(cid+"~~"+created+"~~~"+item_score+"~~"+service_score+"~~"+delivery_score);*/
			 			     	              
		 		     			       }
			    		     	           QN.top.invoke({
	 			    		     			cmd: "taobao.logistics.address.search",
	 			    		     			param:{
 			    		     					"rdef":"get_def"
 			    		     						},
	 			    		     			method: "get",
	 			    		     			success: function (rsp){
	 			    		     				
	 			    		     				 if(typeof rsp === 'string'){
	 			    		                         var    rsp = JSON.parse(rsp);
	 			    		                     }else{
	 			    		                         var	rsp= rsp;
	 			    		                     }
	 			    		                     if(rsp.logistics_address_search_response){
		 			    		                     var addre=rsp.logistics_address_search_response.addresses.address_result[0]
		 			    		     	             mobile_phone=addre.mobile_phone;
			 			    		     	         addr=addre.province+addre.city+addre.country+addre.addr;
			 			    		     	         contact_name =addre.contact_name ;
				 			    		     	       /*alert(mobile_phone+"~~"+contact_name+"~~"+addr);*/
			 		     	          					 ifhaveaddr="yes";
	 			    		                     }else{
														ifhaveaddr="no";
		 			    		                    }
		 			    		                    
		 			    		                 save_userinfo(nick,credit,cid,rate,created,item_score,service_score,delivery_score,mobile_phone,contact_name,addr,ifhaveaddr);
	 			    		     			}
	 			    		      	 	});
			 		     	           /*save_userinfo(nick,credit,cid,rate,created,item_score,service_score,delivery_score,mobile_phone,contact_name,addr,"no");*/
		 			    		     		
		 		     		         
		 		     			}
		 		      	 	});
	          		 }
	          	 });
            
		}
	 	});
 }
 function save_userinfo(nick,credit,cid,rate,created,item_score,service_score,delivery_score,mobile_phone,contact_name,addr,ifhaveaddr){
		var data={
				"nick":nick,
				"credit":credit,
				"category":cid,
				"rate":rate,
				"item_score":item_score,
				"service_score":service_score,
				"delivery_score":delivery_score,
				"shop_start_time":created,
				"shop_start_name":contact_name,
				"shop_start_phone":mobile_phone,
				"shop_start_mail":"",
				"shop_start_addr":addr,
				"appkey":"21588210",
				"ifhaveaddr":ifhaveaddr,
				};
		/*$.ajax({
		  type: 'POST',
		  url: "<?php echo APP_WEB_INDEX_ROOT;?>/tc/sv",
		  data: data,
		  success:function(e){
				alert("成功！"+e);
			  }
		});*/


 }
 function getLength(str) { 
	    var len = str.length; 
	    var reLen = 0; 
	    for (var i = 0; i < len; i++) {        
	        if (str.charCodeAt(i) < 27 || str.charCodeAt(i) > 126) { 
	            /*全角*/
	            reLen += 2; 
	        } else { 
	            reLen++; 
	        } 
	    } 
	    return reLen;    
	}
 function changetosp(num_id){
     QN.plugin.invoke({
     	"cmd": "itemDetail",
     	"param": {
     	iid:num_id
     	},
     	"category": "shangpinguanli"
     	});
 }
 function gotradeDetail(num_id){/*跳转到交易详情*/
	 QN.plugin.invoke({
	     	"cmd": "tradeDetail",
	     	"param": {
	     	tid:num_id
	     	},
	     	"category": "jiaoyiguanli"
	     	});
}
 function gorefundDetail(num_id,refuid){/*转到退款详情*/
	 QN.plugin.invoke({
	     	"cmd": "refundDetail",
	     	"param": {
	     	tid:num_id,
	     	refundId:refuid	     	
	     	},
	     	"category": "jiaoyiguanli"
	     	});
	}
function spplugin(){
    QN.plugin.invoke({
        "category": "jiaoyiguanli",
        "param": {task:"wwtask"},
        success: function (rsp) {
        },
        error:function(rsp){
            if(typeof rsp === 'string'){
                var    rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
              if(rsp.msg != "pluginclose in flow"&& rsp.msg != "plugin in calling, wait"){
                alert("请求超时!");
            }
        }
    });
}
function listcyc(id){
    QN.top.invoke({
        "cmd": "taobao.qianniu.task.message.send",
        "param": {"task_id":id},
        "method": "get",
        "success": function (e){
            alert('提醒发送成功!');
        },
        "error":function(e){
        }
    });
}
function showmemo(){
	QN.top.invoke({
		 "cmd": "taobao.traderates.get",
		 "param": {'fields':"tid,content",
             		'rate_type':'get',
             		'role':'buyer'
             	},
	 "method": "get",
	 "success":function (rsp){
			if(typeof rsp=='string'){
				var rsp=JSON.parse(rsp);
				}else {
					var rsp=rsp
				}
			var tradememo=rsp.traderates_get_response.trade_rates.trade_rate;
				for(var i in tradememo){
					var rate=tradememo[i];
					$("#buyercom"+rate.tid).html('买家评价：'+'<font color="red">'+rate.content+"</font>");
					}
			
		 },
	 "error":function (msp){
		 if(typeof msp === 'string'){

             var    msp = JSON.parse(msp);
         }else{
             var	msp= msp;
         }
         if(msp.sub_code=='subuser.has-no-permission'){
        	/* alert('该子帐号无此操作权限，请通过主帐号设置开通相应权限！'); */
        }else{
        	alert('error---404');
         }
		 
	}
		});
}
function refshvip(nick){
	user_nick=nick;
    QN.top.invoke({
        "cmd": "taobao.vas.subscribe.get",
        "param": {"nick":user_nick,
				 "article_code":"FW_GOODS-1827490"
        		},
        "method": "get",
        "success": function (rsp){
			if(typeof rsp=='string'){
				var rsp=JSON.parse(rsp);
				}else {
					var rsp=rsp
				}
			if(rsp.vas_subscribe_get_response){
    			var subscribe=rsp.vas_subscribe_get_response.article_user_subscribes.article_user_subscribe;
    			for(index in subscribe){
        			var vip=subscribe[index];
        			if(vip.item_code=='FW_GOODS-1827490-1'){
        				vipuser=0;
        				$('#wwgonggao').hide();
            			if(viptime!='off'){
            				viptime=decodeURI(viptime);
            				if(datetime_to_unix(viptime)>datetime_to_unix('2012-05-31 23:59:59')){
            					$.ajax({
          	              		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/upViptime',
          	              		     type: 'POST',
          	              		     dataType:'html',
          	              		     data:{nick:user_nick,viptime:'2012-05-31 23:59:59'},
          	              		     timeout:10000,
      		           			     success: function(data){
      			           			       
      		           			        },
      		           			     error: function(){
      		
      		           			        }
      		           			    });
            				}
            			}
        			}else if(vip.item_code=='FW_GOODS-1827490-v2'){
        				vipuser=1;
        				
        				var deadline=vip.deadline;
        	    		var datetime=datetime_to_unix(deadline)-datetime_to_unix(GetDateStr(0));
        	    		var day=Math.ceil(datetime/86400);
        	    		if(day<83){
        	        		$('#wwgonggao').show();
        	    		}
        				if(datetime_to_unix(deadline) > datetime_to_unix(GetDateStr(0))){
                  			 /*订购没有到期*/
                			if(viptime!='off'){
                				viptime=decodeURI(viptime);
                    				if(datetime_to_unix(deadline)>datetime_to_unix(viptime)){
                    					$.ajax({
                	              		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/upViptime',
                	              		     type: 'POST',
                	              		     dataType:'html',
                	              		     data:{nick:user_nick,viptime:deadline},
                	              		     timeout:10000,
		       		           			     success: function(data){
		       			           			       
		       		           			      },
		       		           			     error: function(){
		       		
		       		           			      }
       		           			    });
                    				}else if(datetime_to_unix(deadline)<datetime_to_unix(viptime)){
                        				/*订购时间小于实际数据库到期时间*/
	                    					$.ajax({
	                  	              		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/upViptime',
	                  	              		     type: 'POST',
	                  	              		     dataType:'html',
	                  	              		     data:{nick:user_nick,viptime:deadline},
	                  	              		     timeout:10000,
	         		           			         success: function(data){
	         			           			       
	         		           			         },
	         		           			         error: function(){
	         		
	         		           			         }
	         		           			    });

	                    				}
	                   		}else{/*写数据库*/
	                   			$.ajax({
	       	              		     url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/upViptime',
	       	              		     type: 'POST',
	       	              		     dataType:'html',
	       	              		     data:{nick:user_nick,viptime:deadline},
	       	              		     timeout:10000,
	       	           			     success: function(data){
	       	
	       	           			     },
	       	           			     error: function(){
	       	           			        }
	       	           			   		 });
	                   		}
              			 }else{
                  			 /*订购已到期*/
              			 }
        			}
				}
   			 
	    		
    		}
        },
        "error":function(msp){
        }
    });
}

/**
 * Created with need.
 * User: wangsx
 * Date: 14-4-26
 * Time: 14:00 
 * 按钮埋点
 */	
function tradePoint(nick,path){
		$.ajax({
			type:"post",
			url:"<?php echo APP_WEB_INDEX_ROOT?>/tc/tradePoint",
			async:true,
			data : { 'nick' : nick, 'path' : path },
			timeout : 5000,
			success : function(data) {
			}
		});
	}
/**
 * 快捷键:核对订单
 */
function actionQ(){
	QN.implement.api({
		cmd: 'checkAddress',
		onInvoke: function(param){
		if(typeof param=='string'){
				param=JSON.parse(param);
				}else {
					param=param;
				}
		if(chatnick!=param.chatNick){
			huidiao('fail');
		}else{
			
			if(gaddrs==''){
				alert('当前没有可以核对地址的订单');
				huidiao('fail');
			}else{
				checkAddressQ(gaddrs,param.chatNick);
				huidiao('success');
			}
			
		}
		
		
		}
	});
}
/**
 * 快捷键：订单备注
 */
function actionW(){
	QN.implement.api({
		cmd: 'orderRemarks',
		onInvoke: function(param){
			console.log(param);
		if(typeof param=='string'){
				param=JSON.parse(param);
				}else {
					param=param;
				}
		if(chatnick!=param.chatNick){
			huidiao('fail');
		}else{
			QN.top.invoke({
			"cmd": "taobao.trades.sold.get",
			"param": {
				"fields":"created,pic_path,title,status,tid",
				 "type":'tid',
				"page_no":'1',
				"buyer_nick":decodeURI(param.chatNick.substr(8)),
				"page_size":'100'
				},
			"method": "get",
			"success": function (rsp){
				
				$.mobile.loading( 'hide' );
	            if(typeof  rsp=== 'string'){
	            	rsp = JSON.parse(rsp);
	            }
				
		        var total_results=rsp.trades_sold_get_response.total_results;
		        

		        if(total_results>0){
		        	var orders = rsp.trades_sold_get_response.trades.trade;
		        	var datas=new Array();
					var actionnum=0;
					for(index in orders)
					{	
						var order=orders[index];
						if(order.status!='TRADE_CLOSED'&&order.status!='TRADE_CLOSED_BY_TAOBAO'&&order.status!='TRADE_FINISHED'){
							datas[actionnum++]=order;
						}
					}
					if(actionnum==0){
							alert('当前没有可以备注的未完成订单');
							huidiao('fail');
					}else if(actionnum==1){
						showbeiw(''+datas[0].tid);
						huidiao('success');
					}else{
		        		QN.application.invoke({
							 "cmd": 'getVersion',
							 "success": function (e){
								 if(typeof  e=== 'string'){
						            	e = JSON.parse(e);
						            }
						            
						            var version=e.version.replace(/[.]/g,"");
						            version=version.replace(/[N]/g,"");
						           /* if(version<10017){*/
							           /**
							           *撤销退款组件
							           */
							           if(version>=20301){
							           		
							           		QN.component.invoke( {
												category : 'select_order',
												cmd : '',
												param : {
												uuid : param.chatNick,
												
												chatNick : decodeURI(param.chatNick.substr(8)), 
												hotkey : param.hotkey, 
												tradeList :JSON.stringify(datas)
												},
												error : function(msg) {
												alert('快捷备注失败');
												huidiao('fail');
												
												},
												success : function(rsp) {
													showbeiw(''+rsp.tid);
								            		huidiao('success');
												}
											});
							            }else{
											showbeiw(''+datas[0].tid);
											huidiao('success');

							            }
							 }
						});
					}

		        }else{
			        /**该买家没有订单*****/
			       								            	alert('当前没有可以备注的未完成订单');
												huidiao('fail');
		        }
			},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else if(msg.sub_code=='isv.invalid-parameter:buyer_nick'){
						    alert('该帐号为买家子帐号，无法查询到订单信息')
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_code);}else{alert('操作失败，请重试');}
					    }
				    }
			});
			
		}
		
		
		}
	});
}
/**
 * 快捷键：改价
 */
function actionE(){
	QN.implement.api({
		cmd: 'priceChange',
		onInvoke: function(param){
		if(typeof param=='string'){
				param=JSON.parse(param);
				}else {
					param=param;
				}
		if(chatnick!=param.chatNick){
			huidiao('fail');
		}else{
			QN.top.invoke({
			"cmd": "taobao.trades.sold.get",
			"param": {
				"fields":"created,pic_path,title,status,tid",
				 "type":'tid',
				"page_no":'1',
				"buyer_nick":decodeURI(param.chatNick.substr(8)),
				"page_size":'100'
				},
			"method": "get",
			"success": function (rsp){
				
				$.mobile.loading( 'hide' );
	            if(typeof  rsp=== 'string'){
	            	rsp = JSON.parse(rsp);
	            }
				
		        var total_results=rsp.trades_sold_get_response.total_results;
		        

		        if(total_results>0){
		        	var orders = rsp.trades_sold_get_response.trades.trade;
		        	var datas=new Array();
					var actionnum=0;
					for(index in orders)
					{	
						var order=orders[index];
						if(order.status=='WAIT_BUYER_PAY'){
							datas[actionnum++]=order;
						}
					}
					if(actionnum==0){
							alert('当前没有可以改价的订单');
							huidiao('fail');
					}else if(actionnum==1){
						showprice(''+datas[0].tid);
						huidiao('success');
					}else{
		        		QN.application.invoke({
							 "cmd": 'getVersion',
							 "success": function (e){
								 if(typeof  e=== 'string'){
						            	e = JSON.parse(e);
						            }
						            
						            var version=e.version.replace(/[.]/g,"");
						            version=version.replace(/[N]/g,"");
						           /* if(version<10017){*/
							           /**
							           *撤销退款组件
							           */
							           if(version>=20301){
							           		
							           		QN.component.invoke( {
												category : 'select_order',
												cmd : '',
												param : {
												uuid : param.chatNick,
												
												chatNick : decodeURI(param.chatNick.substr(8)), 
												hotkey : param.hotkey, 
												tradeList :JSON.stringify(datas)
												},
												error : function(msg) {
												alert('快捷改价失败');
												huidiao('fail');
												
												},
												success : function(rsp) {
													showprice(''+rsp.tid);
								            		huidiao('success');
												}
											});
							            }else{
											showprice(''+datas[0].tid);
											huidiao('success');

							            }
							 }
						});
					}

		        }else{
			        /**该买家没有订单*****/
			       								alert('当前没有可以改价的订单');
												huidiao('fail');
		        }
			},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else if(msg.sub_code=='isv.invalid-parameter:buyer_nick'){
						    alert('该帐号为买家子帐号，无法查询到订单信息')
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_code);}else{alert('操作失败，请重试');}
					    }
				    }
			});
			
		}
		
		
		}
	});
}
/**
 * 快捷键：免邮
 */
function actionR(){
	QN.implement.api({
		cmd: 'postageFree',
		onInvoke: function(param){
		if(typeof param=='string'){
				param=JSON.parse(param);
				}else {
					param=param;
				}
		if(chatnick!=param.chatNick){
			huidiao('fail');
		}else{
			QN.top.invoke({
			"cmd": "taobao.trades.sold.get",
			"param": {
				"fields":"created,pic_path,title,status,tid",
				 "type":'tid',
				"page_no":'1',
				"buyer_nick":decodeURI(param.chatNick.substr(8)),
				"page_size":'100'
				},
			"method": "get",
			"success": function (rsp){
				
				$.mobile.loading( 'hide' );
	            if(typeof  rsp=== 'string'){
	            	rsp = JSON.parse(rsp);
	            }
				
		        var total_results=rsp.trades_sold_get_response.total_results;
		        

		        if(total_results>0){
		        	var orders = rsp.trades_sold_get_response.trades.trade;
		        	var datas=new Array();
					var actionnum=0;
					for(index in orders)
					{	
						var order=orders[index];
						if(order.status=='WAIT_BUYER_PAY'){
							datas[actionnum++]=order;
						}
					}
					if(actionnum==0){
							alert('当前没有可以免邮的订单');
							huidiao('fail');
					}else if(actionnum==1){
						updatepost(''+datas[0].tid);
						huidiao('success');
					}else{
		        		QN.application.invoke({
							 "cmd": 'getVersion',
							 "success": function (e){
								 if(typeof  e=== 'string'){
						            	e = JSON.parse(e);
						            }
						            
						            var version=e.version.replace(/[.]/g,"");
						            version=version.replace(/[N]/g,"");
						           /* if(version<10017){*/
							           /**
							           *撤销退款组件
							           */
							           if(version>=20301){
							           		
							           		QN.component.invoke( {
												category : 'select_order',
												cmd : '',
												param : {
												uuid : param.chatNick,
												
												chatNick : decodeURI(param.chatNick.substr(8)), 
												hotkey : param.hotkey, 
												tradeList :JSON.stringify(datas)
												},
												error : function(msg) {
												alert('快捷免邮失败');
												huidiao('fail');
												
												},
												success : function(rsp) {
													updatepost(''+rsp.tid);
								            		huidiao('success');
												}
											});
							            }else{
											updatepost(''+datas[0].tid);
											huidiao('success');

							            }
							 }
						});
					}

		        }else{
			        /**该买家没有订单*****/
			       								alert('当前没有可以免邮的订单');
												huidiao('fail');
		        }
			},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else if(msg.sub_code=='isv.invalid-parameter:buyer_nick'){
						    alert('该帐号为买家子帐号，无法查询到订单信息')
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_code);}else{alert('操作失败，请重试');}
					    }
				    }
			});
			
		}
		
		
		}
	});
}
/**
 * 快捷键：核对物流
 */
function actionT(){
	QN.implement.api({
		cmd: 'checkLogistics',
		onInvoke: function(param){
		if(typeof param=='string'){
				param=JSON.parse(param);
				}else {
					param=param;
				}
		if(chatnick!=param.chatNick){
			huidiao('fail');
		}else{
			QN.top.invoke({
			"cmd": "taobao.trades.sold.get",
			"param": {
				"fields":"created,pic_path,title,status,tid",
				 "type":'tid',
				"page_no":'1',
				"buyer_nick":decodeURI(param.chatNick.substr(8)),
				"page_size":'100'
				},
			"method": "get",
			"success": function (rsp){
				
				$.mobile.loading( 'hide' );
	            if(typeof  rsp=== 'string'){
	            	rsp = JSON.parse(rsp);
	            }
				
		        var total_results=rsp.trades_sold_get_response.total_results;
		        

		        if(total_results>0){
		        	var orders = rsp.trades_sold_get_response.trades.trade;
		        	var datas=new Array();
					var actionnum=0;
					for(index in orders)
					{	
						var order=orders[index];
						if(order.status=='WAIT_BUYER_CONFIRM_GOODS'){
							datas[actionnum++]=order;
						}
					}
					if(actionnum==0){
							alert('当前没有可以已发货的订单');
							huidiao('fail');
					}else if(actionnum==1){
						checkLogT(datas[0].tid,param.chatNick)
						huidiao('success');
					}else{
		        		QN.application.invoke({
							 "cmd": 'getVersion',
							 "success": function (e){
								 if(typeof  e=== 'string'){
						            	e = JSON.parse(e);
						            }
						            
						            var version=e.version.replace(/[.]/g,"");
						            version=version.replace(/[N]/g,"");
						           /* if(version<10017){*/
							           /**
							           *撤销退款组件
							           */
							           if(version>=20301){
							           		
							           		QN.component.invoke( {
												category : 'select_order',
												cmd : '',
												param : {
												uuid : param.chatNick,
												
												chatNick : decodeURI(param.chatNick.substr(8)), 
												hotkey : param.hotkey, 
												tradeList :JSON.stringify(datas)
												},
												error : function(msg) {
												alert('快捷物流失败');
												huidiao('fail');
												
												},
												success : function(rsp) {
													console.log(rsp);
													checkLogT(rsp.tid,param.chatNick)
								            		huidiao('success');
												}
											});
							            }else{
											checkLogT(datas[0].tid,param.chatNick)
											huidiao('success');

							            }
							 }
						});
					}

		        }else{
			        /**该买家没有订单*****/
			       								alert('当前没有可以已发货的订单');
												huidiao('fail');
		        }
			},
				"error": function (msg) {
					if(msg.sub_code=='subuser.has-no-permission'){
					       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
					    }else if(msg.sub_code=='isv.invalid-parameter:buyer_nick'){
						    alert('该帐号为买家子帐号，无法查询到订单信息')
					    }else{
					    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_code);}else{alert('操作失败，请重试');}
					    }
				    }
			});
			
		}
		
		
		}
	});
}
function checkLogT(Ttid,Tnick){
	QN.top.invoke({
          						"cmd": "taobao.logistics.trace.search",
          						"param": {tid:Ttid,seller_nick:user_nick},/*is_split:'1',sub_tid:datas.sub_tid},*/
          						"method": "get",
          						"success": function (rsp){
          				            if(typeof  rsp=== 'string'){
          				            	rsp = JSON.parse(rsp);
          				            }
 
          						    		var item=rsp.logistics_trace_search_response;
										 	
          									var len=item.trace_list.transit_step_info.length;
          									var datas={};
          									datas.text='订单号:'+Ttid+'\n';
          									if(item.out_sid!=null){
          										datas.text+='运单号:'+item.out_sid+'\n';
          									}
          									if(item.company_name!=null){
          										datas.text+='物流公司:'+item.company_name+'\n';
          									}
          									
          								 	for (var i=0; i <len;i++){
          								 		var order=item.trace_list.transit_step_info[i];
          									 	datas.status_time=order.status_time;/*状态时间*/
          									 	datas.status_desc=order.status_desc;/*状态描述*/
          									 	if(order.status_time!=null&&order.status_desc!=null){
          											datas.text+=datas.status_time+','+datas.status_desc+'\n';
          									 	}else{
          									 		datas.text='no';
          									 		break;
          									 	}
          								 	}
          								 	if(datas.text=='no'){
          								 		alert('未查询到相关物流信息');
          								 	}else{
          								 		QN.wangwang.invoke({
											        category: 'wangwang', 
											        cmd: 'insertText2Inputbox',
											        param: {'uid':Tnick,'text':datas.text,'type':0},
											        success: function (rsp) {
											            if(typeof rsp==='string'){
											           	rsp = JSON.parse(rsp);
											        }
											            if(rsp.code!=null){
											                alert(JSON.stringify(rsp));
											            }else{
											   	    	$("#addrpop").popup("close");
												    	$("#sendaddrpop").popup("close");
												    	alert('发送成功！');
											            }
											        },
													"error": function (msg) {
														if(msg.sub_code=='subuser.has-no-permission'){
														       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
														    }else{
														    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert(JSON.stringify(msg));}
														    }
													    }
											    });
          								 	}


          					    		}
          							});
}
function checkAddressQ(text,Qnick){
	text=decodeURI(text);
	/*if(vipuser==0){
		$("#showvippop").popup("open");
		return;
	}
	var text=$('#addrtext').text();*/

	text=text.split(',');
	var name='';
	var addr='';
	var zip='';
	var phone='';
	var connent='亲，请核对一下地址/:^_^';
	if(text.length==4){
		name=text[0];
		phone=text[1];
		addr=text[2];
		zip=text[3];
		connent='姓名：'+name+'\n电话：'+phone+'\n地址：'+addr+'\n邮编：'+zip+'\n'+connent;
	}else if(text.length==5){
		name=text[0];
		phone=text[1]+','+text[2];
		addr=text[3];
		zip=text[4];
		connent='姓名：'+name+'\n电话：'+phone+'\n地址：'+addr+'\n邮编：'+zip+'\n'+connent;
	}else if(text.length==3){
		name=text[0];
		phone='不需要联系方式';
		addr=text[1];
		zip=text[2];
		connent=name+'\n'+phone+'\n'+'订单信息:'+text+'\n'+zip+'\n'+connent;
	}else{
		var cont='';
		for(index in text){
			cont+=text[index]+'\n';
		}
		connent=cont+connent;
	}
	 QN.wangwang.invoke({
	        category: 'wangwang', 
	        cmd: 'insertText2Inputbox',
	        param: {'uid':Qnick,'text':connent,'type':0},
	        success: function (rsp) {
	            if(typeof rsp==='string'){
	           	rsp = JSON.parse(rsp);
	        }
	            if(rsp.code!=null){
	                alert(JSON.stringify(rsp));
	            }else{
	   	    	$("#addrpop").popup("close");
		    	$("#sendaddrpop").popup("close");
		    	alert('发送成功！');
	            }
	        },
			"error": function (msg) {
				if(msg.sub_code=='subuser.has-no-permission'){
				       /* alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
				    }else{
				    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert(JSON.stringify(msg));}
				    }
			    }
	    });
	 return;
    QN.wangwang.invoke({
        category: 'wangwang',
        cmd:'getActiveUser',
        param: {},
        success: function (rsp) {
            if(typeof rsp==='string'){
        	rsp = JSON.parse(rsp);
            }

	     	    
        },
		"error": function (msg) {
			if(msg.sub_code=='subuser.has-no-permission'){
			      /*  alert('该子帐号无此操作权限, 请通过主帐号设置开通相应权限!'); */
			    }else{
			    	if(msg.sub_msg!=null&&msg.sub_msg!=''){alert(msg.sub_msg);}else{alert(JSON.stringify(msg));}
			    }
		    }
    });
}

function huidiao(rsp){
    var seccessrsult={};
    if(rsp=='success'){
    	QN.plugin.successResponse(seccessrsult);
    }else{
    	QN.plugin.errorResponse(seccessrsult);
    }
}
   </script>
    <script id="selerwslist_template" type="text/x-handlebars-template">
        <div style="padding:5px 5px 3px 5px;background-color:#FFECEC;">
        <p style="font-size:12px;margin:6px 0px 6px 0px;" class="font_wsl">
            <span>{{sendnick}}创建</span>
            <span  style="float:right;">{{cjtime}}</span>
        </p>
            {{#if cons}}
        <p style="font-size:12px; margin:6px 0 6px 0;color:#D26900" class="font_wsl" title="{{contents}}"  onmouseover="this.style.cursor='pointer';"><span style="display:inline-block;word-break:break-all;">{{content}}</span></p>
        {{ else }}
            <p style="font-size:12px; margin:6px 0 6px 0;color:#D26900" class="font_wsl" ><span style="display:inline-block;word-break:break-all;">{{content}}</span></p>
            {{/if}}
            <p style="font-size:12px;margin:6px 0px 6px 0px;" class="font_wsl">
            <span title="处理信息：{{memo}}" onmouseover="this.style.cursor='pointer';"><a>{{recnick}}</a>{{statecontent}}</span>
            <span  style="float:right;" class="{{statecss}}">{{state}}</span>
        </p>
        </div>
        <p style="margin:0;margin-top:-10px;">&nbsp;&nbsp;</p>
    </script>
    <script id="addrwslist_template" type="text/x-handlebars-template">
        {{#if taskis}}
        <a  onclick="listrws('{{tid}}');" data-role="button" data-inline="true" data-mini="true" data-theme="c" class="ddztcheng" >
            <span style="margin:0px; font-size:12px; font-weight:normal;" class="font_wsl" >+添加任务</span>
        </a>
        {{/if}}
        {{#if task}}
        <a  onclick="listcl({{idTask}},{{tid}});" data-role="button" data-inline="true" data-mini="true" data-theme="c" class="ddztlan" >
            <span style="margin:0px; font-size:12px; font-weight:normal;" class="font_wsl">处理任务</span>
        </a>
        <a  onclick="listzj({{dataid}},{{tid}});" data-role="button" data-inline="true" data-mini="true" data-theme="c" class="ddztqing" >
            <span style="margin:0px; font-size:12px; font-weight:normal;" class="font_wsl" >转交任务</span>
        </a>
        {{/if}}
        {{#if iscyc}}
        <a  onclick="listcyc('{{idiscyc}}');" data-role="button" data-inline="true" data-mini="true" data-theme="c" class="ddztlan" >
            <span style="margin:0px; font-size:12px; font-weight:normal;" class="font_wsl" >催一催</span>
        </a>
        {{/if}}
        <a  data-inline="true" data-mini="true" data-theme="c"  >
            &nbsp;&nbsp;
        </a>
         <a href="#"  onclick="spplugin();"style="color:	#003D79;float:right;margin:7px 0px 0px 0px; font-size:12px; font-weight:normal;"  >
          <span >任务管理</span>
         </a>
         </script>
 <script id="list_template" type="text/x-handlebars-template">
<div data-role="collapsible" data-collapsed-icon="arrow-d" data-expanded-icon="arrow-u" class="ui-icon-alt" data-mini="true" style="margin:1px; border-radius:0;" data-collapsed>
				<h3><span  class="{{stacla}}">{{status}}</span><span style="font-size:12px; font-weight:normal;padding-left:3px;">{{state}}</span>
                        <span style="font-weight:normal;font-size:12px;color:#999;padding-left:3px">{{created}}</span>
						{{#if type}}
                        <span class="hdfk" style="float:right;"></span>	
						{{/if}}	
				</h3>
					<div id="orderlist{{tid}}">
					</div>
	
		            <div class="content-primary" style="margin:15px 0 0; color:#005895; text-shadow:none;">
<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">订单编号：<a title="点击查看订单详情" href="javascript:void(0);" onclick="gotradeDetail('{{tid}}')" style="text-decoration:none;">{{tid}}</a></p>
<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">创建时间：{{created}}</p>
<p style="font-size:12px; margin:6px 0 6px 0;display:{{dispay}};" " class="font_wsl">付款时间：{{pay_time}}</p>
<p style="font-size:12px; margin:6px 0 6px 0;display:{{disend}};" " class="font_wsl">{{endname}}：{{end_time}}</p>
<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">&nbsp;&nbsp;&nbsp;支付宝：<a href="javascript:toalipay('{{tid}}');" title="付款给买家" style="text-decoration:none;"><span id="alipay{{tid}}" ></span></a></p>
<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">  发票抬头：<span id="receipt{{tid}}"></span></p>


<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl"><span style="float:left;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;备忘：</span><a href="javascript:void(0)" id="flag{{tid}}" title="修改备注" onclick="showbeiw('{{tid}}')"  style="float:left;" class="bw_{{seller_flag}}"></a><span id="flags{{tid}}"></span></p>

<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">买家留言：<span id="memo{{tid}}"></span></p>
<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">　　实收：<span id="price{{tid}}" class="monney">{{payment}}</span>元（含运费<span id="post{{tid}}">{{post_fee}}</span>）</p>
<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">{{pjtype}}</p>
	{{#if issuccess}}
			<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl">买家评价：<font color="red">尚未评价</font></p>
		{{else}}	
			<p  id ="buyercom{{tid}}" style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl"></p>
	{{/if}}
<p style="font-size:12px; margin:6px 0 6px 0;" class="font_wsl" id="promotions{{tid}}"></p>
		            {{#if css3}}

						<a title="{{titleinfoQ}}" onclick="{{fun1}}('{{name}}','{{tid}}','{{buyer_nick}}','{{seller_nick}}','{{isseller_nick}}','{{created}}')" data-role="button" data-inline="true" data-mini="true"  data-theme="c"  >
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">{{but1}}</span>
						</a>
					{{/if}}
		            	<a onclick="showbeiw('{{tid}}')" data-role="button" data-inline="true" data-mini="true" data-theme="c"  >
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">修改备忘</span>
						</a>
					{{#if isaddr}}
						<a onclick="copyaddr('{{texts}}')" data-role="button" title="{{texts_title}}" data-inline="true" data-mini="true" data-theme="c"  >
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">核对地址</span>
						</a>
					{{/if}}
					{{#if bfsend}}
						<a onclick="tosend('{{name}}','{{tid}}','{{buyer_nick}}','{{seller_nick}}')" data-role="button" data-inline="true" data-mini="true" data-theme="c"  >
							<span style="margin:0x; font-size:12px; font-weight:normal;" class="font_wsl">　发货　</span>
						</a>
					{{/if}}
					{{#if css2}}							
		            	<!--a onclick="gorefundDetail('{{tid}}','{{refunid}}');"  data-role="button" data-inline="true" data-mini="true" data-theme="c">
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">{{addrs}}</span>
						</a-->
					{{/if}}
						
						{{#if css4}}
							<a onclick="{{addr}}('','{{tid}}');"  data-role="button" data-inline="true" data-mini="true" data-theme="c">
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">{{addrs}}</span>
						</a>
						{{/if}}
						
<div style="{{css1}}">
			            	<a onclick="toclose('{{tid}}')" data-role="button" data-inline="true" data-mini="true" data-theme="c"  ><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">关闭订单</span></a>
			            	<a onclick="updatepost('{{tid}}');" data-role="button" data-inline="true" data-mini="true"   data-theme="c"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">一键免邮</span></a>
			            	<a onclick="showprice('{{tid}}')" data-role="button" data-inline="true" data-mini="true" data-theme="c"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">修改价格</span></a>
			             </div>							
				 </div>
              <div id ="versionpd{{tid}}" style="margin-left:-10px;margin-right:-10px;" >
						<hr />
				<div id="selerws{{tid}}" style="margin-top: -5px;">

              </div>
  				<div id="addrws{{tid}}" style="margin-top: -5px;margin-left:-5px;">

                    </div>
			</div>
			</div>
    </script>
    <script id="orderlist_template" type="text/x-handlebars-template">
<table class="ddtable pcwwtable">
                  <tr>
                  <td width="60">
                    <a href="javascript:copyww('http://item.taobao.com/item.htm?id={{num_id}}');">
							{{#if pic_path}}
								<img alt="商品图片" src="{{pic_path}}_60x60.jpg" title="发送商品连接" />
							{{else}}
								<img alt="商品图片" src="http://cdn.zzgdapp.com/trade/web/images/imgnull.gif" width="60" height="60" title="发送商品连接" />
							{{/if}}
					</a><p class="monney" style="padding:0; margin:0; font-size:12px; text-align:center">{{refund_status}}</p></td>
                    <td valign="top">
                     <a href="javascript:changetosp('{{num_id}}')" title="{{titles}}" style="text-decoration:none;"><h3 class="font_wsl" style=" margin:0; padding:0;font-size:12px; line-height:14px;">{{title}}</h3></a>
                    <p style=" margin:0; padding:0;line-height:14px;"><span class="monney">{{price}}</span>元 x {{num}}
					
						{{#if css2}}
							<span><a href="javascript:void(0);" onclick="gorefundDetail('{{tid}}','{{refunid}}');">退款信息</a></span></p>
						{{/if}}
						
					<p style=" margin:0; padding:0;line-height:14px;{{adjustshow}}">手工调整:{{adjust_fee}}</p>
					<p id="promotion{{oid}}" style=" margin:0; padding:0;line-height:14px;color: red;" ></p>
					<p class="font_wsl" style=" margin:0; padding:0;line-height:14px; font-weight:normal;"><a href="javascript:copyww('{{sku_properties_name}}');" title="转发商品属性" style="color:#a99c8b;font-weight:normal;text-decoration:none;" id="skuname{{oid}}">{{sku_properties_name}}</a>
{{#if isupsku}}
<a href="javascript:void(0)" onclick="upsku('{{oid}}','{{num_id}}','{{sku_properties_name}}','{{pic_path}}')" title="修改订单属性" style="font-weight:normal;text-decoration:none;">[修改]</a>
{{/if}}
</p>
                    <p style=" margin:0; padding:0;line-height:14px;">商家编码:{{outer_sku_id}}</p>
                    </td>
				</tr>
</table>

 <!--             				<li>
                    <table class="ddtable">
                      <tr>
                        <td width="60"><img alt="商品图片" src="{{pic_path}}_60x60.jpg" /><p class="monney" style=" padding-top:6px; text-align:center">{{refund_status}}</p></td>
                        <td><h3 class="font_wsl" style=" margin:0; padding:0;font-size:12px; line-height:14px;">{{title}}</h3>
					<p style=" margin:0; padding:0;line-height:14px;" class="font_wsl">{{sku_properties_name}}</p>
					 <p style=" margin:0; padding:0;line-height:14px;"><span class="monney">{{price}}</span>元 x {{num}}</p>
						</td>
                      </tr>
                    </table>
              </li>-->
</script>
<script id="upskulist_template" type="text/x-handlebars-template">
<table class="ddtable pcwwtable">
                  <tr>
                  <td width="60">
                    <a href="javascript:copyww('http://item.taobao.com/item.htm?id={{num_id}}');"><img alt="商品图片" src="{{pic_path}}_60x60.jpg" title="发送商品连接" /></a></td>
                    <td valign="top">
                     <a href="javascript:changetosp('{{num_id}}')" title="{{titles}}" style="text-decoration:none;"><h3 class="font_wsl" style=" margin:0; padding:0;font-size:12px; line-height:14px;">{{title}}</h3></a>
					<p class="font_wsl" style=" margin:0; padding:0;line-height:14px; font-weight:normal;"><a href="javascript:copyww('{{sku_properties_name}}');" title="转发商品属性" style="color:#a99c8b;font-weight:normal;text-decoration:none;" id="upskuname">{{sku_properties_name}}</a></p>
                    </td>
				</tr>
</table>
</script>
    
    <script id="pricelist1_template" type="text/x-handlebars-template">
<h3 style="font-size:12px;">订单原价(不含运费)：<span class="monney">{{total_fee}}</span> 元</h3>
</script>
<script id="pricelist2_template" type="text/x-handlebars-template">
		<h3 style="font-size:12px;">{{title}}</h3>
        <p style="font-size:12px;">{{sku_properties_name}}</p>
        <p style="font-size:12px;">{{price}} X {{num}}</p>
		<div class="formk"><label for="slider-{{oid}}"><span style="font-size:12px;">涨价或折扣(元)</span></label>
<div class="ui-grid-b">
				<div class="ui-block-a" style="width:40%;"><input type="text" data-inline="true" data-mini="true" class="rebate" id="rebate-{{oid}}" value="{{zhe}}" /></div>
				<div class="ui-block-b" style="width:20%;"><p style="font-size:16px;color:#333;text-align:center; padding-top:14px;">折 =</p></div>
				<div class="ui-block-c" style="width:40%;"><input type="text" data-inline="true" data-mini="true" class="money" name="slider-{{oid}}" id="slider-{{oid}}"   value="{{jiage}}" /></div>
</div>
        </div>
</script>   
    

<script id="pricelist3_template" type="text/x-handlebars-template">
	<div class="formk">
	{{#if isyhname}}
    {{yhname}}:<span style="color:#f00;style="font-size:12px;"">{{tdiscount_fee}}</span></p>
	{{/if}}
    <label for="username" style="font-size:12px;">邮费(元)</label>
    <input  type="text" name="post_fee" id="post_fee" data-inline="true" data-mini="true" class="money_post" value="{{post_fee}}" /></div>
	<h3 style="font-size:12px;" >买家实付:<span id="all" class="monney">{{payment}}</span>元</h3>
      <p id="fangwei" style="font-size:12px;">该订单价格的修改范围是：<br/>{{min}}=<买家实付<={{max}}</p>       	
		<div class="ui-body">
		<fieldset class="ui-grid-a">
				<div class="ui-block-a">
		            	<a onclick="freepost();" data-role="button" id ="free" data-inline="true" data-mini="true" data-theme="e"  >
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">免运费</span>
						</a>
</div>
				<div class="ui-block-b">
		            	<a onclick="updateprice('{{tid}}');" data-role="button"  data-inline="true" data-mini="true" data-theme="e"  >
							<span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确　定</span>
						</a>
</div>
	    </fieldset>
		</div>
      <p style="font-size:12px;">订单价格修改范围（必须同时满足以下两个条件）：</p>
      <p style="font-size:12px;">1、-50=<(订单原价-修改后订单金额)<=200；</p>
      <p style="font-size:12px;">2、修改后订单金额必须>=(订单原价*70%)。</p>
	
	</script>
	
	<script id="addbeiw_template" type="text/x-handlebars-template">

            <input type="radio" name="flag" value="1" {{flag1}} />
            <img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_1.png" style="float:left;" width="12" height="12" alt="红旗">
            <input type="radio" name="flag" value="2" {{flag2}} />
            <img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_2.png" style="float:left;" width="12" height="12" alt="黄旗">
            <input type="radio" name="flag" value="3" {{flag3}} />
            <img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_3.png" style="float:left;" width="12" height="12" alt="黄旗">
            <input type="radio" name="flag" value="4" {{flag4}} />
            <img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_4.png" style="float:left;" width="12" height="12" alt="黄旗">
            <input type="radio" name="flag" value="5" {{flag5}} />
            <img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_5.png" style="float:left;" width="12" height="12" alt="黄旗">
<br>
	<select id="selfastbeiw" onchange="changefastbeiw()">
		<option value=''>请选择备忘短语</option>
	</select>
<div class="formk"><textarea cols="40" rows="8" name="textareas" id="textareas">{{memo}}</textarea></div>
<!--<div class="ui-grid-a">
<div class="ui-block-a"><button type="button" onclick="tofast();" data-theme="c" data-ajax="false"  ><span style="margin:0 -15px;" class="font_wsl">插入常用短语</span></button></div>
	<div class="ui-block-b"><button type="button" onclick="addbeiw();" data-theme="a">确定</button></div>
</div>-->
<button type="button" onclick="addbeiw('{{tid}}');"  data-mini="true" data-theme="c"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">确定</span></button>
</script>


<script id="sendlist2_template" type="text/x-handlebars-template"> 
<p class="font_wsl" style="font-size:12px;margin:0; padding:0; line-height:1.2em">收货地址：{{receiver_name}},{{receiver_phone}}{{receiver_state}}{{receiver_city}}{{receiver_district}}{{receiver_address}},{{receiver_zip}}</p>
</script>
<script id="sendlist_template" type="text/x-handlebars-template"> 
<li>

<fieldset id="batchsend{{oid}}" data-inline="true" data-mini="true"  data-role="controlgroup" style="margin-top: -10px;">
	<input type="checkbox" name="batchcheckbox" id="checkbox_{{value}}"  class="custom" value="{{oid}}" />
	<label for="checkbox_{{value}}">
			<table class="ddtable">
                      <tr>
                        <td width="40"><img alt="商品图片" src="{{pic_path}}_40x40.jpg" /></td>
                        <td><h3 style="font-size:12px; margin:0; padding:0; line-height:1.2em">{{title}}</h3>
						<p style="font-size:12px;margin:0; padding:0;">
                        <span class="monney">{{num}}</span>件，共<span class="monney">{{total_fee}}</span>元</p>
						<p style="font-size:12px;margin:0; padding:0;">{{sku_properties_name}}</p></td>
                      </tr>
                    </table>
	</label>
</fieldset>	
</li>
<!--		 <li>
                    <table class="ddtable">
                      <tr>
                        <td width="40"><img alt="商品图片" src="{{pic_path}}_40x40.jpg" /></td>
                        <td><h3 style="font-size:14px; margin:0; line-height:1.2em">{{title}}</h3><p style="padding-top:8px;">
                        <span class="ww_online"><img src="http://amos.im.alisoft.com/online.aw?v=2&uid={{buyer_nick}}&site=cntaobao&s=2&charset=utf-8)" class="wwzx"/>{{buyer_nick}}</span>
                        <span class="monney">{{num}}</span>件，共<span class="monney">{{total_fee}}</span>元</p>
						<p>{{sku_properties_name}}</p></td>
                      </tr>
                      <tr>
                        <td colspan="2"><p class="font_wsl" style="margin:0; padding:0; line-height:1.2em">收货地址：{{receiver_name}},{{receiver_phone}}{{receiver_state}}{{receiver_city}}{{receiver_district}}{{receiver_address}},{{receiver_zip}}</p></td>
                      </tr>
                    </table>
        </li>-->
</script>
<script id="offtrade_template" type="text/x-handlebars-template"> 
<option value="{{code}}" >{{name}}</option>
</script>
<!-- 物流信息模版 -->
<script id="wllist_template" type="text/x-handlebars-template">
<h3><span style="font-weight:normal;" >发货信息</span><a data-role="button"  onclick="copyww('{{texts}}');" data-inline="true" data-mini="true" data-theme="c" class="pro_right"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">发送物流公司和单号</span></a></h3>
			<p>发货方式： {{type}}</p> 
			<p>物流编号：{{order_code}}</p>
			{{#if iscompany}}
			<p>物流公司： {{company_name}}{{#if iscname}}<a data-role="button" onclick="toresend('{{company_name}}');" data-inline="true" data-mini="true" data-theme="c" class="pro_right"  ><span style="font-weight:normal;" >修改</span></a>{{/if}}</p>
			{{/if}}
			{{#if isoutid}}
			<p>运单号码： {{out_sid}}</p>
			{{/if}}
	{{#if bfwl}}
   <h3><span style="font-weight:normal;" >物流跟踪</span><a data-role="button" data-ajax="false" onclick="copyww('{{text}}');" data-inline="true" data-mini="true" data-theme="c" class="pro_right"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">发送最新物流信息</span></a></h3>
	{{/if}}
</script>

<!-- 物流流转信息模版1 -->
<script id="wlxq_template" type="text/x-handlebars-template">
<p style="font-size:12px;margin:0; padding:1;"><span style="font-size:12px;color:#999; display:block; padding-bottom:3px;">{{status_time}}</span>{{status_desc}}</p>
</script>
<!-- 物流流转信息模版2 -->
<script id="wlxqz_template" type="text/x-handlebars-template">
<p style="font-size:12px;margin:0; padding:1;"><span class="monney"><span style="font-size:12px;color:#999; display:block; padding-bottom:3px;">{{status_time}}</span>{{status_desc}}</span></p>
</script>

<script id="ontrade_template" type="text/x-handlebars-template"> 
<option value="{{code}}" {{s}}>{{name}}</option>
</script>
<script id="ratelists_template" type="text/x-handlebars-template">
<form action="#" method="get">            
        <ul data-role="listview" data-theme="c">
				<li>
                    <img alt="商品图片" src="{{pic_path}}_60x60.jpg" />
                    <h3 class="bblib font_wsl">{{title}}</h3>
                    <p class="font_wsl">{{sku_properties_name}}</p>
              </li>
              </ul>
			<div class="formk" style="margin:20px 0 10px 0;">
			<input type="radio" name="radio{{oid}}"  id="radio-choice-c" value="good" />
            <img src="http://cdn.zzgdapp.com/trade/web/images/good.png" style="float:left;" width="12" height="12" alt="好评">
            <input type="radio" name="radio{{oid}}"  id="radio-choice-d" value="neutral" />
            <img src="http://cdn.zzgdapp.com/trade/web/images/neutral.png" style="float:left;" width="12" height="12" alt="中评">
            <input type="radio" name="radio{{oid}}" id="radio-choice-e" value="bad" />
            <img src="http://cdn.zzgdapp.com/trade/web/images/bad.png" style="float:left;" width="12" height="12" alt="差评">
	</form>


	<div class="formk"><textarea cols="40" rows="8" name="content{{oid}}" id="content{{oid}}"></textarea></div>      



</script>





<script id="addrlist_template" type="text/x-handlebars-template"> 
            <li data-role="fieldcontain">       	
            <fieldset data-role="controlgroup" data-inline="true" data-mini="true">
            	<legend style="font-size:12px; margin:0;padding:0;">省/市/区：</legend>
      			<div id="p_id">
			     <!-- 省 -->
			     </div>
			     <div id="c_id">
			     <!-- 市-->			    
			     </div>
			     <div id="d_id">
			     <!-- 区-->			     
			     </div>
			</fieldset>
		</li>
			<li data-role="fieldcontain">
	        	<label for="name" style="font-size:12px; margin:0;padding:0;" ><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">邮政编码：</span></label>
	        	<input type="text" name="receiver_zip" data-inline="true" data-mini="true"  id="receiver_zip" value="{{zip}}"  />
			</li>
			<li data-role="fieldcontain">
	        	<label for="name" style="font-size:12px; margin:0;padding:0;"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">街道地址：</span></label>
	        	<textarea cols="40" rows="4" name="receiver_address" data-inline="true" data-mini="true" id="receiver_address">{{address}}</textarea>
			</li>
			<li data-role="fieldcontain">
	        	<label for="name" style="font-size:12px; margin:0;padding:0;"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">收货人姓名：</span></label>
	        	<input type="text"  name="receiver_name" data-inline="true" data-mini="true" id="receiver_name" value="{{name}}"  />
			</li>
			<li data-role="fieldcontain">
	        	<label for="name" style="font-size:12px; margin:0;padding:0;"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">电话：</span></label>
	        	<input type="text" class="money" data-inline="true" data-mini="true" name="receiver_phone" id="receiver_phone" value="{{phone}}"  />
			</li>
			<li data-role="fieldcontain">
	        	<label for="name" style="font-size:12px; margin:0;padding:0;"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">手机：</span></label>
	        	<input type="text" class="money" data-inline="true" data-mini="true" name="receiver_mobile" id="receiver_mobile" value="{{mobile}}"  />
			</li>
         <div class="ui-body">

<div class="formk"><a data-role="button" data-theme="c"  data-mini="true"  onclick="upaddress();"  ><span style="margin:0 -6px; font-weight:normal;" class="font_wsl">确认修改</span></a></div>
		 </div>
				
</script>
<!-- 退款信息模版 -->
<script id="relist_template" type="text/x-handlebars-template">
			<div class="ddmiaoshu detail_div_top">
            <p style="font-size:12px;margin:0; padding:1;">　　退款编号：{{refund_id}}</p>
            <p style="font-size:12px;margin:0; padding:1;">申请退款时间：{{created}}</p>
            <p style="font-size:12px;margin:0; padding:1;">　　退款类型：{{order_status}}</p>
            <p style="font-size:12px;margin:0; padding:1;">　　退款状态：{{status}}</p>
            <p style="font-size:12px;margin:0; padding:1;">需要退款金额：{{refund_fee}} 元 </p>
            <p style="font-size:12px;margin:0; padding:1;">　　退款原因：{{reason}} </p>
            <p style="font-size:12px;margin:0; padding:1;">　　退款说明：{{desc}}</p>
        </div>
        <div class="ddmiaoshu detail_div_center">
        <div class="ui-grid-a">
        <div class="{{rebutcal}}"><a onclick="torememo({{refund_id}});"  data-role="button" data-mini="true" data-transition="none" data-ajax="false" data-theme="c"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">发表留言</span></a></div>
        {{#if isjj}}
        <div class="ui-block-b"><a onclick="torefuse('{{refund_id}}','{{tid}}','{{oid}}');" data-mini="true"  data-role="button"  data-theme="a" data-transition="none" data-ajax="false"><span style="margin:0; font-size:12px; font-weight:normal;" class="font_wsl">拒绝退款</span></a></div>
		{{/if}}
        </div>
        </div>
</script>
<script id="closelist_template" type="text/x-handlebars-template"> 
<li>
<fieldset id="close{{oid}}" data-inline="true" data-mini="true"  data-role="controlgroup" style="margin-top: -10px;">
	<input type="checkbox" name="closecheckcheckbox" id="closecheck_{{oid}}" checked  class="custom" value="{{oid}}" />
	<label for="closecheck_{{oid}}">
			<table class="ddtable">
                      <tr>
						{{#if pic_path}}
                        	<td width="40"><img alt="商品图片" src="{{pic_path}}_40x40.jpg" /></td>
						{{else}}
							<td width="40"><img alt="商品图片" src="http://cdn.zzgdapp.com/trade/web/images/imgnull.gif" width="40" heigth="40" /></td>
						{{/if}}
                        <td><h3 style="font-size:12px; margin:0; padding:0; line-height:1.2em">{{title}}</h3>
						<p style="font-size:12px;margin:0; padding:0;">
                        <span class="monney">{{num}}</span>件，共<span class="monney">{{total_fee}}</span>元</p>
						<p style="font-size:12px;margin:0; padding:0;">{{sku_properties_name}}</p>
						<p style="font-size:12px;margin:0; padding:0;">{{outer_iid}}</p></td>
                      </tr>
                    </table>
	</label>
</fieldset>	
</li>
</script>
<script id="rememo_template" type="text/x-handlebars-template">
   {{#if owner_role}}
   <div class="liuy_l ui-body-d">

   <p style="font-size:12px;margin:0; padding:1;" class="ddtime">{{created}}</p>

   <p style="font-size:12px;margin:0; padding:1;" >{{content}}</p>
	<div id="repic{{tid}}">
	</div>
	
   </div>
   {{else}}
   <div class="liuy_r ui-body-e">

   <p style="font-size:12px;margin:0; padding:1;" class="ddtime">{{created}}</p>

   <p style="font-size:12px;margin:0; padding:1;">{{content}}</p>

   </div>
   {{/if}}
   <div class="clear"></div>
</script>
<script id="repic_template" type="text/x-handlebars-template">
<p style="font-size:12px;margin:0; padding:1;"><img  style="max-width:200px;" alt="商品图片" src="{{pic_path}}"/></p>
</script>
<script type="text/javascript" src="http://cdn.zzgdapp.com/trade/web/yunyin/autorates.js" ></script>
</body>
</html>
