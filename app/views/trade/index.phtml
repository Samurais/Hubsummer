<!DOCTYPE html>
<html lang="en" manifest='jywebcacheapp.manifest'>
<?php require_once ("app/views/public/head.php");?>
<!-- <script src="http://cdn.zzgdapp.com/trade/web/js/html5sql.js"></script> -->
<style type="text/css">
    .abc {
        background-color: #CCC;
        width: 200px;
        overflow:hidden;
        text-overflow:ellipsis;/*文字溢出的部分隐藏并用省略号代替*/    
        white-space:nowrap;/*文本不自动换行*/
</style>
<style>
#cuxiao{width: 260px ; background: #fefefd url('http://cdn.zzgdapp.com/trade/web/yunyin/bg.jpg') repeat-x ; border: 1px #52524a solid;  font-size: 12px ;  color: #000000 ; font-family: "微软雅黑", "黑体", "宋体",Helvetica,Arial, sans-serif;  }
.bt { border-width: 0px 0px 1px 0px; border-color: #eeeeee ; border-style: solid ; padding: 5px 10px ; }
.bt_left { float: left ;  }
.bt_right { float: right ; }
.nr { line-height: 18px ; padding: 10px ; color: #005580 ; }
.nrbt { text-align: center ; font-weight: bold ; }
.nrwz { padding: 5px ; }
.foot { border-width: 1px 0px 0px 0px; border-color: #eeeeee ; border-style: solid ; padding: 5px 10px ;  }
.yhj { color: #bb0000 ; font-weight: bold; }
.yhj span { text-decoration:line-through; font-weight: normal ; color: #666666 ; }
.clear{ clear:both; overflow:hidden;}
.postion{position:fixed;right:0px;bottom:0px;z-index:999999;}
.djs{ text-align: right ; color: #ff8800; font-weight: bold ; padding: 0px 5px; }

#cuxiaos{width: 260px ; background: #fef7f7 url('http://cdn.zzgdapp.com/trade/web/yunyin/bg2.jpg')  repeat-x ; border: 1px #52524a solid;  font-size: 12px ;  color: #000000 ; font-family: "微软雅黑", "黑体", "宋体",Helvetica,Arial, sans-serif;  }
.bts { border-width: 0px 0px 1px 0px; border-color: #dddddd ; border-style: solid ; padding: 5px 10px ; }
.well{
	min-height: 20px;
	padding: 19px;
	margin-bottom: 20px;
	background-color: #f5f5f5;
	border: 1px solid #e3e3e3;
	-webkit-border-radius: 4px;
	-moz-border-radius: 4px;
	border-radius: 4px;
	-webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
	-moz-box-shadow: inset 0 1px 1px rgba(0,0,0,0.05);
	box-shadow: inset 0 1px 1px rgba(0,0,0,0.05)
}
</style>
<body >
<?php require_once ("app/views/public/top.php");?>
<div style="margin-left: 10px;" class="container">
	<div  id="adv_top" style="display:none;margin-top: 10px;margin-right: 10px;">
    </div>
	<div id="index_content">
           <form class="sui-form sui-row-fluid form-horizontal" style="margin-top: 10px;" >
				<label>买家昵称：</label>
					<div class="input-control control-right">
					   <input type="text" class="input-fat" id="sselectnick" onkeypress="event.keyCode==13?sselect():'';"><i class="sui-icon icon-touch-magnifier"></i>
					</div>
            <label>订单编号：</label>
            <div class="input-control control-right" >
				<input type="text" class="input-fat" id="sselecttid" onkeypress="event.keyCode==13?sselect():'';"><i class="sui-icon icon-touch-magnifier"></i>
			</div>
            <label>订单状态：</label>
         	<span class="sui-dropdown dropdown-bordered select">
				<span class="dropdown-inner">
					<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle" >
       		    		<input  value="all"  type="hidden" >
       		    		<i class="caret"></i>
       		    		<span>所有</span>
       		    	</a>
        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="sselectsta" >
           				<li role="presentation" pointstu="pointstu" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="all">所有</a></li>
            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="dfk">待付款</a></li>             
            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="dfh">待发货</a></li>
            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="yfh">已发货</a></li>
            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="tkz">退款中</a></li>
            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="dpj">待评价</a></li>
            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="sussce">已成功</a></li>
            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="close">已关闭</a></li>
        			</ul>
			</span>
		</span>
             <a href="javascript:sselect();" class="sui-btn btn-primary">查询</a>
			<!--<div class="span4">
				<div class="control-group">
					<label class="control-label" for="input001">成交时间：</label>
					<div class="controls">
						<input class="input-thin input-small" type="text" name="" id="input001" ><label for="input002"> 至 </label>
						<input class="input-thin input-small" type="text" name="" id="input002">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="input003">分销商：</label>
					<div class="controls">
						<input class="input-thin" type="text" name="" id="input003">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="input004">产品名称：</label>
					<div class="controls">
						<input class="input-thin" type="text" name="" id="input004">
					</div>
				</div>
			</div>
			<div class="span4">
				<div class="control-group">
					<label class="control-label" for="input005">采购单编号：</label>
					<div class="controls">
						<input class="input-thin" type="text" name="" id="input005">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="input006">订单编号：</label>
					<div class="controls">
						<input class="input-thin" type="text" name="" id="input006">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="input007">收货人：</label>
					<div class="controls">
						<input class="input-thin" type="text" name="" id="input007">
					</div>
				</div>
			</div>
			<div class="span4">
				<div class="control-group">
					<label class="control-label" for="select001">支付类型：</label>
					<div class="controls">
						<select class="input-thin input-medium" name="" id="select001">
							<option value="">所有</option>
						</select>
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="select002">采购单类型：</label>
					<div class="controls">
						<select class="input-thin input-medium" name="" id="select002">
							<option value="">所有</option>
						</select>
					</div>
				</div>
				<div class="control-group">
					<label class="control-label">&nbsp;</label>
					<div class="controls"><button class="sui-btn btn-default btn-small" type="submit">搜索</button></div>
				</div>
			</div>-->
		</form>
        <ul class="sui-nav nav-tabs nav-large"  id="myTab" style="font-size: 13px;">
	      <li id="threemonth" class="active"><a	data-toggle="tab" href="#all" onclick="getordersta('all','1');">近三个月<span id="allnum"></span></a></li>
	      <li id="daipayorder"><a data-toggle="tab" href="#dfk" onclick="getordersta('dfk','1');">待付款<span id="dfknum"></span></a> </li>
	      <li id="daiSend"><a data-toggle="tab" href="#dfh" onclick="getordersta('dfh','1');">待发货<span id="dfhnum"></span></a> </li>
	      <li id="SendOK"><a data-toggle="tab" href="#yfh" onclick="getordersta('yfh','1');">已发货<span id="yfhnum"></span></a> </li>
	      <li id="isTuiKuan"><a data-toggle="tab" href="#tkz" onclick="getordersta('tkz','1');">退款中<span id="tkznum"></span></a> </li>
	      <li id="NeedRate"><a data-toggle="tab" href="#dpj" onclick="getordersta('dpj','1');">需要评价<span id="dpjnum"></span></a> </li>
          <li id="isSuccess"><a data-toggle="tab" href="#sussce" onclick="getordersta('sussce','a');">已成功<span id="susscenum"></span></a></li>
          <li id="isLoser"><a data-toggle="tab" href="#close" onclick="getordersta('close','a');">已关闭<span id="closenum"></span></a></li>
          <li id="ThreeMonthQian" style="display:none;"><a id="isthreemonth" href="javascript:void(0);" onclick="lookhistory()">三个月前</a></li>
	    </ul>
        <div style="text-align:left;" >
        	<label class="checkbox-pretty inline">
        		<input type="checkbox"  id="tradeqx" name="onsale_bbs" value="option1" class="tradeqx" />&nbsp;<span class="lbl" >全选</span>
        	</label>
            <button class="sui-btn btn-bordered  btn-primary" onclick="sendmore('send');" id="plsbut">批量发货</button>
            <button class="sui-btn btn-bordered btn-primary" onclick="sendmore('post');" id="plpbut">批量免邮</button>
            <button class="sui-btn btn-bordered  btn-primary" onclick="sendmore('memo');">批量备注</button>
            <button class="sui-btn btn-bordered  btn-primary" onclick="sendmore('task');" style="display:none;" id="addtaskpl">批量添加任务</button>
            <label id="hideids" class="checkbox-pretty inline" style="margin-left: 5px;"><input type="checkbox"  id="checkboxhide" onclick="hideonclick();"/><span>不显示已关闭订单<font color="red" id="hidenum">0</font></span></label>
            <button style="float: right;display:none;margin-right:10px;" id="taskgl" class="sui-btn btn-warning" onclick="showrwgl();">任务管理</button>
            <!-- <a href="http://cdn.zzgdapp.com/trade/web/html/logistics?vers=1.2.6" style="float: right;" class="sui-btn btn-small btn-warning" >物流管理</a> -->
        </div>
       </div>
        <div class="tab-content">
        	<div id="all" class="tab-pane active">
				<div id="all_list" style="margin-top:10px;">
				</div>
			</div>
				 	
		<div id="dfk" class="tab-pane">
			<div id="dfk_list" style="margin-top:10px;">
		    </div>
		</div>
				  	
		<div id="dfh" class="tab-pane">
			<div id="dfh_list" style="margin-top:10px;">
			</div>
		</div>
				  	
		<div id="yfh" class="tab-pane">
		    <div id="yfh_list" style="margin-top:10px;">
			</div>
		</div>
				  	
		<div id="tkz" class="tab-pane">
			<div id="tkz_list" style="margin-top:10px;">
			</div>
		</div>
				 	 
		<div id="dpj" class="tab-pane">
			<div id="dpj_list" style="margin-top:10px;">
		    </div>
		</div>
				 	
		<div id="sussce" class="tab-pane">
			<div id="sussce_list" style="margin-top:10px;">
		    </div>
		</div>
				  	
		<div id="close" class="tab-pane">
			<div id="close_list" style="margin-top:10px;">
		    </div>
		</div>
		<div id='detail' class="tab-pane">
			<div id='detail_list' style="margin-top: 10px;">
				<div class="well">
            		<h5 style="margin-top:0;">订单状态：<span id="tdsta"></span></h5>
            		<a style="float: right;margin-top: -35px;" class="sui-btn btn-primary" onclick="gobackindex()" data-toggle="tab" id="detail_back">返回</a>
            		<p id="gettimeinfo" style="text-align:left;"></p>
           			<div style="margin-top: -8px;margin-top: -11px;" id="buyercon"></div>
            		<div style="margin-left: -14px;" style="text-align:left;" id="tdbtn"></div>
        		</div>
        		<div class="well" style="background-color:#fff;">
		            <h5 style="margin-top:0;">订单信息</h5>
		            <p id="tbuserifo"></p>
		            <table class="sui-table table-bordered table-striped table-hover" id="tditem"></table>
		             <div id="tdprice"></div>
		              <div id="codprice"></div>
		              <hr style="margin-left: -9px;">
		              <div class="sui-row-fluid" style="/*border:1px solid #DDDDDD;margin-bottom:5px;border-radius: 3px;*/">
		                <div class="span6" id="tdbuy">
		                </div>
		                <div class="span6" id="tdtid">
		                </div>
            		</div>
       			</div>
    				<table class="sui-table table-bordered" >
        				<tr>
            				<td >
                    			<div class="sui-row-fluid">
                                	<div id="Dbfselects" >
            							<select  id="Dbfselect" onchange="Dshowbg();"></select>
						
            						</div>
                        			<div class="span12" id="tdwuliu">
                            			<h5 style="margin-top:0;">收货和物流信息</h5>
                            			<p>收货地址：
                                			<button class="sui-btn btn-primary" >核对地址</button>
                                			<button class="sui-btn btn-primary">修改地址</button>
                            			</p>
                            			<p>运送方式：</p>
                            			<p>物流公司名称：</p>
                            			<p>运单号：<button class="sui-btn btn-primary"  >点击查看物流信息</button></p>
                        			</div>
                    			</div>
            				</td>
        				</tr>
    				</table>
        		<div class="well" style="background-color:#fff;" id="wltab" style="display:none;">
                	<div class="sui-row-fluid">
                		<div class="span12" id="Dtdwldatas">
                		</div>
                   	</div>
        		</div>
			</div>
		</div>
	</div>
		<div id="chapfys"></div>
        <div id="chapfysall"></div>
        <div id="chapfysdfk"></div>
        <div id="chapfysdfh"></div>
        <div id="chapfysyfh"></div>
        <div id="chapfystkz"></div>
        <div id="chapfysdpj"></div>
        <div id="chapfyssussce"></div>
        <div id="chapfysclose"></div>
</div>
 	 <!--Profile Form修改邮费-->
	<div id="editpost-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="560px" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">修改邮费</h4>      
				</div> 
				 <div class="modal-body">
		 			邮费将改为<input data-mini="true" type="text"  id="editpostval" style="width:88px;"/>元
	        	</div>
	        	<div class="modal-footer">     
					<button class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="editpost();">确定</button>    
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form订单改价 -->
    <div id="price-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="560px" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">订单改价</h4>      
				</div> 
				<div class="modal-body" id="pricebody" style="overflow:scroll;overflow-x:hidden; height: 300px;"></div>
				<div class="modal-footer">     
					<button class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="editprice();">确定</button>    
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form免邮-->
         <div id="postfree-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">一键免邮 </h4>      
				</div> 
		 <div class="modal-body" ><p>邮费将改为0元</p></div>
		 <div class="modal-footer">     
					<button class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="postfree();">确定</button>    
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form关闭订单-->
	<div id="close-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="560px" style="display:none;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">关闭订单 </h4>      
				</div> 
		 		<div class="modal-body" style="overflow:scroll;overflow-x:hidden; max-height: 285px;">
					<div id="close_refsh" class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>
					<span id="readMemo"></span>
		        	<table class="sui-table table-bordered" id="closelist">
               		</table>
		 			<div class="alert" >请您在与买家达成一致的前提下，使用关闭交易这个功能哟!</div>
                	<span style="margin-top: 20px;"><b>请选择关闭该交易的理由：</b></span>
                		<span class="sui-dropdown dropdown-bordered select">
							<span class="dropdown-inner">
								<a id="select" role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
	       		    				<input id="tidclose" value=""  type="hidden">
	       		    				<i class="caret"></i>
	       		    				<span id="pointval">请选择关闭该交易的理由</span>
       		    				</a>
		        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu">
		           				<li role="presentation" pointstu="pointstu" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="请选择关闭该交易的理由">请选择关闭该交易的理由</a></li>
		            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="未及时付款">未及时付款</a></li>             
		            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="买家联系不上">买家联系不上</a></li>
		            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="谢绝还价">谢绝还价</a></li>
		            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="商品瑕疵">商品瑕疵</a></li>
		            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="协商不一致">协商不一致</a></li>
		            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="买家不想买">买家不想买</a></li>
		            			<li role="presentation" pointstu="pointstu"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="与买家协商一致">与买家协商一致</a></li>
		        			</ul>
						</span>
					</span><br>
                	<span style="color: #ff9a00">温馨提示：</span>
                	<p>1.为提升买家购物体验，您可以赠送买家店铺优惠券;</p>
                	<p>2.拍下后减库存的商品，在关闭交易后，系统会自动恢复商品库存，但不会影响已下架商品的状态。</p></div>
                <div class="modal-footer">     
					<button class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="tidclose();">确定</button>    
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form修改备注 -->
	<div id="beiw-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="570px" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">修改备注</h4>      
				</div>      
		 		<div class="modal-body" style="overflow: initial;">
                	<table  class="sui-table table-striped table-bordered table-hover" style="width:540px;">
                    	<tr >
                    		<td>标记(旗帜):</td>
                    		<td>
	                            <input style="margin-left: 20px" type="radio" name="beiwf" value="1" /><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_1.png" width="12" alt="红"></span>
	                            <input style="margin-left: 20px" type="radio" name="beiwf" value="2" /><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_2.png" width="12" alt="黄"></span>
	                            <input style="margin-left: 20px" type="radio" name="beiwf" value="3" /><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_3.png" width="12" alt="绿"></span>
	                            <input style="margin-left: 20px" type="radio" name="beiwf" value="4" /><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_4.png" width="12" alt="蓝"></span>
	                            <input style="margin-left: 20px" type="radio" name="beiwf" value="5" /><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_5.png" width="12" alt="紫"></span>
                        	</td>
                        </tr>
                    	<tr >
                    		<td>选择常用短语:&nbsp;&nbsp;</td>
                        	<td>
					            <span class="sui-dropdown dropdown-bordered select">
									<span class="dropdown-inner">
										<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
											<input id="hidden" value="" type="hidden" onchange="memochoice()" />
											<i class="caret"></i>
       										<span>请选择备注短语</span>
       									</a>
						        		<ul role="menu" id="memone" aria-labelledby="drop4" class="sui-dropdown-menu"></ul>           	
									</span>
								</span>         	
                        	</td>
                        </tr>
                   		<tr >
                   			<td>卖家备注:</td>
                   			<td><textarea class="span12" id="beiwtext"  placeholder="" style="margin-top: 5px;width:400px" data-rules="required" name=beiwtext"></textarea></td>
                   		</tr>
                	</table>
                	<div class="sui-msg msg-large msg-tips">
  						<div class="msg-con">淘宝网系统不会修改任何交易备忘请勿备注个人敏感信息。若不是本人填写，请小心被骗</div>
  						<s class="msg-icon"></s>
					</div>
            	</div>
				<div class="modal-footer">     
					<button class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="addbeiw();">确定</button>    
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form发货 -->
	<div id="senditem-table"  class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="570px" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">发货</h4>      
				</div>    
		  <div class="modal-body" style="max-height: 400px;">
                <div class="sui-row-fluid">
                    <div class="span6"><b>请选择发货方式：</b>
                       <!-- <select id="sendplan">
                            <option value='offline' >自己联系</option>
                            <option value='online'>在线下单</option>
                            <option value='notsend'>无需物流</option>
                        </select>-->
                        <span class="sui-dropdown dropdown-bordered select">
							<span class="dropdown-inner">
							<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;max-width: 360px;">
								<input value="offline" type="hidden" onchange="a_offline()">
								<i class="caret"></i>
       							<span>自己联系</span>
       						</a>
		        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="sendplan">
		        				<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="offline">自己联系</a></li> 
		        				<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="online">在线下单</a></li>
		        				<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="notsend">无需物流</a></li>
		        			</ul>
						</span>
					</span>  
                    </div>
                    <div class="span6" id="wuliush1"><b>请选择物流公司：</b>
                       <!-- <select id="comptyid">
                        </select>-->
                         <span class="sui-dropdown dropdown-bordered select">
							<span class="dropdown-inner">
							<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;max-width: 360px;">
								<input value="offline" type="hidden" onchange="c_offline()">
								<i class="caret"></i>
       							<span></span>
       						</a>
		        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="comptyid">
		        				<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="offline">自己联系</a></li> 
		        			</ul>
						</span>
					</span>  
                    </div>
                </div>
                <div id="off_other">
                </div>
                <div id="wuliush2">
                <p style="margin: 0; padding: 0;"><b>运单号：</b><input style="float: none;" type="text"  class="span4" id="postid" value="" />
                </p>
                </div>
                <span  id="send_refsh" style="text-align:center; padding:0 5px;">
					<img src="http://cdn.zzgdapp.com/trade/mobile/images/loding.gif" align="absmiddle" />订单加载中...
				</span>
<table class="sui-table table-bordered" id="sendlist" style="margin-top: 12px;">
                </table>
                <div id="nohavasendaddr">
                	
                </div>
                <div id="selectsend">
	          <b>选择我的发货地址：</b>
	           <span class="sui-dropdown dropdown-bordered select">
				<span class="dropdown-inner">
					<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;max-width: 360px;">
						<input value="" type="hidden">
						<i class="caret"></i>
       					<span>请选择发货地址</span>
       				</a>
        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="selectaddrQ">
        			</ul>
				</span>
			</span>   
	        <br/><br/>
	        <b>选择我的退货地址：</b>
	        <span class="sui-dropdown dropdown-bordered select">
				<span class="dropdown-inner">
					<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;max-width: 360px;">
						<input value="" type="hidden">
						<i class="caret"></i>
       					<span>请选择退货地址</span>
       				</a>
        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="selectbackaddr">
        			</ul>
				</span>
			</span>  
	          </div>
                <div class="alert">支持拆单发货；设置默认物流公司，方便您的发货</div>
            </div>
            <div class="modal-footer">     
					<button class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="sendplan();">确定发货</button>    
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form货到付款 -->
    <div id="sendcoditem-table"  class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="570px" style="display:none;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">货到付款</h4>      
				</div> 
		  <div class="modal-body" style="overflow:scroll;overflow-x:hidden;">
		  <div class="sui-row-fluid">
                            <b>请选择物流公司：</b>
					            <span class="sui-dropdown dropdown-bordered select">
									<span class="dropdown-inner"><a  role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
					      		    	<input value="ZJS" id="codcomptyid" type="hidden"><i class="caret"></i><span>宅急送</span></a>
					        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu">
					            			<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="ZJS">宅急送</a></li>             
					            			<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="YTO">圆通速递</a></li>
					            			<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="UAPEX">全一快递</a></li>
					            			<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="SF">顺丰速递</a></li>
					            			<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="FEDEX">联邦快递</a></li>
					            			<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="SCWL">尚橙物流</a></li>
					            			<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="GDEMS">广东EMS</a></li>
					        			</ul>
									</span>
								</span>
                        </div>
                        <p style="margin: 0; padding: 0;">
                        	<b>运单号：</b><input style="float:none;" type="text"  class="span4" id="codpostid" value="" />
                       	</p>
              <table class="sui-table table-bordered" id="sendcodlist" style="margin-top: 12px;">
              </table>
              <b>选择我的发货地址：</b>
              <!--<select id="selectaddrW" style="width: 400px;" >
	          </select>-->
	          <span class="sui-dropdown dropdown-bordered select">
				<span class="dropdown-inner"><a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;max-width: 360px;">
      		    	<input value="" type="hidden"><i class="caret"></i><span>请选择退货地址</span></a>
        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="selectaddrW">
        			</ul>
				</span>
			</span>
	           <br/><br/>
	          <b>选择我的退货地址：</b>
	          <span class="sui-dropdown dropdown-bordered select">
				<span class="dropdown-inner"><a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle" style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;max-width: 360px;">
      		    	<input value="" type="hidden"><i class="caret"></i><span>请选择退货地址</span></a>
        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="selectbackaddrQ">
        			</ul>
				</span>
			</span>
             </div>
              <div class="modal-footer">     
					<button class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="codsendplan();">确定发货</button>    
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form评价 -->
         <div id="pingjia-table"  class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="570px" style="display:none;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">评价</h4>      
				</div> 
		 <div class="modal-body" id="pingjiadata" style="max-height: 350px;"></div>
		 <div class="modal-footer">  
					<input type="button" class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="pingjia();" value="确定评价" />
					<input type="button" class="sui-btn btn-default btn-large"  data-dismiss="modal" value="关闭">  
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form延长收货时间 -->
	<div id="shtime-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" >
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">延长收货时间</h4>      
				</div> 
				<div class="modal-body" style="overflow: initial;">
		        	<p>延长收货时间可以让买家有更多时间来”确认收货“，而不会急于去申请退款。</p>
		            <b>延长本交易的“确认收货”期限为：</b>
		             <span class="sui-dropdown dropdown-bordered select">
						<span class="dropdown-inner"><a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
					    	<input id="shday" value="3" type="hidden"><i class="caret"></i><span>3天</span></a>
					        <ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu">
					        	<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="3">3天</a></li>             
					            <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="5">5天</a></li>
					            <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="7">7天</a></li>
					            <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="10">10天</a></li>
					        </ul>
						</span>
					</span>
		   	  	</div>
				<div class="modal-footer">  
					<input type="button" class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="shaddtime();" value="确定" />
					<input type="button" class="sui-btn  btn-large"  data-dismiss="modal" value="关闭">  
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form查看物流-->
	<div id="wldata-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="570px" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">查看物流</h4>      
				</div>  
		 <div class="modal-body" style="max-height: 235px;">
            <div id="bfselects" style="display: block;">
            	<select  id="bfselect" onchange="showbg();"  >
					
				</select>
            </div>
            <div id="tdwldatas">
            </div>
            </div>
		<div class="modal-footer">        
			<div  id="wz">	
			</div>   
		</div>    
			</div>  
		</div>
	</div>
     <!--Profile Form收货地址-->
       <div id="addr-table"  class="sui-modal hide fade" role="dialog" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="500px" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">收货信息</h4>      
				</div> 
		 <div class="modal-body" style="overflow: inherit;">
		 <div class="sui-form">
                <div id="addrinfo" style="display:none;"><p style="margin: 10px 10px 0px 10px;"><span style=""></span></p>
                    </div>
                <div id="addradd" >
                    <div class="sui-control-group">
                        <div class="controls" style="margin-top: 10px;">
                            <span>省/市/区:</span>
                      	<span class="sui-dropdown dropdown-bordered select">
							<span class="dropdown-inner">
								<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
									<input value="" type="hidden" onchange="p_choiceH()">
									<i class="caret"></i>
						       		<span></span>
	       						</a>
	        					<ul role="menu" id="more_shen" aria-labelledby="drop4" class="sui-dropdown-menu" style="width: 50px;">
	        					</ul>
							</span>
						</span>  
                            <!--<select class="input-medium " data-rules="required" style="width: 130px;" id="more_shen"></select>-->
                             <!--   <option>省</option>-->
                            <span class="sui-dropdown dropdown-bordered select">
								<span class="dropdown-inner">
									<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
										<input value="" type="hidden" onchange="c_choiceH()">
										<i class="caret"></i>
						       			<span></span>
	       							</a>
	        						<ul role="menu" id="more_shi" aria-labelledby="drop4" class="sui-dropdown-menu" style="width: 50px;">
	        						</ul>
								</span>
							</span>  
                            <!--<select class="input-medium " data-rules="required" style="width: 130px;" id="more_shi"></select >-->
                             <!--   <option>市</option>-->
                            <span class="sui-dropdown dropdown-bordered select">
								<span class="dropdown-inner">
									<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
										<input value="" type="hidden">
										<i class="caret"></i>
						       			<span></span>
	       							</a>
	        						<ul role="menu" id="more_qu" aria-labelledby="drop4" class="sui-dropdown-menu" style="width: 50px;">
	        						</ul>
								</span>
							</span>  
                            <!--<select class="input-medium " style="width: 130px;" id="more_qu"></select>-->
                              <!--  <option>区</option>-->
                            
                        </div>

                        <div class="controls" style="margin-top: 10px;">
                            <span>邮政编码:</span>
                            <input style="width: 130px;" type="text" id="more_zip">
                        </div>
                        <div class="controls" style="margin-top: 10px;">
                            <span>收货人姓名:</span>
                            <input style="width: 130px;" type="text" id="more_name">
                            <span>街道地址:</span>
                            <input style="width: 150px;" type="text" id="more_address">
                        </div>
                        <div class="controls" style="margin-top: 10px;">
                            <span>电话:</span>
                            <input style="width: 130px;" type="text" id="more_phone">
                            <span>手机:</span>
                            <input style="width: 130px;" type="text" id="more_mobile">
                        </div>
                    </div>
                </div> 
                </div>
            </div>
            <div class="modal-footer">  
					<input type="button" class="sui-btn btn-primary btn-large" type="button" data-ok="modal" onclick="addeitd();" value="确定" />
					<input type="button" class="sui-btn  btn-large"  data-dismiss="modal" value="关闭">  
				</div>    
			</div>  
		</div>
	</div>
     <!--Profile Form批量发货-->
     <div id="plsend-table"  class="sui-modal hide fade" role="dialog" data-backdrop="static" tabIndex="-1" data-hasfoot="true" data-backdrop="static" data-width="570px" style="display:none;background-color:#FFF;">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">发货信息</h4>      
				</div>
		 <div class="modal-body" style="overflow:scroll;overflow-x:hidden; height: 300px;">
                        <div class="sui-row-fluid">
                            <div class="span6"><b>请选择发货方式：</b>
                                <!-- <select id="plsendplan">
                                    <option value='offline'>自己联系</option>
                                    <option value='online'>在线下单</option>
                                    <option value='notsend'>无需物流</option>
                                </select> -->
                                     <span  class="sui-dropdown dropdown-bordered select">
											<span class="dropdown-inner">
												<a  role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
							       		    		<input  value="offline" type="hidden" >
							       		    		<i class="caret"></i>
							       		    		<span>自己联系</span>
							       		    	</a>
							        			<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="plsendplan">
							           				<li role="presentation" pointstu="pointstu" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="offline">在线下单</a></li>
							            			<li role="presentation" pointstu="pointstu" class=""><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="online">自己联系</a></li>             
							            			<li role="presentation" pointstu="pointstu" class=""><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="notsend">自己联系</a></li>             
							        			</ul>
										</span>
									</span>
                                </div>
                            <div class="span6" id="plwuliush1"><b>请选择物流公司：</b>
                                <select id="ploncomptyid">
                                </select>
                            </div>
                        </div>
                         <div id="ploff_other">
                		</div>
                        <div id="plsend">
                        </div>
                    </div>
                     <div class="modal-footer">  
					<input id="plsendbut" onclick="" type="button" class="sui-btn btn-primary btn-large" type="button" data-ok="modal" value="确定发货" />
					<input type="button" class="sui-btn btn-primary btn-large"  data-dismiss="modal" value="关闭">  
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form批量备注-->
	<div id="plmemo-table" class="sui-modal hide fade" role="dialog" tabIndex="-1" data-backdrop="static" data-hasfoot="true" data-width="570px" style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">批量备注</h4>      
			</div>  
		 	<div class="modal-body" style="overflow:scroll;overflow-x:hidden; height: 300px;">
            	<table>
                	<tr >
                		<td>标记(旗帜):</td>
                		<td>
	                    	<input style="margin-left: 20px" type="radio" name="plbeiwf" value="1" /><span><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_1.png" width="12" alt="红"></span>
	                        <input style="margin-left: 20px" type="radio" name="plbeiwf" value="2" /><span><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_2.png" width="12" alt="黄"></span>
	                        <input style="margin-left: 20px" type="radio" name="plbeiwf" value="3" /><span><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_3.png" width="12" alt="绿"></span>
	                        <input style="margin-left: 20px" type="radio" name="plbeiwf" value="4" /><span><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_4.png" width="12" alt="蓝"></span>
	                        <input style="margin-left: 20px" type="radio" name="plbeiwf" value="5" /><span><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_5.png" width="12" alt="紫"></span>
                        </td>
                 	</tr>
                    <tr >
                    	<td>选择常用短语:&nbsp;&nbsp;</td>
                        <td>
                        <!--<select onchange="mmchoice()" style="width: 260px;"  class="conmemo" id="memomore"></select>-->
                          <span class="sui-dropdown dropdown-bordered select">
								<span class="dropdown-inner">
									<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
										<input id="hidden" value="" type="hidden" onchange="mmchoice()" />
										<i class="caret"></i>
       									<span>请选择备注短语</span>
       								</a>
						       		<ul role="menu" id="memomore" aria-labelledby="drop4" class="sui-dropdown-menu" style="max-height: 114px;overflow-y: auto;">            	
						           	</ul>
								</span>
							</span>
                         </td>
                  	</tr>																			
                    <tr >
                    	<td>卖家备注:</td>
                    	<td><textarea class="span12" id="plbeiwtext"  placeholder="" style="margin-top: 5px;width:400px"></textarea></td>
                    </tr>
             	</table>
                <table class="sui-table table-bordered" ><tbody id="plmemo"></tbody></table>
             </div>
			 <div class="modal-footer">        
					<button id="plmemobut" class="sui-btn btn-primary btn-large" type="button" data-ok="modal">确定</button>        
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form批量免邮-->
     <div id="plpost-table" class="sui-modal hide fade" role="dialog" data-backdrop="static" tabIndex="-1" data-hasfoot="true"  style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">批量免邮</h4>      
			</div>
		 <div class="modal-body" id="plpostmsg"></div>
		 <div class="modal-footer">        
					<button id="plpostbut" class="sui-btn btn-primary btn-large" type="button" data-ok="modal">确定</button>        
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--Profile Form订单属性修改 -->
     <div id="skuedit-table" class="sui-modal hide fade" role="dialog" data-backdrop="static" data-width="570px" tabIndex="-1" data-hasfoot="true"  style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">订单属性修改</h4>      
			</div>
		 <div class="modal-body" id="skubody" ></div>
		 <div class="modal-footer">        
					<button id="savesku" class="sui-btn btn-primary btn-large" type="button" data-ok="modal">确定</button>        
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 <!--
     	作者：chenlongke@loveapp.cn
     	时间：2014-04-21
     	描述：显示评价状况。。
     -->
  <div id="isdoulerate" class="sui-modal hide fade" role="dialog" data-backdrop="static" data-width="570px" tabIndex="-1" data-hasfoot="true"  style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">查看评价</h4>      
			</div>
         <div class="modal-body" style="max-height: 235px;">
	         <div class="sui-row-fluid">
	         	<div class="span6" id="Buyerratebody">
	         	</div>
	         	<div class="span6" id="Sellerratebody">
	         	</div>
	         </div>
         </div>
     	<div class="modal-footer">        
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	    <!-- 发送短信 -->
    <div id="sendsms_content" class="sui-modal hide fade" role="dialog" data-backdrop="static" data-width="470px" tabIndex="-1" data-hasfoot="true"  style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
				<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
				<h4 class="modal-title">发送短信<span id="smstitle" style="display: none;"></span><span style="display:none;" id="smstite_wangwang"></span>
            		<span id="company_name" style="display: none;"> </span>
            		<span id="out_sid" style="display: none;"></span>
           		 </h4>     
			</div>
		 <div class="modal-body" style="overflow: inherit;">
		 <div class="sui-form">
			 <span>接收手机号：<input id="sms_buyerphone" style="width: 79%;" type="text" /></span><br>
			 <span style="color: red;margin-left: 71px;">*输入对方的手机号，一次只能输入一个哦</span><br />
			 <span>选择类型：
			 	<span class="sui-dropdown dropdown-bordered select" style="width: 81%;margin-left:8px;">
					<span class="dropdown-inner" style="width: 100%;">
						<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
							<input value='' type="hidden" onchange="sms_template(this.value)">
							<i class="caret"></i>
	       					<span>请选择模版</span>
	       				</a>
	       				<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="sms_template" style="max-height: 114px;overflow-y: auto;">
	       				</ul>
	       			</span>
				</span> 
			 </span><br><br>
			 <span>选择模版：
			 	<span class="sui-dropdown dropdown-bordered select" style="width: 81%;margin-left: 8px;">
					<span class="dropdown-inner" style="width: 100%;">
						<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
							<input value='' type="hidden" onchange="smstemplat2change(this)">
							<i class="caret"></i>
	       					<span>请选择模版</span>
	       				</a>
	       				<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="sms_template2" style="max-height: 114px;overflow-y: auto;">
	       				</ul>
	       			</span>
				</span>
			 </span><br><br>
			  <span style="margin-left: 70px;">
			 	 <span id="smssgin_conent" style="display: none;">签名：
			 	 	<input type="text" id="smssgin_text" style="width: 123px;">
			 	 	<button onclick="saveSmssingn('1')" class="sui-btn btn-primary" style="margin-top: -8px;">保存</button>
			 	 	<button onclick="saveSmssingn('2')" class="sui-btn" style="margin-top: -8px;">取消</button>
			 	 </span>
			  		<span id="smssgin_conent2">
			  			<span>签名：【<span id="smssgin">XXXX</span>】</span>
			  			<a href="javascript:saveSmssingn('3')">点此设置</a>
			  		</span>
			  </span><br>
			   <div id="insert_words" style="display: none;">
			 	<span>插入标签：
			 			<a onclick="insertwords('<买家姓名>')" class="btn btn-mini" href="javascript:void(0);"><买家姓名></a>
			 			<a onclick="insertwords('<买家旺旺>')" style="margin-left: 10px" class="btn btn-mini" href="javascript:void(0);"><买家旺旺></a>
			 			<a onclick="insertwords('<订单编号>')" style="margin-left: 10px" class="btn btn-mini" href="javascript:void(0);"><订单编号></a>
			 			<a onclick="insertwords('<下单时间>')" style="margin-left: 10px" class="btn btn-mini" href="javascript:void(0);"><下单时间></a><br>
			 			<a onclick="insertwords('<物流公司>')" style="margin-left: 65px;margin-top: 5px;" class="btn btn-mini" href="javascript:void(0);"><物流公司></a>
			 			<a onclick="insertwords('<物流单号>')" style="margin-left: 10px;margin-top: 5px;" class="btn btn-mini" href="javascript:void(0);"><物流单号></a>
			 	</span>
			 	<br>
			 </div>
			  <span>内容预览：<textarea disabled="disabled" onmousedown ="savePossms(this)" onmouseup="savePossms(this)" id="editsms_template" style="margin-top: -12px;resize: none;width: 81%;height: 100px;margin-left: 72px;"></textarea><br>
			  <label id="save_chenlongkes"style="margin-left: 345px;" class="checkbox-pretty inline checked" ><input type="checkbox" class="bcbcbj"/><span>保存本次编辑</span></label>
			  <br>
			  </span>
			<!-- <span>内容预览：<textarea disabled="disabled" id="sms_value" style="resize: none;width: 81%;height: 41px;margin-left:11px;" placeholder="请输入自定义短信内容， 先用鼠标选择要插入的位置，点击<名称>就可以插入对应的值哦!"></textarea></span><br>-->
			 <div>
			 	<span style="float:left;margin-left: 69px;margin-top:-10px;" id="check_words">已输入<font color="red">0</font>个汉字,约<font color="red">0</font>条短信(66/条,含签名) </span>
			 </div>
		 </div>
		</div>
		<div class="modal-footer">        
			<span style="float:left;"><a href="<?php echo APP_WEB_INDEX_ROOT;?>/trade/sms?vers=<?php echo REAL_ROOT_VER;?>#smsstatus=sms_log">点击查看发送记录</a></span>
			<button id="smsSend" class="sui-btn btn-primary btn-large" type="button" data-ok="modal">发送</button>        
			<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	 	 <!--Profile Form修改发货 -->
	<div id="resend-table" class="sui-modal hide fade" role="dialog" data-backdrop="static" data-width="570px" tabIndex="-1" data-hasfoot="true"  style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">修改发货</h4>      
				</div>
		 		<div class="modal-body" style="overflow: inherit;">
                	<div  id="on_line" >
                    	<p>请选择物流公司
                    		<div  id="on_div">
                        		<!--<select data-mini="true" name='ontrade' id='resendlist'></select>-->
                        		<span class="sui-dropdown dropdown-bordered select">
									<span class="dropdown-inner" style="width: 112px;">
										<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
											<input value="" type="hidden">
											<i class="caret"></i>
       										<span>请选择物流公司</span>
       									</a>
        							<ul role="menu" aria-labelledby="drop4" id='resendlist' class="sui-dropdown-menu">
        							</ul>
							</span>
						</span>  
                            </div>
                        </p>
                        <p><span style="margin:0 -6px; font-size:12px; font-weight:normal;" class="font_wsl">请填写运单号码</span> </p>
                        <input data-mini="true" type="text" name="outid" id="outid"/>
                   	</div>
           		</div>
        		<div class="modal-footer">        
					<button onclick="toresends();"class="sui-btn btn-primary btn-large" type="button" data-ok="modal">确定</button>        
					<button class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	<!-- 自动评价体验 -->
	<div id="zdrate_content" class="sui-modal hide fade" role="dialog" data-backdrop="static" data-width="570px" tabIndex="-1" data-hasfoot="true"  style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">自动评价设置</h4>      
				</div>
				<div class="modal-body" style="min-height: 400px;max-height: 400px;">
					<div class="grid-demo">
						<div class="sui-row-fluid">
							<div class="span2" style="text-align:right;">
								<strong>评价方式：</strong>
				    		</div>
				    	<div class="span10" >
				    		<div class="radio">
							    <input type="radio" name="optionsRadios" id="optionsRadios1" value="0"   checked="checked">
							  	 立即好评（为了更好的体验效果，推荐使用此方式）
							</div>
							<div class="radio">
							    <input type="radio" name="optionsRadios" id="optionsRadios2" value="1" >
							    买家评价后进行好评。
				    		</div>
				    		<div id="sel1" style="color: red;">
				    		距系统默认评价<select class="input-mini" id="houser">
										  <option value="23">1</option>
										  <option value="22">2</option>
										  <option value="21">3</option>
										  <option value="20">4</option>
										  <option value="19">5</option>
										  <option value="18">6</option>
										  <option value="17">7</option>
										  <option value="16">8</option>
										  <option value="15">9</option>
										  <option value="14">10</option>
										  <option value="13">11</option>
										  <option value="12">12</option>
										  <option value="11">13</option>
										  <option value="10">14</option>
										  <option value="9">15</option>
										  <option value="8">16</option>
										  <option value="7">17</option>
										  <option value="6">18</option>
										  <option value="5">19</option>
										  <option value="4">20</option>
										  <option value="3">21</option>
										  <option value="2">22</option>
									  	  <option value="1">23</option>
									</select>小时，进行评价。
				    			</div>
				    		<div class="radio">
							    <input type="radio" name="optionsRadios" id="optionsRadios3" value="2" >
							  	定时抢评。
				    		</div>
				    		<div id="sel2"  style="color: red;">
				    		交易成功后的<select class="input-mini" id="day2">
										  <option value="14">14</option>
										  <option value="13">13</option>
										  <option value="12">12</option>
										  <option value="11">11</option>
										  <option value="10">10</option>
										  <option value="9">9</option>
										  <option value="8">8</option>
										  <option value="7">7</option>
										  <option value="6">6</option>
										  <option value="5">5</option>
										  <option value="4">4</option>
										  <option value="3">3</option>
										  <option value="2">2</option>
									  	  <option value="1">1</option>
									  	  <option value="0">0</option>
									</select>天<select class="input-mini" id="houser2">
										  <option value="23">23</option>
										  <option value="22">22</option>
										  <option value="21">21</option>
										  <option value="20">20</option>
										  <option value="19">19</option>
										  <option value="18">18</option>
										  <option value="17">17</option>
										  <option value="16">16</option>
										  <option value="15">15</option>
										  <option value="14">14</option>
										  <option value="13">13</option>
										  <option value="12">12</option>
										  <option value="11">11</option>
										  <option value="10">10</option>
										  <option value="9">9</option>
										  <option value="8">8</option>
										  <option value="7">7</option>
										  <option value="6">6</option>
										  <option value="5">5</option>
										  <option value="4">4</option>
										  <option value="3">3</option>
										  <option value="2">2</option>
									  	  <option value="1">1</option>
									</select>小时，进行抢评。
				  	    </div>
				  </div>
				</div>
			</div>
				<div class="grid-demo">
					<div class="sui-row-fluid">
						<div class="span2" style="text-align:right;">
							<strong>黑名单过滤:</strong>
				    	</div>
				    	<div class="span10" >
							<div class="checkbox">
							    <input type="checkbox" id="checkboxhmd" >
							    不评价黑名单列表中的买家　
							</div>
				    	</div>
				    </div>
				</div>
				<div class="grid-demo">
					<div class="sui-row-fluid">
						<div class="span2" style="text-align:right;">
							<strong>自动黑名单:</strong>
				    	</div>
				    	<div class="span10">
							<div class="checkbox" >
							    <input type="checkbox" id="checkboxhmd2" >
							    中差评自动加入黑名单<a href="javascript:void(0);" onclick="gettraderates(1,'bad');">一键导入历史中差评买家</a>
							</div>
							  <p >注：加入黑名单后在买家下一次下单时生效，也可以手动添加黑名单哦。</p>
				    	</div>
				    </div>
				</div>
				<div class="grid-demo">
					<div class="sui-row-fluid">
						<div class="span2" style="text-align:right;">
							<strong><span id="fmname">电台提醒</span>:</strong>
				    	</div>
				    	<div class="span10" >
							<div class="checkbox" >
							  <input type="checkbox" id="checkboxhmd3" ><span id="fmcont">出现中差评时立即进行电台提醒 </span><span id="fmconts" style="color:red;">*请开启后再选择</span>
							</div>
							 <p id="fmrate"><span style="color:red;">注：开启方法：千牛消息中心——消息订阅——系统消息——插件消息——爱用交易管理勾选，并选择提醒方式保存3。</span></p>
		
				    		<p >注：根据淘宝规则，必须双方评价完成后，才能获取买家的评价内容！<cite title="软件才能第一时间发出提醒通知！" style="color: red;">软件才能第一时间发出提醒通知！</cite></p>
				    	</div>
				    </div>
				</div>
	</div>
	<div class="modal-footer">        
			<button onclick="saveActBzdrate();" class="sui-btn btn-primary btn-large" type="button" data-ok="modal">保存并开启</button>        
			<button onclick="closerateActB(2);" class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
				</div>    
			</div>  
		</div>
	</div>
	<div id="defenrate_contents"  class="sui-modal hide fade" role="dialog" data-backdrop="static" data-width="692px" tabIndex="-1" data-hasfoot="true"  style="display: none">
		<div class="modal-dialog">    
			<div class="modal-content">      
				<div class="modal-header">        
					<button aria-hidden="true" class="sui-close" type="button" data-dismiss="modal">×</button>        
					<h4 class="modal-title">差评师拦截设置</h4>      
				</div>
			<div class="modal-body" style="max-height: 385px;">
				<div class="alert"><p style="margin:.3em 0;">提示：符合任一选中状态的买家都会拦截,不能购买您的宝贝,拍下订单10秒后,订单将自动关闭并自动加入黑名单。</p></div>
				<div class="grid-demo">
					<div class="sui-row-fluid"><div class="span2"><span><label><input type="radio" name="qwert" checked="checked" onchange="checkbox_change2('sys');">系统默认设置</label></span></div>
					<div class="span2"><span><label><input type="radio" name="qwert" onchange="checkbox_change2('def');" id="index_default">自定义设置</label></span></div></div>
				</div>
				<h4>设置关闭条件:</h4>
				<table class="sui-table table-condensed table-bordered" style="width:100%">
					<tr class="form-inline">
						<td>
							<label class="checkbox">
					   			&nbsp;&nbsp;&nbsp;&nbsp;<input checked="checked" type="checkbox" id="neutralrate_check" value="on" onchange="checkbox_change(this);" />给过我中评的买家
					 		</label>
						</td>
					</tr>
					<tr class="form-inline">
						<td>
							<label class="checkbox">
					   			&nbsp;&nbsp;&nbsp;&nbsp;<input checked="checked" type="checkbox" id="badrate_check" value="on" onchange="checkbox_change(this);" />给过我差评的买家
					 		</label>
						</td>
					</tr>
					<tr class="form-inline">
						<td>
							<label class="checkbox">
					   			&nbsp;&nbsp;&nbsp;&nbsp;<input checked="checked" type="checkbox" id="conditionKey_check" value="on" onchange="checkbox_change(this);"/>地址或留言包含以下关键字:
					 		</label>
					 		<input type="text" style="width:70%; height:30px;"class="input-small" id="conKyes" value="活刷,皇冠,不降权,不扣分,不封店,爆款,刷钻,真实单号" placeholder="联系Q Q，活刷，皇冠，不降权，不扣分，不封店，爆款，刷钻，刷粉刷店铺、宝贝收藏，天猫关注，开团提醒，u站喜欢，企业QQ，动态评分，微淘关注，教程">
					 		<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="input-small" style="color: red"> &nbsp;&nbsp;*关键字之间用逗号隔开</span>
						</td>
					</tr>
					<tr class="form-inline">
						<td>
							<label class="checkbox">
								&nbsp;&nbsp;&nbsp;&nbsp;<input disabled="disabled" type="checkbox" value="off" id="public_check" value="off" onchange="checkbox_change(this)"/>发出过中差评的买家
							</label>
						</td>
					</tr>
					<tr class="form-inline">
						<td>
							<label class="checkbox">
						   		&nbsp;&nbsp;&nbsp;&nbsp;<input disabled="disabled" type="checkbox" id="credit_check" name="credit_check" value="off" onchange="checkbox_change(this);">买家信用分数低于:
						 	</label>
						 		<input disabled="disabled" type="text" class="input-small" style="width:30%;margin-left: 24px;" id="creadit" placeholder="0~10000001"/>&nbsp;&nbsp;分
						 	<span class="input-small"> &nbsp;&nbsp;&nbsp;&nbsp;可输入0~10000001</span>
						</td>
					</tr>
					<tr class="form-inline">
						<td>
							<label class="checkbox">
					   		&nbsp;&nbsp;&nbsp;&nbsp;<input disabled="disabled" type="checkbox" id="regday_check" name="regday_check" value="off" onchange="checkbox_change(this);"/>买家注册天数小于:
					 	</label>
					 		<input disabled="disabled" type="text" class="input-small" style="width:30%;margin-left: 24px;" id="regday" placeholder="0~99999"/>&nbsp;&nbsp;天
					 	<span class="input-small"> &nbsp;&nbsp;&nbsp;&nbsp;可输入0~99999</span>
						</td>
					</tr>
					<tr class="form-inline">
						<td>
								<label class="checkbox">
							   		&nbsp;&nbsp;&nbsp;&nbsp;<input disabled="disabled" type="checkbox" id="bigmoney_check" name="bigmoney_check" value="off" onchange="checkbox_change(this);">此次订单金额大于:
							 	</label>
							 		<input disabled="disabled" type="text" class="input-small" style="width:30%;margin-left: 24px;" id="thebigmoeny" placeholder="如:5.98或10"/>&nbsp;&nbsp;元
							 		<span class="input-small"> &nbsp;&nbsp;&nbsp;&nbsp;最大可输入99999</span>
						 </td>
					</tr>
					<tr class="form-inline">
						<td>
								<label class="checkbox">
							   		&nbsp;&nbsp;&nbsp;&nbsp;<input disabled="disabled" type="checkbox" id="smalmoney_check" name="smalmoney_check" value="off" onchange="checkbox_change(this);">此次订单金额小于:
							 	</label>
							 		<input disabled="disabled" type="text" class="input-small" style="width:30%;margin-left: 24px;" id="smallmoney" placeholder="如:5.98或10"/>&nbsp;&nbsp;元
							 	<span class="input-small"> &nbsp;&nbsp;&nbsp;&nbsp;最大可输入99999</span>
						</td>
					</tr>
					<tr class="form-inline">
						<td>
							<label class="checkbox">
					   			 &nbsp;&nbsp;&nbsp;&nbsp;<input disabled="disabled" type="checkbox" id="goodrate_check" name="goodrate_check" value="off" onchange="checkbox_change(this);">得到的卖家好评率低于:
					 		</label>
					 		  <input disabled="disabled" type="text" class="input-small" style="width:30%;" id ="goodsrate" placeholder="0~99.99"/>&nbsp;&nbsp;%&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最大可输入99.99%
					 		 <br><span class="input-small" style="color: red"> &nbsp;&nbsp;&nbsp;&nbsp;*该好评率是卖家给买家发出的好评率</span>
						</td>
					</tr>
					<tr class="form-inline" id="black_tr">
							<td>
							<label class="checkbox">
					   			&nbsp;&nbsp;&nbsp;&nbsp;<input type="checkbox" disabled="disabled"/>拦截我手动添加的黑名单用户:   
					 		</label><a href="javascript:void(0);" class="btn" disabled="disabled">添加黑名单</a><br />
					 		<span style="margin-left:25px;">已添加<font color="red">0</font>个黑名单用户</span>
					 		
						</td>
					</tr>
			</table>
			<h4>设置关闭理由:</h4>
			<p style="margin:.3em 0;">设置关闭交易时卖家解释(买家可见)</p>
			<div>
				<input type="text" id ="closetent" placeholder="订单状态错误，请联系售后客服" style="width:98%;" maxlength="20"/><br />
				<font color="red">*默认解释可设置6-14个汉字</font>
			</div>
		</div>
		<div class="modal-footer">        
			<button onclick="saveandcontinue()" class="sui-btn btn-primary btn-large" type="button" data-ok="modal">保存并开启</button>        
			<button onclick="closerateActB(3);" class="sui-btn btn-default btn-large" type="button" data-dismiss="modal">关闭</button>      
		</div>    
	</div>  
</div>
</div>
  <!-- 
 		作者：Duanhq
     	时间：2014-05-05
     	描述：查看留言
     	无用的弹框
     -->
       <div id="readmesage" class="mesWindow" style="Z-INDEX: 99999; LEFT: 0px; POSITION: absolute; width: 80%; border: none; display: none; font-family: 微软雅黑; background-color: #FFF;">
     	<div class="modal-header" style="height:35px;">
            <button type="button" class="close" style="margin-top: 6px;" onclick="closeMsg('');">×</button>
            <h4>买家留言</h4>
         </div>
         <div class="modal-body" style="max-height: 235px;">
         	<table>
	         	<tr>

	         		<td style="padding:5px 5px;" >
	         			         		<span  id="readmesage_refsh" style="text-align:center; padding:0 5px;">
			<img src="http://cdn.zzgdapp.com/trade/mobile/images/loding.gif" align="absmiddle" />加载中...
				</span>
				<span id="readMemo"></span>
	         		</td>
	         	</tr>
    		</table>
         </div>
     	<div class="modal-footer">
			<input type="button" onclick="closeMsg('');" style="margin-left:8px;padding: 3px 10px;" value="关闭">	
		</div>
     </div>
    <!-- 暂未修改的弹框 --> 
         <!--Profile Form修改物流信息-->
     <!--<div id="UpWldata-table" class="mesWindow" style="Z-INDEX:99998; POSITION:absolute;height:350px; width:570px;display:none;background-color:#FFF;">
		 <div class="mesWindowTop" style="height:35px;">
            <button type="button" class="close" style="margin-top: 6px;" onclick="closeMsg('');">×</button>
            <h4>发货修改</h4>
         </div>
		 <div class="modal-body" >
				<div  id="on_line" >
		    	<p>请选择物流公司<div  id="on_div"><select data-mini="true" name='ontrade' id='resendlist'></select></div>
		         </p>
		         <p><span style="margin:0 -6px; font-size:12px; font-weight:normal;" class="font_wsl">请填写运单号码</span> </p>
		         <input data-mini="true" type="text" name="outid" id="outid"/>
		         </div>
            </div>
		<div class="footer">
			 <div  class="mesWindowBottom">	
				 <input type="button" class="btn btn-primary"  onclick="toresends();" value="确定"><input type="button" onclick="closeMsg('');" style="margin-left:8px;padding: 3px 10px;" value="关闭">	
			 </div>
		 </div>
	 </div>-->
	 	 <!--Profile Form推荐物流-->
     <div id="wuliuup" class="mesWindow" style="Z-INDEX:99998; POSITION:absolute;width:520px;height:400px;display:none;background-color:#FFF;">
		 <div class="mesWindowTop" style="height:35px;">
            <button type="button" class="close" style="margin-top: 6px;" onclick="closeMsg('');">×</button>
            <h4>推荐物流</h4>
         </div>
		 <div class="mesWindowContent" >
		 <div style="margin-top:-5px;">货物重量：<span id="zl_up" style=""></span>&nbsp;&nbsp;&nbsp;总件：<span id="zj_up"></span>件</div>
	     <div>发货地址：<select id="saddr_up" style="height:25px;width: 400px;"></select></div>
	     <div >收货地址：<span id="faddr_up"></span></div>
	     <div style="margin-top:5px;">
		     <a href="javascript:void(0);" onclick="printqiao(1);" class="btn">在线下单</a>
		     <a href="javascript:void(0);" onclick="printqiao(1);" class="btn">货到付款</a>
		     <label id="hide_up" style="display: block; position: absolute; margin: -25px 0px 0px 68%;"><input type="checkbox" id="wlcheckboxhide" onclick="showcywl();">&nbsp;<span id="hides_up" class="lbl">仅显示我的常用物流</span></label>
			 <table class="table table-striped table-bordered table-hover" style="margin-top:5px;text-align:center;">
					<thead><tr><td width="20%">物流公司名称</td><td width="20%">运送资费</td><td width="20%">预计时间</td><td width="25%">揽收时段</td><td width="15%">操作</td></tr></thead>
       				<tbody id="wlbody_up"></tbody>
			 </table>
			 <div class="alert" style="text-align:left;" id="fy_up">奋力加载数据中...</div>
	     </div>
        </div>
		<div class="footer">
			 <div  class="mesWindowBottom">
			 <samp id="plwuliusum" style="float: left;"></samp>
				 <input type="button" class="btn btn-primary" style="padding: 3px 10px;" onclick="batchSend(2);" value="确定发货"><input type="button" onclick="closeMsg('');" style="margin-left:8px;padding: 3px 10px;" value="关闭">	
			 </div>
		 </div>
	 </div>
	 <div id="admsg">
	 	
	 </div>
<script>
/**
 * 刷新index
 * @author Duanhq
 */
var isreshow=false;
function reshow(){  
    if(isreshow){
		return;
    }else{
    	isreshow=true;
        getordersta(gsta,gpageno);
    }            
}
/**
 * 页面载入后一系列初始化加载处理
 * @author Duanhq
 * @parm gtid,全局变量-主订单id
 * @parm gsta,全局变量-当前查看的订单所属状态
 * @parm sellertype,全局变量-卖家店铺类型（B，C店）
 * @parm buyernick,全局变量-买家昵称
 * @parm user_nick,全局变量-卖家昵称 from top.php
 * @parm vip_time,全局变量-订购到期时间
 * @parm vipuser,全局变量-身份信息
 * @parm version,全局变量-千牛版本号
 */
var gtid = '';
var gsta = '';
var sellertype='';
var buyernick=null;
var version="";
var tsdzon='off';/*是否开启特殊地址*/
var tsdzval='';/*用户设置的特殊地址*/
window.onload = function(){
	layer.use('extend/layer.ext.js', function(){});
	/*html5sql.openDatabase( "db_item", "商品", 30 * 1024 * 1024 );*/
 	QN.initTheme();
 	$("#indexsel").attr("class","dqzt");
    $("#taskgl").show();
    $("#addtaskpl").show();
    $("#ThreeMonthQian").show();/*轻任务不做版本判断*/
 	$("#all_list").html('<div class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>');
	$('#myTab a').click(function (e) {/*为发货设置绑定单击事件*/
	    e.preventDefault();
	    $(this).tab('show');
	});
	onload_viptime('index');/*获取订购信息、同步订购信息*/
	setTimeout(function(){
		if(user_nick==''|| user_nick==null||user_nick.length<2||user_nick=='null'){
			refshvip_top();
		}
	},2000);/*两秒后检测登录用户是否有取到用户信息，否则再次获取*/
	setTimeout(get_userinfo_data,100);
	/*initDataBase();初始化数据库*/
	if(window.localStorage.getItem(user_nick+'Glset')==''||window.localStorage.getItem(user_nick+'Glset')==null){/*加载特殊地址预警*/
		$.ajax({
			url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getuserglsz',
			type:'post',
			dataType:'html',
			data:{'nick':user_nick},
			error:function(){
			},
			success:function(rsp){
				if(typeof rsp==='string'){rsp=JSON.parse(rsp);}
					if(rsp.tsdz){
						if(rsp.tsdz.split(';')[0]=='on'){
							tsdzon='on';
						if(rsp.tsdz.split(';')[1]){tsdzval=rsp.tsdz.split(';')[1];}
						window.localStorage.setItem(user_nick+'Glset',rsp.tsdz);
					}
				}else{
					window.localStorage.setItem(user_nick+'Glset','off;');
				}
			}
		});
	}else{
		var dddd=window.localStorage.getItem(user_nick+'Glset');
		if(dddd.split(';')[0]=='on'){
			tsdzon='on';
			if(dddd.split(';')[1]){tsdzval=dddd.split(';')[1];}
		}
	}
	window.localStorage.getItem(user_nick+'sms_words');/*删除短信关键字。当用户要使用时。自动获取。减轻数据库压力*/
	var shash=window.location.hash.substr(1);
	
	var params = shash.split('&');
	var map = new HashMap();
	for (var i in params) {
	    var p = params[i].split("=");
	    if (p.length == 2) {
	        map.put(p[0], p[1]);
	    }
	}
	/*运营统计写Cookie*/
	var nicks=map.get('nick');
	if(nicks!=null){
		nicks=decodeURIComponent(nicks);
		nicks=nicks.split(":")[0];
		document.cookie = "u="+nicks+";path=/;domain=zzgdapp.com;";
		var activedt=map.get('activedt');/*第一次使用时间*/
		var viptimes=map.get('vip_time');
		var vipusers=map.get('vipuser');
		var autorate=map.get('autorate');
		if(vipusers==1){
			document.cookie = "trade_vtime="+viptimes+";path=/;domain=zzgdapp.com;";
		}else{
			document.cookie = "autorate="+autorate+";path=/;domain=zzgdapp.com;";
		}
		if(activedt!='off'){
			document.cookie = "trade_freetime="+activedt+";path=/;domain=zzgdapp.com;";
		}
	}
	buyernick=map.get('buyerNick');
	var tradestatus=map.get('tradeStatus');
	var event=map.get('event');
	var tid=map.get('tid');
	if(map.get("gsta")!=null){
    	gsta=map.get("gsta");
	    switch(gsta){
	        case "dfh":
	            $('#myTab a[href="#dfh"]').tab('show');
	            break;
	        case "dpj":
	            $('#myTab a[href="#dpj"]').tab('show');
	            break;
	        case "dfk":
	            $('#myTab a[href="#dfk"]').tab('show');
	            break;
	        case "yfh":
	            $('#myTab a[href="#yfh"]').tab('show');
	            break;
	        case "tkz":
	            $('#myTab a[href="#tkz"]').tab('show');
	            break;
	        case "sussce":
	            $('#myTab a[href="#sussce"]').tab('show');
	            break;
	        case "close":
	            $('#myTab a[href="#close"]').tab('show');
	            break;
	        default :
	            $('#myTab a[href="#all"]').tab('show');
	    };
	}/*疑问*/
	if(buyernick==null&&tradestatus==null&&gsta==""){/*疑问*/
		if(event=='tradeDetail' && tid!=''){
			 todetails(tid,'task');
		}else{
			setTimeout(showlist,200);
		}
	}else if(gsta==""){
	    if(buyernick!=null)
	    {
	        buyernick=decodeURIComponent(buyernick);
	        var buyernickarr =buyernick.split(":");
	        buyernick=buyernickarr[0];
	        $("#sselectnick").val(buyernick);
	        sselect();
	    }
	    if(tradestatus==null){
	        /*$("#sselectsta option[value='all']").attr("selected","selected");*/
	    	$("#sselectsta li").attr('class','');
	    	$("#sselectsta").siblings('a').children('input').val('all');
            $("#sselectsta").siblings('a').children('span').html('所有');
            $("#sselectsta li a[value='all']").parent('li').attr('class','active');
            if(event=='tradeDetail' && tid!=''){/*跳详情去*/
				todetails(tid,'task');
            }
	    }else{
	    	$("#sselectsta li").attr('class','');
	        switch(tradestatus){
	            case 'no_create_pay':{
	            	$("#sselectsta").siblings('a').children('input').val('dfk');
	                $("#sselectsta").siblings('a').children('span').html('待付款');
	                $("#sselectsta li a[value='dfk']").parent('li').attr('class','active');
		            /*$("#sselectsta option[value='dfk']").attr("selected","selected");*/
		            break;
	            }
	            case 'wait_buyer_pay':{
	            	$("#sselectsta").siblings('a').children('input').val('dfk');
	                $("#sselectsta").siblings('a').children('span').html('待付款');
	                $("#sselectsta li a[value='dfk']").parent('li').attr('class','active');
		            /*$("#sselectsta option[value='dfk']").attr("selected","selected");*/
		            break;
		            }
	            case 'wait_seller_send_goods':{
	            	$("#sselectsta").siblings('a').children('input').val('dfh');/*input hiddden添加值*/
	                $("#sselectsta").siblings('a').children('span').html('待发货');/*上一层的span.改变文字*/
	                $("#sselectsta li a[value='dfh']").parent('li').attr('class','active');/*添加active*/
		           /* $("#sselectsta option[value='dfh']").attr("selected","selected");*/
		            break;
		            }
	            case 'buyer_conform_goods':{
	            	$("#sselectsta").siblings('a').children('input').val('dpj');
	                $("#sselectsta").siblings('a').children('span').html('待评价');
	                $("#sselectsta li a[value='dpj']").parent('li').attr('class','active');
		            /*$("#sselectsta option[value='dpj']").attr("selected","selected");*/
		            break;
		            }
	            case 'refunding':{
	                $("#sselectsta").siblings('a').children('input').val('tkz');/*input hiddden添加值*/
	                $("#sselectsta").siblings('a').children('span').html('退款中');/*上一层的span.改变文字*/
	                $("#sselectsta li a[value='tkz']").parent('li').attr('class','active');/*添加active*/
		            break;
	            }
	            case 'trade_finish':{
	            	$("#sselectsta").siblings('a').children('input').val('sussce');
	                $("#sselectsta").siblings('a').children('span').html('已成功');
	                $("#sselectsta li a[value='sussce']").parent('li').attr('class','active');
		            /*$("#sselectsta option[value='sussce']").attr("selected","selected");*/
		            break;
	            }
	            case 'trade_close':{
	            	$("#sselectsta").siblings('a').children('input').val('close');
	                $("#sselectsta").siblings('a').children('span').html('已关闭');
	                $("#sselectsta li a[value='close']").parent('li').attr('class','active');
		            /*$("#sselectsta option[value='close']").attr("selected","selected");*/
		            break;
	            }
	            case 'trade_close_by_taobao':{
	            	$("#sselectsta").siblings('a').children('input').val('close');
	                $("#sselectsta").siblings('a').children('span').html('已关闭');
	                $("#sselectsta li a[value='close']").parent('li').attr('class','active');
		            /*$("#sselectsta option[value='close']").attr("selected","selected");*/
		            break;
	            }
	            default :{
	            	$("#sselectsta").siblings('a').children('input').val('all');
	                $("#sselectsta").siblings('a').children('span').html('所有');
	                $("#sselectsta li a[value='all']").parent('li').attr('class','active');
		            /*$("#sselectsta option[value='all']").attr("selected","selected");*/
		            break;
	            }
	        }
	        setTimeout(sselect,1200);/*跳到制定状态去*/
	    }
	}else{
	    setTimeout("getordersta('"+gsta+"',1)",200);
	}
	setTimeout(huidiao,200);/*top回调*/
	gonggao();
	tradedots('index');/*统计埋点,首页进入*/
	//$("#sendplan").change(a_offline);/*绑定事件，物流公司选择-发货*/
	//$("#plsendplan").change(plcomsel);/*绑定事件，物流公司选择-批量发货*/
	var hidelocal = window.localStorage.getItem("hidelocal");
	if(hidelocal=="yes"){$("#hideids").checkbox().checkbox('check');}
	sendaddr();
	if(vipuser==0){
		ittoolspam('AD20140730133000','indexf');
	}else{
		ittoolspam('AD20140730133000','indexpvip');
	}
	
}
</script>

<!-- 业务处理 -->
<script>
/**
 * 加载订单数据(初始化)
 * @author Duanhq
 * @parm gpageno,全局变量-当前页
 * @parm gplsendarr,全局变量-批量发货所选数组
 * @parm gplpostarr，全局变量-批量免邮所选数组
 */
var gpageno;
var gplsendarr= new Array();
var gplpostarr= new Array();
function showlist(){
	if(gsta=='dfh'||gsta=='all'){
		 gplsendarr= [];
	}
	if(gsta=='dfk'||gsta=='all'){
		gplpostarr= [];
	}
	 gsta = 'all';
    /*$("#tradeqx").attr("checked",false);
    $(".tradecheck").attr("checked",false);*/
	$("."+gsta+"check").parent('label').checkbox('uncheck');
    $("."+gsta+"check").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
    gpageno=1;
    gettbtime();/*获取淘宝的时间*/
  QN.top.invoke({
	  cmd: "taobao.trades.sold.get",
	  param: {
          fields:"cod_status,orders.oid,orders.outer_iid,orders.outer_sku_id,tid,status,end_time,buyer_nick,trade_from,credit_card_fee,buyer_rate,seller_rate,created,num,payment,pic_path,has_buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.status,orders.price,orders.sku_properties_name,orders.num_iid,orders.refund_id,orders.pic_path,orders.refund_status,orders.num,seller_flag,type,post_fee",
          type:'tmall_i18n,fixed,auction,guarantee_trade,step,independent_simple_trade,independent_shop_trade,auto_delivery,ec,cod,game_equipment,shopex_trade,netcn_trade,external_trade,instant_trade,b2c_cod,hotel_trade,super_market_trade,super_market_cod_trade,taohua,waimai,nopaid,step,eticket',
		  page_no:'1',
          page_size:'20'
      },
	  method: "post",
	  success: function (rsp){
		  $("#all_list").empty();
		  $("#chapfys"+gsta).empty();
          if(typeof rsp === 'string'){
              var rsp = JSON.parse(rsp);
          }else{
              var rsp= rsp;
          }
          var total_results=rsp.trades_sold_get_response.total_results;
          all_results=total_results;
          $("#"+gsta+"num").html('('+total_results+')');
            if(total_results>0){
              	var orders = rsp.trades_sold_get_response.trades.trade;
                try{
                	totaltasknum=orders.length;
                    for(index in orders){
                    	var order = orders[index];
                        showlists('all',order);
                  	}
                    if(total_results>20){
                    	var page_sum=Math.ceil(total_results/20);
                        pagin('chapfys'+gsta,'getlistdata',1,page_sum,total_results);
                   	}
             	}catch(e){
                	 layer.msg('showlist:'+e,1,3);
                     
                 }
          	}else{
                  $("#all_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有当前状态的订单</div><s class="msg-icon"></s></div>');
          	}
	  },
      error: function(msp){
          if(typeof msp === 'string'){
              var msp = JSON.parse(msp);
          }else{
              var msp= msp;
          }
          if(msp.sub_code=='subuser.has-no-permission'){
        	  /* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
               */
          }else if(msp.sub_msg=='HTTP Standard Error Code.'||msp.sub_code=='404'){
        	  layer.msg(msp.msg+'：'+msp.sub_msg+'，网络错误，淘宝技术同学正在紧急排查，为您带来的不便请谅解：',1,3);
        	  
          }else if(msp.sub_code=='isv.invalid-parameter:buyer_nick'){
        	  layer.msg(msp.msg+'：'+msp.sub_msg+'，近三个月内，您查询的买家并没有在您的店铺中留下消费记录，请核对下买家旺旺昵称是否正确：',1,3);
        	  
          }else if(msp.msg=='plugin authorize failed!'||msp.code=='-501088250'){
        	  layer.msg(msp.msg+'：插件授权失败，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：',1,3);
        	  
          }else if(msp.msg=='Invalid signature'){
        	  layer.msg(msp.msg+'：插件授权失效，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
        	  
          }else if(msp.sub_code=="isv.invalid-track-id"){
        	  layer.msg(msp.msg+'：参数丢失，千牛客户端获取某个字段错误致操作失败，请重试。',1,3);
        	  
          }else{
              geterrorinfo("taobao.trades.sold.get",msp);
          }
      }
	  });
}
/**
 * 订单数据处理，前台展示
 * @author ...
 * @parm hidenum,全局变量-关闭的订单数
 * @parm taobaotime,全局变量-淘宝系统时间
 * @parm dpjtotal,全局变量-待评价订单的总数
 * @parm tasktids,全局变量-轻任务id|taskindex,全局变量-轻任务|taskbugnick,全局变量-轻任务|iscreate,全局变量-轻任务
 * @parm sta,局部变量-当前订单的状态
 * @parm order,局部变量-需要处理展示的订单数据(json)
 * 
 * 
 */
var hidenum =0;/*关闭订单数*/
var taobaotime='';
var dpjtotal=0;
var tasktids='';
var totaltasknum=0;
var taskindex=0;
var taskbugnick='';
var iscreate=[];
function showlists(sta,order){
	var datas={};
    datas.sta=sta;
	if(sellertype=='B'){
		datas.sellertype=true;
	}
    datas.tradeid = sta + order.tid;
    datas.tid=order.tid;
    if(sta!='close'){/*已关闭的不显示留言*/
		datas.tpmemo=order.has_buyer_message;
    }
	datas.addr= order.receiver_name+'，'+order.receiver_mobile+'，'+order.receiver_phone+'，'+ order.receiver_state+order.receiver_city+order.receiver_district+ order.receiver_address+'，'+order.receiver_zip;
	if(tsdzon=='on'){
		var addrs=tsdzval.split(',');
		for(var i in addrs){
			if(datas.addr.split(addrs[i]).length>1){
				datas.dangeraddr=true;
				break;
			}		
		}	
	}
    datas.ppflash=false;
    datas.fhflash=false;
    datas.wlflash=false;
    datas.pjflash=false;
    datas.tshflash=false;
    datas.addrflash=true;
	datas.tradecod=false;
    if("tkz"==sta){
    	datas.tkflash=true;
    }
	if('cod'==order.type){
		datas.tradecod=true;
		switch(order.cod_status){
	    	case 'SIGN_IN':datas.stacla='success';datas.dstatus = '买家已签收'; break;
	    	case 'REJECTED_BY_OTHER_SIDE':datas.stacla='';datas.dstatus = '签收失败'; break;
		}
	}
    datas.post_fee = order.post_fee;
    if(order.post_fee=='0.00'||order.post_fee=='0'||order.post_fee < 0 ||order.post_fee==''||order.post_fee==null ||order.post_fee==undefined){
		datas.showprice="display:none;";
    }
    switch (order.status)
    {
        case 'WAIT_BUYER_PAY':{ datas.stacla='warning';datas.dstatus = '等待付款';datas.status = '待付款';datas.ppflash=true;if(0!=order.post_fee){gplpostarr.push(datas.tid.toString());}break;}
        case 'WAIT_SELLER_SEND_GOODS':{ datas.bgcolor='background:#B94A48;';datas.dstatus = '等待发货';datas.status = '待发货';datas.addrflash=false;datas.fhflash=true;if('cod'!=order.type){gplsendarr.push(datas.tid.toString());}break;}
        case 'WAIT_BUYER_CONFIRM_GOODS':{datas.stacla='info';datas.dstatus = '已发货';datas.status = '已发货';datas.wlflash=true;datas.tshflash=true;break;}
        case 'SELLER_CONSIGNED_PART':{
            datas.stacla='important';
            datas.bgcolor='background:#B94A48;';
            datas.dstatus='部分发货';
            datas.fhflash=true;
            datas.wlflash=true;
           break;
        }
        case 'TRADE_FINISHED':{
            datas.wlflash=true;datas.dstatus = '已成功';
            if(datetime_to_unix(order.end_time) > datetime_to_unix(GetDateStr(-15))&&order.seller_rate==false){
                datas.status = '待评价';datas.isd=true;datas.pjflash=true;datas.bgcolor='background:#7F7E00;';break;
            }else{
                datas.status = '已成功'; datas.bgcolor='background:#468847;';break;
            }
        }
        case 'TRADE_CLOSED':{ datas.stacla='';datas.dstatus = '已关闭';datas.status = '已关闭';datas.hidename = 'hidename';if(gsta=='all'){hidenum++};if(document.getElementById("checkboxhide").checked&&"close"!=sta){datas.hidenone = 'display:none;';} break;}
        case 'TRADE_CLOSED_BY_TAOBAO':{ datas.stacla='';datas.dstatus = '已关闭';datas.status = '已关闭';datas.hidename = 'hidename';if(gsta=='all'){hidenum++};if(document.getElementById("checkboxhide").checked&&"close"!=sta){datas.hidenone = 'display:none;';} break;}
        case 'TRADE_NO_CREATE_PAY':
            {
        	 datas.stacla='warning';
        	 datas.dstatus = '等待付款';
        	 datas.status = '待付款';                    	 
        	 datas.ppflash=true;
        	 datas.nocreated=true;
        	 break;
            }
    }
    if(gsta=='all'){
   		$("#hidenum").html('('+hidenum+')');
    }
	if('cod'==order.type&&'NEW_CREATED'!=order.cod_status){
	    datas.fhflash=false;
	    datas.wlflash=true;
	}
    datas.buyer_nick = order.buyer_nick;
    var created = new  Date(Date.parse(order.created.replace(/-/g,"/")));
    datas.created = created.format('yyyy-MM-dd hh:mm');
    datas.tcreated = order.created;
	datas.sellernick = user_nick;
    datas.num=0;
    datas.payment = order.payment;
    datas.title = order.orders.order[0].title;
    datas.pic_path = order.orders.order[0].pic_path;
    datas.price=order.orders.order[0].price;
    datas.xnum=order.orders.order[0].num;
    datas.sku_properties_name=order.orders.order[0].sku_properties_name;
     /**
     *
   	 *list_template显示商家编码
     */
    if(order.orders.order[0].outer_sku_id!=''||order.orders.order[0].outer_iid!=''){
        if(order.orders.order[0].outer_sku_id!=''&&order.orders.order[0].outer_sku_id!=null){
    		datas.outer_id=order.orders.order[0].outer_sku_id;                		
        }else if(order.orders.order[0].outer_iid!=''&& order.orders.order[0].outer_iid!=null){
       	 datas.outer_id=order.orders.order[0].outer_iid;                   
        }                    
    }
    if(order.seller_flag==0){
        datas.seller_flag='0';
    }
    if(order.seller_flag==1){
        datas.seller_flag='1';
    }
    if(order.seller_flag==2){
        datas.seller_flag='2';
    }
    if(order.seller_flag==3){
        datas.seller_flag='3';
    }
    if(order.seller_flag==4){
        datas.seller_flag='4';
    }
    if(order.seller_flag==5){
        datas.seller_flag='5';
    }/*备注旗帜*/
    datas.tkzz=false;
    datas.mytidorder=JSON.stringify(order.orders.order);
    datas.toid=order.orders.order[0].oid;
    datas.num_iid=order.orders.order[0].num_iid;
    datas.refund_id=order.orders.order[0].refund_id;
   for(var j in order.orders.order){
        var orderx=order.orders.order[j];
        if(orderx.refund_status!=null&&orderx.refund_status!='NO_REFUND'){
            if(datas.status=='待发货'){
                datas.status = '退款中';
                datas.tkzz=true;
            }
            if(datas.status=='已发货'){
                datas.status = '退款中';
                datas.tkzz=true;
            }
            if(orderx.refund_status!='CLOSED'){
            	datas.tshflash=false;
            }
        }
        datas.num=parseFloat(datas.num)+parseFloat(orderx.num);
	}
   	datas.rowspan=order.orders.order.length;
  	datas.sendsms=true;
    if(order.orders.order[0].refund_status!=null&&order.orders.order[0].refund_status!='NO_REFUND'){
		 switch(order.orders.order[0].refund_status){
		 		case 'WAIT_SELLER_AGREE':{datas.refund_status='退款中';datas.tkzz=true;datas.sendsms=false;break;}
		 		case 'WAIT_BUYER_RETURN_GOODS':{datas.refund_status='退款中';datas.tkzz=true;datas.sendsms=false;break;}
		 		case 'WAIT_SELLER_CONFIRM_GOODS':{datas.refund_status='退款中';datas.tkzz=true;datas.sendsms=false;break;}
		 		case 'SELLER_REFUSE_BUYER':{datas.refund_status='已拒绝退款';datas.tkzz=true;datas.sendsms=false;break;}
				case 'CLOSED':{datas.refund_status='退款关闭';datas.sendsms=false;break;}
				case 'SUCCESS':{datas.refund_status='退款成功';break;}
		 	}
	 }else{
		 switch(order.orders.order[0].status){
	  	 case 'TRADE_NO_CREATE_PAY':{datas.refund_status='待付款';break;}
		 case 'WAIT_BUYER_PAY':{datas.refund_status='待付款';break;}
		 case 'WAIT_SELLER_SEND_GOODS':{datas.refund_status='待发货';break;}
		 case 'WAIT_BUYER_CONFIRM_GOODS':{datas.refund_status='已发货';break;}
		 case 'TRADE_BUYER_SIGNED':{datas.refund_status='已签收';break;}
		 case 'TRADE_FINISHED':{datas.refund_status='已成功';break;}
		 case 'TRADE_CLOSED_BY_TAOBAO':{datas.refund_status="已取消";break;}
		 case 'TRADE_CLOSED':{datas.refund_status="已取消";break;}
		 }

	}
    if(vipuser==1 && (order.status!='TRADE_CLOSED' && order.status!='TRADE_CLOSED_BY_TAOBAO')){
		datas.viptd=true;/*如果是高级版用户，则显示安全系数的<td>标签*/
	}
	datas.receiver_name= order.receiver_name;
	datas.receiver_state = order.receiver_state;
	datas.receiver_city = order.receiver_city;
	datas.receiver_district = order.receiver_district;
	datas.receiver_address = order.receiver_address;
	datas.receiver_zip = order.receiver_zip;
	datas.receiver_mobile = order.receiver_mobile;
	datas.receiver_phone = order.receiver_phone;
	if( sta == 'sussce'||sta=='dpj'||(sta== 'all'&& datas.dstatus=='已成功')){
		 if( order.buyer_rate==true && order.seller_rate==true) {
			datas.isdoubleRate="双方已评";
			datas.sellerrate=true;
			datas.buyerrate=true;
			datas.isclick=true;
			datas.sendsms=false;
		}else if(order.buyer_rate==true && order.seller_rate==false){
			datas.isdoubleRate="买家已评";
			datas.sellerrate=false;
			datas.buyerrate=true;
			datas.sendsms=false;
		}else if(order.buyer_rate==false && order.seller_rate==true){
			datas.isdoubleRate="我已评价";
			datas.sellerrate=true;
			datas.buyerrate=false;
		}else if(order.buyer_rate==false && order.seller_rate==false){
			datas.isdoubleRate="双方未评";
			datas.sellerrate=false;
			datas.buyerrate=false;
		}
	}
	if(  order.status=='TRADE_CLOSED'  || order.status=='TRADE_CLOSED_BY_TAOBAO'){/**是退款成功的订单，并且不是已关闭的订单*/
		datas.sendsms=false;
	}
	if(  order.status=='TRADE_CLOSED'  || order.status=='TRADE_CLOSED_BY_TAOBAO' && datas.refund_status=='退款成功'){/**是退款成功的订单，并且不是已关闭的订单*/
		datas.sendsms=true;
	}
	
	var endtime=datetime_to_unix(gettimes(order.end_time,15));
	if(taobaotime!=''){
		taobaotime=GetDateStr(0);
	}
	var nowtime=datetime_to_unix(taobaotime);
	var hidetable=false;
	if(endtime < nowtime)
	{
		hidetable=true;
	}
	if(sta == "dpj" && hidetable==true){ /*隐藏过期订单!*/
			dpjtotal--;
    		datas.hidenone = 'display:none;';
	}
	if(dpjtotal<1&&sta=='dpj'){
			$("#dpj_list").empty();
         	$("#dpj_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有当前状态的订单</div><s class="msg-icon"></s></div>');
	} 
    if(datas.status=='待发货'){
   		datas.editpro=true;
    }else{
    	datas.editpro=false;
    } 
    datas.oid=order.orders.order[0].oid;    
	if("WAP"==order.trade_from.match("WAP")&&order.trade_from!=undefined){
		datas.tradePhone=true;
	}
	if(parseInt(order.credit_card_fee)>0&& order.credit_card_fee!=undefined){
		datas.xingyongka=true;
	}
	if(datas.sku_properties_name=='' || datas.sku_properties_name==null){
		datas.sku_properties_name=false;
	}
    var source = $("#list_template").html();
    var template=Handlebars.compile(source);
    var htmlstr = template(datas);
    $("#"+sta+"_list").append(htmlstr);

   /*getlirun( order.orders.order, 1, order.payment,datas.tradeid);显示利润哦~*/
	
    for(var n in order.orders.order){
        var orderx=order.orders.order[n];
    	if(n!=0){
            datas.title = order.orders.order[n].title;
            datas.oid=order.orders.order[n].oid;
            datas.pic_path = order.orders.order[n].pic_path;
            datas.price=order.orders.order[n].price;
            datas.xnum_iid=order.orders.order[n].num_iid;
            datas.xnum=order.orders.order[n].num;
            datas.refund_id=order.orders.order[n].refund_id;
          /*list2_template显示商家编码*/
            datas.outer_iid='';
            if(order.orders.order[n].outer_iid!=''||order.orders.order[n].outer_sku_id!=''){
                if(order.orders.order[n].outer_sku_id!=''&&order.orders.order[n].outer_sku_id!=null){
            		datas.outer_iid=order.orders.order[n].outer_sku_id;                        		
                }else if(order.orders.order[n].outer_iid!=''&&order.orders.order[n].outer_iid!=null){
               	 datas.outer_iid=order.orders.order[n].outer_iid;                           	
                }                            
            }
            datas.sku_properties_name=order.orders.order[n].sku_properties_name;
		       	 if(orderx.refund_status!=null&&orderx.refund_status!='NO_REFUND'){
	    		 switch(orderx.refund_status){
	  		 		case 'WAIT_SELLER_AGREE':{datas.refund_status='退款中';datas.tkzz=true;break;}
	  		 		case 'WAIT_BUYER_RETURN_GOODS':{datas.refund_status='退款中';datas.tkzz=true;break;}
	  		 		case 'WAIT_SELLER_CONFIRM_GOODS':{datas.refund_status='退款中';datas.tkzz=true;break;}
	  		 		case 'SELLER_REFUSE_BUYER':{datas.refund_status='已拒绝退款';datas.tkzz=true;break;}
					case 'CLOSED':{datas.refund_status='退款关闭';break;}
					case 'SUCCESS':{datas.refund_status='退款成功';break;}
				 	}
	    	 }else{
	    		 switch(orderx.status){
				  	 case 'TRADE_NO_CREATE_PAY':{datas.refund_status='待付款';break;}
					 case 'WAIT_BUYER_PAY':{datas.refund_status='待付款';break;}
					 case 'WAIT_SELLER_SEND_GOODS':{datas.refund_status='待发货';break;}
					 case 'WAIT_BUYER_CONFIRM_GOODS':{datas.refund_status='已发货';break;}
					 case 'TRADE_BUYER_SIGNED':{datas.refund_status='已签收';break;}
					 case 'TRADE_FINISHED':{datas.refund_status='已成功';break;}
					 case 'TRADE_CLOSED_BY_TAOBAO':{datas.refund_status="已取消";break;}
					 case 'TRADE_CLOSED':{datas.refund_status="已取消";break;}
	    		 }
	    	 }
            var source = $("#list2_template").html();
            var template=Handlebars.compile(source);
            var htmlstr = template(datas);
            $("#"+datas.tradeid).append(htmlstr);
        }
    }
	if(sta!='close'){/*已关闭的订单显示备注和留言*/
		getmemoandmessage(order.tid,sta);
	}else{
		$("#buyercom"+sta+order.tid).empty();
	}
    if(totaltasknum==1||sta=='tkz'||sta=='dpj'){
                QN.top.invoke({
    				 "cmd": "taobao.qianniu.tasks.get",
    				 "param": {"biz_ids":order.tid,"fields":"meta,meta.id,sender_uid,sender_nick,status,id,status,receiver_uid","need_meta":true,"biz_type":"trade"},
    				 "method": "post",
    				 "success": function (e){
    					 if(typeof  e=== 'string'){
    			            	e = JSON.parse(e);
    			            }
    				 var datas= {};
                   var ismeta=0;
                   datas.taskis="";
                         $("#"+sta+"taskts"+order.tid).hide();
                         $("#addtasks"+order.tid).remove();
    				if(e.qianniu_tasks_get_response.tasks.q_task){
    					datas.task="";
                      datas.isck="";
                      var taskData=e.qianniu_tasks_get_response.tasks.q_task;
                      datas.iscksid=taskData[0].meta.id;
                      for(var i=0;i<taskData.length;i++){
                          if(taskData[i].status!=2 && ismeta==0){
                              ismeta=1;
                              datas.isck=1;
                              datas.dataid=taskData[i].meta.id;
                          }
                          if(taskData[i].receiver_uid==taskuid&&taskData[i].status!=2 && taskData[i].status!=6){
                              datas.dataid=taskData[i].meta.id;
                              datas.task=1;
                              datas.idTask=taskData[i].id;
                              switch (taskData[i].status){
                                  case 0:
                                      datas.state="未处理";
                                      break;
                                  case 1:
                                      datas.state="执行中";
                                      break;
                                  case 3:
                                      datas.state="超时";
                                      break;
                                  case 4:
                                      datas.state="取消";
                                      break;
                                  case 5:
                                      datas.state="忽略";
                                      break;
                              }
                              break;
                          }
                      }
   				 }else{
     					datas.taskis="1";
    				 }
                   datas.iscks="";
                   if(ismeta==0 && datas.taskis==""){
                      datas.taskis="1";
                       datas.iscks="1";
                   }
                   if( datas.taskis=="1"){
                       var create={};
                       create.tid=order.tid;
                       create.buyer_nick=order.buyer_nick;
                       iscreate[iscreate.length]=create;
                   }
  				 datas.tid=order.tid;
  				 datas.buyer_nick = order.buyer_nick;
                   datas.gsta=gsta;
                  var source = $("#addtask").html();
                  var template=Handlebars.compile(source);
                  var htmlstr = template(datas);
                  $("#"+sta+"task"+order.tid).append(htmlstr);            
				 },
                  "error":function(e){
                  }
			 });
     }else{
        	$("#"+sta+"taskts"+order.tid).hide();
            if(tasktids=='')tasktids=order.tid;else tasktids=tasktids+','+order.tid;
            if(taskbugnick=='')taskbugnick=order.buyer_nick;else taskbugnick=taskbugnick+'|Y|'+order.buyer_nick;
            taskindex++;
            if(taskindex==totaltasknum)uptaskshow(1,sta);
      }
	isreshow=false;
}

function getlirun(order, i, payment,tradeid ){
    /*从websql中根据nick和num_iid取出数据*/
  	var lirun = 0;
	var sql = "select properties,price,width from priceset where nick='" + window.user_nick + "' and num_iid='" + order[i - 1].num_iid + "'";
   	executeQuery( sql,
	function(transaction, results){
		if( results.rows.length ){/*设置了成本价  在数据库中有数据*/
	    	var obj = results.rows.item(0);
	        var propertiess = obj.properties.split('|');
	        var prices = obj.price.split('|');
	        var index = 0;
	        /*console.log( results.rows.item(0) );
	        console.log( order[i - 1].sku_properties_name ); */
	       	for( var index in propertiess){
	        	if( propertiess[index] == order[i - 1].sku_properties_name ){
	            	break;
	            }
	       	}
	       lirun += payment - prices[index];
	       if( i < order.length ){
	            getlirun( order, i + 1, lirun ,tradeid);
	       	}else{ /*将利润添加到页面上*/
		    	if( lirun >= 0 ) {
		        	//var info = "<span style='color:#00CC00'>利润：￥" + lirun.toFixed(2) + "</span>";
		            $("#lirun"+tradeid).html("<span style='color:#00CC00'>利润：￥" + lirun.toFixed(2) + "</span>").css('color','#00CC00');
		        }else {
		        	//var info = "<span style='color:red'>利润：￥" + lirun.toFixed(2) + "</span>";
		            $("#lirun"+tradeid).html("<span style='color:red'>利润：￥" + lirun.toFixed(2) + "</span>").css('color','red');
		      	}
		        //$("#table" + datas.tradeid).find("td[width='16%']").append(info);
		       // console.log('-->'+info);
	       	}
	    }else{
	    	var setPrice = "<a href='javascript:goToItemIndexSetPrice();' title=点击设置成本价>设置成本价</a>";
	    	//$("#table" + datas.tradeid).find("td[width='16%']").append( setPrice );
	    	//console.log('===>'+setPrice);
	    	$("#lirun"+tradeid).remove();
	    }
	});
}
/**
 * Created with need.
 * User: wangsx
 * Date: 14-4-08
 * Time: 20:30 
 * 重写轻任务调用方法
 */	
var taskarrs={};
var taskuid="";
function uptaskshow(page,sta){
	QN.top.invoke({
		 "cmd": "taobao.qianniu.tasks.get",
		 "param": {"biz_ids":tasktids,"fields":"biz_id,meta,meta.id,sender_uid,sender_nick,status,id,status,receiver_uid","need_meta":true,"biz_type":"trade","page_size":100,"current_page":page},
		 "method": "post",
		 "success": function (e){
			 if(typeof  e=== 'string'){
	            	e = JSON.parse(e);
	            }
	            var taskarr=e.qianniu_tasks_get_response.tasks.q_task;
	            if(taskarr==undefined||taskarr=='undefined'){
		            	var tasktidse=tasktids.split(',');
		            	var taskbugnicks=taskbugnick.split('|Y|');
		            	for(var ind in tasktidse){
		    	    		var datas= {};
		    	         	var ismeta=0;
		    				datas.taskis="1";
		    	         	datas.iscks="";
		    	         if( datas.taskis=="1"){
		    	             var create={};
		    	             create.tid=tasktidse[ind];
		    	             create.buyer_nick=taskbugnicks[ind];
		    	             iscreate[iscreate.length]=create;
		    	         }
		    			 datas.tid=tasktidse[ind];
		    			 datas.buyer_nick = taskbugnicks[ind];
		    	         datas.gsta=gsta;
		    	         $("#addtasks"+taskbugnicks[ind]).remove();
		    	        var source = $("#addtask").html();
		    	        var template=Handlebars.compile(source);
		    	        var htmlstr = template(datas);
		    	        $("#"+sta+"task"+tasktidse[ind]).append(htmlstr); 
		            	}
		            	taskindex=0;
		            	totaltasknum=0;
		            	tasktids='';
		            }else{
			            if(page==1){
			            	taskarrs=taskarr;
			            }else{
			            	taskarrs=taskarrs.concat(taskarr);
			            }
			            if(taskarr.length==100){
			            	uptaskshow(page+1,sta);
			            }else{
			            	uptaskshows(sta);
			            	taskindex=0;
			            	totaltasknum=0;
			            	tasktids='';
				         }
			 }
		 },
        "error":function(e){
        	geterrorinfo("taobao.qianniu.tasks.get",e);
        }
	 });
}
/**
 * Created with need.
 * User: wangsx
 * Date: 14-4-08
 * Time: 21:30 
 * 显示轻任务调用方法JSON.stringify(uptaskarr[0])
 */	
function uptaskshows(sta){
	var uptaskarr=[];
	var i;
	for(var index=0;index<taskarrs.length;index++){
    	for(i=0;i<uptaskarr.length;i++){
    		if(taskarrs[index].biz_id==uptaskarr[i]['biz_id']){
    			uptaskarr[i]['task'][uptaskarr[i]['task'].length]=taskarrs[index];
    			break;
    		}
    	}
    	var task=[];
    	if(i==uptaskarr.length){
    		task['biz_id']=taskarrs[index].biz_id;
    		var tasks=[];
    		tasks[0]=taskarrs[index];
    		task['task']=tasks;   
    		uptaskarr[uptaskarr.length]=task;
    	}
    }
	var tasktidse=tasktids.split(',');
	var taskbugnicks=taskbugnick.split('|Y|');
	for(var index in uptaskarr){
    	for(var ind in tasktidse){
			if(tasktidse[ind]==uptaskarr[index]['biz_id']){
    			tasktidse.splice(ind,1);
    			taskbugnicks.splice(ind,1);
				break;}
        	}
    		var datas= {};
         	var ismeta=0;
         	datas.taskis="";
			if(uptaskarr[index]['task']){
			datas.task="";
            datas.isck="";
            var taskData=uptaskarr[index]['task'];
            datas.iscksid=taskData[0].meta.id;
	        for(var i=0;i<taskData.length;i++){
	                if(taskData[i].status!=2 && ismeta==0){
	                    ismeta=1;
	                    datas.isck=1;
	                    datas.dataid=taskData[i].meta.id;
	                }
	                if(taskData[i].receiver_uid==taskuid&&taskData[i].status!=2 && taskData[i].status!=6){
	                    datas.dataid=taskData[i].meta.id;
	                    datas.task=1;
	                    datas.idTask=taskData[i].id;
	                    switch (taskData[i].status){
	                        case 0:
	                            datas.state="未处理";
	                            break;
	                        case 1:
	                            datas.state="执行中";
	                            break;
	                        case 3:
	                            datas.state="超时";
	                            break;
	                        case 4:
	                            datas.state="取消";
	                            break;
	                        case 5:
	                            datas.state="忽略";
	                            break;
	                    }
	                    break;
	                }
	            }
			 }else{
				datas.taskis="1";
			 }
         datas.iscks="";
         if(ismeta==0 && datas.taskis==""){
            datas.taskis="1";
            datas.iscks="1";
         }
         if( datas.taskis=="1"){
             var create={};
             create.tid=uptaskarr[index]['biz_id'];
             create.buyer_nick=uptaskarr[index]['task'][0].sender_nick;
             iscreate[iscreate.length]=create;
         }
         $("#addtasks"+uptaskarr[index]['biz_id']).remove();
		 datas.tid=uptaskarr[index]['biz_id'];
		 datas.buyer_nick = uptaskarr[index]['task'][0].sender_nick;
         datas.gsta=gsta;
        var source = $("#addtask").html();
        var template=Handlebars.compile(source);
        var htmlstr = template(datas);
        $("#"+sta+"task"+uptaskarr[index]['biz_id']).append(htmlstr); 
    	}
	for(var ind in tasktidse){
    		var datas= {};
         	var ismeta=0;
			datas.taskis="1";
         	datas.iscks="";
         if( datas.taskis=="1"){
             var create={};
             create.tid=tasktidse[ind];
             create.buyer_nick=taskbugnicks[ind];
             iscreate[iscreate.length]=create;
         }
		 datas.tid=tasktidse[ind];
		 datas.buyer_nick = taskbugnicks[ind];
         datas.gsta=gsta;
         $("#addtasks"+tasktidse[ind]).remove();
        var source = $("#addtask").html();
        var template=Handlebars.compile(source);
        var htmlstr = template(datas);
        $("#"+sta+"task"+tasktidse[ind]).append(htmlstr); 
    	}
   /* for(var index in taskarrs){
       	 	var datas= {};
         	var ismeta=0;
         	datas.taskis="";
			if(taskarrs[index]){
			datas.task="";
            datas.isck="";
            var taskData=taskarrs[index];
            datas.iscksid=taskData[0].meta.id;
	        for(var i=0;i<taskData.length;i++){
	                if(taskData[i].status!=2 && ismeta==0){
	                    ismeta=1;
	                    datas.isck=1;
	                    datas.dataid=taskData[i].meta.id;
	                }
	                if(taskData[i].receiver_uid==taskuid&&taskData[i].status!=2 && taskData[i].status!=6){
	                    datas.dataid=taskData[i].meta.id;
	                    datas.task=1;
	                    datas.idTask=taskData[i].id;
	                    switch (taskData[i].status){
	                        case 0:
	                            datas.state="未处理";
	                            break;
	                        case 1:
	                            datas.state="执行中";
	                            break;
	                        case 3:
	                            datas.state="超时";
	                            break;
	                        case 4:
	                            datas.state="取消";
	                            break;
	                        case 5:
	                            datas.state="忽略";
	                            break;
	                    }
	                    break;
	                }
	            }
			 }else{
				datas.taskis="1";
			 }
         datas.iscks="";
         if(ismeta==0 && datas.taskis==""){
            datas.taskis="1";
            datas.iscks="1";
         }
         if( datas.taskis=="1"){
             var create={};
             create.tid=taskarrs[index].biz_id;
             create.buyer_nick=taskarrs[index].sender_nick;
             iscreate[iscreate.length]=create;
         }
		 datas.tid=taskarrs[index].biz_id;
		 datas.buyer_nick = taskarrs[index].sender_nick;
         datas.gsta=gsta;
        var source = $("#addtask").html();
        var template=Handlebars.compile(source);
        var htmlstr = template(datas);
        $("#"+sta+"task"+taskarrs[index].biz_id).append(htmlstr); 
        }*/
	taskarrs={};
}
/**
 * 获取各状态的采购单
 * @author Duanhq
 * @parm all_results……close_results，全局变量，订单总量缓存变量
 */
var all_results=0;
var dfk_results=0;
var dfh_results=0;
var yfh_results=0;
var sussce_results=0;
var close_results=0;
var isshowtrade=false;
var gpageno=1;
function getordersta(sta,pageno)
{  
	if(isshowtrade&&sta==gsta&&gpageno==pageno&&sta=='tkz'){
		return;
	}
	gpageno=pageno;
	if(sta==gsta){
		isshowtrade=true;
		setTimeout(function(){
			isshowtrade=false;
		},3000);
	}
	$("#chapfys"+gsta).hide();
	$("#chapfys").empty();
	$("#chapfys").hide();
	$("#chapfys"+sta).empty();
	$("#"+gsta+"num").html('');
	$("."+gsta+"check").parent('label').checkbox('uncheck');
	$("."+gsta+"check").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
	if(istradesel){
		$("#"+gsta+"_list").empty();
	}
	istradesel=false;
	var htmllens=$("#"+sta+"_list").html().length;
    var tstatus='';
    $("#sselecttid").val('');
    $("#sselectnick").val('');
    
    /*$("#sselectsta option[value='"+sta+"']").attr("selected","selected");*/
    $("#sselectsta li").attr('class','');/*清掉class*/
    $("#sselectsta").siblings('a').children('input').val(sta);/*input hiddden添加值*/
    $("#sselectsta").siblings('a').children('span').html($("#sselectsta li a[value='"+sta+"']").html());/*上一层的span.改变文字*/
    $("#sselectsta li a[value='"+sta+"']").parent('li').attr('class','active');/*添加active*/
    $("#plpbut").hide();
    $("#plsbut").hide();
    $("#hideids").hide();
    switch(sta){
        case "all":{$("#"+sta+"num").html('('+all_results+')');hidenum=0;tstatus='';$("#plsbut").show();$("#plpbut").show();$("#hideids").show();break;}
        case "dfk":{$("#"+sta+"num").html('('+dfk_results+')');tstatus='ALL_WAIT_PAY';$("#plpbut").show();break;}
        case "dfh":{$("#"+sta+"num").html('('+dfh_results+')');tstatus='WAIT_SELLER_SEND_GOODS';$("#plsbut").show();break;}
        case "yfh":{$("#"+sta+"num").html('('+yfh_results+')');tstatus='WAIT_BUYER_CONFIRM_GOODS';break;}
        case "tkz":{tstatus='';break;}
        case 'dpj':{tstatus='TRADE_FINISHED';break;}
        case "sussce":{$("#"+sta+"num").html('('+sussce_results+')');tstatus='TRADE_FINISHED';break;}
        case "close":{$("#"+sta+"num").html('('+close_results+')');tstatus='ALL_CLOSED';break;}
    }

	if(htmllens>23&&pageno=='a'){/*重复切换tab时不刷新数据，减少top调用增加用户体验*/
	    $("#chapfys"+sta).show();
	    gsta = sta;
		return;
	}else if(pageno=='a'){
		pageno='1';
	}
    $("#"+sta+"_list").html('<div class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>');       
   
    /*$("#tradeqx").attr("checked",false);
    $(".tradecheck").attr("checked",false);*/
    gsta = sta;
    gpageno=pageno;
    $("#chapfys"+gsta).empty();
    $("#chapfys"+gsta).show();
    var  page_size=20;
    if("tkz"!=sta&&"dpj"!=sta)
    {
        QN.top.invoke({
            "cmd": "taobao.trades.sold.get",
            "param": {
                "fields":"alipay_id,cod_status,orders.oid,orders.outer_iid,orders.outer_sku_id,tid,status,end_time,buyer_nick,seller_rate,buyer_rate,trade_from,credit_card_fee,created,num,payment,pic_path,has_buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.status,orders.price,orders.sku_properties_name,orders.num_iid,orders.refund_id,orders.pic_path,orders.refund_status,orders.num,seller_flag,type,post_fee",
                "type":'tmall_i18n,fixed,auction,guarantee_trade,step,independent_simple_trade,independent_shop_trade,auto_delivery,ec,cod,game_equipment,shopex_trade,netcn_trade,external_trade,instant_trade,b2c_cod,hotel_trade,super_market_trade,super_market_cod_trade,taohua,waimai,nopaid,step,eticket',
                "page_no":pageno,
                "page_size":page_size,
                "status":tstatus
            },
            "method": "post",
            "success": function (rsp){
            	$("#chapfys"+gsta).empty();
            	$("#"+sta+"_list").empty();
                if(typeof rsp === 'string'){
                    var rsp = JSON.parse(rsp);
                }
                var total_results=rsp.trades_sold_get_response.total_results;
                switch(sta){
	                case "all":{all_results=total_results;break;}
	                case "dfk":{dfk_results=total_results;break;}
	                case "dfh":{dfh_results=total_results;break;}
	                case "yfh":{yfh_results=total_results;break;}
	                case "tkz":{tkz_results=total_results;break;}
	                case 'dpj':{dpj_results=total_results;break;}
	                case "sussce":{sussce_results=total_results;break;}
	                case "close":{close_results=total_results;break;}
            	}
                $("#"+gsta+"num").html('('+total_results+')');
                if(total_results>0){
                var orders = rsp.trades_sold_get_response.trades.trade;
                    try{
                    	totaltasknum=orders.length;
                        for(index in orders)
                        {
                            var order = orders[index];
                            showlists(sta,order);
                        }
                    }catch(e){
                    	layer.msg('getordersta:'+e,1,3);
                        
                    }
                    if(total_results>page_size){
                        var page_sum=Math.ceil(total_results/page_size);
                        pagin('chapfys'+gsta,'getlistdata',pageno,page_sum,total_results);
                    }
                }else{
                    $("#"+sta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有当前状态的订单</div><s class="msg-icon"></s></div>');
                }
            },
            error: function(msp){
            	if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }else{
                    var msp= msp;
                }
                if(msp.sub_code=='subuser.has-no-permission'){
              	  /* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                     */
                }else if(msp.sub_msg=='HTTP Standard Error Code.'||msp.sub_code=='404'){
              	  layer.msg(msp.msg+'：'+msp.sub_msg+'，网络错误，淘宝技术同学正在紧急排查，为您带来的不便请谅解：)',1,3);
              	  
                }else if(msp.sub_code=='isv.invalid-parameter:buyer_nick'){
              	  layer.msg(msp.msg+'：'+msp.sub_msg+'，近三个月内，您查询的买家并没有在您的店铺中留下消费记录，请核对下买家旺旺昵称是否正确：)',1,3);
              	  
                }else if(msp.msg=='plugin authorize failed!'||msp.code=='-501088250'){
              	  layer.msg(msp.msg+'：插件授权失败，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
              	  
                }else if(msp.msg=='Invalid signature'){
              	  layer.msg(msp.msg+'：插件授权失效，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
              	  
                }else if(msp.sub_code=="isv.invalid-track-id"){
              	  layer.msg(msp.msg+'：参数丢失，千牛客户端获取某个字段错误致操作失败，请重试。',1,3);
              	  
                }else{
                    geterrorinfo("taobao.trades.sold.get",msp);
                }
            }

        });
    }else if("tkz"==sta){
        QN.top.invoke({
            "cmd": "taobao.refunds.receive.get",
            "param": {
                "fields":'tid,status',
                "page_no":1,
                "start_modified":GetDateStr(-90),
                "end_modified":GetDateStr(0),
                "page_size":100,
                "use_has_next":true
            },
            "method": "post",
            "success": function (rsp){
            	$("#"+sta+"_list").empty();
                if(typeof rsp === 'string'){
                    var rsp = JSON.parse(rsp);
                }else{
                    var	rsp= rsp;
                }
                var num=0;
                if(rsp.refunds_receive_get_response.refunds){
                var refunds=rsp.refunds_receive_get_response.refunds.refund;
                /*var has_next=rsp.refunds_receive_get_response.has_next;
                if(has_next){
                    results=i+1;
                }*/
                    var tkzarray=[];
                    for(index in refunds){
                        var refund=refunds[index];
                        if($.inArray(refund.tid,tkzarray)<0){
                            tkzarray.push(refund.tid);
                            switch(refund.status){
                                case 'WAIT_SELLER_AGREE':{showtid(sta,refund.tid);num++;break;}
                                case 'WAIT_BUYER_RETURN_GOODS':{showtid(sta,refund.tid);num++;break;}
                                case 'WAIT_SELLER_CONFIRM_GOODS':{showtid(sta,refund.tid);num++;break;}
                                case 'SELLER_REFUSE_BUYER':{showtid(sta,refund.tid);num++;break;}
                            }
                        }
                    }
                }
                if(0==num){
                    $("#"+sta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有当前状态的订单</div><s class="msg-icon"></s></div>');
                }
            },
            error: function(msp){
                if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }else{
                    var	msp= msp;
                }
                if(msp.sub_code=='subuser.has-no-permission'){
                /* 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                     */
                }else{
                    /* if(msp.sub_msg){
                    	layer.msg('getordersta_tkz:'+msp.sub_msg+'',1,3);
                        
                    }else{
                    	geterrorinfo("taobao.refunds.receive.get",msp);
                    } */
                    geterrorinfo("taobao.refunds.receive.get",msp);
                }
            }
        });
    }else if("dpj"==sta){
        showdpj(sta,tstatus,pageno);
    }
    tradedots(sta);
}
/**
 * 根据tid显示订单数据--退款中状态
 */
function showtid(sta,rtid){
    QN.top.invoke({
        "cmd": "taobao.trade.fullinfo.get",
        "param": {
            "fields":"cod_status,tid,status,end_time,buyer_nick,seller_rate,created,num,payment,pic_path,trade_from,credit_card_fee,buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.price,orders.sku_properties_name,orders.pic_path,orders.status,orders.refund_status,orders.num,orders.num_iid,orders.refund_id,orders.outer_sku_id,orders.outer_iid,seller_flag,type,post_fee",
            tid:rtid
        },
        "method": "post",
        "success": function (rsp){
            if(typeof rsp === 'string'){
                var rsp = JSON.parse(rsp);
            }
            var trade = rsp.trade_fullinfo_get_response.trade;
            if(trade.buyer_message&&trade.buyer_message!=''){
            	trade.has_buyer_message=true;
            }
            totaltasknum=1;
            showlists(sta,trade);
        },
        error: function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var	msp= msp;
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                 */
            }else{
                geterrorinfo("taobao.trade.fullinfo.get",msp);
            }
        }
    });
}
/**
 * 显示带评价状态中的订单
 */
function  showdpj(sta,tstatus,pageno)
{
    var  page_size=20;
    QN.top.invoke({
        "cmd": "taobao.trades.sold.get",
        "param": {
            "fields":"buyer_rate,seller_rate,cod_status,orders.oid,orders.outer_iid,orders.outer_sku_id,tid,status,end_time,buyer_nick,trade_from,credit_card_fee,seller_rate,created,num,payment,pic_path,has_buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.num_iid,orders.refund_id,orders.status,orders.price,orders.sku_properties_name,orders.pic_path,orders.refund_status,orders.num,seller_flag,type,post_fee",
            "status":tstatus,
            "rate_status":'RATE_UNSELLER',
            "type":'tmall_i18n,fixed,auction,guarantee_trade,step,independent_simple_trade,independent_shop_trade,auto_delivery,ec,cod,game_equipment,shopex_trade,netcn_trade,external_trade,instant_trade,b2c_cod,hotel_trade,super_market_trade,super_market_cod_trade,taohua,waimai,nopaid,step,eticket',
            "page_no":pageno,
            "page_size":page_size
        },
        "method": "get",
        "success": function (rsp){
        	$("#"+sta+"_list").empty();
        	$("#chapfys"+gsta).empty();
            if(typeof rsp === 'string'){
                var rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
            var total_results=rsp.trades_sold_get_response.total_results;
            dpjtotal=total_results;
            if(total_results > 0){
            var orders = rsp.trades_sold_get_response.trades.trade;
                try{
                	totaltasknum=orders.length;
                    for(index in orders)
                    {
                        var order = orders[index];
                        showlists(sta,order);
                    }
                    if(total_results>page_size){
                        var page_sum=Math.ceil(total_results/page_size);
                        pagin('chapfys'+gsta,'getlistdata',pageno,page_sum,total_results);
                    }
                }catch(e){
                	layer.msg('showdpj:'+e,1,3);
                    
                }
            }else{
                $("#"+sta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有当前状态的订单</div><s class="msg-icon"></s></div>');
            }
            
        },
        error: function(msp){
        	if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var msp= msp;
            }
            if(msp.sub_code=='subuser.has-no-permission'){
          	/*   layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                 */
            }else if(msp.sub_msg=='HTTP Standard Error Code.'||msp.sub_code=='404'){
          	  layer.msg(msp.msg+'：'+msp.sub_msg+'，网络错误，淘宝技术同学正在紧急排查，为您带来的不便请谅解：)',1,3);
          	  
            }else if(msp.sub_code=='isv.invalid-parameter:buyer_nick'){
          	  layer.msg(msp.msg+'：'+msp.sub_msg+'，近三个月内，您查询的买家并没有在您的店铺中留下消费记录，请核对下买家旺旺昵称是否正确：)',1,3);
          	  
            }else if(msp.msg=='plugin authorize failed!'||msp.code=='-501088250'){
          	  layer.msg(msp.msg+'：插件授权失败，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
          	  
            }else if(msp.msg=='Invalid signature'){
          	  layer.msg(msp.msg+'：插件授权失效，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
          	  
            }else if(msp.sub_code=="isv.invalid-track-id"){
          	  layer.msg(msp.msg+'：参数丢失，千牛客户端获取某个字段错误致操作失败，请重试。',1,3);
          	  
            }else{
                geterrorinfo("taobao.trades.sold.get",msp);
            }
        }
    });
}
/**
 * 显示三个月前的订单
 */
function lookhistory(){/*查看三个月前的订单*/
	getHistoryTrade();
 	$("#isthreemonth").click(function(){ 
        if(gsta=='all'){
        	$("#threemonth").addClass("active");
				$("#ThreeMonthQian").removeClass("active");
      	}else if(gsta=='dfk'){
      		$("#daipayorder").addClass("active");
      		$("#ThreeMonthQian").removeClass("active");
        }else if(gsta=='dfh'){
        	$("#daiSend").addClass("active");
          	$("#ThreeMonthQian").removeClass("active");
	    }else if(gsta=='yfh'){
	    	$("#SendOK").addClass("active");
	    	$("#ThreeMonthQian").removeClass("active");
		}else if(gsta=='tkz'){
			$("#isTuiKuan").addClass("active");
	    	$("#ThreeMonthQian").removeClass("active");
		}else if(gsta=='dpj'){
			$("#NeedRate").addClass("active");
	    	$("#ThreeMonthQian").removeClass("active");
		}else if(gsta=='sussce'){
			$("#isSuccess").addClass("active");
	    	$("#ThreeMonthQian").removeClass("active");
		}else if(gsta=='close'){
			$("#isLoser").addClass("active");
	    	$("#ThreeMonthQian").removeClass("active");
		}
	 }); 
   //  $("#gotoThreeMonth").click();
 	//getordersta(gsta,1);
       
}
/**
 * 查看历史订单
 */
function getHistoryTrade(){/*查看历史订单*/
	/*QN.application.invoke({
        "cmd": "getVersion",
        "error" : function(msg) {
        	
        },
        "success" : function(e) {
            if(typeof  e=== 'string'){
                e = JSON.parse(e);
            }
            var version=e.version.replace(/[.]/g,"");
            version=version.replace(/[N]/g,"");
            if(version<10500){
            	layer.msg('请升级到最新版本！',1,3);
	 	        
            }else{

            }
        }
    });*/
    QN.component.invoke( {
        category : 'sold_items',
        param:{
            uuid:'2314'
            },
        error : function(msg, cmd, param) {
        	 /* alert("查看失败！");*/
        },
        success : function(rsp, cmd, param) {
        	/* alert("查看成功");*/
        }
    });
}
/**
 * 搜索订单
 */
function sselect()
{
	
	if(gsta=='dfh'||gsta=='all'){
		 gplsendarr= [];
	}
	if(gsta=='dfk'||gsta=='all'){
		gplpostarr= [];
	}
    iscreate=[];
   /*  $("#tradeqx").attr("checked",false);
    $(".tradecheck").attr("checked",false); */
    $("."+gsta+"check").parent('label').checkbox('uncheck');
	$("."+gsta+"check").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
   	var sselecttid=$("#sselecttid").val();
   	var sselectnick=$('#sselectnick').val();
    sselecttid=clearBr(sselecttid);
    if(sselecttid==''||sselecttid==null){
    	sselectnotid(1);
        /*if(sselectnick==''||sselectnick==null){
        	layer.msg('请输入要搜索的订单号或买家昵称',1,3);
            
        }else{
        	
        }*/
    }else if(/^([0-9]*)$/.test(sselecttid)){
       /* var sselectsta=$("#sselectsta").find("option:selected").val();*/
        var sselectsta=$("#sselectsta").siblings('a').children('input').val();
        $("#"+sselectsta+"_list").html('<div class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>');
        var tstatus='';
        switch(sselectsta){
            case "all":{tstatus='';break;}
            case "dfk":{tstatus='ALL_WAIT_PAY';break;}
            case "dfh":{tstatus='WAIT_SELLER_SEND_GOODS';break;}
            case "yfh":{tstatus='WAIT_BUYER_CONFIRM_GOODS';break;}
            case "tkz":{tstatus='';break;}
            case 'dpj':{tstatus='TRADE_FINISHED';break;}
            case "sussce":{tstatus='TRADE_FINISHED';break;}
            case "close":{tstatus='ALL_CLOSED';break;}
        }
        $("#"+sselectsta+"_list").empty();
        $("#chapfys").empty();
        $("#chapfys").show();
        $("#chapfys"+sselectsta).empty();
        $("#chapfys"+sselectsta).hide();
        $("#"+sselectsta+"_list").html('<div class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>');
       $('#myTab a[href="#'+sselectsta+'"]').tab('show');
        $("#sselectnick").val('');

        $("#sselectsta li").attr('class','');/*清掉class*/
        $("#sselectsta").siblings('a').children('input').val(sselectsta);/*input hiddden添加值*/
        $("#sselectsta").siblings('a').children('span').html($("#sselectsta li a[value='"+sselectsta+"']").html());/*上一层的span.改变文字*/
        $("#sselectsta li a[value='"+sselectsta+"']").parent('li').attr('class','active');
       /* $("#sselectsta option[value='"+sselectsta+"']").attr("selected","selected");*/
        QN.top.invoke({
            "cmd": "taobao.trade.fullinfo.get",
            "param": {
                "fields":"buyer_rate,cod_status,seller_flag,seller_memo,status,trade_from,credit_card_fee,orders.status,buyer_nick,buyer_message,alipay_no,created,pay_time,end_time,payment,receiver_name,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_mobile,receiver_phone,consign_time,shipping_type,orders,total_fee,post_fee, created,tid,seller_rate,buyer_flag,adjust_fee",
                "tid":sselecttid
            },
            "method": "get",
            "success": function (rsp){
                if(typeof rsp === 'string'){
                    var rsp = JSON.parse(rsp);
                }else{
                    var	rsp= rsp;
                }
                
                
                $("#"+sselectsta+"_list").empty();
                $("#chapfys").empty();
                gsta = sselectsta;
                if(gsta=='all'){hidenum=0;}
                gpageno=1;
                $("#"+gsta+"num").html('('+1+')');
                var trade = rsp.trade_fullinfo_get_response.trade;
                totaltasknum=1;
                istradesel=true;
                if(trade){
                	if(trade.buyer_message!=undefined&&trade.buyer_message!=''){
                        trade.has_buyer_message=true;
                    }
                    if("dpj"==sselectsta){
                        if(trade.end_time!=undefined){
                        if(datetime_to_unix(trade.end_time) > datetime_to_unix(GetDateStr(-15))&&trade.seller_rate==false){
                            showlists(sselectsta,trade);
                        }else{
                            $("#"+sselectsta+"num").html('('+0+')');
                            $("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                        }
                        }else{
                            $("#"+sselectsta+"num").html('('+0+')');
                            $("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                        }
                    }else if("tkz"==sselectsta){
                        var refff=false;
                        for( index in trade.orders.order){
                            if('WAIT_SELLER_AGREE'==trade.orders.order[index].refund_status||'WAIT_BUYER_RETURN_GOODS'==trade.orders.order[index].refund_status||'SELLER_REFUSE_BUYER'==trade.orders.order[index].refund_status||'WAIT_SELLER_CONFIRM_GOODS '==trade.orders.order[index].refund_status){
                                refff=true;
                            }
                          }
                            if(refff){
                                showlists(sselectsta,trade);
                            }else{
                                $("#"+sselectsta+"num").html('('+0+')');
                                $("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                            }
                    }else if("all"!=sselectsta){
                        if(tstatus==trade.status){
                        showlists(sselectsta,trade);
                        }else{
                            if(('TRADE_NO_CREATE_PAY'==trade.status||'WAIT_BUYER_PAY'==trade.status)&&"dfk"==sselectsta){
                                showlists(sselectsta,trade);
                            }else if(('TRADE_CLOSED'==trade.status||'TRADE_CLOSED_BY_TAOBAO'==trade.status)&&"close"==sselectsta){
                                showlists(sselectsta,trade);
                            }else{
                                $("#"+sselectsta+"num").html('('+0+')');
                            $("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                            }
                        }
                    }else{
                        showlists(sselectsta,trade);
                    }
                    
                    if(trade.seller_memo!=undefined&&trade.seller_memo!='')
                    {
                    	var objString = trade.seller_memo.replace(/(^\s*)/g, "");
        			if(objString!=""){
                        $("#sellercom"+gsta+sselecttid).attr("title", trade.seller_memo);
                        $("#sellercoms"+gsta+sselecttid).attr("title", trade.seller_memo);
                        } else{
                       	 $("#sellercom"+gsta+sselecttid).attr("title", '暂时没有备忘信息');
                            }
                        var objLength = objString.length;
                        var num = 5;
                        if(objLength > num && objString!=""){
                            var i=$("#sellercoms"+gsta+sselecttid).html(objString.substring(0,5) + "...");
                        }else{
                            var j=$("#sellercoms"+gsta+sselecttid).html(objString);
                        }
                    }else{
                        $("#sellercom"+gsta+sselecttid).attr("title", '暂时没有备忘信息');
                    }
                    if(trade.buyer_message!=undefined&&trade.buyer_message!='')
                    {
                        $("#buyercom"+gsta+sselecttid).attr("title", trade.buyer_message);
                        var bobjString = trade.buyer_message;
                        var bobjLength = bobjString.length;
                        if(bobjLength > 40){
                            $("#buyercom"+gsta+sselecttid).html(bobjString.substring(0,40) + "...");
                        }else{
                            $("#buyercom"+gsta+sselecttid).html(bobjString);
                        }
                    }
                }else{
                    $("#"+sselectsta+"num").html('('+0+')');
                    $("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                }
            },
            error: function(msp){
            	istradesel=true;
            	$("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }else{
                    var	msp= msp;
                }
                if(msp.sub_code=='subuser.has-no-permission'){
                	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                     */
                }else{
                    geterrorinfo("taobao.trade.fullinfo.get",msp);
                }
            }
        });
    }else{
    	layer.msg('输入的订单号错误！',1,3);
        
    }
}
/**
 * 搜索订单--显示加载
 */
var istradesel=false;
function sselectnotid(pageno)
{
	if(gsta=='dfh'||gsta=='all'){
		 gplsendarr= [];
	}
	if(gsta=='dfk'||gsta=='all'){
		gplpostarr= [];
	}
    /*$("#tradeqx").attr("checked",false);
    $(".tradecheck").attr("checked",false);*/
	$("."+gsta+"check").parent('label').checkbox('uncheck');
	$("."+gsta+"check").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
	$(".tradeqx").parent('label').checkbox('uncheck');
    var sselectnick=$("#sselectnick").val();
    sselectnick=clearBr(sselectnick);
    
   /* var sselectsta=$("#sselectsta").find("option:selected").val();*/
    var sselectsta=$("#sselectsta").siblings('a').children('input').val();
    if(sselectnick==''||sselectnick==null){
	    $('#myTab a[href="#'+sselectsta+'"]').tab('show');
	    $("#sselecttid").val('');
	    getordersta(sselectsta,pageno);
	    return;
	}
        var tstatus='';
        switch(sselectsta){
            case "all":{tstatus='';break;}
            case "dfk":{tstatus='ALL_WAIT_PAY';break;}
            case "dfh":{tstatus='WAIT_SELLER_SEND_GOODS';break;}
            case "yfh":{tstatus='WAIT_BUYER_CONFIRM_GOODS';break;}
            case "tkz":{tstatus='';break;}
            case 'dpj':{tstatus='TRADE_FINISHED';break;}
            case "sussce":{tstatus='TRADE_FINISHED';break;}
            case "close":{tstatus='ALL_CLOSED';break;}
        }
        $("#"+sselectsta+"_list").empty();
        $("#chapfys").empty();
        $("#chapfys").show();
        $("#chapfys"+sselectsta).empty();
        $("#chapfys"+sselectsta).hide();
        $("#"+sselectsta+"_list").html('<div class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>');
        $('#myTab a[href="#'+sselectsta+'"]').tab('show');
        $("#sselecttid").val('');
        if("tkz"!=sselectsta&&"dpj"!=sselectsta)
        {
            QN.top.invoke({
                "cmd": "taobao.trades.sold.get",
                "param": {
                    fields:"cod_status,orders.oid,orders.outer_iid,orders.outer_sku_id,tid,status,end_time,buyer_nick,trade_from,credit_card_fee,seller_rate,buyer_rate,created,num,payment,pic_path,has_buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.status,orders.price,orders.sku_properties_name,orders.num_iid,orders.refund_id,orders.pic_path,orders.refund_status,orders.num,seller_flag,type,post_fee",
                    buyer_nick:sselectnick,
                    status:tstatus,
                    type:'tmall_i18n,fixed,auction,guarantee_trade,step,independent_simple_trade,independent_shop_trade,auto_delivery,ec,cod,game_equipment,shopex_trade,netcn_trade,external_trade,instant_trade,b2c_cod,hotel_trade,super_market_trade,super_market_cod_trade,taohua,waimai,nopaid,step,eticket',
                    page_no:pageno,
                    page_size:20
                },
                "method": "post",
                "success": function (rsp){
                    if(typeof rsp === 'string'){
                        var rsp = JSON.parse(rsp);
                    }else{
                        var	rsp= rsp;
                    }
                    	$("#"+sselectsta+"_list").empty();
                        $("#chapfys").empty();
                    gsta = sselectsta;
                    
                    if(gsta=='all'){hidenum=0;}
                    gpageno=pageno;
                    istradesel=true;
                    var total_results=rsp.trades_sold_get_response.total_results;
                        $("#"+gsta+"num").html('('+total_results+')');
                    if(total_results>0){
                        var orders = rsp.trades_sold_get_response.trades.trade;
                        totaltasknum=orders.length;
                        try{ for(index in orders)
                        {
                            var order = orders[index];
                            showlists(sselectsta,order);
                        }
                            if(total_results>20){
                                var page_sum=Math.ceil(total_results/20);
                                pagin('chapfys','sselectnotid',pageno,page_sum,total_results);
                            }
                        }catch(e){
                        	layer.msg('sselectnotid_e:'+e,1,3);
                            
                        }
                    }else{
                        $("#"+sselectsta+"num").html('('+0+')');
                        $("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                    }
                },
                error: function(msp){
	                istradesel=true;
	            	$("#"+sselectsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                	if(typeof msp === 'string'){
                        var msp = JSON.parse(msp);
                    }else{
                        var msp= msp;
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                  	 /*  layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                         */
                    }else if(msp.sub_msg=='HTTP Standard Error Code.'||msp.sub_code=='404'){
                  	  layer.msg(msp.msg+'：'+msp.sub_msg+'，网络错误，淘宝技术同学正在紧急排查，为您带来的不便请谅解：)',1,3);
                  	  
                    }else if(msp.sub_code=='isv.invalid-parameter:buyer_nick'){
                  	  layer.msg(msp.msg+'：'+msp.sub_msg+'，近三个月内，您查询的买家并没有在您的店铺中留下消费记录，请核对下买家旺旺昵称是否正确：)',1,3);
                  	  
                    }else if(msp.msg=='plugin authorize failed!'||msp.code=='-501088250'){
                  	  layer.msg(msp.msg+'：插件授权失败，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
                  	  
                    }else if(msp.msg=='Invalid signature'){
                  	  layer.msg(msp.msg+'：插件授权失效，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
                  	  
                    }else if(msp.sub_code=="isv.invalid-track-id"){
                  	  layer.msg(msp.msg+'：参数丢失，千牛客户端获取某个字段错误致操作失败，请重试。',1,3);
                  	  
                    }else{
                        geterrorinfo("taobao.trades.sold.get",msp);
                    }
                }
            });
        }else if("dpj"==sselectsta){
            QN.top.invoke({
                "cmd": "taobao.trades.sold.get",
                "param": {
                    "fields":"cod_status,orders.oid,orders.outer_iid,orders.outer_sku_id,tid,status,end_time,buyer_nick,trade_from,credit_card_fee,seller_rate,created,num,payment,pic_path,has_buyer_message,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_name,receiver_mobile,receiver_phone,orders.title,orders.num_iid,orders.refund_id,orders.status,orders.price,orders.sku_properties_name,orders.pic_path,orders.refund_status,orders.num,seller_flag,type,post_fee",
                    "status":tstatus,
                    "buyer_nick":sselectnick,
                    "rate_status":'RATE_UNSELLER',
                    "type":'tmall_i18n,fixed,auction,guarantee_trade,step,independent_simple_trade,independent_shop_trade,auto_delivery,ec,cod,game_equipment,shopex_trade,netcn_trade,external_trade,instant_trade,b2c_cod,hotel_trade,super_market_trade,super_market_cod_trade,taohua,waimai,nopaid,step,eticket',
                    "page_no":1,
                    "page_size":100
                },
                "method": "post",
                "success": function (rsp){
                    if(typeof rsp === 'string'){
                        var rsp = JSON.parse(rsp);
                    }else{
                        var	rsp= rsp;
                    }
                    istradesel=true;
                    gsta = sselectsta;
                	$("#"+sselectsta+"_list").empty();
                    $("#chapfys").empty();
                    var total_results=rsp.trades_sold_get_response.total_results;
                        $("#"+gsta+"num").html('('+total_results+')');
                    if(total_results>0){
                        var orders = rsp.trades_sold_get_response.trades.trade;
                        try{
                            var pjff=true;
                            for(index in orders)
                            {
                                var order = orders[index];
                                if(datetime_to_unix(order.end_time) > datetime_to_unix(GetDateStr(-15))&&order.seller_rate==false){
                                    showlists('dpj',order);
                                    var pjff=false;
                                }
                            }
                            if(pjff){
                                $("#dpjnum").html('('+0+')');
                                $("#dpj_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                            }
                        }catch(e){
                        	layer.msg('sselectnotid_e:'+e,1,3);
                            
                        }
                    }else{
                        $("#dpjnum").html('('+0+')');
                        $("#dpj_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                    }
                },
                error: function(msp){
	                istradesel=true;
	            	$("#dpj_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');

                	if(typeof msp === 'string'){
                        var msp = JSON.parse(msp);
                    }else{
                        var msp= msp;
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                  	 /*  layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                         */
                    }else if(msp.sub_msg=='HTTP Standard Error Code.'||msp.sub_code=='404'){
                  	  layer.msg(msp.msg+'：'+msp.sub_msg+'，网络错误，淘宝技术同学正在紧急排查，为您带来的不便请谅解：)',1,3);
                  	  
                    }else if(msp.sub_code=='isv.invalid-parameter:buyer_nick'){
                  	  layer.msg(msp.msg+'：'+msp.sub_msg+'，近三个月内，您查询的买家并没有在您的店铺中留下消费记录，请核对下买家旺旺昵称是否正确：)',1,3);
                  	  
                    }else if(msp.msg=='plugin authorize failed!'||msp.code=='-501088250'){
                  	  layer.msg(msp.msg+'：插件授权失败，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
                  	  
                    }else if(msp.msg=='Invalid signature'){
                  	  layer.msg(msp.msg+'：插件授权失效，请尝试注销帐号重新登录，如果重复多次出现请立马联系我们的客服：)',1,3);
                  	  
                    }else if(msp.sub_code=="isv.invalid-track-id"){
                  	  layer.msg(msp.msg+'：参数丢失，千牛客户端获取某个字段错误致操作失败，请重试。',1,3);
                  	  
                    }else{
                        geterrorinfo("taobao.trades.sold.get",msp);
                    }
                }
            });
        }else if("tkz"==sselectsta){
            QN.top.invoke({
                "cmd": "taobao.refunds.receive.get",
                "param": {
                    "fields":'tid,status',
                    "page_no":1,
                    "buyer_nick":sselectnick,
                    "start_modified":GetDateStr(-90),
                    "end_modified":GetDateStr(0),
                    "page_size":100,
                    "use_has_next":true
                },
                "method": "post",
                "success": function (rsp){
                    if(typeof rsp === 'string'){
                        var rsp = JSON.parse(rsp);
                    }else{
                        var	rsp= rsp;
                    }
                    istradesel=true;
                    gsta = sselectsta;
                	$("#"+sselectsta+"_list").empty();
                    $("#chapfys").empty();
                    var num=0;
                    if(rsp.refunds_receive_get_response.refunds){
                        var refunds=rsp.refunds_receive_get_response.refunds.refund;
                        var tkzarray=[];
                        for(index in refunds){
                            var refund=refunds[index];
                            if($.inArray(refund.tid,tkzarray)<0){
                                tkzarray.push(refund.tid);
                                switch(refund.status){
                                    case 'WAIT_SELLER_AGREE':{showtid('tkz',refund.tid);num++;break;}
                                    case 'WAIT_BUYER_RETURN_GOODS':{showtid('tkz',refund.tid);num++;break;}
                                    case 'WAIT_SELLER_CONFIRM_GOODS':{showtid('tkz',refund.tid);num++;break;}
                                    case 'SELLER_REFUSE_BUYER':{showtid('tkz',refund.tid);num++;break;}
                                }
                            }
                        }
                    }
                    if(0==num){
                        $("#tkznum").html('('+0+')');
                        $("#tkz_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');
                    }else{
                        $("#"+gsta+"num").html('('+num+')');
                    }
                },
                error: function(msp){
                	istradesel=true;
	            	$("#tkz_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有搜索的订单！</div><s class="msg-icon"></s></div>');

                    if(typeof msp === 'string'){
                        var msp = JSON.parse(msp);
                    }else{
                        var	msp= msp;
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                    	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                         */
                    }else{
                        /* if(msp.sub_msg){
                        	layer.msg('select_error:'+msp.sub_msg+'',1,3);
                            
                        }else{
                        	geterrorinfo("taobao.refunds.receive.get",msp);
                        } */
                        geterrorinfo("taobao.refunds.receive.get",msp);
                    }
                }
            });
        }else{
        	layer.msg('select_else:'+sselectsta,1,3);
            
        }
}
/**
 * 任务管理
 */
function showrwgl(){
	window.location.href="<?php echo APP_WEB_INDEX_ROOT?>/trade/gentlytask?vers=<?php echo REAL_ROOT_VER;?>";
}
/**
 * 添加任务
 */
function tasktj(tid,nick){
	var mytid=tid;
	var jsontasklist = [{"biz_id":mytid,"nick":nick}];
   QN.component.invoke({
      		category:'qtask_create',
      		param:{
      			biz_type:'trade',
      			items:jsontasklist,
      		},
      		error : function(msg, cmd, param) {

      		},
      		success : function(rsp, cmd, param) {
      			layer.msg('添加任务成功！',1,1);
                
      			sselect();
      		}
   });
}
/**
 * 处理任务
 */
function taskcl(id){
			QN.component.invoke({
				category:'qtask_deal',
				param:{
					task_ids:[id]
				},
				error : function(msg, cmd, param) {
				},
				success : function(rsp, cmd, param) {
					layer.msg('任务处理成功！',1,1);
	                
					sselect();
				}
			});
}
/**
 * 转交任务
 */
function taskzj(id){
        QN.component.invoke({
            category:'qtask_transfer',
            param:{
                meta_ids:[id]
            },
            error : function(msg, cmd, param) {
            },
            success : function(rsp, cmd, param) {
            	layer.msg('任务转交成功！',1,1);
                sselect();
            }
        });
}
/**
 * 发送短信
 * chenlongke
 */
function sendsms_dialog(name,phone,wangwang,rtid,lkjl){/*弹出框框。*/
	gtid=rtid;/*gtid全局变量*/
	$("#company_name").html('');/*物流公司清空*/
	$("#out_sid").html('');/*物流单号清空*/
	$("#sms_value").val('');/*短信内容清空*/
	$("#sms_template2").empty();/*模版二清空。*/
	$('#sendsms_content').modal('show');
	$("#smsSend").attr("onclick","sendsms('"+ rtid +"')");
	$(".bcbcbj").parent('label').checkbox().checkbox('uncheck');
	var localsign=window.localStorage.getItem(user_nick+'smsspan');/*读取签名*/
	if(localsign==''||localsign==null||localsign=='null'){	
		$.ajax({
			type:'POST',
			url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/SmsByType',
			dataType:'html',
			data:{nick:user_nick,type:'readSign'},
			error:function(){
				$("#smstitle").html(name);
				$("#smstite_wangwang").html(wangwang);
				$("#sms_buyerphone").val(phone);
				$("#smssgin").html(user_nick);
			},
			success:function(rsp){
				if(typeof rsp==='string'){rsp=JSON.parse(rsp);}
				$("#smstitle").html(name);
				$("#smstite_wangwang").html(wangwang);
				$("#sms_buyerphone").val(phone);
				if(rsp.smsspan==''){
					window.localStorage.setItem(user_nick+'smsspan',user_nick);
					$("#smssgin").html(user_nick);
				}else{
					window.localStorage.setItem(user_nick+'smsspan',rsp.smsspan);
					$("#smssgin").html(rsp.smsspan);
				}
			}
		});
	}else{
		$("#smstitle").html(name);
		$("#smstite_wangwang").html(wangwang);
		$("#sms_buyerphone").val(phone);
		$("#smssgin").html(localsign);
	}
	switch (lkjl){
		case '待付款':
		{
			$("#sms_template").siblings('a').children('input').val('cuifu');
            $("#sms_template").siblings('a').children('span').html('订单催付提醒');
			$("#sms_template").empty().append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="cuifu">订单催付提醒</a></li>');
			sms_template('cuifu');
			break;
		}
		case '待发货':
		{
			$("#sms_template").siblings('a').children('input').val('yanchi');
            $("#sms_template").siblings('a').children('span').html('延时发货提醒');
			$("#sms_template").empty().append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="yanchi">延时发货提醒</a></li>');
			sms_template('yanchi');
			break;
		}
		case '已发货':
		{	
			$("#sms_template").siblings('a').children('input').val('fahuo');
        	$("#sms_template").siblings('a').children('span').html('卖家发货提醒');
			$("#sms_template").empty().append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="no">请选择模版</a></li>');
			$("#sms_template").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="fahuo">卖家发货提醒</a></li>');
			$("#sms_template").append('<li role="presentation" ><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="queren">确认收货提醒</a></li>');
			$("#sms_template").append('<li role="presentation" ><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="haoping">好评奖励提醒</a></li>');
			sms_template('fahuo');
			break;
		}
		case '退款中':
		{
			$("#sms_template").siblings('a').children('input').val('tuikuan');
            $("#sms_template").siblings('a').children('span').html('退款成功提醒');
			$("#sms_template").empty().append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="tuikuan">退款成功提醒</a></li>');
			sms_template('tuikuan');
			break;
		}
		case '待评价':
		{
			$("#sms_template").siblings('a').children('input').val('haoping');
            $("#sms_template").siblings('a').children('span').html('好评奖励提醒');
			$("#sms_template").empty().append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="haoping">好评奖励提醒</a></li>');
			sms_template('haoping');
			break;
		}
		case '已成功':
		{
			$("#sms_template").siblings('a').children('input').val('haoping');
            $("#sms_template").siblings('a').children('span').html('好评奖励提醒');
			$("#sms_template").empty().append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="haoping">好评奖励提醒</a></li>');
			sms_template('haoping');
			break;
		}
		case '已关闭':
		{
			$("#sms_template").siblings('a').children('input').val('tuikuan');
            $("#sms_template").siblings('a').children('span').html('退款成功提醒');
			$("#sms_template").empty().append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="tuikuan">退款成功提醒</a></li>');
			sms_template('tuikuan');
			break;
		}
		default:
		{
			break;
		}
	}
}
function sms_template2(type,rsp){
	$("#sms_template2").empty();
	rsp=JSON.parse(rsp);
	var flag=0;/*用户设置的是几号模版0,1,2,3*/
	var smstext='';/*用户设置的模版内容*/
	switch(type){
		case 'cuifu':
		{
			var cuifu=rsp.smspay;
			if(cuifu.smstext!=undefined&&cuifu.smstext!=''||cuifu.smstext!=null){smstext=cuifu.smstext;}if(cuifu.smsflag!=undefined){flag=cuifu.smsflag;}
			if(rsp.smscompy!=undefined){
				if(rsp.smscompy.smspay==3){
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【订单提醒】亲爱的<买家姓名>，您拍下的宝贝我们一直为您留着，麻烦您付下款，成功后我们立即为您发货哦。@'+$("#smssgin").html()+'#0">模版一</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【订单提醒】亲，您在'+user_nick+'购买的宝贝还未成功，请尽快付款以便我们以最快的速度发货哦！@'+$("#smssgin").html()+'#1">模版二</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【订单提醒】亲爱的<买家旺旺>，您的宝贝还没付款哦，我们已经给您预留了，每天下午4点前付款会当天发货哦~@'+$("#smssgin").html()+'#2">模版三</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
				}else{
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="亲爱的<买家姓名>，您拍下的宝贝我们一直为您留着，麻烦您确认一下，成功后我们立即为您送达宝贝哦。#0">模版一</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="亲，您在<卖家旺旺>购买的宝贝还未成功，请尽快确认以便我们以最快的速度送达宝贝哦！#1">模版二</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="亲爱的<买家旺旺>，您下单的宝贝还没成功哦，这个订单我们已经给您预留了，每天下午4点前确认会当天发的哦~#2">模版三</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
				}
			}else{
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【订单提醒】亲爱的<买家姓名>，您拍下的宝贝我们一直为您留着，麻烦您付下款，成功后我们立即为您发货哦。@'+$("#smssgin").html()+'#0">模版一</a></li>');
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【订单提醒】亲，您在'+user_nick+'购买的宝贝还未成功，请尽快付款以便我们以最快的速度发货哦！@'+$("#smssgin").html()+'#1">模版二</a></li>');
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【订单提醒】亲爱的<买家旺旺>，您的宝贝还没付款哦，我们已经给您预留了，每天下午4点前付款会当天发货哦~@'+$("#smssgin").html()+'#2">模版三</a></li>');
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
			}
			break;
		}
		case 'fahuo':
		{
			var fahuo=rsp.smssend;
			if(fahuo.smstext!=''&&fahuo.smstext!=undefined||fahuo.smstext!=null){smstext=fahuo.smstext;}if(fahuo.smsflag!=undefined){flag=fahuo.smsflag;}
			if(rsp.smscompy!=undefined){
				if(rsp.smscompy.smssend==2){
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【发货提醒】<买家姓名>，亲的宝贝已经发货了！“<物流公司>”派送，运单号<物流单号>,请记得及时收货噢！@'+$("#smssgin").html()+'#0">模版一</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【发货提醒】亲爱的<买家姓名>，您的宝贝已经发货了！请保持手机畅通方便快递联系您，签收前记得先检查包装哟！@'+$("#smssgin").html()+'#1">模版二</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【发货提醒】亲爱的<买家姓名>，感谢您的惠顾，宝贝已经发货啦，请知悉，'+user_nick+'祝您生活愉快。@'+$("#smssgin").html()+'#2">模版三</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
				}else{
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="<买家姓名>，亲的宝贝已经发货了！“<物流公司>”派送，运单号<物流单号>,请记得及时收货噢！#0">模版一</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="<买家姓名>，您的宝贝已经发货了！请保持手机畅通方便快递联系您，签收前记得先检查包装哟！#1">模版二</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="亲爱的<买家姓名>，感谢您的惠顾，宝贝已经发货啦，请知悉，<卖家旺旺>祝您生活愉快。#2">模版三</a></li>');
					$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
				}
			}else{
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【发货提醒】<买家姓名>，亲的宝贝已经发货了！“<物流公司>”派送，运单号<物流单号>,请记得及时收货噢！@'+$("#smssgin").html()+'#0">模版一</a></li>');
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【发货提醒】亲爱的<买家姓名>，您的宝贝已经发货了！请保持手机畅通方便快递联系您，签收前记得先检查包装哟！@'+$("#smssgin").html()+'#1">模版二</a></li>');
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【发货提醒】亲爱的<买家姓名>，感谢您的惠顾，宝贝已经发货啦，请知悉，'+user_nick+'祝您生活愉快。@'+$("#smssgin").html()+'#2">模版三</a></li>');
				$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
			}
			break;
		}
		case 'queren':
		{
			var queren=rsp.smsconfirm;
			if(queren.smstext!=''&&queren.smstext!=undefined||queren.smstext!=null){smstext=queren.smstext;}if(queren.smsflag!=undefined){flag=queren.smsflag;}
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【收货提醒】亲爱的<买家姓名>，感谢您在我们店铺购买宝贝，真诚期待给予好评。@'+$("#smssgin").html()+'#0">模版一</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【收货提醒】<姓名>，麻烦确认收货并好评，我们期待您的支持和鼓励！@'+$("#smssgin").html()+'#1">模版二</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【收货提醒】亲爱的<买家旺旺>，我们已经收到您的付款信息，期待您收货后给予好评，如果商品如出现任何问题请联系客服！@'+$("#smssgin").html()+'#2">模版三</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
			break;
		}
		case 'haoping':
		{
			var haoping=rsp.smsgood;
			if(haoping.smstext!=''&&haoping.smstext!=undefined||haoping.smstext!=null){smstext=haoping.smstext;}if(haoping.smsflag!=undefined){flag=haoping.smsflag;}
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【好评奖励】亲爱的<买家姓名>，感谢您给小店的好评，小店已经将您加入VIP会员，更多优惠等着您哦！@'+$("#smssgin").html()+'#0">模版一</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【好评奖励】亲爱的<买家旺旺>，谢谢您给的5分好评，现在联系客服可以免费获得优惠券，供您下次购买本店宝贝使用。@'+$("#smssgin").html()+'#1">模版二</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【好评奖励】亲爱的<买家旺旺>，感谢您给小店亮5颗星，本店最近有新货，给亲最大的优惠，祝您下次购物愉快哦！@'+$("#smssgin").html()+'#2">模版三</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
			break;
		}
		case 'tuikuan':
		{
			var tuikuan=rsp.smsrefund;if(tuikuan.smstext!=''&&tuikuan.smstext!=undefined||tuikuan.smstext!=null){smstext=tuikuan.smstext;}if(tuikuan.smsflag!=undefined){flag=tuikuan.smsflag;}
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【退款成功】亲爱的<买家姓名>，您的退款已处理成功，请及时查收。抱歉给您带来的不便，有疑问请联系客服旺旺。@'+$("#smssgin").html()+'#0">模版一</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【退款成功】<买家姓名>，亲的退款已处理成功，很抱歉没能够给您带来好的购物体验，希望能再次为您服务!@'+$("#smssgin").html()+'#1">模版二</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【退款成功】亲爱的<买家旺旺>，退款已经处理完毕，给您带来的不便请谅解，期待您的再次光临。@'+$("#smssgin").html()+'#2">模版三</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
			break;
		}	
		case 'yanchi' :
		{
			var yanchi=rsp.smsdelay;if(yanchi.smstext!=''&&yanchi.smstext!=undefined||yanchi.smstext!=null){smstext=yanchi.smstext;}if(yanchi.smsflag!=undefined){flag=yanchi.smsflag;}
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【延时发货】亲爱的<买家旺旺>，由于订单量过大仓库已断货，公司正临时赶货。很抱歉您的订单需延误几天发货请知悉！@'+$("#smssgin").html()+'#0">模版一</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【延时发货】<买家姓名>，由于活动太火爆致使订单量激增，您的宝贝将会延迟几天发出，我们会以短信告知物流动态，请谅解！@'+$("#smssgin").html()+'#1">模版二</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="【延时发货】亲爱的<买家姓名>，由于近期全国各地物流繁忙，您的订单将在2天后才能发出，如果有任何问题请咨询客服。@'+$("#smssgin").html()+'#2">模版三</a></li>');
			$("#sms_template2").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+smstext +'#3">自定义</a></li>');
			break;
		}
		case 'no':{$("#sms_template2").empty();$("#sms_value").val('');break;}
		default :{$("#sms_template2").empty();$("#sms_value").val('');break;}
	}
		var wenzi=$("#sms_template2 li:eq("+flag+")").children('a').html();/*获取文字*/
		var value=$("#sms_template2 li:eq("+flag+") a").attr('value');/*获取a标签的value*/
		$("#sms_template2 li:eq("+flag+")").attr('class','active');/*添加active*/
		$("#sms_template2").siblings('a').children('span').html(wenzi)
		$("#sms_template2").siblings('a').children('input').val(value);
		$("#editsms_template").val(value.split('#')[0]);
		if(flag==3){/*如果选择的是自定义*/
			$("#insert_words").show();
			$("#editsms_template").val(smstext);
			document.getElementById('editsms_template').disabled=false;
			$("#save_chenlongkes").show();
			$(".bcbcbj").parent('label').checkbox().checkbox('check');
			var length=$("#editsms_template").val().length+$("#smssgin").html().length+7;
			if(length>70){
				$('#check_words').html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">'+Math.ceil(length/66)+'</font>条短信(含签名)');
			}else{
				$('#check_words').html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">1</font>条短信(含签名)');
			} 
		}else{
			$("#insert_words").hide();
			$("#save_chenlongkes").hide();
			document.getElementById('editsms_template').disabled=true;
			$(".bcbcbj").parent('label').checkbox().checkbox('uncheck');
			var length=$("#editsms_template").val().length;
			if(length>70){
				$('#check_words').html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">'+Math.ceil(length/66)+'</font>条短信(含签名)');
			}else{
				$('#check_words').html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">1</font>条短信(含签名)');
			} 
		}
	}
function replacesmstext(smstext){/*公共方法*/
	var sign=$("#smssgin").html();
	smstext=smstext.replace('【'+sign+'】','');
	smstext=smstext.replace(/<买家姓名>/g,$("#smstitle").html());
	smstext=smstext.replace(/<下单时间>/g,$("#created"+gtid).html());
	smstext=smstext.replace(/<买家旺旺>/g,$("#smstite_wangwang").html());/*替换为买家旺旺*/
	smstext=smstext.replace(/<订单编号>/g,gtid);/*替换为订单编号*/
	smstext=smstext.replace(/【卖家旺旺】/g,user_nick);
	/* smstext=smstext.replace(new RegExp('@'+sign,"g"),'');  
	smstext=smstext.replace(/【发货提醒】/g,''); 
	smstext=smstext.replace(/【订单提醒】/g,''); 
	smstext=smstext.replace(/【收货提醒】/g,''); 
	smstext=smstext.replace(/【好评奖励】/g,''); 
	smstext=smstext.replace(/【退款成功】/g,'');  */
	return smstext;
}
function sms_template(type){/*选择的模版的onchange事件*/
	var singn=$("#smssgin").html();
	var template=window.localStorage.getItem(user_nick+'smstemplate');
	if(template==''||template==null||template=='null'){
		$.ajax({
			url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/SmsByType',
			type:'post',
			data:{nick:user_nick,type:'template'},
			error:function(msp){
				layer.msg('读取模版失败',1,3);
			},
			success:function(rsp){
				window.localStorage.setItem(user_nick+'smstemplate',rsp);
				sms_template2(type,rsp);
			}
		});
	}else{
		sms_template2(type,template);
	}
		var Textarea = document.getElementById("editsms_template");
		addListener(Textarea,"keyup",function(){
			var Value = $("#editsms_template").val();
			var length=Value.length+singn.length+7;
			if(length>70){
				$("#check_words").html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">'+Math.ceil(length/66)+'</font>条短信(含签名)');
			}else{
				$("#check_words").html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">1</font>条短信(含签名)');
			}
		}); 
	}
function saveSmssingn(type){
	switch(type){
		case '1':/*保存签名*/
		{
			var smsspan=$("#smssgin_text").val();
			if(smsspan!=null&&smsspan!=''){
				var words='&|<|>|;|\\|/|+|~|!|@|#|$|%|^|&|*|(|)|{|}|[|]|制服|股票|大金贵金属|统战|毛泽东|周永康|骚比|正恩|八达岭孔雀城体验|成绩提高快|定税企业|复制手机卡|胡锦涛|截取短信|<*#|李洪志|买枪|你他妈的|瞟】|侨香公馆|上网文凭|税号码改13|提供无*抵*押|我处提供高~档越|一张和对方一样的|越是调控别|情妇|权威主义国家的合法性理论|仁波切|人民真实|人体炸弹|日你妈啦逼|撒尿|三陪|色情网站|汕特农信社|尚勇|社会主义|涂运普|台办|联总|小平|大同证券|止损|仓空|白银|预约电话：0774-2811588|股 票|华澳融信|高于银行利率|股.票|金属|预约电话：0719-5235278|开房|西北大学|预约电话：63317658|公投|援交|胸很大|当局|办理51518888|达赖喇嘛|高息|急用钱|[ldzx]|辽一网|性交|票可开|情感陪护|示威|私募|无须担保|拥护台独|炸药|卓越塔兰漺硬发言|情欲|群P|人权|任亚平|日元贷款|塞你老母|骚 货|杀人|邵家健|神通加持法|生者和死者|脱衣舞|按摩|推翻|月子病|熙来|口交|代办|龚部长|毒胶囊|金菊峰|电狗|放贷|红火柴|疆独|【太极实业】|款]无{抵|马会|你好税提供|缥）|枪支|税点优惠|特肖|温家宝|一样的号玛|越是调控|中奖|钦本立|清债|去死|热站政论网|人事接班|日你妈|瑞士金融大学|三码|色情服务|善念|上你|突厥斯坦|薄瓜瓜|男人|性感|理财|年化收益|异.性|预约电话：69865232|姐的疯狂|王志军|交配|满清|信访|xiu.com活力盛夏|藏独|仿真枪|海峡茶都|江泽民|【票】|克隆|绿卡|你的号码要卖吗|艾滋|枪模|上访|税点优|特码|押贷款|有高档香烟如|中华包装瓶网|窃听王|清纯|去你妈的|热比娅|人民内情真相|人事布局出手既稳又重|日你|肉穴|三级片|色情|善恶有报|上门安装|社保基金会|沈彤|省市换班第五代冒起|cctv|语音|军车|达兰萨拉|前列腺|咪咪|城管|融资|小穴|核污染|代办证件|法轮功|贷款|集会|[脱|就可以让你亲耳听到对|六合彩|民新加坡|接听别人电话|票源正规|情缘点歌平台|双燕|《大金融》|熙溪地|优惠税金|赵洪祝|抢粮记|秦银河|请愿|群奸|人民报讯|人权保障|日本狗|肉棒|塞你母|骚逼|杀手|上海帮|邵明立|沈德咏|升达毕业证|性事|套動|外教|汽车点评|骗 子|骗子|双色球|彩票|警察|冬病夏治|毛岸英|曾庆红|骚女人|成人a片|东港印象|改号通|胡温|今日的小天使|<票>|李永彬|美官员现场剖析|你想了解他人谈~话|票》|窃听|佘山地王联排|税后付款|天材教育一对|我们就能为您做1张同样的卡|移`民|蕴华学校|中特|亲民党|情色|全国两会|仁吉旺姆|人民真实报道|人员安排|日死你|萨达姆|三陪女|色情小电影|对方不会发现|烧饼歌|设局|声色|屠杀|公证|展穴|使馆|嫖娼|领事馆|大奖|中共|民主|露点|屁股|皮革奶粉|办证|代kai|法轮|及各类资格|*3*1|偷听|迷药|您好税提供|票-据|情场的最佳帮手|实荜业正书及部分|税率优|透码|抵押|易贷沈阳为您解决资金难题|增值税|准后在合作|秦光荣|情色电影|瘸腿帮|人弹|人民之声论坛|忍无可忍|日他娘|塞你爸|骚|色欲|金正恩|少数民族|身份证生成器|生鸦片|团派政治明星|透视|酥穴|法院|破解|止盈|借贷|选举|薄一波|胸大|海伍德|罢课|处女|赌博|高潮|婚外情|中南海|生殖器|利民投资|迷魂药|偷窥|票-】|青春不回来|盛大车险|税率低|童子军特训营|无低压.当天放|移民|增直收|专业刷客|亲日|情色大片|全哲洙|仁青加|人渣|日他|萨拉托加|桑 拿|色诱|少儿误入|申维辰|生当作人杰之昨日重现|团派|包皮|酥胸|打倒|猥亵|达赖|枪声|FALUN|奔驰金融专案|弹药|法輪功|管制刀具|假文凭|【汉京山西街】|六码|男女公关|方励之|桑拿|税查验|台独|为感谢社会的支持|新翰教育|有/發/票/低价|中东帕萨迪纳独栋|窃听器|邱学强|群体灭绝|人权侵害|情场|肉棍|三公|骚乱|傻逼|上海垮台|射精|三水法轮|绳虐|法正|轮回|薄熙来|艹|集资|开苞|falun|包二奶|代理税率|法輪|供她的一个号|佳家乐衣讯|【财富单双】|据]|自焚|请把款汇到|税（票）|苏共|脱衣让哥摸乳房|习近平|游行|证券分析|乔石|青天白日旗|庆红|群交|人民大会堂|人权调查|日本军舰|肉洞|骚货|傻屄|邵琪伟|沈浩波|升天|转化|秦永敏|淫妹妹|颠覆|真善忍|账 号|中新网|预约0564-8670666|房地产|好方法不怕试|谷开来|搞基|班禅|政变|fuck|抵制|反动派|国地税|【摩尔城】|抗议|吕祖善|男女员工|陪读|钱还没汇吧|傻B|税点低|泰州金|卫校新生|性别不限|有多余的发票代开|窃听器材|清楚邪恶|屈万祥|燃烧辅助工具|人民大众时事参考|人事变动|日内瓦金融|肉体|三级|骚穴|煞笔|涉日|沈素琍|蔣彥永|CCTV|税务代|零八宪章|房产|银行账号';
				words=words.split('|');
				for(var i in words){
					if(smsspan.split(words[i]).length>1){
						layer.msg("检测到您签名中含有特殊字符，为了不影响短信发送成功率请删除或重新编辑。", 1,3);
						return;
					}
				}
				if(/\s+/.test(smsspan)){
					layer.msg("短信签名不能含有空格", 1,3);
				}else if(/^[0-9]{1,12}$/.test(smsspan)){
					layer.msg("短信签名不能是单纯的数字", 1,3);
				}else if(/^[A-Za-z]{1,12}$/.test(smsspan)){
					layer.msg("短信签名不能是单纯的英文", 1,3);
				}else if(smsspan.length>12){
					layer.msg("短信签名不能超过12个字符", 1,3);
				}else{
					var smstext=$("#sms_value").val();
					if(smstext==''||smstext==null){
					}else{
						var oldsign=$("#smssgin").html();
						smstext=smstext.replace(oldsign,smsspan);
						$("#sms_value").val(smstext);
					}
					var loadi = layer.load(0,0);
					$.ajax({
			   		   type: 'POST',
					   data:{smsspan:smsspan,nick:user_nick,type:'saveSign'},
					   dataType: 'html',
					   timeout: 10000,
				       url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/SmsByType',
				        success: function(data){
				        	$("#smssgin").html(smsspan);
				        	layer.close(loadi);
					        layer.msg('操作成功!', 1, 1);
					        $("#smssgin").html(smsspan);
					        window.localStorage.setItem(user_nick+'smsspan',smsspan);
					    	$("#smssgin_conent2").show();
							$("#smssgin_conent").hide();
						},
				       error: function(msp){
					       	layer.close(loadi);
					       	layer.msg('操作失败!', 1, 3);
				            $("#smssgin_conent2").show();
							$("#smssgin_conent").hide();
					}});
				}
			}else{
				layer.msg("短信签名不能为空", 1,3);
			}
			break;
		}
		case '2':/*取消设置*/
		{
			$("#smssgin_conent2").show();
			$("#smssgin_conent").hide();
			break;
		}
		case '3':/*点此设置*/
		{
			$("#smssgin_text").val($("#smssgin").html());
			$("#smssgin_conent2").hide();
			$("#smssgin_conent").show();
			break;
		}
		case '4':/*保存到自定义模版*/
		{
			var info={};
			info.smstext=$("#editsms_template").val();
			if(info.smstext==null||info.smstext==''||info.smstext=='null'){
				layer.msg('请输入短信内容~',1,3);
				return;
			}
			var type=$("#sms_template").siblings('a').children('input').val();/*发送类型*/
			if(type=='cuifu'){
				info.type='smspay';
			}else if(type=='fahuo'){
				info.type='smssend';
			}else if(type=='queren'){
				info.type='smsconfirm';
			}else if(type=='haoping'){
				info.type='smsgood';
			}else if(type=='tuikuan'){
				info.type='smsrefund';
			}else if(type=='yanchi'){
				info.type='smsdelay';
			}
			var words=window.localStorage.getItem(user_nick+'sms_words');
			info.user_nick=user_nick;
			info.types='index';
			if(words=='null'||words==null ||words==''){
				$.ajax({
					type:'post',
					url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/smsbytype',
					data:{'type':'words','nick':user_nick},
					error:function(msp){},
					success:function(rsp){
						window.localStorage.setItem(user_nick+'sms_words',rsp);
						rsp=JSON.parse(rsp);
						for(var i in rsp){
							var words=rsp[i].words;
							if(info.smstext.indexOf(words)>0){
								layer.alert('检测到您的短信中含有“'+words+'”敏感词，短信无法发送成功，请重新编辑。',8);
								layer.close(index);
								return;
							}
						}
					sendsms2(gtid);
					$.ajax({url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/savedefaultsms',type:'post',data:info,error:function(msp){/*layer.confirm('保存失败');*/},success:function(rsp){/*layer.msg('保存成功', 1, 1);*/window.localStorage.removeItem(user_nick+'smstemplate');}});
				}});
			}else{
				var rsp=JSON.parse(words);
				for(var i in rsp){
					var words=rsp[i].words;
					if(info.smstext.indexOf(words)>0){
						layer.alert('检测到您的短信中含有“'+words+'”敏感词，短信无法发送成功，请重新编辑。',8);
						layer.close(index);
						return;
					}
				}
				sendsms2(gtid);
				$.ajax({url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/savedefaultsms',type:'post',data:info,error:function(msp){/*layer.confirm('保存失败');*/},success:function(rsp){/*layer.msg('保存成功', 1, 1);*/window.localStorage.removeItem(user_nick+'smstemplate');}});
			}
		}
	}
}
function sendsms(rtid){
	if($(".bcbcbj")[0].checked){/*保存本次编辑*/
		gtid=rtid;
		saveSmssingn('4');
	}else{
		sendsms2(rtid);
	}
}
function sendsms2(rtid){
	var port=$("#sms_template2").siblings('a').children('input').val();
	var info={};
	if(port.split('#')[1]=='3'){
		port=3;/*是手动发送*/	
	}else{
		port=123;
	}
	if($("#sms_buyerphone").val()=='' || $("#sms_buyerphone").val()==null){
		layer.msg("请输入手机号码", 1,3);
		return;
	}
	if($("#editsms_template")==''||$("#editsms_template").val()==null){
		layer.msg('请选择发送内容哦~',1,3);
		return;
	}
	var buyertel=$("#sms_buyerphone").val();
	if(buyertel!='' && buyertel!=null){
		if(!/^1[3|4|5|8][0-9]\d{8}$/.test(buyertel)){
				layer.msg("请输入格式正确的11位手机号码", 1,3);
			return;
		}
	}
	var sign=$("#smssgin").html();
	if(/\s+/.test(sign)){
		layer.msg("短信签名不能含有空格", 1,3);
		return;
	}else if(/^[0-9]{1,12}$/.test(sign)){
		layer.msg("短信签名不能是单纯的数字", 1,3);
		return;
	}else if(/^[A-Za-z]{1,12}$/.test(sign)){
		layer.msg("短信签名不能是单纯的英文", 1,3);
		return;
	}else if(sign.length>12){
		layer.msg("短信签名不能超过12个字符", 1,3);
		return;
	}
	var words='&|<|>|;|\\|/|+|~|!|@|#|$|%|^|&|*|(|)|{|}|[|]|制服|股票|大金贵金属|统战|毛泽东|周永康|骚比|正恩|八达岭孔雀城体验|成绩提高快|定税企业|复制手机卡|胡锦涛|截取短信|<*#|李洪志|买枪|你他妈的|瞟】|侨香公馆|上网文凭|税号码改13|提供无*抵*押|我处提供高~档越|一张和对方一样的|越是调控别|情妇|权威主义国家的合法性理论|仁波切|人民真实|人体炸弹|日你妈啦逼|撒尿|三陪|色情网站|汕特农信社|尚勇|社会主义|涂运普|台办|联总|小平|大同证券|止损|仓空|白银|预约电话：0774-2811588|股 票|华澳融信|高于银行利率|股.票|金属|预约电话：0719-5235278|开房|西北大学|预约电话：63317658|公投|援交|胸很大|当局|办理51518888|达赖喇嘛|高息|急用钱|[ldzx]|辽一网|性交|票可开|情感陪护|示威|私募|无须担保|拥护台独|炸药|卓越塔兰漺硬发言|情欲|群P|人权|任亚平|日元贷款|塞你老母|骚 货|杀人|邵家健|神通加持法|生者和死者|脱衣舞|按摩|推翻|月子病|熙来|口交|代办|龚部长|毒胶囊|金菊峰|电狗|放贷|红火柴|疆独|【太极实业】|款]无{抵|马会|你好税提供|缥）|枪支|税点优惠|特肖|温家宝|一样的号玛|越是调控|中奖|钦本立|清债|去死|热站政论网|人事接班|日你妈|瑞士金融大学|三码|色情服务|善念|上你|突厥斯坦|薄瓜瓜|男人|性感|理财|年化收益|异.性|预约电话：69865232|姐的疯狂|王志军|交配|满清|信访|xiu.com活力盛夏|藏独|仿真枪|海峡茶都|江泽民|【票】|克隆|绿卡|你的号码要卖吗|艾滋|枪模|上访|税点优|特码|押贷款|有高档香烟如|中华包装瓶网|窃听王|清纯|去你妈的|热比娅|人民内情真相|人事布局出手既稳又重|日你|肉穴|三级片|色情|善恶有报|上门安装|社保基金会|沈彤|省市换班第五代冒起|cctv|语音|军车|达兰萨拉|前列腺|咪咪|城管|融资|小穴|核污染|代办证件|法轮功|贷款|集会|[脱|就可以让你亲耳听到对|六合彩|民新加坡|接听别人电话|票源正规|情缘点歌平台|双燕|《大金融》|熙溪地|优惠税金|赵洪祝|抢粮记|秦银河|请愿|群奸|人民报讯|人权保障|日本狗|肉棒|塞你母|骚逼|杀手|上海帮|邵明立|沈德咏|升达毕业证|性事|套動|外教|汽车点评|骗 子|骗子|双色球|彩票|警察|冬病夏治|毛岸英|曾庆红|骚女人|成人a片|东港印象|改号通|胡温|今日的小天使|<票>|李永彬|美官员现场剖析|你想了解他人谈~话|票》|窃听|佘山地王联排|税后付款|天材教育一对|我们就能为您做1张同样的卡|移`民|蕴华学校|中特|亲民党|情色|全国两会|仁吉旺姆|人民真实报道|人员安排|日死你|萨达姆|三陪女|色情小电影|对方不会发现|烧饼歌|设局|声色|屠杀|公证|展穴|使馆|嫖娼|领事馆|大奖|中共|民主|露点|屁股|皮革奶粉|办证|代kai|法轮|及各类资格|*3*1|偷听|迷药|您好税提供|票-据|情场的最佳帮手|实荜业正书及部分|税率优|透码|抵押|易贷沈阳为您解决资金难题|增值税|准后在合作|秦光荣|情色电影|瘸腿帮|人弹|人民之声论坛|忍无可忍|日他娘|塞你爸|骚|色欲|金正恩|少数民族|身份证生成器|生鸦片|团派政治明星|透视|酥穴|法院|破解|止盈|借贷|选举|薄一波|胸大|海伍德|罢课|处女|赌博|高潮|婚外情|中南海|生殖器|利民投资|迷魂药|偷窥|票-】|青春不回来|盛大车险|税率低|童子军特训营|无低压.当天放|移民|增直收|专业刷客|亲日|情色大片|全哲洙|仁青加|人渣|日他|萨拉托加|桑 拿|色诱|少儿误入|申维辰|生当作人杰之昨日重现|团派|包皮|酥胸|打倒|猥亵|达赖|枪声|FALUN|奔驰金融专案|弹药|法輪功|管制刀具|假文凭|【汉京山西街】|六码|男女公关|方励之|桑拿|税查验|台独|为感谢社会的支持|新翰教育|有/發/票/低价|中东帕萨迪纳独栋|窃听器|邱学强|群体灭绝|人权侵害|情场|肉棍|三公|骚乱|傻逼|上海垮台|射精|三水法轮|绳虐|法正|轮回|薄熙来|艹|集资|开苞|falun|包二奶|代理税率|法輪|供她的一个号|佳家乐衣讯|【财富单双】|据]|自焚|请把款汇到|税（票）|苏共|脱衣让哥摸乳房|习近平|游行|证券分析|乔石|青天白日旗|庆红|群交|人民大会堂|人权调查|日本军舰|肉洞|骚货|傻屄|邵琪伟|沈浩波|升天|转化|秦永敏|淫妹妹|颠覆|真善忍|账 号|中新网|预约0564-8670666|房地产|好方法不怕试|谷开来|搞基|班禅|政变|fuck|抵制|反动派|国地税|【摩尔城】|抗议|吕祖善|男女员工|陪读|钱还没汇吧|傻B|税点低|泰州金|卫校新生|性别不限|有多余的发票代开|窃听器材|清楚邪恶|屈万祥|燃烧辅助工具|人民大众时事参考|人事变动|日内瓦金融|肉体|三级|骚穴|煞笔|涉日|沈素琍|蔣彥永|CCTV|税务代|零八宪章|房产|银行账号';
	words=words.split('|');
	for(var i in words){
		if(sign.split(words[i]).length>1){
			layer.msg("检测到您签名中含有特殊字符，为了不影响短信发送成功率请删除或重新编辑。", 1,3);
			return;
		}
	}
	info.smstext=$("#editsms_template").val();/*短信内容*/
	info.buyer_nick=$("#smstite_wangwang").html();/*收信方昵称*/
	info.nick=user_nick;/*发信方昵称~*/
	info.tid=rtid;/*订单编号*/
	info.smstype=$("#sms_template").siblings('a').children('input').val();/*发送的状态类型短信，fahuo,haoping,quren,tuikuan,cuifu,yanchi*/
	info.buyertel=buyertel/*接收方电话号码~*/
	info.smsspan=sign;/*短信签名*/
	info.smstext=replacesmstext(info.smstext);
	if(info.smstype=='fahuo' && port!=3){/*选择的是模板发货*/
		info.port='cm';
	}else if(port==3){/*选得是自定义*/
		info.port='812';		
	}else if(info.smstype=='cuifu' && port!=3){/*催付模版*/
		info.port='gd';
	}else{
		info.port='gd';
	}
	if(port==3){
		if(info.smstype=='fahuo'){/*发货*/
			info.smstext='【发货提醒】'+info.smstext+'@'+sign;
		}else if(info.smstype=='cuifu'){/*催付*/
			info.smstext='【订单提醒】'+info.smstext+'@'+sign;
		}else if(info.smstype=='yanchi'){/*延迟*/
			info.smstext='【延时发货】'+info.smstext+'@'+sign;
		}else if(info.smstype=='haoping'){/*好评*/
			info.smstext='【好评奖励】'+info.smstext+'@'+sign;
		}else if(info.smstype=='tuikuan'){/*退款*/
			info.smstext='【退款成功】'+info.smstext+'@'+sign;
		}else if(info.smstype=='queren'){/*确认*/
			info.smstext='【收货提醒】'+info.smstext+'@'+sign;
		}		
	}
	if(info.smstext.split('<物流公司>').length>1||info.smstext.split('<物流单号>').length>1){
		QN.top.invoke({
			cmd:'taobao.logistics.orders.get',
			method:'get',
			param:{fields:'company_name,out_sid',tid:rtid},
			error:function(msp){
				layer.msg('亲，没有获取到您的物流信息，请重新编辑后再发送哦。',1,3);
				return;
			},
			success:function(rsp){
				if(typeof rsp ==='string'){ rsp=JSON.parse(rsp);}
					var order=rsp.logistics_orders_get_response.shippings.shipping[0];
					/*alert(JSON.stringify(order));*/
					var out_sid=order.out_sid;
					var company_name=order.company_name;
					info.smstext=info.smstext.replace(/<物流公司>/g,company_name);
					info.smstext=info.smstext.replace(/<物流单号>/g,out_sid);
					/*alert('发送的内容 '+'----->'+info.smstext);*/
				/*return; */
				var index=layer.load(0,0);
				$.ajax({
					type:'POST',
					url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/SmsByType',
					dataType:'html',
					data:{nick:user_nick,type:'select'},
					error:function(){layer.close(index);layer.msg('短信提交失败', 1, 8);},
					success:function(rsp){
						rsp=JSON.parse(rsp);
						if(rsp.smsnum==0||rsp.smsnum==''||rsp.smsnum<0){
							layer.close(index);
							showsmsbuy();
							return;
						}else{
							var words=window.localStorage.getItem(user_nick+'sms_words');
							if(words=='null'||words==null ||words==''){
								$.ajax({
									type:'post',
									url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/smsbytype',
									data:{'type':'words','nick':user_nick},
									error:function(msp){},
									success:function(rsp){window.localStorage.setItem(user_nick+'sms_words',rsp);rsp=JSON.parse(rsp);for(var i in rsp){var words=rsp[i].words;if(info.smstext.indexOf(words)>0){layer.alert('检测到您的短信中含有“'+words+'”敏感词，短信无法发送成功，请重新编辑。',8);layer.close(index);return;}}
									/*layer.alert('发送先暂停~。因为已经可以提交发送短信了。现在进行前段装修工作');
									return;*/
									$.ajax({type:'post',url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/sendsms',dataType:'html',data:info,timeout:10000,error:function(msp){layer.close(index);layer.msg('短信提交失败', 1, 8);},success:function(rsp){layer.close(index);layer.msg(rsp, 1, 1);closeMsg('');}});
								}});
							}else{
								var rsp=JSON.parse(words);for(var i in rsp){var words=rsp[i].words;if(info.smstext.indexOf(words)>0){layer.alert('检测到您的短信中含有“'+words+'”敏感词，短信无法发送成功，请重新编辑。',8);layer.close(index);return;}}
								$.ajax({type:'post',url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/sendsms',dataType:'html',data:info,timeout:10000,error:function(msp){layer.close(index);layer.msg('短信提交失败', 1, 8);},success:function(rsp){layer.close(index);layer.msg(rsp, 1, 1);closeMsg('');}});
							}
						}
					}});									
				}
			});
	}else{
	/*alert('发送的内容 '+'----->'+info.smstext);
	return; */
	var index=layer.load(0,0);
	$.ajax({
		type:'POST',
		url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/SmsByType',
		dataType:'html',
		data:{nick:user_nick,type:'select'},
		error:function(){layer.close(index);layer.msg('短信提交失败', 1, 8);},
		success:function(rsp){
			rsp=JSON.parse(rsp);
			if(rsp.smsnum==0||rsp.smsnum==''||rsp.smsnum<0){
				layer.close(index);
				showsmsbuy();
				return;
			}else{
				var words=window.localStorage.getItem(user_nick+'sms_words');
				if(words=='null'||words==null ||words==''){
					$.ajax({
						type:'post',
						url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/smsbytype',
						data:{'type':'words','nick':user_nick},
						error:function(msp){},
						success:function(rsp){window.localStorage.setItem(user_nick+'sms_words',rsp);rsp=JSON.parse(rsp);for(var i in rsp){var words=rsp[i].words;if(info.smstext.indexOf(words)>0){layer.alert('检测到您的短信中含有“'+words+'”敏感词，短信无法发送成功，请重新编辑。',8);layer.close(index);return;}}
						/*layer.alert('发送先暂停~。因为已经可以提交发送短信了。现在进行前段装修工作');
						return;*/
						$.ajax({type:'post',url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/sendsms',dataType:'html',data:info,timeout:10000,error:function(msp){layer.close(index);layer.msg('短信提交失败', 1, 8);},success:function(rsp){layer.close(index);layer.msg(rsp, 1, 1);closeMsg('');}});
					}});
				}else{
					var rsp=JSON.parse(words);for(var i in rsp){var words=rsp[i].words;if(info.smstext.indexOf(words)>0){layer.alert('检测到您的短信中含有“'+words+'”敏感词，短信无法发送成功，请重新编辑。',8);layer.close(index);return;}}
					$.ajax({type:'post',url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/sendsms',dataType:'html',data:info,timeout:10000,error:function(msp){layer.close(index);layer.msg('短信提交失败', 1, 8);},success:function(rsp){layer.close(index);layer.msg(rsp, 1, 1);}});
				}
			}
		}});
	}
}
function smstemplat2change(obj){
	var value=obj.value;
	if(value.split("#")[1]==3){
		$("#editsms_template").val(obj.value.split('#')[0]);
		$("#insert_words").show();
		$("#save_chenlongkes").show();
		document.getElementById('editsms_template').disabled=false;
		$(".bcbcbj").parent('label').checkbox().checkbox('check');
		var length=value.length+$("#smssgin").html().length+5;/*#3还带2个字符*/
		if(length>70){
			$("#check_words").html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">'+Math.ceil(length/66)+'</font>条短信(含签名)');
		}else{
			$("#check_words").html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">1</font>条短信(含签名)');
		}  
	}else{
		document.getElementById('editsms_template').disabled=true;
		$("#editsms_template").val(obj.value.split('#')[0]);
		$("#insert_words").hide();
		$("#save_chenlongkes").hide();
		$(".bcbcbj").parent('label').checkbox().checkbox('uncheck');
		var length=value.length-2;
		if(length>70){
			$("#check_words").html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">'+Math.ceil(length/66)+'</font>条短信(含签名)');
		}else{
			$("#check_words").html('已输入<font color="red">'+length+'</font>个字符，约<font color="red">1</font>条短信(含签名)');
		}  
	}
}
function showsmsbuy(){/*购买短信的弹框*/
	var loadi=layer.load('加载中...',5);
		$.ajax({
	        type: 'POST',
	        data:{type:'set',nick:user_nick},
		    url: '<?php echo APP_WEB_INDEX_ROOT; ?>/iytrade/smsbuy',
		        success: function(data){
		        	layer.close(loadi);
		        	var smsdata=JSON.parse(data);
		        	var datas=smsdata.set;
		        	var html='<table class="table table-striped table-bordered table-condensed" style="margin: 10px 10px 10px -10px;"><thead><tr><th>套餐包名称</th><th>操作</th></tr></thead><tbody>';
		        	for(index in datas){
		        		html+='<tr><td>'+datas[index].title+'</td><td><a href="javascript:void(0);" onclick="smsbuy('+datas[index].id+')">立即购买</a></td></tr>';
		        	}
		        	html+='</tbody></table>';
		        	html+='<div class="alert alert-info" style="margin-right:10px;margin-left:-10px;">如果剩余短信条数为0，请购买后再开启短信关怀</div>';
		        	var datas=smsdata.log;
		        	var htmls='<table class="table table-striped table-bordered table-condensed" style="margin: 0px 10px 10px -10px;"><thead><tr><th>购买时间</th><th>套餐包</th><th>金额</th></tr></thead><tbody>';
		        	for(index in datas){
		        		htmls+='<tr><td align="center" style="border:solid 1px #C0C0C0;border-collapse:collapse;width:30%;">'+datas[index].paytime+'</td><td align="center" style="border:solid 1px #C0C0C0;border-collapse:collapse;width:50%;">'+datas[index].typetitle+'</td><td align="center" style="border:solid 1px #C0C0C0;border-collapse:collapse;width:20%;">'+datas[index].price+'元</td></tr>';
		        	}
		        	htmls+='</tbody></table>';
		        	layer.tab({
					    area: [($(window).width() - 110) +'px', ($(window).height() - 110) +'px'],
					    offset: ['50px', ''],
					    data: [
					        {title: '购买', content:html},
					        {title: '记录', content:htmls}                    
					    ]
					});
				},
		       error: function(){
		       		layer.close(loadi);
		    	    layer.msg('操作失败，请重试！',1,3);
		            
				}
		    });
}
/**
 * 购买短信-支付宝协议
 * @author Duanhq
 */
function smsbuy(id){
	layer.close(layer.index);
	var loadi=layer.load(5);
	$.ajax({
	        type: "get",
		    url: 'http://sms.zzgdapp.com/pay/alipay?type=tradesms&nick='+user_nick+'&typeid='+id,
	  	    beforeSend: function(XMLHttpRequest){
	       },
	        success: function(data){
	        	layer.close(loadi);
	            if(data=='sql_error'){
		           	layer.msg('sql_error:订单生成失败，请重试！',1,3);
		            
	            }else{
	            	 QN.application.invoke({
	   					"cmd" : "browserUrlEmbedded",
	   					"param" : { "url" : data,id : '1', "title" : "短信订购", "width" : '900', "height" : '720' }
	   				});
	            	 layer.confirm('完成付款了吗？', function(){
					    layer.close(layer.index);
					    $('#sendsms_content').modal('show');
					});
	            }
			},
		    complete: function(XMLHttpRequest, textStatus){
	  		},
	       error: function(){
		       	layer.close(loadi);
		        layer.msg('操作失败，请重试！',1,3);
	       }
	    });
}
/*$(".bcbcbj").click(function(){
	if(this.checked){
		var value=$("#editsms_template").val();
		value=replacesmstext(value);
		var length=$("#sms_value").val().length+$("#smssgin").html().length+Number(2);
		if(length>70){
			$("#check_words").html('已输入<font color="red">'+length+'</font>个汉字符，约'+Math.ceil(length/66)+'条短信(含签名)');
		}else{
			$("#check_words").html('已输入<font color="red">'+length+'</font>个汉字符，约1条短信(含签名)');
		}  
	}
});*/
var first=0;
var last=0;
function insertwords(content){
	var textBox = document.getElementById("editsms_template"); 
	var pre = textBox.value.substr(0, first); 
	var post = textBox.value.substr(last); 
	textBox.value = pre + content + post;
}
function savePossms(textBox){ 
	//如果是Firefox(1.5)的话，方法很简单 
	if(typeof(textBox.selectionStart) == "number"){ 
		first = textBox.selectionStart; 
		last = textBox.selectionEnd; 
	}else if(document.selection){ //下面是IE(6.0)的方法，麻烦得很，还要计算上'\n' 
		var range = document.selection.createRange(); 
		if(range.parentElement().id == textBox.id){
			// create a selection of the whole textarea 
			var range_all = document.body.createTextRange(); 
			range_all.moveToElementText(textBox); 
			//两个range，一个是已经选择的text(range)，一个是整个textarea(range_all) 
			//range_all.compareEndPoints()比较两个端点，如果range_all比range更往左(further to the left)，则 		//返回小于0的值，则range_all往右移一点，直到两个range的start相同。 
//calculate selection start point by moving beginning of range_all to beginning of range 
			for (first=0; range_all.compareEndPoints("StartToStart", range) < 0; first++) 
				range_all.moveStart('character', 1); 
//get number of line breaks from textarea start to selection start and add them to start 
//计算一下\n 
			for (var i = 0; i <= first; i ++){
				if (textBox.value.charAt(i) == '\n')
					first++;
			}
			// create a selection of the whole textarea 
			var range_all = document.body.createTextRange(); 
			range_all.moveToElementText(textBox); 
			// calculate selection end point by moving beginning of range_all to end of range 
			for (last = 0; range_all.compareEndPoints('StartToEnd', range) < 0; last ++)
				range_all.moveStart('character', 1); 
			// get number of line breaks from textarea start to selection end and add them to end 
			for (var i = 0; i <= last; i ++){
				if (textBox.value.charAt(i) == '\n')
					last ++; 
			}
		}
	}
if(event.keyCode==39 && event.srcElement.id=="editsms_template"){		
	if(textBox.value.length!=last){
		first = first + 1;
		last = last + 1;
	}
}
if(event.keyCode==37 && event.srcElement.id=="editsms_template"){		
		first = first - 1;
		last = last - 1;
}
//document.getElementById("start").value = start;
//document.getElementById("end").value = end;
}
function addListener(element,e,fn){ 
	if(element.addEventListener){   
		element.addEventListener(e,fn,false);   
	}else {   
		element.attachEvent("on" + e,fn);   
	}   
}
</script>

<!-- 业务逻辑处理   -->
<script type="text/javascript">
/**
 * 修改价格-天猫只能修改运费(B店)
 * @author Duanhq
 */
function showeditpost(tid){
    gtid=tid;
    $("#editpostval").val('');
    $('#editpost-table').modal('show');
}
/**
 * 修改运费-天猫商城
 * @author Duanhq
 */
function editpost(){
    var fee=$("#editpostval").val();
    fee=clearBr(fee);
    closeMsg('');
    if(fee!=''){
        QN.top.invoke({
            "cmd": "taobao.trade.postage.update",
            "param":{
                tid:gtid,
                post_fee:fee
            },
            "method": "get",
            "success" : function(rsp) {
                if(typeof rsp === 'string'){
                    var rsp = JSON.parse(rsp);
                }else{
                    var	rsp= rsp;
                }
                
            	layer.msg('修改成功！',1,3);
            	
            	var payment=rsp.trade_postage_update_response.trade.payment;
            	var post_fee=rsp.trade_postage_update_response.trade.post_fee;
                $('#listpayall'+gtid).text(payment);
                $('#listpaydfk'+gtid).text(payment);

                $('#listpostall'+gtid).text(post_fee);
                $('#listpostdfk'+gtid).text(post_fee);
                
                if(liststatus=='detail'){
                	getdetail(gtid);
                }
            },
            error: function(msp){
                if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }else{
                    var	msp= msp;
                }
                closeMsg('');
                if(msp.sub_code=='subuser.has-no-permission'){
                /* 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                     */
                }else if(msp.sub_msg=='订单状态错误'){
                	layer.msg('卖家进入付款流程，15分钟之内无法操作',1,3);
                    
                }else{
                	geterrorinfo("taobao.trade.postage.update",msp);
                }
            }
        });
    }else{
    	layer.msg('邮费不能为空！',1,3);
        
        $("input[msgstu='again']").attr("onclick","closeMsg('editpost-table');");
    }
}
/**
 * 修改价格-调用改价组件(C店)
 * @author Duanhq
 */
function getpricer(tid){
        QN.component.invoke( {
            category:'updateprice',
            param:{
                uuid:'2314',
                tid:tid
            },
            error : function(msg, cmd, param) {
                
            },
            success : function(rsp) {
            	if(typeof rsp === 'string'){
                    var rsp = JSON.parse(rsp);
                }else{
                    var	rsp= rsp;
                }
                $('#listpayall'+tid).text("实付:"+rsp.payment+"元");
                $('#listpaydfk'+tid).text("实付:"+rsp.payment+"元");
           	 	$('#listpostall'+tid).text("(含运费"+rsp.post_fee+"元)");
             	$('#listpostdfk'+tid).text("(含运费"+rsp.post_fee+"元)");
                if(rsp.post_fee>0||rsp.post_fee!=0){
                	$("#postbut"+gsta+tid).show();
                }else if(rsp.post_fee=='0.00'||rsp.post_fee==0||rsp.post_fee==undefined){
                	$("#postbut"+gsta+tid).hide();
                }
            	layer.msg('改价成功！',1,1);
	            
	            if(liststatus=='detail'){
                	getdetail(gtid);
                }
            }
        });

}
/**
 * 一键免邮
 * 1.打开二次确认框
 * @author Duanhq
 * Last author chenlongke
 */
function openpostfree(tid){
	gtid=tid;
}
/**
 * 一键免邮
 * 2.确认免除邮费
 * @author Duanhq
 */
function postfree()
{var rtid=gtid;
    QN.top.invoke({
        "cmd": "taobao.trade.postage.update",
        "param":{
            tid:rtid,
            post_fee:0
        },
        "method": "get",
        "success" : function(rsp) {
            if(typeof rsp === 'string'){
                var rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
            var payment=rsp.trade_postage_update_response.trade.payment;
        	var post_fee=rsp.trade_postage_update_response.trade.post_fee;
            $('#listpayall'+rtid).text("实付:"+payment+"元");
            $('#listpaydfk'+rtid).text("实付:"+payment+"元");
            $('#listpostall'+rtid).text("(含运费"+post_fee+"元)");
            $('#listpostdfk'+rtid).text("(含运费"+post_fee+"元)");
            if(post_fee=='0.00'||post_fee==0||post_fee<0||post_fee==''||post_fee==null){
            	$("#postbut"+gsta+rtid).hide();
            }
            layer.msg('修改成功！', 2, 1);
            if(liststatus=='detail'){
            	getdetail(gtid);
            }
        },
        error: function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var	msp= msp;
            }
            closeMsg('');
            if(msp.sub_code=='subuser.has-no-permission'){
            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                 */
            }else if(msp.sub_msg=='订单状态错误'){
            	layer.msg('卖家进入付款流程，15分钟之内无法操作',1,3);
                
            }else{
            	geterrorinfo("taobao.trade.postage.update",msp);
            }
        }
    });
}
/**
 * 关闭订单
 * 1.打开关闭订单附属窗口
 * 2.加载子订单数据，支持拆单关闭
 */
function showclosetrade(tid,trade){
	gtid=tid;
	$('#close_refsh').show();
	/*showMsg('close-table');*/
	$("#closelist").empty();
	if(trade==null||trade==''){/*数据传递失败，调用top接口显示数据*/
		QN.top.invoke({
	        "cmd": "taobao.trade.fullinfo.get",
	        "param": {
	            "fields":"orders.status,orders.oid,orders.pic_path,orders.title,orders.price,orders.num,orders.sku_properties_name,orders.outer_sku_id,orders.outer_iid",
	             "tid":gtid
	        },
	        "method": "get",
	        "success": function (rsp){
	            if(typeof rsp === 'string'){
	                var rsp = JSON.parse(rsp);
	            }else{
	                var	rsp= rsp;
	            }
	            var datas={};
	            trade = rsp.trade_fullinfo_get_response.trade;
	            datas.tditems=trade.orders.order;
	            $("#closelist").empty();
	            for(var n in trade.orders.order){
	                var oid=trade.orders.order[n].oid;
	                if(datas.tditems[n].status=="TRADE_NO_CREATE_PAY"||datas.tditems[n].status=="WAIT_BUYER_PAY"){
	                	datas.tditems[n].iscdclose=true;
	                }else{
	                	datas.tditems[n].iscdclose=false;
	                }
	            }
	            var source = $("#closelist_template").html();
	            var template=Handlebars.compile(source);
	            var htmlstr = template(datas);
	            $("#closelist").html(htmlstr);
	            $('#close_refsh').hide();
	        },
	        error: function(msp){
	            /*请求出错处理 */
	            /* alert(JSON.stringify(msp));*/
	        	$('#close_refsh').text('订单加载失败，：)');
	        	closeMsg('');
	            if(typeof msp === 'string'){
	                var msp = JSON.parse(msp);
	            }else{
	                var	msp= msp;
	            }
	            if(msp.sub_code=='subuser.has-no-permission'){
	            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
	     	         */
	            }else{
	            	geterrorinfo("taobao.trade.fullinfo.get",msp);
	            }
	        }
	    });
	}else{
		try{
	        if(typeof trade === 'string'){
	            trade = JSON.parse(trade);
	        }
			var datas={};
	        datas.tditems=trade;
	        $("#closelist").empty();
	        for(var n in trade){

	            if(datas.tditems[n].status=="TRADE_NO_CREATE_PAY"||datas.tditems[n].status=="WAIT_BUYER_PAY"){
	            	datas.tditems[n].iscdclose=true;
	            }else{
	            	datas.tditems[n].iscdclose=false;
	            }
	            
	           	var  closesta=$('#restas'+gsta+trade[n].oid).text();
	        	if(closesta=='已取消'){
	        		datas.tditems[n].iscdclose=false;
	        	}
	           /* datas.outer_sku_id=trade.orders.order[n].outer_sku_id;
	            datas.outer_iid=trade.orders.order[n].outer_iid;*/
	        }
	        var source = $("#closelist_template").html();
	        var template=Handlebars.compile(source);
	        var htmlstr = template(datas);
	        $("#closelist").html(htmlstr);
	        $('#close_refsh').hide();
	   }catch(e){
	   		
	   }
	}
}
/**
 * 关闭订单
 * 1.判断是否拆单关闭
 * @author Duanhq
 */
function tidclose(){
	var num=0;
	var tids=new Array();
	var turn=document.getElementsByName('closecheckcheckbox');
	for(i=0;i<turn.length;i++){ 
		if(turn[i].checked){ 
			tids[num++]=turn[i].value;
		}
	}
    if(num==0){
    	closeMsg('');
    	layer.msg('关闭错误，请选择需要关闭的订单！',1,3);
        
        $("input[msgstu='again']").attr("onclick","closeMsg('close-table');");
		
    }else{
		if(num==turn.length){
			/*不拆单关闭*/
			tids=new Array([gtid]);
		}
    }
    tidcloses(tids);
    
}
/**
 * 关闭订单
 * 2.确认关闭
 * @aothor Duanhq
 */
function tidcloses(closeid)
{
    var day=$("#tidclose").val();
    if(day!=''){
    	var dd=layer.load(3);
    	for(index in closeid){
            QN.top.invoke({
                "cmd": "taobao.trade.close",
                "param":{
                    tid:closeid[index],
                    close_reason:day
                },
                "method": "get",
                "success" : function(rsp) {
                    if(typeof rsp === 'string'){
                        var rsp = JSON.parse(rsp);
                    }else{
                        var	rsp= rsp;
                    }
                    var tid=rsp.trade_close_response.trade.tid;
    				/*$('#dfk_list').empty();
    				$('#close_list').empty();
    				$('#all_list').empty();*/
    				var total=$('#'+gsta+'num').html();
    				total=total.replace('(','');
    				total=total.replace(')','');
    				var sums=total-1;
    				if(sums==0||sums<1){
    					$('#'+gsta+'num').html("(0)");
    					$("#"+gsta+"_list").html('<div class="sui-msg msg-large msg-tips" style="width:100%"><div class="msg-con">您没有当前状态的订单</div><s class="msg-icon"></s></div>');
        			}else{
        				$('#'+gsta+'num').html(sums);
            		}
            		layer.close(dd);
    				$('#table'+gsta+tid).remove();
    				layer.msg("关闭成功！",1,1);
                    if(liststatus=='detail'){
                    	getdetail(gtid);
                    }
                    getordersta(gsta,gpageno);
                    /*
                    if(tid==gtid){
                        /*主订单被关闭
			        	var turn=document.getElementsByName('closecheckcheckbox');
			        	for(i=0;i<turn.length;i++){
			        		if(turn[i].checked){
			            		tid=turn[i].value;
			            		$('#restasall'+tid).text('已取消');
			            		$('#restasdfk'+tid).text('已取消');
			            		$('#close_'+tid).remove();
			        		}
			        	}
			        	/*最新状态切换：等待付款->已关闭
			        	$('#stascalall'+gtid).attr("class", "label label-");
                    	$('#stascaldfk'+gtid).attr("class", "label label-");
                    	$('#stascalall'+gtid).text('已关闭');
                    	$('#stascaldfk'+gtid).text('已关闭');
                    	/*前状态业务功能按钮隐藏：关闭订单，改价，催付，一键免邮
                    	$('#closebutdfk'+gtid).hide();
                    	$('#closebutall'+gtid).hide();
                    	$('#pricebutdfk'+gtid).hide();
                    	$('#pricebutall'+gtid).hide();
                    	$('#postbutdfk'+gtid).hide();
                    	$('#postbutall'+gtid).hide();
			        	layer.msg('操作成功！</p>');
                    }else{
                    	$('#restasall'+tid).text('已取消');
			            $('#restasdfk'+tid).text('已取消');
                    	layer.msg('操作成功！</p>');
						
                    }*/

                },
                error: function(msp){
                    layer.close(dd);
                    if(typeof msp === 'string'){
                        var msp = JSON.parse(msp);
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                    	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                         */
                    }else{
                    	geterrorinfo("taobao.trade.close",msp);
                    }
                }
            });
    	}
    }else{
    	layer.msg("关闭错误，关闭理由不能为空！",1,3);
        $("input[msgstu='again']").attr("onclick","closeMsg('close-table');");
    }
}
/**
 * 发货
 * 1.加载发货数据
 * 2.支持拆单发货
 */
var cdsend;
var sentid=null;
function showsend(tid,type){
	$("#postid").val('');/*运单号清空*/
	$("#codpostid").val('');/*运单号清空*/
	$('#othercompany').val('');
	sentid=tid;
	gtid=tid;
	$("#sendlist").empty();
	$('#send_refsh').show();
	showmyaddr();
	if(type=='senditem-table'){/*不是货到付款*/
		getcompty(null);/*加载默认物流*/
		/*$('#comptyid').change(c_offline);*/
	}
		QN.top.invoke({
	        cmd: "taobao.trade.fullinfo.get",
	        param: {
	            fields:"seller_flag,buyer_nick,buyer_message,seller_memo,receiver_name,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_mobile,receiver_phone,orders.status,orders.oid,orders.pic_path,orders.title,orders.price,orders.num,orders.sku_properties_name,orders.outer_sku_id,orders.outer_iid",
	             tid:gtid
	        },
	        method: "get",
	        success: function (rsp){
	            if(typeof rsp === 'string'){
	                var rsp = JSON.parse(rsp);
	            }else{
	                var	rsp= rsp;
	            }
	            var datas={};
	            trade = rsp.trade_fullinfo_get_response.trade;
	            datas.tditems=trade.orders.order;
	            var value=datas.tditems.length;
	            $("#sendlist").empty();
	            for(var n in trade.orders.order){
                	if(datas.tditems[n].status=="WAIT_BUYER_CONFIRM_GOODS" ||datas.tditems[n].status=='TRADE_FINISHED'){
                    	datas.tditems[n].iscdsend=false;
                        value--;
                 	}else{
                       	datas.tditems[n].iscdsend=true;
                    }
                    datas.outer_sku_id=trade.orders.order[n].outer_sku_id;
                    datas.outer_iid=trade.orders.order[n].outer_iid;
                }
                if(value==datas.tditems.length){
			    	cdsend=value;
		    	}else{
			    	cdsend=0;
		    	}
		    	datas.receiver_name= trade.receiver_name;
                datas.receiver_state = trade.receiver_state;
                datas.receiver_city = trade.receiver_city;
                datas.receiver_district = trade.receiver_district;
                datas.receiver_address = trade.receiver_address;
                datas.receiver_zip = trade.receiver_zip;
                datas.receiver_mobile = trade.receiver_mobile;
                datas.receiver_phone = trade.receiver_phone;
                datas.consign_time = trade.consign_time;
                datas.buyer_nick=trade.buyer_nick;
				if(trade.buyer_message!=undefined && trade.buyer_message!=''){
					datas.buyer_message=trade.buyer_message;
				}
				if(trade.seller_memo!=undefined && trade.seller_memo!=''){
					datas.seller_memo=trade.seller_memo;
				}
				datas.seller_flag=trade.seller_flag;
	            var source = $("#sendlist_template").html();
                var template=Handlebars.compile(source);
                var htmlstr = template(datas);
                $("#sendlist").html(htmlstr);
                source = $("#codsendlist_template").html();
                template=Handlebars.compile(source);
                htmlstr = template(datas);
                $("#sendcodlist").html(htmlstr);
                $('#send_refsh').hide();
               /* $("#sendplan").change(a_offline);陈龙科*/
                /*a_offline();*/
                $("#"+type).modal('show');
	        },
	        error: function(msp){
	        	$('#close_refsh').text('订单加载失败，：)');
	            if(typeof msp === 'string'){
	                var msp = JSON.parse(msp);
	            }
	            $("#"+type).modal('show');
	            if(msp.sub_code=='subuser.has-no-permission'){
	            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
	     	         */
	            }else{
	            	geterrorinfo("taobao.trade.fullinfo.get",msp);
	            }
	        }
	    });
	}
/**
 * 加载物流公司
 * 1.获取数据
 * @author Duanhq
 */
function getcompty(changeoff){
		var comptydata = window.localStorage.getItem("compty"+user_nick);
		if(comptydata==null||comptydata=="null"|| typeof(comptydata)=="undefined"||comptydata.length<4)
		{
			$.ajax({
         		url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getsend',
         		type: 'POST',
         		dataType:'html',
         		data:{nick:user_nick},
         		timeout:10000,
				error: function(){
					loaddatass(comptydata,changeoff);
				},
				success: function(data){
					if(data.length>3)
                     {
                         window.localStorage.setItem("compty"+user_nick,data);
                     }
					loaddatass(data,changeoff);
				}
			});
		}else{
			loaddatass(comptydata,changeoff);
		}
}
/**
 * 加载物流公司
 * 2.业务处理
 * @author Duanhq
 */
var lastmodes="";/*上次发货的记录*/
var lasttrade="";/*上一次发货的公司*/
function loaddatass(data,changeoff){
	$("#wuliush1").show();
	$("#wuliush2").show();
	$("#off_other").empty();
	if(data==null|| typeof(data)=="undefined"||data==''||data.length<4){
	}else{
    	data=JSON.parse(data);
	}
	var name='';
    var code='';
    var datas={};
    datas.lastmode=new Array();
	datas.lastmode[0]='offline';
	datas.lastmode[1]='';
    datas.onname='';
    datas.oncode='';
    datas.offname='';
    datas.offcode='';
    for(index in data){
        order=data[index];
        /*在线下单，卖家是否在数据库中存储了默认快递公司*/
        	if(order.mode=='online'){
        		if(order.last_way!=null){
        			datas.lastmode=order.last_way.split(",");
        			if(datas.lastmode[1]==null){
        				datas.lastmode[1]='';
        			}
        		}
        		if(order.name!=null){
        			datas.onname=order.name.split(",");/*快递公司名字*/
        			datas.oncode=order.code.split(",");/*快递公司编码*/
        		}
        	}else if(order.mode=='offline'){
        		if(order.name!=null){
        			datas.offname=order.name.split(",");/*快递公司名字*/
        			datas.offcode=order.code.split(",");/*快递公司编码*/
        		}
        	}
    }
    $("#sendplan li").attr("class","");
	if(changeoff!=null){
		if(changeoff=='offline'){
	    	datas.mode='offline';
	    	if(datas.offname!=''&&datas.offname!=null){
	    	    name=datas.offname;
	    	}else{
	    	    name='';
	    	}
	    	if(datas.offcode!=''&&datas.offcode!=null){
	    	    code=datas.offcode;
	    	}else{
	    	    code='';
	    	}
	    	/*$("#sendplan option[value='offline']").attr("selected","selected");*/
	    	$("#sendplan li a[value='offline']").parent('li').attr('class','active');
	    	$("#sendplan").siblings('a').children('span').html('自己联系');
	    	$("#sendplan").siblings('a').children('input').val('offline');
	    }else if(changeoff=='online'){
            datas.mode='online';
            if(datas.onname!=''&&datas.onname!=null){
                name=datas.onname;
            }else{
            	name='';
            }
            if(datas.oncode!=''&&datas.oncode!=null){
                code=datas.oncode;
            }else{
            	code='';
            }
	    	/*$("#sendplan option[value='online']").attr("selected","selected");*/
            $("#sendplan li a[value='online']").parent('li').attr('class','active');
	    	$("#sendplan").siblings('a').children('span').html('在线下单');
	    	$("#sendplan").siblings('a').children('input').val('online');
	    }else if(changeoff=='notsend'){
			name='no';
			name='no';
			/*$("#sendplan option[value='notsend']").attr("selected","selected");*/
			$("#sendplan li a[value='notsend']").parent('li').attr('class','active');
	    	$("#sendplan").siblings('a').children('span').html('无需物流');
	    	$("#sendplan").siblings('a').children('input').val('notsend');
	    }
	}else{
		lastmodes=datas.lastmode[0];
    	lasttrade=datas.lastmode[1];
        if(datas.lastmode[0]=='offline'){
            datas.mode='offline';
            if(datas.offname!=''&&datas.offname!=null){
                name=datas.offname;
            }else{
            	name='';
            }
            if(datas.offcode!=''&&datas.offcode!=null){
                code=datas.offcode;
            }else{
            	code='';
            }
	    	/*$("#sendplan option[value='offline']").attr("selected","selected");*/
            $("#sendplan li a[value='offline']").parent('li').attr('class','active');
	    	$("#sendplan").siblings('a').children('span').html('自己联系');
	    	$("#sendplan").siblings('a').children('input').val('offline');
		}else if(datas.lastmode[0]=='online'){
            datas.mode='online';
            if(datas.onname!=''&&datas.onname!=null){
                name=datas.onname;
            }else{
            	name='';
            }
            if(datas.oncode!=''&&datas.oncode!=null){
                code=datas.oncode;
            }else{
            	code='';
            }
			/*$("#sendplan option[value='online']").attr("selected","selected");*/
            $("#sendplan li a[value='online']").parent('li').attr('class','active');
	    	$("#sendplan").siblings('a').children('span').html('在线下单');
	    	$("#sendplan").siblings('a').children('input').val('online');
		}else if(datas.lastmode[0]=='notsend'){
			name='no';
			name='no';
			/*$("#sendplan option[value='notsend']").attr("selected","selected");*/
			$("#sendplan li a[value='notsend']").parent('li').attr('class','active');
	    	$("#sendplan").siblings('a').children('span').html('无需物流');
	    	$("#sendplan").siblings('a').children('input').val('notsend');
		}else{
            datas.mode='offline';
            if(datas.offname!=''&&datas.offname!=null){
                name=datas.offname;
            }else{
            	name='';
            }
            if(datas.offcode!=''&&datas.offcode!=null){
                code=datas.offcode;
            }else{
            	code='';
            }
	    	/*$("#sendplan option[value='offline']").attr("selected","selected");*/
            $("#sendplan li a[value='offline']").parent('li').attr('class','active');
	    	$("#sendplan").siblings('a').children('span').html('自己联系');
	    	$("#sendplan").siblings('a').children('input').val('offline');
		}
	}
	if(name!=''&&name!='no'){
		$("#comptyid").empty();
		for(index in name){
			datas.name=name[index];
			datas.code=code[index];
			if(datas.lastmode[1]!=''&&datas.lastmode[1]!=null){
				if(datas.code==datas.lastmode[1]){
					/*$("#comptyid").append('<option value="'+datas.code+'" selected=selected>'+datas.name+'</option>');*/
					$("#comptyid").siblings('a').children('input').val(datas.code);
					$("#comptyid").siblings('a').children('span').html(datas.name);
					$("#comptyid").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>'); 
                }else{
					/*$("#comptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');*/
					$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>');
				}
			}else{
                 /*$("#comptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');*/
				$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>');
            }
        }
		if(datas.mode=='offline'){
			/*$("#comptyid").append("<option value='others'>其它物流公司</option>");*/
			$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="others">其他物流公司</a></li>');
		}
		if(datas.lastmode[1]=='other'){
			$("#comptyid").siblings('a').children('input').val('other');
			$("#comptyid").siblings('a').children('span').html('其它物流公司');
			$("#sendplan li a[value='other']").parent('li').attr('class','active');
			/*$("#comptyid option[value='other']").attr("selected","selected");	*/	
		}
		if($("#comptyid li[class='active'").length==0){
 			var wenzi=$("#comptyid li:eq(0)").children('a').html();/*获取文字*/
 			var value=$("#comptyid li:eq(0) a").attr('value');/*获取a标签的value*/
 			$("#comptyid li:eq(0)").attr('class','active');/*添加active*/
 			$("#comptyid").siblings('a').children('span').html(wenzi)
 			$("#comptyid").siblings('a').children('input').val(value);
	    }
		c_offline();
	}else if(name=='no'){/*上一次选择了无需物流*/
	        $("#wuliush1").hide();
	        $("#wuliush2").hide();
      	    $("#off_other").empty();
	}else{/*默认快递公司为空,则通过条用淘宝接口列出所有快递公司供选择*/
		QN.top.invoke({
			"cmd": "taobao.logistics.companies.get",
			"param": {fields:'code,name',is_recommended:true,order_mode:datas.mode},
			"method": "get",
			"success": function (rsp){
				if(typeof  rsp=== 'string'){
					rsp = JSON.parse(rsp);
				}
				try{
					$('#comptyid').empty();
					for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
						var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
						var datas={};
						datas.name=order.name;
              	    	datas.code=order.code;
   		                if(lasttrade!=''&&lasttrade!=null){
   		                    if(datas.code==lasttrade){
   		                    	$("#comptyid").siblings('a').children('input').val(datas.code);
   	   		 					$("#comptyid").siblings('a').children('span').html(datas.name);
   	   		 					$("#comptyid").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>'); 
   		                       /*	$("#comptyid").append('<option value="'+datas.code+'" selected=selected>'+datas.name+'</option>');*/
   		                    }else{
   	   		                    /*$("#comptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');*/
   		                    	$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>');
      		                }
   		                }else{
   		                    /*$("#comptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');*/
   		                	$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>');
   		                }
          	    	}
          	    	if($("#sendplan").siblings('a').children('input').val()=='offline'){
              		    /*$("#comptyid").append("<option value='other'>其它</option>");*/
                		  $("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="other">其它</a></li>');
                    }
          	    	if($("#comptyid li[class='active'").length==0){
          	 			var wenzi=$("#comptyid li:eq(0)").children('a').html();/*获取文字*/
          	 			var value=$("#comptyid li:eq(0) a").attr('value');/*获取a标签的value*/
          	 			$("#comptyid li:eq(0)").attr('class','active');/*添加active*/
          	 			$("#comptyid").siblings('a').children('span').html(wenzi)
          	 			$("#comptyid").siblings('a').children('input').val(value);
          		    }
                    c_offline();
				}catch(e){
					layer.msg(e,1,3);
				}
        	}
		});
	}
}
/**
 * 物流方式更改后事件
 */
function a_offline(){
	/*var sel=$('#sendplan').find("option:selected").val();*/
	var sel=$('#sendplan').siblings('a').children('input').val();
    $("#wuliush1").show();
    $("#wuliush2").show();
    getcompty(sel);
	if(sel=='notsend'||sel=='online'){
		$("#off_other").empty();
	}else{
		c_offline();
	}
}
/**
 * 物流公司更改后事件
 */
function c_offline()
{
	$("#off_other").empty();
	var sel = $("#comptyid").siblings('a').children('input').val();
	if(sel=='other'||sel=='OTHER')
	{
		$("#off_other").append("<p><input type='text' name='othercompany' id='othercompany' placeholder='请输入物流公司'></input></p>");
	}else if(sel=='others'){
		d_offline();
	}
}
/**
 * 物流公司更改后事件:选中其他物流公司
 */
function d_offline(){
	QN.top.invoke({
		"cmd": "taobao.logistics.companies.get",
		"param": {fields:'code,name',is_recommended:true,order_mode:'offline'},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                if(rsp.sub_msg){
                	layer.msg('+rsp.sub_msg+',1,3);
                }else{
                	geterrorinfo("taobao.logistics.companies.get",rsp);
                }
            }else{
	    			$('#comptyid').empty();
	    			 for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
    	    			var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
						var datas={};
    	    			datas.name=order.name;
    	    			datas.code=order.code;
                        if(lasttrade!=''&&lasttrade!=null){
                       		if(datas.code==lasttrade){
                       			/*$("#comptyid").append('<option value="'+datas.code+'" selected=selected>'+datas.name+'</option>');*/
                       			$("#comptyid").siblings('a').children('span').html(datas.name);
	    		    	 		$("#comptyid").siblings('a').children('input').val(datas.code);
	    		    	 		$("#comptyid").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>');
                        	}else{
                              	/* $("#comptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>'); */
                        		$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>');
                            }
                        }else{
                        	/* $("#comptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>'); */
                        	$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.code+'">'+datas.name+'</a></li>');
                        }
	    			 }
	    				 /*$("#comptyid").append("<option  value='POST'>中国邮政平邮</option>");*/
	    			 	$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="POST">中国邮政平邮</a></li>');
	    		    	 if($("#sendplan").siblings('a').children('input').val()=='offline'){
	    		    	 	if(lasttrade=='other'){
	    		    	 		/*$("#comptyid").append("<option  value='other' selected=selected>其它</option>");*/
	    		    	 		$("#comptyid").siblings('a').children('span').html('其它');
	    		    	 		$("#comptyid").siblings('a').children('input').val('other');
	    		    	 		$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="other">其它</a></li>');
	    		    	 		c_offline();
	    		    	 	}else{
	    		    		 	/*$("#comptyid").append("<option  value='other'>其它</option>");*/
	    		    	 		$("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="other">其它</a></li>');
	    		    		 }
    		    		 }
	    		    	 if($("#comptyid li[class='active'").length==0){
	    		    		 var wenzi=$("#comptyid li:last").children('a').html();
		    		  		var value=$("#comptyid li:last a").attr('value');
		    		  		$("#comptyid li:last").attr('class','active');
		    		  		$("#comptyid").siblings('a').children('span').html(wenzi)
		    		  		$("#comptyid").siblings('a').children('input').val(value);
		    			}
            }
	    },
        error: function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var	msp= msp;
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
	                 */
            }else{
                if(msp.sub_msg){
                	layer.msg(msp.sub_msg,1,3);
                }else{
                	geterrorinfo("taobao.logistics.companies.get",msp);
                }
            }
        }
	});
}
/**
 * 发货：货到付款
 * */
function codsendplan(){/*WQ*/
	var cycode=$("#codcomptyid").val();
    var cycode=$("#codcomptyid").find("option:selected").val();
    var codoutid= $("#codpostid").val();
    codoutid=clearBr(codoutid);
    var selleraddr=$("#selectaddrW").siblings.children('input').val();
    var sellerback=$("#selectbackaddrQ").siblings.children('input').val();
    if(codoutid!=''){
    QN.top.invoke({
        cmd:"taobao.logistics.online.send",
        param:{
            tid:gtid,
            out_sid:codoutid,
            company_code:cycode,
            sender_id:selleraddr,
            cancel_id:sellerback
        },
        method:"get",
        success:function(rsp) {
            if(typeof rsp === 'string'){
                var rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
            var rsperror=rsp.msg;
            layer.msg('修改成功！',1,1);
            $('#dfh_list').empty();
            $('#all_list').empty();
            if(liststatus=='detail'){/*如果是在详情界面*/
            	getdetail(gtid);
            }
            getordersta(gsta,gpageno);
        },
        error: function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);*/
            }else if(msp.sub_code=='isv.logistics-online-service-error:B02'){
            	layer.msg('您的帐号没有发货的权限!',1,3);
      		}else if(msp.sub_code=='isv.logistics-online-service-error:B04'){
	          	layer.msg('订单状态不对',1,3);
      		}else if(msp.sub_code=='isv.logistics-online-service-error:B101'){
	          	layer.msg('您还没设置默认的退发货地址',1,3);
      		}else if(msp.sub_code=='isv.logistics-online-service-error:B79'){
	          	layer.msg('该物流公司揽收或派送范围不支持',1,3);
      		}else if(msp.sub_code=='isv.logistics-online-service-error:B55'){
	          	layer.msg('该交易状态不正确，不能发货',1,3);
      		}else if(msp.msg=='Invalid arguments:sender_id'){
            	layer.msg('发货地址异常，请检查您的发货地址！',1,3);
            }else{
                if(msp.sub_msg){
                	layer.msg('codsendplan_error:'+msp.sub_msg,1,3);
                }else{
                	geterrorinfo("taobao.logistics.online.send",msp);
                }
            }
        }
    });
    }else{
    	layer.msg('运单号不能为空！',1,3);
    }
}
/**
 * 发货
 */
function sendplan(){
	var num=0;
	var tids=new Array();
	var sub_tid='';
	$("input[name='batchcheckbox']:checked").each(
			function(){
				tids[num]=$(this).val();
				num++;
			} );
    if(num==0){
    	layer.msg('请选择需要发货的订单！',1,3);
    }else{
    		for(index in tids){
    			sub_tid+=tids[index]+',';
    		}
    		if(cdsend==0){/*拆单发货*/
    			cdtosendss(sub_tid)
    		}else{
        		if(num==cdsend){/*不拆弹发货*/
        			zcsendplan();
        		}else{/*拆单发货*/
    			cdtosendss(sub_tid)
        		}
    		}
    }
}
/**
 * 正常发货
 */
function zcsendplan(){
    var mode=$("#sendplan").siblings('a').children('input').val();
    var cycode=$("#comptyid").siblings('a').children('input').val();
    if(cycode=='OTHER'){
    	cycode='other';
    }
    var outid= $("#postid").val();
    /*var selleraddr=$("#selectaddrQ").val();*/
    var selleraddr=$("#selectaddrQ").siblings('a').children('input').val();
    var sellerback=$("#selectbackaddr").siblings('a').children('input').val();
    if(outid==''&&'notsend'!=mode){
    	layer.msg('运单号不能为空！',1,3);
    }else{
    	var urlcode=cycode;
		if(cycode=='other'){/*其他物流公司*/
			cycode=$('#othercompany').val();
		}
		var parms={};
    	if(selleraddr==null||sellerback==null){/*要传的值*/
			parms={
               tid:gtid,
               out_sid:outid,
               company_code:cycode,
          	};
    	}else{
   			parms={
               tid:gtid,
               out_sid:outid,
               company_code:cycode,
               sender_id:selleraddr,
               cancel_id:sellerback
          	};
    	}
    	if('online'==mode){
       	 	QN.top.invoke({
            	cmd:"taobao.logistics.online.send",
            	param:parms,
            	method: "post",
            	success: function(rsp) {
                	if(typeof rsp === 'string'){
                    	var rsp = JSON.parse(rsp);
                	}
                	if(liststatus=='detail'){
                		getdetail(gtid);
                	}
             	 	layer.msg('发货成功！',1,1);
           	   		if(liststatus=='detail'){/*当前是在详情界面*/
                  		getdetail(gtid);/*将详情重刷*/
                  		$("#table"+gsta+gtid).remove();
                  	}else{
                		if(gsta=='dfh'){/*如果是在待发货界面*/
                   			$("#table"+gsta+gtid).remove();
                     	}else{
                     		getordersta(gsta,gpageno);
                     	}
                  	}
					/*$('#dfh_list').empty();
					$('#yfh_list').empty();
					$('#all_list').empty();
	                getordersta(gsta,gpageno);*/
					if(lastmodes==mode&&lasttrade==urlcode){
					}else{
		           		$.ajax({
			       		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tosend',
			       		    type: 'POST',
			       		    dataType:'html',
			      		    data:{nick:user_nick,mode:mode,offtrade:urlcode},
			       		    timeout:10000,
				        	success: function(data, textStatus){
					       		var datas = window.localStorage.getItem("compty"+user_nick);
			        	        if(datas.length>3){
			                       	datas=JSON.parse(datas);
			                       	for(index in datas){
			                          	if(datas[index].mode=='online'){
			                        		datas[index].last_way=clearBr(data);
			                        		break;
			                        	}
			                    	}
			                    	datas=JSON.stringify(datas);
			                   		window.localStorage.setItem("compty"+user_nick,datas);
			                    }
			         		},
			         	 	error: function(){
			         	    }
			   	      	});
					}
	            },
	            error: function(msp){
	                if(typeof msp === 'string'){
	                    var msp = JSON.parse(msp);
	                }
	                if(msp.sub_code=='subuser.has-no-permission'){
	                	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);*/
	                }else if(msp.sub_code=='isv.logistics-online-service-error:B02'){
	                	layer.msg('您的帐号没有发货的权限!',1,3);
	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B04'){
	  	          		layer.msg('订单状态不对。您已使用“在线下单”方式对此订单进行发货操作，请前往卖家中心核实',1,3);
	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B101'){
	  	          		layer.msg('您还没设置默认的退发货地址',1,3);
	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B79'){
	  	          		layer.msg('该物流公司揽收或派送范围不支持',1,3);
	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B55'){
	  	          		layer.msg('该交易状态不正确，不能发货',1,3);
	          		}else if(msp.msg=='Invalid arguments:sender_id'){
	                	layer.msg('发货地址异常，请检查您的发货地址！',1,3);
	                }else{
	                	geterrorinfo("taobao.logistics.online.send",msp);
	                }
	            }
	        });
    	}else if('offline'==mode){
	        QN.top.invoke({
	            cmd: "taobao.logistics.offline.send", 
	            param:parms,
	            method: "post",
	            success: function(rsp) {
	                if(typeof rsp === 'string'){
	                    var rsp = JSON.parse(rsp);
	                }
	                layer.msg('发货成功！',1,1);
	                if(liststatus=='detail'){/*当前是在详情界面*/
	                	getdetail(gtid);/*将详情重刷*/
	                	$("#table"+gsta+gtid).remove();
	                }else{
	              	  if(gsta=='dfh'){/*如果是在待发货界面*/
	                 		$("#table"+gsta+gtid).remove();
	                   }else{
	                   		getordersta(gsta,gpageno);
	                   }
	                }
					/*$('#dfh_list').empty();
					$('#yfh_list').empty();
					$('#all_list').empty();
	                getordersta(gsta,gpageno);*/
					if(lastmodes==mode&&lasttrade==urlcode){
					}else{
			
			               		$.ajax({
				             		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tosend',
				             		    type: 'POST',
				             		    dataType:'html',
				             		    data:{nick:user_nick,mode:mode,offtrade:urlcode},
				             		    timeout:10000,
			         		        	success: function(data, textStatus){
			         		        		var datas = window.localStorage.getItem("compty"+user_nick);
			                    		        if(datas.length>3){
			                    		        	datas=JSON.parse(datas);
			                    		        	for(index in datas){
			                        		        	if(datas[index].mode=='online'){
			                        		        		datas[index].last_way=clearBr(data);
			                        		        		break;
			                        		        	}
			                    		        	}
			                    		        	datas=JSON.stringify(datas);
			                   		        	 window.localStorage.setItem("compty"+user_nick,datas);
			                    		        }
			         	        	},
			         	 	       error: function(){
			         	        	}
			   	      	    });
					}
	            },
	            error: function(msp){
	                if(typeof msp === 'string'){
	                    var msp = JSON.parse(msp);
	                }else{
	                    var	msp= msp;
	                }
	                if(msp.sub_code=='subuser.has-no-permission'){
	                	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);*/
	                }else if(msp.sub_code=='isv.logistics-offline-service-error:B02'){
	  					layer.msg('您的帐号没有发货的权限!',1,3);
	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B04'){
	      				layer.msg('订单状态不对。您已使用“在线下单”方式对此订单进行发货操作，请前往卖家中心核实',1,3);
	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B101'){
	      				layer.msg('您还没设置默认的退发货地址',1,3);
	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B57'){
	      				layer.msg('该物流公司不支持自己联系',1,3);
	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B55'){
	      				layer.msg('该交易状态不正确，不能发货',1,3);
	      			}else{
	      				geterrorinfo("taobao.logistics.offline.send",msp);
	                }
	            }
	        });
    	}else if('notsend'==mode){/*无需物流*/
	        QN.top.invoke({
	            cmd:"taobao.logistics.dummy.send",
	            param:{tid:gtid},
	            method: "post",
	            success : function(rsp) {
	                if(typeof rsp === 'string'){
	                    var rsp = JSON.parse(rsp);
	                }
	              	layer.msg('发货成功！',1,1);
	                if(liststatus=='detail'){/*当前是在详情界面*/
	                	getdetail(gtid);/*将详情重刷*/
	                	$("#table"+gsta+gtid).remove();
	                }else{
	              	  if(gsta=='dfh'){/*如果是在待发货界面*/
	                 		$("#table"+gsta+gtid).remove();
	                   }else{
	                   		getordersta(gsta,gpageno);
	                   }
	                }
					/*$('#dfh_list').empty();
					$('#yfh_list').empty();
					$('#all_list').empty();
	                getordersta(gsta,gpageno);*/
					if(lastmodes==mode&&lasttrade==urlcode){
					}else{
			        	$.ajax({
				        	url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tosend',
				            type: 'POST',
				            dataType:'html',
				            data:{nick:user_nick,mode:mode,offtrade:urlcode},
				            timeout:10000,
			         		success: function(data, textStatus){
			         			var datas = window.localStorage.getItem("compty"+user_nick);
			                    if(datas.length>3){
			                    	datas=JSON.parse(datas);
			                    	for(index in datas){
			                        	if(datas[index].mode=='online'){
			                        		datas[index].last_way=clearBr(data);
			                        		break;
			                        	}
			                    	}
			                    	datas=JSON.stringify(datas);
			                   		window.localStorage.setItem("compty"+user_nick,datas);
			                    }
			         	     },
			         	 	 error: function(){
							}
			   	      	});
					}
	            },
	            error: function(msp){
	                if(typeof msp === 'string'){
	                    var msp = JSON.parse(msp);
	                }
	                if(msp.sub_code=='subuser.has-no-permission'){
	                /* 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);*/
	                }else{
	                    if(msp.sub_msg){
	                    	layer.msg('无需物流错误:'+msp.sub_msg,1,3);
	                    }else{
	                    	geterrorinfo("taobao.logistics.dummy.send",msp);
	                    }
	                }
	            }
	        });
   		 }
	}
}
/**
 * 拆单发货
 */
function cdtosendss(sub_tid)
{
   var mode=$("#sendplan").siblings('a').children('input').val();
   var cycode=$("#comptyid").siblings('a').children('input').val();
   var outid= $("#postid").val();
   var selleraddr=$("#selectaddrQ").siblings('a').children('input').val();
   var sellerback=$("#selectbackaddr").siblings('a').children('input').val();
   if(cycode=='OTHER'){
   	cycode='other';
   }
   if(outid==''&&'notsend'!=mode){
   	layer.msg('运单号不能为空！',1,3);
   }else{
   var urlcode=cycode;
	if(cycode=='other'){
		cycode=$('#othercompany').val();
	}
	var parms={};
   if(selleraddr==null||sellerback==null){
		parms={
               tid:gtid,
               out_sid:outid,
               is_split:'1',
               sub_tid:sub_tid,
               company_code:cycode,
          };
   }else{
   		parms={
               tid:gtid,
               out_sid:outid,
               is_split:'1',
               sub_tid:sub_tid,
               company_code:cycode,
               sender_id:selleraddr,
               cancel_id:sellerback
          };
   }
   if('online'==mode){
       QN.top.invoke({
           cmd:"taobao.logistics.online.send",
           param:parms,
           method:"get",
           success : function(rsp) {
               if(typeof rsp === 'string'){

                   var    rsp = JSON.parse(rsp);
               }
               if(liststatus=='detail'){/*是在详情里面*/
                  	getdetail(gtid);
               }else{
	                layer.msg('发货成功！',1,1);
					$('#dfh_list').empty();
					$('#yfh_list').empty();
					$('#all_list').empty();
	            	getordersta(gsta,gpageno);
               }
				if(lastmodes==mode&&lasttrade==urlcode){
				}else{
            		$.ajax({
			        	url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tosend',
			            type: 'POST',
			            dataType:'html',
			            data:{nick:user_nick,mode:mode,offtrade:urlcode},
			            timeout:10000,
		         		success: function(data, textStatus){
		         			var datas = window.localStorage.getItem("compty"+user_nick);
		                    if(datas.length>3){
		                    	datas=JSON.parse(datas);
		                    	for(index in datas){
		                        	if(datas[index].mode=='online'){
		                        		datas[index].last_way=clearBr(data);
		                        		break;
		                        	}
		                    	}
		                    	datas=JSON.stringify(datas);
		                   		window.localStorage.setItem("compty"+user_nick,datas);
		           			}
		       			},
		         	 	error: function(){}
		   	    	});
				}
           },
           error: function(msp){
               if(typeof msp === 'string'){
                   var msp = JSON.parse(msp);
               }
               if(msp.sub_code=='subuser.has-no-permission'){
               /* 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                    */
               	}else if(msp.sub_code=='isv.logistics-online-service-error:B02'){
               		layer.msg('您的帐号没有发货的权限!',1,3);
         		}else if(msp.sub_code=='isv.logistics-online-service-error:B04'){
 	          		layer.msg('订单状态不对。您已使用“在线下单”方式对此订单进行发货操作，请前往卖家中心核实：)',1,3);
         		}else if(msp.sub_code=='isv.logistics-online-service-error:B101'){
 	          		layer.msg('您还没设置默认的退发货地址',1,3);
         		}else if(msp.sub_code=='isv.logistics-online-service-error:B79'){
 	          		layer.msg('该物流公司揽收或派送范围不支持',1,3);
         		}else if(msp.sub_code=='isv.logistics-online-service-error:B55'){
 	          		layer.msg('该交易状态不正确，不能发货',1,3);
         		}else if(msp.msg=='Invalid arguments:sender_id'){
               		layer.msg('发货地址异常，请检查您的发货地址！',1,3);
               	}else{
               		geterrorinfo("taobao.logistics.online.send",msp);
               	}
           }
       });
   }else if('offline'==mode){
       QN.top.invoke({
           cmd:"taobao.logistics.offline.send",
           param:parms,
           method:"get",
           success:function(rsp) {
               if(typeof rsp === 'string'){
                   var rsp = JSON.parse(rsp);
               }
               	layer.msg('发货成功！',1,1);
				$('#dfh_list').empty();
				$('#yfh_list').empty();
				$('#all_list').empty();
                getordersta(gsta,gpageno);
				if(lastmodes==mode&&lasttrade==urlcode){
				}else{
		        	$.ajax({
			        	url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tosend',
			            type: 'POST',
			            dataType:'html',
			            data:{nick:user_nick,mode:mode,offtrade:urlcode},
			            timeout:10000,
		         		success: function(data, textStatus){
		         			var datas = window.localStorage.getItem("compty"+user_nick);
		                    if(datas.length>3){
		                    	datas=JSON.parse(datas);
		                    	for(index in datas){
		                        	if(datas[index].mode=='online'){
		                        		datas[index].last_way=clearBr(data);
		                        		break;
		                        	}
		                    	}
		                    	datas=JSON.stringify(datas);
		                   		window.localStorage.setItem("compty"+user_nick,datas);
		                    }
		         	  	},
		         	 	error: function(){
		         	   	}
		   	      	});
				}
           },
           error: function(msp){
               if(typeof msp === 'string'){
                   var msp = JSON.parse(msp);
               }else{
                   var	msp= msp;
               }
               if(msp.sub_code=='subuser.has-no-permission'){
               	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);*/
               }else if(msp.sub_code=='isv.logistics-offline-service-error:B02'){
 					layer.msg('您的帐号没有发货的权限!',1,3);
     			}else if(msp.sub_code=='isv.logistics-offline-service-error:B04'){
     				layer.msg('订单状态不对。您已使用“在线下单”方式对此订单进行发货操作，请前往卖家中心核实',1,3);
     			}else if(msp.sub_code=='isv.logistics-offline-service-error:B101'){
     				layer.msg('您还没设置默认的退发货地址',1,3);
     			}else if(msp.sub_code=='isv.logistics-offline-service-error:B57'){
     				layer.msg('该物流公司不支持自己联系',1,3);
     			}else if(msp.sub_code=='isv.logistics-offline-service-error:B55'){
     				layer.msg('该交易状态不正确，不能发货',1,3);
     			}else{
     				geterrorinfo("taobao.logistics.offline.send",msp);
               }
           }
       });
   }else if('notsend'==mode){/*无需物流7*/
       QN.top.invoke({
           cmd:"taobao.logistics.dummy.send",
           param:{
               tid:gtid
           },
           method:"get",
           success: function(rsp) {
               if(typeof rsp === 'string'){
                   var rsp = JSON.parse(rsp);
               }
               if(liststatus=='detail'){
                  	getdetail(gtid);
               }
               	layer.msg('发货成功！',1,1);
				$('#dfh_list').empty();
				$('#yfh_list').empty();
				$('#all_list').empty();
                getordersta(gsta,gpageno);
				if(lastmodes==mode&&lasttrade==urlcode){
				}else{
	           		$.ajax({
		       		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tosend',
		       		    type: 'POST',
		       		    dataType:'html',
			             		    data:{nick:user_nick,mode:mode,offtrade:urlcode},
			             		    timeout:10000,
		         		        	success: function(data, textStatus){
		         		        		var datas = window.localStorage.getItem("compty"+user_nick);
		                    		        if(datas.length>3){
		                    		        	datas=JSON.parse(datas);
		                    		        	for(index in datas){
		                        		        	if(datas[index].mode=='online'){
		                        		        		datas[index].last_way=clearBr(data);
		                        		        		break;
		                        		        	}
		                    		        	}
		                    		        	datas=JSON.stringify(datas);
		                   		        	 window.localStorage.setItem("compty"+user_nick,datas);
		                    		        }
		         	        	},
		         	 	       error: function(){
		         	        	}
		   	      	    });
				}
           },
           error: function(msp){
               if(typeof msp === 'string'){
                   var msp = JSON.parse(msp);
               }else{
                   var	msp= msp;
               }
               if(msp.sub_code=='subuser.has-no-permission'){
              /*  	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
 	                 */
               }else{
                   if(msp.sub_msg){
                   	layer.msg('无需物流错误：'+msp.sub_msg+'！',1,3);
     	                
                   }else{
                   	geterrorinfo("taobao.logistics.dummy.send",msp);
                   }
               }

           }
       });
   }
   }
}
/**
 * 显示卖家的退发货地址
 */
var ftdata=null;
function showmyaddr()
{
	$('#selectsend').hide();
	$('#nohavasendaddr').empty();
	$('#nohavasendaddr').html('<div class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>');
	$("#selectaddrQ").empty();
	$("#selectbackaddr").empty();
	$("#selectbackaddrQ").empty();
	$("#selectaddrW").empty();
	if(ftdata!=null){
		var datas={};
		for(index in ftdata){
 	  		var result=ftdata[index];
 	  		datas.province=result.province;
 	  		datas.city=result.city;
		 	datas.country=result.country;
		 	datas.addr=result.addr;
		 	datas.zip_code=result.zip_code;
		 	datas.contact_name=result.contact_name;
		 	datas.phone=result.phone;
		 	datas.mobile_phone=result.mobile_phone;
		 	datas.memo=result.memo;
		 	datas.seller_company=result.seller_company;
		 	datas.get_def=result.get_def;
		 	datas.cancel_def=result.cancel_def;
			datas.contact_id=result.contact_id;
			var source = $("#selectaddr_template").html();
			var template=Handlebars.compile(source);
	 	  	var htmlstr = template(datas);
 	  	   	$("#selectaddrW").append(htmlstr);
 	 	  	 /*<option value="{{contact_id}}" {{#if get_def}}selected{{/if}}>{{province}},{{city}},{{country}},{{addr}},{{zip_code}},{{contact_name}},{{phone}},{{mobile_phone}}</option>*/
			if(result.get_def){
				$("#selectaddrQ").siblings('a').children('input').val(datas.contact_id);
                $("#selectaddrQ").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
 	  			$("#selectaddrQ").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');

 	  			$("#selectaddrW").siblings('a').children('input').val(datas.contact_id);
                $("#selectaddrW").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
 	  			$("#selectaddrW").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
			}else{
				$("#selectaddrQ").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
				$("#selectaddrW").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
			}
 	 	  	 /*$("#selectaddrQ").append(htmlstr);*/
 	  		if(datas.cancel_def){
 	  			$("#selectbackaddrQ").siblings('a').children('input').val(datas.contact_id);/*input hiddden添加值*/
                $("#selectbackaddrQ").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
 	  			$("#selectbackaddrQ").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');

 	  			$("#selectbackaddr").siblings('a').children('input').val(datas.contact_id);/*input hiddden添加值*/
                $("#selectbackaddr").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
 	  			$("#selectbackaddr").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
 	 	  	}else{
 	 	 	  	$("#selectbackaddr").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
 	 	 	 	$("#selectbackaddrQ").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
 	 	 	}
 	  		datas={};
 	  	  }
 	  		$('#selectsend').show();
 	  		$('#nohavasendaddr').empty();
 	  	  return;
	}else{
	   	QN.top.invoke({
	   		 "cmd": "taobao.logistics.address.search",
	  		 "method": "get",
	  		 "success": function(rsp){
	  			 if(typeof  rsp=== 'string'){
	  				rsp = JSON.parse(rsp);
	  			}
	  			
	  			if(rsp.logistics_address_search_response){
	  				var datas={};
	  				if(rsp.logistics_address_search_response.addresses.address_result){
	  					ftdata=new Array();
	  					ftdata=rsp.logistics_address_search_response.addresses.address_result;
	 			 	  	for(index in rsp.logistics_address_search_response.addresses.address_result){
	 	  					var result=rsp.logistics_address_search_response.addresses.address_result[index];
	 	  					datas.province=result.province;
	 	  					datas.city=result.city;
			 	  	   		datas.country=result.country;
			 	  	   		datas.addr=result.addr;
			 	  	   		datas.zip_code=result.zip_code;
			 	  	   		datas.contact_name=result.contact_name;
			 	  	   		datas.phone=result.phone;
			 	  	   		datas.mobile_phone=result.mobile_phone;
			 	  	   		datas.memo=result.memo;
			 	  	   		datas.seller_company=result.seller_company;
			 	  	   		datas.get_def=result.get_def;
			 	  	   		datas.cancel_def=result.cancel_def;
					 	  	datas.contact_id=result.contact_id;
					 		var source = $("#selectaddr_template").html();
					 		var template=Handlebars.compile(source);
		 	  	  		   	var htmlstr = template(datas);
		 	  	  		   	/*$("#selectaddrQ").append(htmlstr);*/
	 	  	   	  		    /*$("#selectaddrW").append(htmlstr);*/
	 		 	  	   	  	if(result.get_def){
	 		 					$("#selectaddrQ").siblings('a').children('input').val(datas.contact_id);
	 		 	                $("#selectaddrQ").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
	 		 	 	  			$("#selectaddrQ").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');

	 		 	 	  			$("#selectaddrW").siblings('a').children('input').val(datas.contact_id);
	 		 	                $("#selectaddrW").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
	 		 	 	  			$("#selectaddrW").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
	 		 				}else{
	 		 					$("#selectaddrQ").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
	 		 					$("#selectaddrW").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
	 		 				}
		 	  		   		if(datas.cancel_def){
		 	  	 	  			$("#selectbackaddrQ").siblings('a').children('input').val(datas.contact_id);/*input hiddden添加值*/
		 	  	                $("#selectbackaddrQ").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
		 	  	 	  			$("#selectbackaddrQ").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
		 	  	 	  			$("#selectbackaddr").siblings('a').children('input').val(datas.contact_id);/*input hiddden添加值*/
		 	  	                $("#selectbackaddr").siblings('a').children('span').html(datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone);
		 	  	 	  			$("#selectbackaddr").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
		 	  	 	 	  	}else{
		 	  	 	 	 	  	$("#selectbackaddr").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
		 	  	 	 	 	 	$("#selectbackaddrQ").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+datas.contact_id+'">'+datas.province+','+datas.city+','+datas.country+','+datas.addr+','+datas.zip_code+','+datas.contact_name+','+datas.phone+','+datas.mobile_phone+'</a></li>');
		 	  	 	 	 	}
	 				   		datas={};
	 	  	  		  	}
	 	  	  		  	$('#selectsend').show();
	 	  	  		  	$('#nohavasendaddr').empty();
	  				}
	  			}
	  	},
	  	error: function(msp){
	  			$('#nohavasendaddr').html('<p>*<span style="color:red;">退、发货地址获取失败，将使用默认退发货地址进行发货。(或关闭后重试></p>');
	    	}
		});
	}
}
/**
*新增退发货地址:发货时发现没有设置默认发货地址/默认退货地址
*@author Duanhq
**/
function addsendaddr(){
showMsg('sendh');
mofirst('external_newadd');
}
/**
 * 修改地址
 */
var gmoreshen;
var gmoreshi;
var gmorequ;
function editadrr(tid,name,mobile,tel,state,city,district,addrs,zip){
	gtid=tid;
	gmoreshen=state;
	gmoreshi=city;
	gmorequ=district;
	$('#more_zip').val(zip);
    $('#more_name').val(name);
    $('#more_address').val(addrs);
    $('#more_phone').val(tel);
    $('#more_mobile').val(mobile);
	loadaddress();
     /*showMsg('addr-table');*/
}
 /************************退款组件*****************************/
 function torefund(rid,tid,oid){
              if(true){
                  /*无法使用退款组件*/
                  if(rid){
                  window.location.href='<?php echo APP_WEB_INDEX_ROOT?>/trade/refundinfo?vers=<?php echo REAL_ROOT_VER;?>#refundId='+rid+'&oid='+oid+'&tid='+tid;
                  }
              }else{
                 /* QN.component.invoke( {
                      category:'refund',
                      param:{
                          uuid:'1234',
                          bizOrderId:tid
                      },
                      error : function(msg, cmd, param) {
                          alert(JSON.stringify(msg));
                      },
                      success : function(rsp, cmd, param) {
                          alert(JSON.stringify(rsp));
                      }
                  });*/
              }
  }
/**
 * 延长收货时间
 * 1.呼出延长收货时间设置框
 * @author Duanhq
 */  
function showaddtime(tid){
	gtid=tid;
	//showMsg('shtime-table');
}
/**
 * 延长收货时间
 * 2.确认延长收货时间
 **/
function shaddtime(){
	/*var day=$("#shday").siblings('a').children('input').val();*/
     var day=$("#shday").val();
    QN.top.invoke({
    	cmd:"taobao.trade.receivetime.delay",
        param:{tid:gtid,days:day},
        method:"get",
       	success: function(rsp) {
        	if(typeof rsp === 'string'){
            	var rsp = JSON.parse(rsp);
           	}
           	var rsperror=rsp.msg;
            if(rsperror==undefined){
            	if(liststatus=='detail'){
                	getdetail(gtid);
             	}
               layer.msg('修改成功！',1,1);
       		}else{
            	if(rsp.sub_msg){
                	layer.msg('延长收货时间:'+rsp.sub_msg,1,3);
               }else{
                  	geterrorinfo("taobao.trade.receivetime.delay",rsp);
               }
            }
         },
         error: function(msp){
         	if(typeof msp === 'string'){
           		var msp = JSON.parse(msp);
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/*  layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');*/
            }else{
            	if(msp.sub_msg){
                	layer.msg('延长收货错误:'+msp.sub_msg,1,3);
                }else{
                	geterrorinfo("taobao.trade.receivetime.delay",msp);
                }
            }
         }
     });
}
</script>

<!--
	作者：306800838@qq.com
	时间：2014-05-15
	描述：未改造的页面
-->
<script>
        /**
         * Created with need.
         * User: wangsx
         * Date: 14-4-02
         * Time: 下午14:45 
         * 取省市区.【更新】
         */	
function loadaddress(){
	var areadata = window.localStorage.getItem("areadata");
	if(areadata=="null"||areadata==null||areadata.length<5){
		$.ajax({
	    	url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getArea',
	      	type: 'POST',
	      	dataType:'html',
	      	data:{},
	      	timeout:10000,
            success: function(datas){
            	window.localStorage.setItem("areadata",datas);
            	loaddata();
       		}
         });
	}else{
		loaddata();
	}
}
        /**
         * Created with need.
         * User: wangsx
         * Date: 14-4-02
         * Time: 下午14:45 
         * 取省.【更新】
         */	
        function loaddata(){
        	var areadata = window.localStorage.getItem("areadata");
            $("#more_shen").empty();
            $("#more_shi").empty();
            $("#more_qu").empty();
            var object = eval("(" + areadata + ")");
            var provinces = object['province'];
            var procode ='';
            for(var i=0;i<provinces.length;i++)
            {
                if(provinces[i]['address']==gmoreshen)
                {   procode = provinces[i]['addcode'];
                    /*$("#more_shen").append("<option selected='selected' value='"+provinces[i]['addcode']+","+provinces[i]['address']+"'>"+provinces[i]['address']+"</option>");*/
                	$("#more_shen").siblings('a').children('input').val(provinces[i]["addcode"]+','+provinces[i]["address"]+'">'+provinces[i]['address']);
                	$("#more_shen").siblings('a').children('span').html(provinces[i]['address']);
                	$("#more_shen").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+provinces[i]["addcode"]+','+provinces[i]["address"]+'">'+provinces[i]['address']+'</a></li>');
                }else{
                    /*$("#more_shen").append("<option  value='"+provinces[i]['addcode']+","+provinces[i]['address']+"'>"+provinces[i]['address']+"</option>");*/
                	$("#more_shen").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+provinces[i]["addcode"]+','+provinces[i]["address"]+'">'+provinces[i]['address']+'</a></li>');
                }
            }
            var citys = object['citys'][procode];
            var citycode = '';
            for(var i=0;i<citys.length;i++)
            {
                if(citys[i]['address']==gmoreshi)
                {   citycode = citys[i]['addcode'];
                   /* $("#more_shi").append("<option selected='selected' value='"+citys[i]['addcode']+","+citys[i]['address']+"'>"+citys[i]['address']+"</option>");*/
                	$("#more_shi").siblings('a').children('input').val(citys[i]["addcode"]+','+citys[i]["address"]+'">'+citys[i]['address']);
                	$("#more_shi").siblings('a').children('span').html(citys[i]['address']);
                	$("#more_shi").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+citys[i]["addcode"]+','+citys[i]["address"]+'">'+citys[i]['address']+'</a></li>');
                }else{
                	$("#more_shi").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+citys[i]["addcode"]+','+citys[i]["address"]+'">'+citys[i]['address']+'</a></li>');
                }
            }
            var districts = object['districts'][citycode];
            for(var i=0;i<districts.length;i++)
            {
                if(districts[i]['address']==gmorequ)
                {
                    /* $("#more_qu").append("<option selected='selected' value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>"); */
                	$("#more_qu").siblings('a').children('input').val(districts[i]["addcode"]+','+districts[i]["address"]);
                	$("#more_qu").siblings('a').children('span').html(districts[i]['address']);
                	$("#more_qu").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+districts[i]["addcode"]+','+districts[i]["address"]+'">'+districts[i]['address']+'</a></li>');
                }else{
                	$("#more_qu").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+districts[i]["addcode"]+','+districts[i]["address"]+'">'+districts[i]['address']+'</a></li>');
                }
            }
            $("#more_shen").trigger("create");
            $("#more_shi").trigger("create");
            $("#more_qu").trigger("create");
            /*$("#more_shen").change(p_choiceH);*/
            /*$("#more_shi").change(c_choiceH);*/
        }
        /**
         * Created with need.
         * User: wangsx
         * Date: 14-4-02
         * Time: 下午14:45 
         * 取区.【更新】
         */	
        function p_choiceH(){
        	var areadata = window.localStorage.getItem("areadata");
        	var sel=$("#more_shen").siblings('a').children('input').val();
           /* var sel= $("#more_shen").find('option:selected').val();*/
            if(areadata!=null)
            {
                var object = eval("(" + areadata + ")");
                var vals = sel.split(",");
                var citys = object['citys'][vals[0]];
                $("#more_shi").empty();
                var citycode = '';
                for(var i=0;i<citys.length;i++)
                {
                    if(i==0)
                    {   citycode = citys[i]['addcode'];
                        /* $("#more_shi").append("<option selected='selected' value='"+citys[i]['addcode']+","+citys[i]['address']+"'>"+citys[i]['address']+"</option>"); */
	                    $("#more_shi").siblings('a').children('input').val(citys[i]["addcode"]+','+citys[i]["address"]+','+citys[i]['address']);
	                	$("#more_shi").siblings('a').children('span').html(citys[i]['address']);
	                	$("#more_shi").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+citys[i]["addcode"]+','+citys[i]["address"]+'">'+citys[i]['address']+'</a></li>');
                    }else{
                       /*  $("#more_shi").append("<option  value='"+citys[i]['addcode']+","+citys[i]['address']+"'>"+citys[i]['address']+"</option>"); */
                    	$("#more_shi").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+citys[i]["addcode"]+','+citys[i]["address"]+'">'+citys[i]['address']+'</a></li>');
                    }
                }
                var districts = object['districts'][citycode];
                $("#more_qu").empty();
                for(var i=0;i<districts.length;i++)
                {
                    if(i==0)
                    {
                        /*$("#more_qu").append("<option selected='selected' value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");*/
                    	$("#more_qu").siblings('a').children('input').val(districts[i]["addcode"]+','+districts[i]["address"]);
                    	$("#more_qu").siblings('a').children('span').html(districts[i]['address']);
                    	$("#more_qu").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+districts[i]["addcode"]+','+districts[i]["address"]+'">'+districts[i]['address']+'</a></li>');
                    }else{
                    	$("#more_qu").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+districts[i]["addcode"]+','+districts[i]["address"]+'">'+districts[i]['address']+'</a></li>');
                    }

                }
                $("#more_shi").trigger("create");
                $("#more_qu").trigger("create");
                /*$("#more_shi").change(c_choiceH);*/
            }
        }
        /**
         * Created with need.
         * User: wangsx
         * Date: 14-4-02
         * Time: 下午14:45 
         * 取市下面的区.【更新】
         */	
        function c_choiceH()
        {
        	var areadata = window.localStorage.getItem("areadata");
          /*  var sel= $("#more_shi").find('option:selected').val();*/
            var sel=$("#more_shi").siblings('a').children('input').val();
            if(areadata!=null)
            {
                var object = eval("(" + areadata + ")");
                var vals = sel.split(",");
                var districts = object['districts'][vals[0]];
                $("#more_qu").empty();
                for(var i=0;i<districts.length;i++)
                {
                    if(i==0)
                    {
                        /*$("#more_qu").append("<option selected='selected' value='"+districts[i]['addcode']+","+districts[i]['address']+"'>"+districts[i]['address']+"</option>");*/
                    	$("#more_qu").siblings('a').children('input').val(districts[i]["addcode"]+','+districts[i]["address"]);
                    	$("#more_qu").siblings('a').children('span').html(districts[i]['address']);
                    	$("#more_qu").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+districts[i]["addcode"]+','+districts[i]["address"]+'">'+districts[i]['address']+'</a></li>');
                    }else{
                    	$("#more_qu").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+districts[i]["addcode"]+','+districts[i]["address"]+'">'+districts[i]['address']+'</a></li>');
                    }
                }
                var more_ququ=$("#more_qu").find("option:selected").text();
                $("#more_qu").trigger("create");
            }
        }
        /**
         * Created with need.
         * User: wangsx
         * Date: 14-4-02
         * Time: 下午14:45 
         * 修改收货地址.【更新】
         */	
        function addeitd()
        {
           /* var more_shen=$("#more_shen").find("option:selected").text();
            var more_shi=$("#more_shi").find("option:selected").text();
            var more_quC=$("#more_qu").find("option:selected").text();*/
            var more_shen=$("#more_shen").siblings('a').children('span').text();
            var more_shi=$("#more_shi").siblings('a').children('span').text();
            var more_quC=$("#more_qu").siblings('a').children('span').text();
            var more_zip= $("#more_zip").val();
            var more_name= $("#more_name").val();
            var more_address= $("#more_address").val();
            var more_phone=  $("#more_phone").val();
            var more_mobile= $("#more_mobile").val();
            if(more_quC==''){
            	more_quC=".";
            }
            var regu = /^[0-9a-zA-Z\_]+$/;
            var regzip = /^\d{6}$/;
            var regmobile = /^\d\d{7,15}$/;
            if(more_zip==''||more_name==''||more_address==''){
            	layer.msg('亲，请填写完整的收货信息！',1,3);
	 	        
		 	    $("input[msgstu='again']").attr("onclick","closeMsg('addr-table');");
            }else if(!regzip.test(more_zip)&&more_zip!=''){
                layer.msg('邮编只能是6位数字！',1,3);
	 	        
		 	    $("input[msgstu='again']").attr("onclick","closeMsg('addr-table');");
            }else if(more_address.length<4||more_address.length>60){
            	layer.msg('区县以下的街道地址最少要4个字，最多不能超过60个字！',1,3);
	 	        
		 	    $("input[msgstu='again']").attr("onclick","closeMsg('addr-table');");
            }else if(more_phone==''&&more_mobile==''){
                layer.msg('亲，电话和手机不能都为空亲，电话和手机不能都为空!',1,3);
	 	        
		 	    $("input[msgstu='again']").attr("onclick","closeMsg('addr-table');");
            }else if(regu.test(more_address)){
                layer.msg('区县以下的街道地址不能全是字母，请重新填写！',1,3);
	 	        
		 	    $("input[msgstu='again']").attr("onclick","closeMsg('addr-table');");
            }else if(!regmobile.test(more_mobile)&&more_mobile!=''){
                layer.msg('手机号码必须由8到16位数字构成！',1,3);
	 	        
		 	    $("input[msgstu='again']").attr("onclick","closeMsg('addr-table');");
            }else{
                QN.top.invoke({
                    "cmd": "taobao.trade.shippingaddress.update ",
                    "param":{
                        tid:gtid,
                        receiver_name:more_name,
                        receiver_phone:more_phone,
                        receiver_mobile:more_mobile,
                        receiver_state:more_shen,
                        receiver_city:more_shi,
                        receiver_district:more_quC,
                        receiver_address:more_address,
                        receiver_zip:more_zip
                    },
                    "method": "get",
                    "success" : function(rsp) {
                        if(typeof rsp === 'string'){
                            var rsp = JSON.parse(rsp);
                        }else{
                            var	rsp= rsp;
                        }
                        var rsperror=rsp.msg;
                        if(rsperror==undefined){
                        	if(liststatus=='detail'){
                            	getdetail(gtid);
                            }
                        	layer.msg('修改成功！',1,1);
            	 	        
            	 	        $('#all_list').empty();
            	 	        $('#dfh_list').empty();
                            getordersta(gsta,gpageno);
                        }else{
                            if(rsp.sub_msg){
                            	layer.msg('修改地址：'+rsp.sub_msg,1,3);
                	 	        
                            }else{
                            	geterrorinfo("taobao.trade.shippingaddress.update ",rsp);
                            }
                        }
                    },
                    error: function(msp){
                        if(typeof msp === 'string'){
                            var msp = JSON.parse(msp);
                        }else{
                            var	msp= msp;
                        }
                        if(msp.sub_code=='subuser.has-no-permission'){
                        /* 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
            	 	         */
                        }else{
                            if(msp.sub_msg){
                            	layer.msg('修改地址错误：'+msp.sub_msg,1,3);
                	 	        
                            }else{
                            	geterrorinfo("taobao.trade.shippingaddress.update ",msp);
                            }
                        }
                    }
                });
            }
        }
/*
 编辑订单属性
 */
function editsku(oid,num_iid,pic_path,title,price,num,properties){
    QN.top.invoke({
        "cmd": "taobao.item.get",
        "param":{
            fields:'sku.properties_name,sku.properties,sku.quantity,sku.price,property_alias',
            num_iid:num_iid
        },
        "method": "get",
        "success" : function(rsp) {
            if(typeof rsp === 'string'){
                var rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
            var datas={};
            datas.pic_path=pic_path;
            datas.title=title;
            datas.price=price;
            datas.num=num;
            datas.num_iid=num_iid;
            datas.properties=properties;
            var propertiename='';
            var provals='';
            var proname='';
            var pronametext='';
            var skus=rsp.item_get_response.item.skus.sku;
            var  property_alias=rsp.item_get_response.item.property_alias;
            property_alias=property_alias.split(';');
            var proalias ={};
            for(var i in property_alias){
                var alias= property_alias[i].split(':');
                var id=''+alias[0]+alias[1];
                proalias[id]=alias[2];
            }
            for(var index in skus){
                propertiename=skus[index].properties_name;
                provals=propertiename.split(';');
                for(var j in provals){
                    proname=provals[j].split(':');
                    if(proname!=''){
                        if(j!=0){
                            if(proalias[proname[0]+proname[1]]){
                                pronametext+=';'+proname[2]+':'+proalias[''+proname[0]+proname[1]];
                            }else{
                                pronametext+=';'+proname[2]+':'+proname[3];
                            }
                        }else{
                            if(proalias[''+proname[0]+proname[1]]){
                                pronametext=proname[2]+':'+proalias[''+proname[0]+proname[1]];
                            }else{
                                pronametext=proname[2]+':'+proname[3];
                            }
                        }
                    }
                }
                if(properties==pronametext){
                	skus[index].isprosku=true;;
                }
                skus[index].properties_name=pronametext;
            }
            
            datas.skus=skus;
            var source = $("#skudata_template").html();
            var template = Handlebars.compile(source);
            var htmlstr = template(datas);
            $("#skubody").html(htmlstr).trigger('create');
            
            $('.dropdown-toggle').dropdown();
            $("#savesku").attr("onclick","savesku('"+oid+"')");
            radclick();
            $('#skuedit-table').modal('show');
        },
        error: function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var	msp= msp;
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
     	         */
            }else{
                if(msp.sub_msg){
                	layer.msg('编辑订单属性:'+msp.sub_msg,1,3);
                }else{
                	geterrorinfo("taobao.item.get",msp);
                }
            }
        }
    });
}
function radclick(){/*编辑属性时的onchange事件*/
    /*var provl= $("#selectsku").find('option:selected').val();*/
    var provl=$("#selectsku").siblings('a').children('input').val();
    provl=provl.split(",");
    $("#skuprice").html(provl[1]);
    $("#skunum").html(provl[2]);
}
function savesku(oid){
    /*var provl= $("#selectsku").find('option:selected').val();*/
    var provl= $("#selectsku").siblings('a').children('input').val();
    provl=provl.split(",");
    var properties=provl[0];
    if(properties==''||oid==''){
    	layer.msg('操作失败，请重试！',1,3);
    }else{
        QN.top.invoke({
            "cmd": "taobao.trade.ordersku.update",
            "param":{
                oid:oid,
                sku_props:properties
            },
            "method": "get",
            "success" : function(rsp) {
                if(typeof rsp === 'string'){
                    var rsp = JSON.parse(rsp);
                }
                layer.msg('修改成功！',1,1);
                $('#all_list').empty();
            	$('#dfh_list').empty();
                
                if(liststatus=='detail'){
                	getdetail(gtid);
                }
                getordersta(gsta,gpageno);
            },
            error: function(msp){
                /*请求出错处理 */
                /* alert(JSON.stringify(msp));*/
                if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }
                if(msp.sub_code=='subuser.has-no-permission'){
                	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                     */
                }else{
                    if(msp.sub_msg){
                    	layer.msg('保存库存：'+msp.sub_msg,1,3);
                    }else{
                    	geterrorinfo("taobao.trade.ordersku.update",msp);
                    }
                }
            }
        });
    }

}
    function wwfastpay(tid,buyernick,name,time,sellernick){
    	tradePoint(sellernick,'首页旺旺催付');
        if(vipuser==0){
          	$('#buyvip').modal('show');
          	return;
        }
    	var cuifucontent=window.localStorage.getItem("cuifucontent"+sellernick);
		if(cuifucontent==''|| cuifucontent==null){
	        $.ajax({
  	  		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/fastpay',
  	  		    type: 'POST',
  	  		    dataType:'html',
  	  		    data:{nick:user_nick},
  	  		    timeout:10000,
	            beforeSend: function(XMLHttpRequest){
	            },
	            success: function(data){
	            	window.localStorage.setItem('cuifucontent'+user_nick,data);
	                data=data.replace(/<买家姓名>/g, name);
	                data=data.replace(/<卖家旺旺>/g, sellernick);
	                data=data.replace(/<订单链接>/g, 'http://trade.taobao.com/trade/detail/trade_item_detail.htm?bizOrderId='+tid);
	                data=data.replace(/<买家旺旺>/g, buyernick);
	                data=data.replace(/<订单编号>/g, tid);
	                data=data.replace(/<下单时间>/g, time);
	                wangwangPC(buyernick,data);
	            },
	            complete: function(XMLHttpRequest, textStatus){
	                /*HideLoading(); */
	            },
	            error: function(){
	                /*请求出错处理 */
	                layer.msg('获取数据失败！',1,3);
                    
	            }
	        });
		 }else{
			 cuifucontent=cuifucontent.replace(/<买家姓名>/g, name);
			 cuifucontent=cuifucontent.replace(/<卖家旺旺>/g, sellernick);
			 cuifucontent=cuifucontent.replace(/<订单链接>/g, 'http://trade.taobao.com/trade/detail/trade_item_detail.htm?bizOrderId='+tid);
			 cuifucontent=cuifucontent.replace(/<买家旺旺>/g, buyernick);
			 cuifucontent=cuifucontent.replace(/<订单编号>/g, tid);
			 cuifucontent=cuifucontent.replace(/<下单时间>/g, time);
             wangwangPC(buyernick,cuifucontent);
			 }
    	}
var wz;/*疑问*/
    function onclicktid(cmd,tid){/*弹出发货，和卖家备注的*/
        $("#codpostid").val('');
        $("#postid").val('');/*运单号清空*/
        $("#beiwtext").val('');
    	$("#more_shen").empty();
        $("#more_shi").empty();
    	$("#more_qu").empty();
        window.ggtadjust_fee ='';
        window.gbeiwsta ='';
        gtid=tid;
            QN.top.invoke({
                "cmd": "taobao.trade.fullinfo.get",
                "param": {
                    "fields":"cod_status,promotion_details,seller_flag,seller_memo,status,seller_nick,orders.status,buyer_nick,buyer_message,alipay_no,created,pay_time,end_time,consign_time,shipping_type,orders,total_fee,post_fee, created, tid, seller_rate,buyer_flag,adjust_fee",
                     "tid":gtid
                },
                "method": "get",
                "success": function (rsp){
                    if(typeof rsp === 'string'){
                        var rsp = JSON.parse(rsp);
                    }
                    var trade = rsp.trade_fullinfo_get_response.trade;
                    wz=trade.status;
                    if(trade.seller_flag==0){
                        $(':radio[name="beiwf"]').eq(0).attr("checked",false);
                        $(':radio[name="beiwf"]').eq(1).attr("checked",false);
                        $(':radio[name="beiwf"]').eq(2).attr("checked",false);
                        $(':radio[name="beiwf"]').eq(3).attr("checked",false);
                        $(':radio[name="beiwf"]').eq(4).attr("checked",false);
                        if(undefined==trade.seller_memo){
                            gbeiwsta ='add';
                            beizhu="";
                            $("#beiwtext").val('');
                        }else{
                            gbeiwsta ='eid';
                           $("#beiwtext").val(trade.seller_memo);
                        }
                    }else if(trade.seller_flag==1){
                        $(':radio[name="beiwf"]').eq(0).attr("checked",true);
                        gbeiwsta ='eid';
                    }else if(trade.seller_flag==2){
                        $(':radio[name="beiwf"]').eq(1).attr("checked",true);
                        gbeiwsta ='eid';
                    }else if(trade.seller_flag==3){
                        $(':radio[name="beiwf"]').eq(2).attr("checked",true);
                        gbeiwsta ='eid';
                    }else if(trade.seller_flag==4){
                        $(':radio[name="beiwf"]').eq(3).attr("checked",true);
                        gbeiwsta ='eid';
                    }else if(trade.seller_flag==5){
                        $(':radio[name="beiwf"]').eq(4).attr("checked",true);
                        gbeiwsta ='eid';
                    }
                    if(trade.seller_flag!=0&&trade.seller_memo!=undefined){$("#beiwtext").val(trade.seller_memo.replace(/(^\s*)/g, ""))};
                    if('beiw-table'==cmd)
                    {
                        getmymemo();
                    }
                    var datas= {};
                    gprdetail=0;
                    try{
	                    if(trade.promotion_details){
	                    for(var pn in trade.promotion_details.promotion_detail){
	                        var prdetail=trade.promotion_details.promotion_detail[pn];
	                        if(trade.tid==prdetail.id){
	                            if(1==trade.promotion_details.promotion_detail.length&&trade.orders.order[0].discount_fee!=0){
	                                gprdetail=0;
	                                break;
	                            }else{
	                                gprdetail=prdetail.discount_fee;
	                                break;
	                            }
	                        }
	                    }
	                    }
                    }catch(e){
                    	layer.msg(e,1,3);
                    }
                    datas.tditems=trade.orders.order;
                    datas.total_fee=trade.total_fee;
                    datas.post_fee=trade.post_fee;
                    window.gpost_fee= datas.post_fee;
                    window.gtotal_fee= datas.total_fee;
                    window.goidarr= new Array();
                    var tadjust_fee = 0;
                    var tdiscount_fee=0;
                    var value=datas.tditems.length;
                    for(var n in trade.orders.order){
                        var oid=trade.orders.order[n].oid;
                        goidarr[n]=oid;
                        tadjust_fee =Number(tadjust_fee) + Number(trade.orders.order[n].adjust_fee);
                        tdiscount_fee =Number(tdiscount_fee) + Number(trade.orders.order[n].discount_fee);
                        var zhe=''
                        if(datas.adjust_fee-datas.discount_fee==0){
                            datas.tditems[n].zhe='';
                        }else{
                            zhe=parseFloat(trade.orders.order[n].price*trade.orders.order[n].num)+parseFloat(trade.orders.order[n].adjust_fee)-trade.orders.order[n].discount_fee;
                            zhe*=10;
                            var pn=trade.orders.order[n].price*trade.orders.order[n].num;
                            zhe/=pn;
                            datas.tditems[n].zhe=zhe.toFixed(2);
                        }
                        datas.tditems[n].zhe_fee=(parseFloat(trade.orders.order[n].adjust_fee)-parseFloat(trade.orders.order[n].discount_fee)).toFixed(2);

                        datas.tditems[n].itemtotal=pn.toFixed(2);
                        if(datas.tditems[n].status=="WAIT_BUYER_CONFIRM_GOODS"){
                        	datas.tditems[n].iscdsend=false;
                        	value--;
                        }else{
                        	datas.tditems[n].iscdsend=true;
                        }
                        if(datas.tditems[n].status=="TRADE_NO_CREATE_PAY"||datas.tditems[n].status=="WAIT_BUYER_PAY"){
                        	datas.tditems[n].iscdclose=true;
                        }else{
                        	datas.tditems[n].iscdclose=false;
                        }
                        datas.outer_sku_id=trade.orders.order[n].outer_sku_id;
                        datas.outer_iid=trade.orders.order[n].outer_iid;
                    }
		    		
                    datas.tadjust_fee = (Number(tadjust_fee)-Number(tdiscount_fee)).toFixed(2);
                    datas.pricetotal= (Number(datas.tadjust_fee)+ Number(datas.total_fee)+Number(datas.post_fee)-Number(gprdetail)).toFixed(2);
                    if(datas.tadjust_fee<0){
                        if(0==gprdetail){
                        datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' '+ datas.tadjust_fee+' = '+datas.pricetotal;
                        }else{
                            datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' '+ datas.tadjust_fee+' - '+gprdetail+' = '+datas.pricetotal;
                        }
                    }else{
                        if(0==gprdetail){
                        datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' + '+datas.tadjust_fee+' = '+datas.pricetotal;
                        }else{
                            datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' + '+datas.tadjust_fee+' - '+gprdetail+' = '+datas.pricetotal;
                        }
                    }
                    window.gtadjust_fee= datas.tadjust_fee;
                    datas.receiver_name= trade.receiver_name;
                    datas.receiver_state = trade.receiver_state;
                    datas.receiver_city = trade.receiver_city;
                    datas.receiver_district = trade.receiver_district;
                    datas.receiver_address = trade.receiver_address;
                    datas.receiver_zip = trade.receiver_zip;
                    datas.receiver_mobile = trade.receiver_mobile;
                    datas.receiver_phone = trade.receiver_phone;
                    datas.consign_time = trade.consign_time;
                    datas.shipping_type = '';
                   	gmoreshen= trade.receiver_state;
                    gmoreshi=trade.receiver_city;
                    gmorequ=trade.receiver_district;
                    $("#addrinfo").html('<p style="margin: 10px 10px 0px 10px;"><span style="">'+trade.receiver_name+'，'+trade.receiver_mobile+'，'+trade.receiver_phone+'，'+ trade.receiver_state+trade.receiver_city+trade.receiver_district+ trade.receiver_address+'，'+trade.receiver_zip+'</span></p>');
                    $("#more_zip").val(trade.receiver_zip);
                     $("#more_name").val(trade.receiver_name);
                     $("#more_address").val(trade.receiver_address);
                     $("#more_phone").val(trade.receiver_phone);
                     $("#more_mobile").val(trade.receiver_mobile);
                    switch(trade.shipping_type){
                        case 'free': datas.shipping_type = '卖家包邮';break;
                        case 'post': datas.shipping_type = '平邮';break;
                        case 'express': datas.shipping_type = '快递';break;
                        case 'ems': datas.shipping_type = 'EMS';break;
                        case 'virtual': datas.shipping_type = '虚拟发货';break;
                        case '25': datas.shipping_type = '次日必达';break;
                        case '26': datas.shipping_type = '预约配送';break;
                    }
                    datas.buyer_nick=trade.buyer_nick;
                    datas.seller_nick=trade.seller_nick;
                    datas.wlflase = true;
                    datas.wleditt = false;
                    var source = $("#pricebd_template").html();
                    var template=Handlebars.compile(source);
                    var htmlstr = template(datas);
                    $("#pricebody").html(htmlstr).trigger('create');
					if(cmd=='price-table'){
						$('#price-table').modal('show');
					}
                    var source = $("#pingjiadata_template").html();
                    var template=Handlebars.compile(source);
                    var htmlstr = template(datas);
                    $("#pingjiadata").html(htmlstr).trigger('create');
                    if(cmd=='pingjia-table'){
						$("#pingjia-table").modal('show');
                    }
                    var fast_ratews=window.localStorage.getItem("fast_rate"+datas.seller_nick);
              		if(fast_ratews==''|| fast_ratews==null){
	                    $.ajax({
	                         type: 'POST',
 	 		    			data:{nick:datas.seller_nick},
	                        url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getPing',
	                        error: function(e){/*获取失败*/
	                        },
	                        success: function(dataP){ /*获取成功*/
	                            var dataPs=dataP;
	                            window.localStorage.setItem('fast_rate'+datas.seller_nick,dataPs);
	                            $(".conpj").empty();
	                            var valP=dataPs.split('\\n');
	                            if(valP[0].indexOf('\n') > 0 ) valP=dataPs.split('\n');
	                            if(valP!=null&&valP.length>1){
	                                for(index in valP){
	                                    $(".conpj").append('<option  value="'+valP[index]+'">'+valP[index]+'</option>');
	                                }
	                            }else $(".conpj").append('<option  value="'+dataPs+'">'+dataPs+'</option>');
	                            $("[name='initpcon']").html(valP[0]);
	                        }
	                    });
              		}else{
              			$(".conpj").empty();
                        var valP=fast_ratews.split('\\n');
                        if(valP[0].indexOf('\n') > 0 ) valP=fast_ratews.split('\n');
                        if(valP!=null&&valP.length>1){
                            for(index in valP){
                                $(".conpj").append('<option  value="'+valP[index]+'">'+valP[index]+'</option>');
                            }
                        }else $(".conpj").append('<option  value="'+fast_ratews+'">'+fast_ratews+'</option>');
                        $("[name='initpcon']").html(valP[0]);
                  		}
              		
                    datas.sendsmessage=$("#sellercoms"+gsta+trade.tid).attr("title");
                    datas.sendbmessage=$("#buyercom"+gsta+trade.tid).attr("title");
                    var source = $("#closelist_template").html();
                    var template=Handlebars.compile(source);
                    var htmlstr = template(datas);
                    $("#closelist").html(htmlstr).trigger('create');
                    if(trade.buyer_message!=undefined && trade.buyer_message!=''){
    					datas.buyer_message=trade.buyer_message;
    				}
    				if(trade.seller_memo!=undefined && trade.seller_memo!=''){
    					datas.seller_memo=trade.seller_memo;
    				}
    				datas.seller_flag=trade.seller_flag;
                    var source = $("#sendlist_template").html();
                    var template=Handlebars.compile(source);
                    var htmlstr = template(datas);
                    $("#sendlist").html(htmlstr).trigger('create');
                    var source = $("#codsendlist_template").html();
                    var template=Handlebars.compile(source);
                    var htmlstr = template(datas);
                    $("#sendcodlist").html(htmlstr).trigger('create');
                    if(cmd=="wldata-table"){/*查看物流*/
                    	showwuliu(trade.seller_nick);
                    }
                },
                error: function(msp){
                    /*请求出错处理 */
                    /* alert(JSON.stringify(msp));*/
                    if(typeof msp === 'string'){
                        var msp = JSON.parse(msp);
                    }else{
                        var	msp= msp;
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                    	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
             	         */
                    }else{
                        if(msp.sub_msg){
                        	layer.msg('显示错误：'+msp.sub_msg,1,3);
                 	        
                        }else{
                        	geterrorinfo("taobao.trade.fullinfo.get",msp);
                        }
                    }
                }
            });
    }
    /*获取卖家备注留言快捷短语*/
function getmymemo(){
	var fast_beiw=window.localStorage.getItem("fast_beiw"+user_nick);
    $("#memone").empty().append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="">请选择常用短语</a></li>');
    $("#memomore").empty().append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="">请选择常用短语</a></li>');
	if(fast_beiw==''|| fast_beiw==null){
		$.ajax({
  		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getFast',
  		    type: 'POST',
  		    dataType:'html',
  		    data:{nick:user_nick,types:'fast_beiw'},
  		    timeout:10000,
	        success: function(dataP){ /*获取成功*/
	            var dataPs=dataP;
	            window.localStorage.setItem('fast_beiw'+user_nick,dataPs);
	            var valP=dataPs.split('\\n');
	            if(valP[0].indexOf('\n') > 0 ) valP=dataPs.split('\n');
	            if(valP!=null&&valP.length>1){
	                for(index in valP){
	                	$("#memone").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+valP[index]+'">'+valP[index]+'</a></li>');
	                	$("#memomore").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+valP[index]+'">'+valP[index]+'</a></li>');
		           	}
	            }else{
	            	$("#memone").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+dataPs+'">'+dataPs+'</a></li>');
	            	 $("#memomore").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+dataPs+'">'+dataPs+'</a></li>');
	            }
	        }
	    });
	}else{
        var valP=fast_beiw.split('\\n');
        if(valP[0].indexOf('\n') > 0 ){valP=fast_beiw.split('\n');}
        if(valP!=null&&valP.length>1){
            for(index in valP){
            	$("#memone").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+valP[index]+'">'+valP[index]+'</a></li>');
            	$("#memomore").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+valP[index]+'">'+valP[index]+'</a></li>');
            }
        }else{
        	$("#memone").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+fast_beiw+'">'+fast_beiw+'</a></li>');
        	$("#memomore").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+fast_beiw+'">'+fast_beiw+'</a></li>');
        }
	}
}

    /*备注*/

        function addbeiw()
        {
            var data=$("#beiwtext").val();
            if(data.length>500){
            	layer.msg('备注不能超过500字！',1,3);
            }else{
           	 var seltitle=$(':radio[name="beiwf"]:checked').val();
                if('add'==gbeiwsta){
                    QN.top.invoke({
                        "cmd": "taobao.trade.memo.update",
                        "param":{
                            tid:gtid,
                            memo:data,
                            flag:seltitle
                        },
                        "method": "get",
                        "success" : function(rsp) {
                            if(typeof rsp === 'string'){
                                var rsp = JSON.parse(rsp);
                            }else{
                                var	rsp= rsp;
                            }
                            var rsperror=rsp.msg;
                            if(rsperror==undefined){
                            	/*if(liststatus!='detail'){
                                	getdetail(gtid);
                                }*/
                            	layer.msg('添加成功！',1,1);
                            	if(data.length > 5 && data!=""){
                            		$("#sellercoms"+gsta+gtid).html(data.substring(0,5) + "...");
                                	$("#sellercoms"+gsta+gtid).attr('title',data);
                                }else if(data.length <=5 && data!=""){
                                	$("#sellercoms"+gsta+gtid).html(data);
                                	$("#sellercoms"+gsta+gtid).attr('title',data);
                                }else{
                                	$("#sellercoms"+gsta+gtid).html('');
                                	$("#sellercoms"+gsta+gtid).attr('title','暂无备注信息');
                                }
                                if(seltitle!=undefined){
                                	$("#sellercom"+gsta+gtid).attr('src','http://cdn.zzgdapp.com/trade/web/images/op_memo_'+seltitle+'.png');
	                               }
                                /*$('#all_list').empty();
                                $('#dfk_list').empty();
                                $('#yfh_list').empty();
                                $('#tkz_list').empty();
                                $('#dpj_list').empty();
                                $('#sussce_list').empty();
                                $('#close_list').empty();
                               	getordersta(gsta,gpageno);*/
                               	if(liststatus=='detail'){
                               		getdetail(gtid);
                               	}
                            }else{
                                if(rsp.sub_msg){
                                	layer.msg('添加备注：'+rsp.sub_msg,1,3);
                                    
                                }else{
                                	geterrorinfo("taobao.trade.memo.update",rsp);
                                }
                            }
                        },
                        error: function(msp){
                            if(typeof msp === 'string'){
                                var msp = JSON.parse(msp);
                            }else{
                                var	msp= msp;
                            }
                            if(msp.sub_code=='subuser.has-no-permission'){
                            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                                 */
                            }else{
                                if(msp.sub_msg){
                                	layer.msg('添加备注错误：'+msp.sub_msg,1,3);
                                    
                                }else{
                                	geterrorinfo("taobao.trade.memo.update",msp);
                                }
                            }
                        }
                    });
                }else if('eid'==gbeiwsta){
                    QN.top.invoke({
                        "cmd": "taobao.trade.memo.update",
                        "param":{
                            tid:gtid,
                            memo:data,
                            flag:seltitle
                        },
                        "method": "get",
                        "success" : function(rsp) {
                            if(typeof rsp === 'string'){
                                var rsp = JSON.parse(rsp);
                            }else{
                                var	rsp= rsp;
                            }
                            var rsperror=rsp.msg;
                            if(rsperror==undefined){
                            	/*if(liststatus=='detail'){
                                	getdetail(gtid);
                                }*/
                            	layer.msg('修改成功！',1,1);
                            	if(data.length > 5 && data!=""){
                            		$("#sellercoms"+gsta+gtid).html(data.substring(0,5) + "...");
                                	$("#sellercoms"+gsta+gtid).attr('title',data);
                                }else if(data.length <=5 && data!=""){
                                	$("#sellercoms"+gsta+gtid).html(data);
                                	$("#sellercoms"+gsta+gtid).attr('title',data);
                                }else{
                                	$("#sellercoms"+gsta+gtid).html('');
                                	$("#sellercoms"+gsta+gtid).attr('title','暂无备注信息');
                                }
                            	if(seltitle!=undefined){
                            		$("#sellercom"+gsta+gtid).attr('src','http://cdn.zzgdapp.com/trade/web/images/op_memo_'+seltitle+'.png');
                            	}
                                /*$('#all_list').empty();
                                $('#dfk_list').empty();
                                $('#yfh_list').empty();
                                $('#tkz_list').empty();
                                $('#dpj_list').empty();
                                $('#sussce_list').empty();
                                $('#close_list').empty();
                               getordersta(gsta,gpageno);*/
                            	if(liststatus=='detail'){
                               		getdetail(gtid);
                               	}
                            }else{
                                if(rsp.sub_msg){
                                	layer.msg('添加备注错误：'+rsp.sub_msg,1,3);
                                    
                                }else{
                                	geterrorinfo("taobao.trade.memo.update",rsp);
                                }
                            }
                        },
                        error: function(msp){
                            if(typeof msp === 'string'){
                                var msp = JSON.parse(msp);
                            }else{
                                var	msp= msp;
                            }
                            if(msp.sub_code=='subuser.has-no-permission'){
                            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                                 */
                            }else{
                                if(msp.sub_msg){
                                	layer.msg('备注错误：'+msp.sub_msg,1,3);
                                    
                                }else{
                                	geterrorinfo("taobao.trade.memo.update",msp);
                                }
                            }
                        }
                    });
                }else{
                }
            }
        }
function showIndexsucRate(tid,sellerrate,buyerrate){
	if(buyerrate=true || buyerrate==''){
		QN.top.invoke({
			cmd:'taobao.traderates.get',
			param:{
				fields:'nick,result,content,reply,created',
				rate_type:'get',
				role:'buyer',
				tid:tid
			},
			method:'GET',
			success:function(rsp){
				$('#doubleratebody').empty();
				if(typeof rsp==='string'){
					rsp=JSON.parse(rsp);
				}
				if(rsp.traderates_get_response.total_results<1){
					$('#Buyerratebody').empty().html('<h5>买家尚未评价</h5>');
				}else{
					$('#Buyerratebody').empty();
					var datas={};
					var rates=rsp.traderates_get_response.trade_rates.trade_rate;
					for(var i in rates){
						datas.nick=rates[i].nick;
						datas.result=rates[i].result;
						datas.content=rates[i].content;
						datas.reply=rates[i].reply;
						datas.created=rates[i].created; 
						var template = Handlebars.compile($("#index_buyerrate_success-template").html());
						$('#Buyerratebody').append(template(datas));
						if(i<rates.length-1){
							$('#Buyerratebody').append('<hr/>');
						}
					}
				}
				$("#isdoulerate").modal('show');
			},
			error:function(msp){
				if(typeof msp==='string'){
					msp=JSON.parse(msp);
				}
				geterrorinfo("taobao.traderates.get",msp);
			}
		});
	}else{
			$('#Buyerratebody').empty().html('<h5>买家尚未评价</h5>');
	} 
	if(sellerrate=true ||sellerrate==''){/*卖家也评论了*/
		QN.top.invoke({
			cmd:'taobao.traderates.get',
			param:{
				fields:'nick,result,content,created',
				rate_type:'give',
				role:'seller',
				tid:tid
			},
			method:'GET',
			success:function(rsp){
				$("#Sellerratebody").empty();
				if(typeof rsp==='string'){
					rsp=JSON.stringify(rsp);
				}
				if(rsp.traderates_get_response.total_results<1){
					$("#Sellerratebody").empty();
					$("#Sellerratebody").html('<h5>卖家尚未评价</h5>');
				}else{
					var datas={};
					datas.issller=true;
					var rates=rsp.traderates_get_response.trade_rates.trade_rate;
					$("#Sellerratebody").empty();
					for(var i in rates){
						datas.nick=rates[i].nick;
						datas.result=rates[i].result;
						datas.content=rates[i].content;
						datas.created=rates[i].created; 
						var template = Handlebars.compile($("#index_buyerrate_success-template").html());
						$("#Sellerratebody").append(template(datas));
						if(i<rates.length-1){
							$('#Sellerratebody').append('<hr/>');
						}
					}
				}
			},
			error:function(msp){
				if(typeof msp==='string'){
					msp=JSON.stringify(msp);
				}
				geterrorinfo("taobao.traderates.get",msp);
			}
		});
	}else{
		$("#Sellerratebody").empty().html('<h5>卖家尚未评价</h5>');
	}
}
	    var gisresend;
    	var mycd;
        var mysub_tids;
    	function showwuliu(seller_nick){/*查看物流*/
            gisresend=false;
            mycd=false;
            mysub_tids='';
    		$('#wz').html("<input class=\"sui-btn btn-primary btn-large\" type=\"button\" data-ok=\"modal\" type=\"button\" value=\"关闭\">");
    		$("#bfselect").empty();
    		$("#tdwldatas").empty();
        	QN.top.invoke({
        		cmd: "taobao.logistics.orders.get",
        		param: {fields:'order_code,seller_nick,buyer_nick,delivery_start,delivery_end,out_sid,item_title,receiver_name,created,modified,status,type,freight_payer,seller_confirm,company_name,sub_tids,is_spilt',tid:gtid},
        		method: "get",
        		success: function (rsp){
                    if(typeof  rsp=== 'string'){rsp = JSON.parse(rsp);}
                    if(rsp.code!=null){
                        if(rsp.sub_msg){
                        	layer.msg('显示物流：'+rsp.sub_msg,1,3);
                        }else{
                       		geterrorinfo("taobao.logistics.orders.get",rsp);
                        }
                    }else{
                        var orders=rsp.logistics_orders_get_response.shippings.shipping;
                        var datas={};
                        var i=1;
                        var n=0;
                        var compoid='';
                        for(index in orders){
                            var item=orders[index];
                            if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.modified)>=23*60*60+50*60){
                               var show_resend=false;
                            	/*var show_resend=true;*/
                            }else{
                                var show_resend=true;
                            }
                            if(show_resend && item.company_name!=null&&(wz=='WAIT_BUYER_CONFIRM_GOODS'||wz=='SELLER_CONSIGNED_PART')){
                                gisresend=true;
                            }else{
                                gisresend=false;
                            }
                            if(orders[index].company_name||orders[index].out_sid ){
                           compoid += orders[index].company_name +','+orders[index].out_sid +'  ';}
                        }
                        $('#wz').prepend("<input type=\"button\" class=\"sui-btn btn-primary btn-large\" style=\"padding: 3px 10px;\" onclick=\"sendwuliuww(\'"+orders[0].buyer_nick+"\',\'"+compoid+"\');\" value=\"发送物流信息到旺旺\">");
                        if(orders.length<2){
                           	 $("#bfselect").append("<option value=\"abc\" >包裹"+i+"</option>").trigger("create");
                           	 $("#bfselect").hide();
                           	 showwulius(seller_nick,orders[0]);
                        }else{
                             mycd=true;
                          	 $("#bfselect").show();
                             var n=0;
                         	 var i=1;
                          	 for(index in orders){
                                 var item=orders[index];
                                 if(item.seller_confirm=="yes"){
                    				 	$("#bfselect").append("<option value=\""+index+"\" >包裹"+i+"</option>").trigger("create");
										i++;
         	    	            		if(n==0){
         	 	    	            		n++;
                  				 			datas.sub_tid=item.sub_tids.number;
                                            mysub_tids=item.sub_tids.number;
                                            if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.created)>=23*60*60+50*60){
                                                var show_resend=false;
                                            }else{
                                                var show_resend=true;
                                            }
                                            if(show_resend&&item.company_name!=null&&(wz=='WAIT_BUYER_CONFIRM_GOODS'||wz=='SELLER_CONSIGNED_PART')){
                                                gisresend=true;
                                            }else{
                                                gisresend=false;
                                            }
	                  				 	QN.top.invoke({
	                  						cmd: "taobao.logistics.trace.search",
	                  						param: {tid:gtid,seller_nick:seller_nick,is_split:'1',sub_tid:datas.sub_tid},
	                  						method: "get",
	                  						success: function (rsp){
	                  				        	if(typeof  rsp=== 'string'){
	                  				            	rsp = JSON.parse(rsp);
	                  				            }
	                  				            if(rsp.code!=null){
	                                                if(rsp.sub_msg){
	                                                	layer.msg('物流搜索：'+rsp.sub_msg,1,3);
	                                                }else{
	                                                	geterrorinfo("taobao.logistics.trace.search",rsp);
	                                                }
	                  				            }else{
	                 				            	var datas= {};
	                                                datas.isresend=gisresend;
	                   			                    datas.company_name = rsp.logistics_trace_search_response.company_name;
	                   			                    datas.out_sid = rsp.logistics_trace_search_response.out_sid;
	                   			                    datas.tracelists = rsp.logistics_trace_search_response.trace_list.transit_step_info;
	                   			                    var source = $("#tdwldatas_template").html();
	                   			                    var template=Handlebars.compile(source);
	                   			                    var htmlstr = template(datas);
	                   			                    $("#tdwldatas").html(htmlstr).trigger('create');
	                    			               	$("#bfselect option[value='0']").attr("selected","selected");
	                  				            }
	                  					    }
	                  					});
                                 	}/*end if ==0*/
                                 }/*end if yes */
                             }/*end for*/
                           	$("#wldata-table").modal('show');
                         }/*end else*/
        			}
        		},
                error: function(msp){
                    /*请求出错处理 */
                    /* alert(JSON.stringify(msp));*/
                    if(typeof msp === 'string'){
                        var msp = JSON.parse(msp);
                    }else{
                        var	msp= msp;
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                    	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
             	         */
                    }else{
                        if(msp.sub_msg){
                        	layer.msg('搜索错误：'+msp.sub_msg,1,3);
                        }else{
                        	geterrorinfo("taobao.logistics.orders.get",msp);
                        }
                    }
                }
        	 });
    	}

function showbg(){
	var sel=$("#bfselect").find("option:selected").val();
    $("#tdwldatas").empty();
    QN.top.invoke({
	    cmd:"taobao.logistics.orders.get",
	    param: {fields:'tid,order_code,seller_nick,buyer_nick,delivery_start,delivery_end,out_sid,item_title,receiver_name,created,modified,status,type,freight_payer,seller_confirm,company_name,sub_tids,is_spilt',tid:gtid},
	    method:"get",
	    success: function (rsp){
	    	if(typeof  rsp=== 'string'){
	        	rsp = JSON.parse(rsp);
	      	}                
	        if(rsp.code!=null){
	        	if(rsp.sub_msg){
	            	layer.msg('显示BG：'+rsp.sub_msg,1,3);
	         	}else{
	            	layer.msg('显示BG：操作失败，请重试！',1,3);
	        	}
			}else{
	        	var orders=rsp.logistics_orders_get_response.shippings.shipping;
	            var datas={};
	            for(index in orders){
	            	var item=orders[index];
	                if(index==sel){
	                    datas.sub_tid=item.sub_tids.number;
	                    mysub_tids=item.sub_tids.number;
	                    if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.created)>=23*60*60+50*60){
	                    	var show_resend=false;
	                  	}else{
	                    	var show_resend=true;
	                   	}
	                    if(show_resend&&item.company_name!=null&&(wz=='WAIT_BUYER_CONFIRM_GOODS'||wz=='SELLER_CONSIGNED_PART')){
	                    	gisresend=true;
	                    }else{
	                    	gisresend=false;
	                    }
	                    QN.top.invoke({
	                    	cmd: "taobao.logistics.trace.search",
	                    	param: {tid:gtid,seller_nick:user_nick,is_split:'1',sub_tid:datas.sub_tid},
	                    	method: "get",
	                    	success: function (rsp){
	                    		if(typeof  rsp=== 'string'){
	                    			rsp = JSON.parse(rsp);
	                    		}
	                    		if(rsp.code!=null){
	                            	if(rsp.sub_msg){
	                                	layer.msg('交易搜索：'+rsp.sub_msg,1,3);
	                             	}else{
	                                 	geterrorinfo("taobao.logistics.trace.search",rsp);
	                               	}
	                    		}else{
	                   				var datas= {};
	                               	datas.isresend=gisresend;
	                     			datas.company_name = rsp.logistics_trace_search_response.company_name;
	                     			datas.out_sid = rsp.logistics_trace_search_response.out_sid;
	                     			datas.tracelists = rsp.logistics_trace_search_response.trace_list.transit_step_info;
	                     			var source = $("#tdwldatas_template").html();
	                     			var template=Handlebars.compile(source);
	                     			var htmlstr = template(datas);
	                     			$("#tdwldatas").html(htmlstr).trigger('create');
	                    		}
	                    	}
	                   	});
	                }
	           	}
			}
	     },
	    error: function(msp){
	    	if(typeof msp === 'string'){
	        	var msp = JSON.parse(msp);
	      	}
	        if(msp.sub_code=='subuser.has-no-permission'){
	        /* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);*/
			}else{
				if(msp.sub_msg){
					layer.msg('交易搜索错误：'+msp.sub_msg,1,3);
				}else{
	            	geterrorinfo("taobao.logistics.orders.get",msp);
				}
	     	}
		}
   	});
 }
        function showwulius(seller_nick,orders){
            QN.top.invoke({
                cmd:"taobao.logistics.trace.search",
                param:{tid:gtid,seller_nick:seller_nick },
                method:"get",
                success:function(rsp) {
                    if(typeof rsp === 'string'){
                        var rsp = JSON.parse(rsp);
                    }
                    var datas= {};
                    datas.isresend=gisresend;
                    if(rsp.logistics_trace_search_response.company_name!=undefined){
                    	datas.company_name = rsp.logistics_trace_search_response.company_name;
                    }else{
                    	datas.company_name=orders.company_name;
                    }
                    datas.out_sid = rsp.logistics_trace_search_response.out_sid;
                    datas.tracelists = rsp.logistics_trace_search_response.trace_list.transit_step_info;
                    var source = $("#tdwldatas_template").html();
                    var template=Handlebars.compile(source);
                    var htmlstr = template(datas);
                    $("#tdwldatas").html(htmlstr).trigger('create');
                    $("#wldata-table").modal('show');
                },
                error: function(msp){
                    if(typeof msp === 'string'){
                        var msp = JSON.parse(msp);
                    }else{
                        var	msp= msp;
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                    	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
             	         */
                    }else{
                    	geterrorinfo("taobao.logistics.trace.search",msp);
                    }
                }
            });
        }
    function sendwuliuww(nick,company){
    	var text=company+'\n'+$("p.intro:last").text();
        wangwangPC(nick,text);
    }
    function toresend(company){
        $('#outid').val('');
        QN.top.invoke({
            cmd:"taobao.logistics.companies.get",
            param:{fields:'code,name',is_recommended:true,order_mode:'online'},
            method:"get",
            success: function (rsp){
                if(typeof  rsp=== 'string'){rsp = JSON.parse(rsp); }
                if(rsp.code!=null){
                    if(rsp.sub_msg){
                    	layer.msg('发货在线：'+rsp.sub_msg,1,3);
                    }else{
                    	geterrorinfo("taobao.logistics.companies.get",rsp);
                    }
                }else{
                    $('#resendlist').empty();
                    var datas={};
                    for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
                        var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
                        datas.name=order.name;
                        /* datas.code=order.code;*/
                        /*var source = $("#ontrade_template").html();
                        var template = Handlebars.compile(source);
                        var htmlstr = template(datas);*/
                        if(datas.name==company){
                        	$("#resendlist").append('<li role="presentation" class="active"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+order.code+'">'+order.name+'</a></li>');
                        	$("#resendlist").siblings('a').children('input').val(order.code);/*input hiddden添加值*/
                            $("#resendlist").siblings('a').children('span').html(order.name);
                            /*$("#resendlist option[value='"+order.code+"']").attr("selected","selected");*/
                        }else{
                        	$("#resendlist").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+order.code+'">'+order.name+'</a></li>');
                        }
                       /* $("#resendlist").append('<option value="'+order.code+'">'+order.name+'</option>');*/
                    }
                }
                $("#resend-table").modal('show');
            },
            error: function(msp){
                if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }else{
                    var	msp= msp;
                }
                if(msp.sub_code=='subuser.has-no-permission'){
                	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
         	         */
                }else{
                    if(msp.sub_msg){
                    	layer.msg('发货在线错误：'+msp.sub_msg,1,3);
             	        
                    }else{
                    	geterrorinfo("taobao.logistics.companies.get",msp);
                    }
                }
            }
        });
    }
    function toresends(){
        var outid=$('#outid').val();
        var cycode=$("#resendlist").siblings('a').children('input').val();
        if(outid==''){
        	layer.msg('修改发货失败,运单号不能为空！',1,3);
        }else{
            if(mycd==true){ /*拆单发货*/
                QN.top.invoke({
                    cmd:"taobao.logistics.consign.resend",
                    param:{tid:gtid,out_sid:outid,is_split:'1',sub_tid:mysub_tids,company_code:cycode},
                    method:"get",
                    success:function (rsp){
                        if(typeof rsp=== 'string'){
                            rsp = JSON.parse(rsp);
                        }
                        if(rsp.code!=null){
                            $('#outid').val(null);
                            if(rsp.sub_msg){
                            	layer.msg(rsp.sub_msg,1,3);
                            }else{
                            	geterrorinfo("taobao.logistics.consign.resend",rsp);
                            }
                        }else{
                            $('#outid').val(null);
                            $('#yfh_list').empty();
                            getordersta(gsta,gpageno);
                            layer.msg('操作成功！',1,1);
                  	       if(liststatus=='detail'){
                              	getdetail(gtid);
                              }
                        }
                    },
                    error: function(msp){
                        if(typeof msp === 'string'){
                            var msp = JSON.parse(msp);
                        }else{
                            var	msp= msp;
                        }
                        if(msp.sub_code=='subuser.has-no-permission'){
                        	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                 	         */
                        }else{
                            if(msp.sub_msg){
                            	layer.msg('错误：'+msp.sub_msg,1,3);
                            }else{
                            	geterrorinfo("taobao.logistics.consign.resend",msp);
                            }
                        }
                    }
                });
            }else{
                QN.top.invoke({
                    cmd: "taobao.logistics.consign.resend",
                    param:{tid:gtid,out_sid:outid,company_code:cycode},
                    method:"get",
                    success: function (rsp){
                        if(typeof  rsp=== 'string'){
                            rsp = JSON.parse(rsp);
                        }
                        if(rsp.code!=null){
                            $('#outid').val(null);
                            if(rsp.sub_msg){
                            	layer.msg(rsp.sub_msg,1,3);
                            }else{
                            	geterrorinfo("taobao.logistics.consign.resend",rsp);
                            }
                        }else{
                            $('#outid').val(null);
                            
                            $('#yfh_list').empty();
                            getordersta(gsta,gpageno);
                            layer.msg('操作成功！',1,1);
                  	       if(liststatus=='detail'){
                              	getdetail(gtid);
                              }
                        }
                    },
                    error: function(msp){
                        /*请求出错处理 */
                        if(typeof msp === 'string'){
                            var msp = JSON.parse(msp);
                        }else{
                            var	msp= msp;
                        }
                        if(msp.sub_code=='subuser.has-no-permission'){
                        	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                 	         */
                        }else{
                            if(msp.sub_msg){
                            	layer.msg('错误：'+msp.sub_msg,1,3);
                     	        
                            }else{
                            	geterrorinfo("taobao.logistics.consign.resend",msp);
                            }
                        }
                    }
                });
            }
        }
    }
        function wangwang(bnick){
            var wangnick='cntaobao'+bnick;
            QN.wangwang.invoke({
                category: 'wangwang',
                cmd: 'chat',
                param: {'uid':wangnick},
                success: function (rsp) {
                },
                error: function (msg) {
                    if(msp.sub_msg){
                    	layer.msg(msp.sub_msg,1,3);
                    }else{
                    	layer.msg('操作失败，请重试！',1,3);
                    }
                }
            });
        }
        function getcomptys(){
            var mode=$("#sendplan").siblings('a').children('input').val();
            $("#comptyid").empty();
            if('notsend'!=mode){
                QN.top.invoke({
                    cmd:"taobao.logistics.companies.get",
                    param:{fields:'code,name',is_recommended:true, order_mode:mode },
                    method:"get",
                    success:function(rsp) {
                        if(typeof rsp === 'string'){
                            var rsp = JSON.parse(rsp);
                        }else{
                            var	rsp= rsp;
                        }
                        for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
                            var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
                            /*$("#comptyid").append('<option value="'+order.code+'">'+order.name+'</option>');*/
                            $("#comptyid").append('<li role="presentation"><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="'+order.code+'">'+order.name+'</a></li>');
                        }
                    },
                    error: function(msp){
                        if(typeof msp === 'string'){
                            var msp = JSON.parse(msp);
                        }else{
                            var	msp= msp;
                        }
                        if(msp.sub_code=='subuser.has-no-permission'){
                        	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
          	                 */
                        }else{
                            if(msp.sub_msg){
                            	layer.msg('获取快递公司：'+msp.sub_msg,1,3);
              	                
                            }else{
                            	geterrorinfo("taobao.logistics.companies.get",msp);
                            }
                        }
                    }
                });
            }
        }
        /*评价操作*/
        function pingjia()
        {
            debugger;
            var tql='';
            var pjtqlcom=false;
            var pjtextmax=false;
            var sub_msge='';
            var failnum=0;
            var oknum=0;
            var num=goidarr.length;
            for(var n in goidarr){
                var oid=goidarr[n];
                var mychecked =$(':radio[name="rate'+oid+'"]:checked').val();
                var text = $('#trate'+oid).val();
                if(text==''&&mychecked=='good'){
                    text='好评！';
                }
                if(text==''){
                    pjtqlcom=true;
                }
                if(text.length>500){
                    /*pjtextmax=true;*/
                    layer.msg('评价内容长度只能在0~500字之间',1,3);
                    return;
                }
               /* QN.top.invoke({
                    "cmd": "taobao.traderate.add",
                    "param":{
                        tid:gtid,
                        oid:oid,
                        result:mychecked,
                        role:'seller',
                        content:text,
                        anony:false
                    },
                    "method": "get",
                    "success" : function(rsp) {
                        if(typeof rsp === 'string'){

                            var    rsp = JSON.parse(rsp);
                        }else{
                            var	rsp= rsp;
                        }
                        var rsperror=rsp.msg;
                        if(rsperror==undefined){

                        }else{
                            $("#errodata").html(JSON.stringify(rsp));
                            $("#erroinfo-table").modal('show');
                        }

                    },
                    error: function(msp){

                        if(typeof msp === 'string'){

                            var    msp = JSON.parse(msp);
                        }else{
                            var	msp= msp;
                        }
                         alert(JSON.stringify(msp));
                         alert(msp.code);
                        if(msp.sub_code=='subuser.has-no-permission'){
                            $("#errodata").html('<p>该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                            $("#erroinfo-table").modal('show');
                        }else{
                            $("#errodata").html('<p>'+JSON.stringify(msp),1,3);
                            $("#erroinfo-table").modal('show');
                        }

                    }
                });*/

                QN.top.invoke({
		           	 "cmd": "taobao.traderate.add",
			         "param": {'tid':gtid,'oid':oid,'result':mychecked,'role':"seller",'content':text,'anony':false},
		       		 "method": "get",
		           	 "success": function(resp){
			           		if(typeof resp === 'string'){
			                    var    rsp = JSON.parse(resp);
			                    }else{
			                    var	rsp= resp;
			                    }
		                    	if(rsp.traderate_add_response.trade_rate.tid) oknum++; else failnum++;
		                    	if(num-oknum==failnum){
		                    		  layer.msg('成功：'+oknum+'个，失败：'+failnum+'个！'+sub_msge,1,1);
		                              $('#dpj_list').empty();
		                              $('#sussce_list').empty();
				  	                  getordersta(gsta,gpageno);
			  		                  }
			           			 },
         			 "error" : function (msg){
							if(typeof msg === 'string'){
			                    var msg = JSON.parse(msg);
			                  }
							sub_msge=msg.sub_msg;
							failnum++;
							if(num-oknum==failnum){
									if(msg.sub_code=='subuser.has-no-permission'){
										/*  layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
			                              */
				      	           }else{
					      	        	 layer.msg('成功：'+oknum+'个，失败：'+failnum+'个！'+sub_msge,1,3);
			                             
				      	           }
				      	           	$('#dpj_list').empty();
		                              $('#sussce_list').empty();
									getordersta(gsta,gpageno);
				                  }
		    					}
				           	 });
                /* tql=tql+'{insert into traderate (tid,oid,result,role,content,anony) values ('+gtid+','+oid+','+mychecked+',seller,'+text+',false)}';*/
            }
            if(liststatus=='detail'){
            	getdetail(gtid);
            }
/*
            if(pjtextmax){
                $("#errodata").html("评价内容不能超过500字！");
                $("#erroinfo-table").modal('show');
            }else if(pjtqlcom){
                $("#errodata").html("评价内容不能为空！");
                $("#erroinfo-table").modal('show');
            }else{
            QN.top.invoke({
                "cmd":"tql",
                "param":{"ql":tql},
                "method":"post",
                "success":function (rsp){

                    if(typeof rsp === 'string'){

                        var    rsp = JSON.parse(rsp);
                    }else{
                        var	rsp= rsp;
                    }
                    if(rsp[0].error_response){
                        if(rsp[0].error_response.sub_code=='subuser.has-no-permission'){
                            $("#errodata").html('<p>该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                            $("#erroinfo-table").modal('show');
                        }else{
                            if(rsp[0].error_response.sub_msg){
                                $("#errodata").html('000'+rsp[0].error_response.sub_msg);
                                $("#erroinfo-table").modal('show');
                            }else{
                                $("#errodata").html("62操作失败，请重试！");
                                $("#erroinfo-table").modal('show');
                            }
                        }
                    }else{
                        Alert("评价成功");
                        getordersta(gsta,gpageno);

                    }


                },
                error: function(msp){
                    if(typeof msp === 'string'){
                        var    msp = JSON.parse(msp);
                    }else{
                        var	msp= msp;
                    }
                    if(msp.sub_code=='subuser.has-no-permission'){
                        $("#errodata").html('<p>该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                        $("#erroinfo-table").modal('show');
                    }else{
                        if(msp.sub_msg){
                            $("#errodata").html('----33'+msp.sub_msg);
                            $("#erroinfo-table").modal('show');
                        }else{
                            $("#errodata").html("63操作失败，请重试！");
                            $("#erroinfo-table").modal('show');
                        }
                    }

                }
            });
        }*/
        }

        /*添加评价快捷短语*/
    function Pconchoice(valac){
            var selec= $("#conpj"+valac).find('option:selected').val();
            $("#trate"+valac).val(selec);        
            }
    function memochoice(){
        /*var selec= $("#memone").find('option:selected').val();*/
        var selec= $("#memone").siblings('a').children('input').val();
        $("#beiwtext").val(selec);
         }
    function mmchoice(){
       /* var selec= $("#memomore").find('option:selected').val();*/
    	var selec= $("#memomore").siblings('a').children('input').val();
        $("#plbeiwtext").val(selec);
    	}
</script>
<!--
	作者：306800838@qq.com
	时间：2014-05-15
	描述：未改造的页面，批量功能
-->
<script>
function sendmore(plan){
    if('send'==plan){/*批量发货*/
	        $('#plsend').empty();
	        var plarr = new Array();
	        var plarrs = new Array();
	        var sendff=false;
	        if(0==$("."+gsta+"check:checked").length){
		        layer.msg('亲，您没有选择订单哦！',1,3);
		        return;
	        }else{
	       			$("."+gsta+"check:checked").each(function(){
	         		var  pltid=$(this).val();
	                if($.inArray(pltid,gplsendarr)>=0){
	                    var addrval=$('#addrinfo'+gsta+pltid).val();
	                    addrval=addrval.replace(/undefined/g,'');
	                    addrval=addrval.replace(/，，/g,',');
	                    var nickval=$('#nickinfo'+gsta+pltid).val();
	                    var addrs='';
                        plarrs.push(pltid);
                        $("#tabletd"+gsta+pltid).hide();
                        var htmlsends= '<table class="sui-table table-bordered" id="adrr'+pltid+'"><tr><td colspan="2"><p>收货信息d：'+addrval+'</p><p>买家昵称：<a onclick="wangwang("'+nickval+'");"  href="javascript:void(0);"><img border="0" src="http://amos.alicdn.com/realonline.aw?v=2&uid='+nickval+'&site=cntaobao&s=2&charset=utf-8" />'+nickval+'</a></p><p style="margin: 0; padding: 0;" class="plydid"><b>运单号：</b><input type="text" class="span6" id="plyd'+pltid+'" value="" /></p></td></tr><tr><td colspan="2">订单编号：'+pltid+'</td></tr>'+$('#'+gsta+pltid).html()+'</table>';
                        $("#tabletd"+gsta+pltid).show();
                        $('#plsend').append(htmlsends);
                        $('#plsend .delsend').removeAttr('onclick');
                        $('#plsend .delsend').removeAttr('href');
                        $('#plsend .delsend').removeAttr('title');
                        $('#plsend .delsends').remove();
	                }else{
	                    sendff=true;
	                }
	           });
            	$('#plsendplan').change(pla_offline);
    			$('#ploncomptyid').change(plc_offline);
	           try{
			        if(sendff){
			        	 layer.msg('请选择“买家已付款”状态,需要卖家发货的交易！',1,3);
			        }else{
			            var plcmd= 'plsendmore('+JSON.stringify(plarrs)+');';
			            $("#plsendbut").attr('onclick',plcmd);
			            plcomone(null);
			            $("#plsend-table").modal('show');
			        }
	           }catch(e){
		        	window.localStorage.removeItem("compty"+user_nick);
		            var plcmd= 'plsendmore('+JSON.stringify(plarrs)+');';
		            $("#plsendbut").attr('onclick',plcmd);
		            plcomone(null);
		            $("#plsend-table").modal('show');
	           }
	       }
        }else if('memo'==plan){/*批量备注*/
	        $('#plmemo').empty();
	        getmymemo();
	        $("#plbeiwtext").val('');/*masterchen*/
	        $(':radio[name="plbeiwf"]').attr("checked",false);
	        var plarr = new Array();
	        if($("."+gsta+"check:checked").length>0){
		        $("."+gsta+"check:checked").each(function(){
		            var  pltid=$(this).val();
		            plarr.push(pltid);
		            $("#tabletd"+gsta+pltid).hide();
		            var dd='<tr><td colspan="2">订单编号：'+pltid+'</td></tr>'+$('#'+gsta+pltid).html();
		            $("#tabletd"+gsta+pltid).show();
		            $('#plmemo').append(dd);
		            $('#plmemo .delsend').removeAttr('onclick');
                    $('#plmemo .delsend').removeAttr('href');
                    $('#plmemo .delsend').removeAttr('title');
                    $('#plmemo .delsends').remove();
		        });
		        var plcmd= 'memomore(0,'+plarr.length+','+JSON.stringify(plarr)+');';
		        $("#plmemobut").attr('onclick',plcmd);
		        $('#plmemo-table').modal('show');
	        }else{
		        layer.msg('亲，您没有选择订单哦！',1,3);
		        return;
	        }
	     }else if('post'==plan){/*批量免邮*/
	        var plarr = new Array();
	        var succ=0;
	        var fase=0;
	        $("."+gsta+"check:checked").each(function(){
	            var   pltid=$(this).val();
	            if($.inArray(pltid,gplpostarr)>=0){
	                plarr.push(pltid);
	                ++succ;
	            }else{
	                ++fase;
	            }
	        });
	        var plcmd= 'postmore(0,'+plarr.length+','+JSON.stringify(plarr)+');';
	        $("#plpostbut").attr('onclick',plcmd);
	        if(0==plarr.length){
	            layer.msg('没有可以进行免邮操作的订单',1,3);
	            return;
	        }else{
	            if(0==fase){
	                $("#plpostmsg").html('<p>您一共选择了'+succ+'笔交易进行免邮操作</p>');
	                $("#plpostbut").text('确定');
	            }else{
	                $("#plpostmsg").html('<p>有'+fase+'笔交易不能进行免邮操作</p><p>选择“继续”对其他'+succ+'笔交易进行免邮操作</p>');
	                $("#plpostbut").text('继续');
	            }
	            $("#plpostbut").show();
	            $('#plpost-table').modal('show');
	        }
    }else if('task'==plan){
    	var jsontasklist=[];
        if(0==$("."+gsta+"check:checked").length){
        	layer.msg('亲，您没有选择订单哦！',1,3);
            return;
        }
        $("."+gsta+"check:checked").each(function(){
            var   pltid=$(this).val();
            for(var i=0;i<iscreate.length;i++){
                if(iscreate[i].tid==pltid){
                    var tasks={};
                    tasks.biz_id=iscreate[i].tid;
                    tasks.nick=iscreate[i].buyer_nick;
                    jsontasklist[jsontasklist.length]=tasks;
                    break;
                }
            }
        });
        if(jsontasklist.length>0){
            QN.component.invoke({
                category:'qtask_create',
                param:{
                    biz_type:'trade',
                    items:jsontasklist
                },
                error : function(msg, cmd, param) {

                },
                success : function(rsp, cmd, param) {
                	layer.msg('添加任务成功！',1,1);
                    sselect();
                }
            });
        }else{
        	layer.msg('亲，没有查询到可添加任务的订单哦！订单上有未处理完成的任务时不能添加任务，只有任务处理完成之后才能添加新的任务。',1,3);
        }
    }
}
function plcomone(changeoff){
	var comptydata = window.localStorage.getItem("compty"+user_nick);
	if(comptydata==null||comptydata=="null"|| typeof(comptydata)=="undefined"||comptydata.length<4)
	{
		$.ajax({
     		url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getsend',
     		type: 'POST',
     		dataType:'html',
     		data:{nick:user_nick},
     		timeout:10000,
			error: function(){
				plcomones(comptydata,changeoff);
			},
			success: function(data){
				if(data.length>3)
                 {
                     window.localStorage.setItem("compty"+user_nick,data);
                     
                 }
				plcomones(comptydata,changeoff);
			}
		});
	}else{
		plcomones(comptydata,changeoff);
	}

}
function plcomones(data,changeoff){
	$('.plydid').show();
	$("#plwuliush1").show();
	$("#ploff_other").empty();
	if(data==null|| typeof(data)=="undefined"||data==''||data.length<4){
	}else{
    	data=JSON.parse(data);
	}
	var name='';
    var code='';
	var datas={};
    datas.lastmode=new Array();
	datas.lastmode[0]='offline';
	datas.lastmode[1]='';
    datas.onname='';
    datas.oncode='';
    datas.offname='';
    datas.offcode='';
    for(index in data){
        order=data[index];
        /*在线下单，卖家是否在数据库中存储了默认快递公司*/
        	if(order.mode=='online'){
        		if(order.last_way!=null){
        			datas.lastmode=order.last_way.split(",");
        			if(datas.lastmode[1]==null){
        				datas.lastmode[1]='';
        			}
        		}
        		if(order.name!=null){
        			datas.onname=order.name.split(",");/*快递公司名字*/
        			datas.oncode=order.code.split(",");/*快递公司编码*/
        		}
        	}else if(order.mode=='offline'){
        		if(order.name!=null){
        			datas.offname=order.name.split(",");/*快递公司名字*/
        			datas.offcode=order.code.split(",");/*快递公司编码*/
        		}
        	}
    }
    if(changeoff!=null){
		if(changeoff=='offline'){
	    	datas.mode='offline';
	    	if(datas.offname!=''&&datas.offname!=null){
	    	    name=datas.offname;
	    	}else{
	    	    name='';
	    	}
	    	if(datas.offcode!=''&&datas.offcode!=null){
	    	    code=datas.offcode;
	    	}else{
	    	    code='';
	    	}
	    	/*$("#plsendplan option[value='offline']").attr("selected","selected");*/
	    	$("#plsendplan li").attr('class',' ');
	        $("#plsendplan").siblings('a').children('input').val('offine');
	        $("#plsendplan").siblings('a').children('span').html($("#plsendplan li a[value='offline']").html());
	        $("#plsendplan li a[value='offline']").parent('li').attr('class','active');	    	
	    }else if(changeoff=='online'){
            datas.mode='online';
            if(datas.onname!=''&&datas.onname!=null){
                name=datas.onname;
            }else{
            	name='';
            }
            if(datas.oncode!=''&&datas.oncode!=null){
                code=datas.oncode;
            }else{
            	code='';
            }
	    	/*$("#plsendplan option[value='online']").attr("selected","selected");*/
        	$("#plsendplan li").attr('class',' ');
	        $("#plsendplan").siblings('a').children('input').val('online');
	        $("#plsendplan").siblings('a').children('span').html($("#plsendplan li a[value='online']").html());
	        $("#plsendplan li a[value='online']").parent('li').attr('class','active');	  
	    }else if(changeoff=='notsend'){
	    	$('.plydid').hide();
			name='no';
			name='no';
			/*$("#plsendplan option[value='notsend']").attr("selected","selected");*/
			$("#plsendplan li").attr('class',' ');
	        $("#plsendplan").siblings('a').children('input').val('notsend');
	        $("#plsendplan").siblings('a').children('span').html($("#plsendplan li a[value='notsend']").html());
	        $("#plsendplan li a[value='notsend']").parent('li').attr('class','active');	  
	    }
	}else{
		lastmodes=datas.lastmode[0];
    	lasttrade=datas.lastmode[1];
        if(datas.lastmode[0]=='offline'){
            datas.mode='offline';
            if(datas.offname!=''&&datas.offname!=null){
                name=datas.offname;
            }else{
            	name='';
            }
            if(datas.offcode!=''&&datas.offcode!=null){
                code=datas.offcode;
            }else{
            	code='';
            }
	    	/*$("#plsendplan option[value='offline']").attr("selected","selected");*/
            $("#plsendplan li").attr('class',' ');
	        $("#plsendplan").siblings('a').children('input').val('offline');
	        $("#plsendplan").siblings('a').children('span').html($("#plsendplan li a[value='offline']").html());
	        $("#plsendplan li a[value='offline']").parent('li').attr('class','active');	  
		}else if(datas.lastmode[0]=='online'){
            datas.mode='online';
            if(datas.onname!=''&&datas.onname!=null){
                name=datas.onname;
            }else{
            	name='';
            }
            if(datas.oncode!=''&&datas.oncode!=null){
                code=datas.oncode;
            }else{
            	code='';
            }
			/*$("#plsendplan option[value='online']").attr("selected","selected");*/
            $("#plsendplan li").attr('class',' ');
	        $("#plsendplan").siblings('a').children('input').val('online');
	        $("#plsendplan").siblings('a').children('span').html($("#plsendplan li a[value='online']").html());
	        $("#plsendplan li a[value='online']").parent('li').attr('class','active');	  
		}else if(datas.lastmode[0]=='notsend'){
			name='no';
			name='no';
			/*$("#plsendplan option[value='notsend']").attr("selected","selected");*/
				 $("#plsendplan li").attr('class',' ');
		        $("#plsendplan").siblings('a').children('input').val('notsend');
		        $("#plsendplan").siblings('a').children('span').html($("#plsendplan li a[value='notsend']").html());
		        $("#plsendplan li a[value='notsend']").parent('li').attr('class','active');	  
		}else{
            datas.mode='offline';
            if(datas.offname!=''&&datas.offname!=null){
                name=datas.offname;
            }else{
            	name='';
            }
            if(datas.offcode!=''&&datas.offcode!=null){
                code=datas.offcode;
            }else{
            	code='';
            }
	    	/*$("#plsendplan option[value='offline']").attr("selected","selected");*/
            $("#plsendplan li").attr('class',' ');
	        $("#plsendplan").siblings('a').children('input').val('offline');
	        $("#plsendplan").siblings('a').children('span').html($("#plsendplan li a[value='offline']").html());
	        $("#plsendplan li a[value='offline']").parent('li').attr('class','active');	  
		}
	}
	if(name!=''&&name!='no'){
		$("#ploncomptyid").empty();
		for(index in name){
			datas.name=name[index];
			datas.code=code[index];
			if(datas.lastmode[1]!=''&&datas.lastmode[1]!=null){
				if(datas.code==datas.lastmode[1]){
					$("#ploncomptyid").append('<option value="'+datas.code+'" selected=selected>'+datas.name+'</option>');
                }else{
					$("#ploncomptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');
				}
			}else{
                  	$("#ploncomptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');
            }
        }
		if(datas.mode=='offline'){
			$("#ploncomptyid").append("<option  value='others'>其它物流公司</option>");
			
		}
		if(datas.lastmode[1]=='other'){
			$("#ploncomptyid option[value='other']").attr("selected","selected");		
		}
		plc_offline();
	}else if(name=='no'){/*上一次选择了无需物流*/
	        $("#plwuliush1").hide();
			$("#ploff_other").append("<p><input type='text' name='plothercompany' id='plothercompany' placeholder='请输入物流公司'></input></p>");
			
	}else{/*默认快递公司为空,则通过条用淘宝接口列出所有快递公司供选择*/
		QN.top.invoke({
			"cmd": "taobao.logistics.companies.get",
			"param": {fields:'code,name',is_recommended:true,order_mode:datas.mode},
			"method": "get",
			"success": function (rsp){
				if(typeof  rsp=== 'string'){
					rsp = JSON.parse(rsp);
				}
				try{
					$('#ploncomptyid').empty();
					for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
						var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
						var datas={};
						datas.name=order.name;
              	    	datas.code=order.code;
   		                if(lasttrade!=''&&lasttrade!=null){
   		                    if(datas.code==lasttrade){
   		                       	$("#ploncomptyid").append('<option value="'+datas.code+'" selected=selected>'+datas.name+'</option>');
   		                    }else{
   	   		                    $("#ploncomptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');
      		                }
   		                }else{
   		                    $("#ploncomptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');
   		                }
          	    	}
          	    	/*if($("#plsendplan").find("option:selected").val()=='offline'){*/
          	    	if($("#plsendplan").siblings('a').children('input').val()=='offline'){
              		    $("#ploncomptyid").append("<option  value='other'>其它</option>");
                    }
                    plc_offline();

				}catch(e){
					layer.msg(e,1,3);
					
				}
        	}
		});
	}
}
/**
 * 物流方式更改后事件
 */
function pla_offline(){
	/*var sel=$('#plsendplan').find("option:selected").val();*/
	var sel=$('#plsendplan').siblings('a').children('input').val();
	plcomone(sel);
	if(sel=='notsend'||sel=='online'){
		$("#ploff_other").empty();
	}else{
		plc_offline();
	}
}
/**
 * 物流公司更改后事件
 */
function plc_offline()
{
	$("#ploff_other").empty();
	var sel = $("#ploncomptyid").find("option:selected").val();
	if(sel=='other'||sel=='OTHER')
	{
		$("#ploff_other").append("<p><input type='text' name='plothercompany' id='plothercompany' placeholder='请输入物流公司'></input></p>");
	}else if(sel=='others'){
		pld_offline();
	}
}
/**
 * 物流公司更改后事件:选中其他物流公司
 */
function pld_offline(){
	QN.top.invoke({
		"cmd": "taobao.logistics.companies.get",
		"param": {fields:'code,name',is_recommended:true,order_mode:'offline'},
		"method": "get",
		"success": function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }
            if(rsp.code!=null){
                if(rsp.sub_msg){
                	layer.msg('在线：'+rsp.sub_msg,1,3);
  	                
                }else{
                	geterrorinfo("taobao.logistics.companies.get",rsp);
                }
            }else{
	    			$('#ploncomptyid').empty();
	    			 for(index in rsp.logistics_companies_get_response.logistics_companies.logistics_company){
    	    			 var order=rsp.logistics_companies_get_response.logistics_companies.logistics_company[index];
						var datas={};
    	    			 datas.name=order.name;
    	    			 datas.code=order.code;
                        if(lasttrade!=''&&lasttrade!=null){
                       		if(datas.code==lasttrade){
                       			$("#ploncomptyid").append('<option value="'+datas.code+'" selected=selected>'+datas.name+'</option>');
                        	}else{
                              	$("#ploncomptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');
                            }
                        }else{
                        	$("#ploncomptyid").append('<option value="'+datas.code+'">'+datas.name+'</option>');
                        }
	    			 }
	    				 $("#ploncomptyid").append("<option  value='POST'>中国邮政平邮</option>");
	    		    	 /*if($("#plsendplan").find("option:selected").val()=='offline'){*/
	    		    	 if($("#plsendplan").siblings('a').children('input').val()=='offline'){
	    		    	 	if(lasttrade=='other'){
	    		    	 		$("#ploncomptyid").append("<option  value='other' selected=selected>其它</option>");
	    		    	 		c_offline();
	    		    	 	}else{
	    		    		 	$("#ploncomptyid").append("<option  value='other'>其它</option>");
	    		    		 }
    		    		 }
            }
	    		},
        error: function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var	msp= msp;
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            /* 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
	                 */
            }else{
                if(msp.sub_msg){
                	layer.msg('在线错误：'+msp.sub_msg,1,3);
  	                
                }else{
                	geterrorinfo("taobao.logistics.companies.get",msp);
                }
            }
        }
	});
}
/**
 * 批量发货
 * @author Duanhq
 */
var plsendnum=null; 
var plerror = new Array();
function plsendmore(params)
{

	tradePoint(user_nick,'首页批量发货确定');
	closeMsg('');
    if(vipuser==0){
      	$('#buyvip').modal('show');
      	return;
    }
 /*   var plmode=$("#plsendplan").find("option:selected").val();*/
    var plmode=$("#plsendplan").siblings('a').children('input').val();
    var plcycode=$("#ploncomptyid").find("option:selected").val();
    if(plcycode=='OTHER'){
    	plcycode='other';
    }
    var urlcode=plcycode;
	if(plcycode=='other'){
		plcycode=$('#plothercompany').val();
	}
    var tid='';
    if(plmode!='notsend'){
		for(index in params){
			tid=params[index];
			var ploutid= $("#plyd"+tid).val();
			ploutid=clearBr(ploutid);
			if(ploutid==''){
				layer.msg('您有运单号没有填写！',1,3);
		        $("input[msgstu='again']").attr("onclick","closeMsg('plsend-table');");
		        return;
			}
		}
    }
    plsendnum=0;
    plerror=[];
    $("#hints").html('<p><img src="http://cdn.zzgdapp.com/trade/mobile/images/loding.gif" align="absmiddle" />发货中，请耐心等待...</p>');
    $("#hint").modal('show');
	for(index in params){
		tid=params[index];
		var ploutid= $("#plyd"+tid).val();
 		var paramx={
                tid:tid+'',
                out_sid:ploutid,
                company_code:plcycode,
           };
 	    if('online'==plmode){
 	        QN.top.invoke({
 	            "cmd": "taobao.logistics.online.send",
 	            "param":paramx,
 	            "method": "get",
 	            "success" : function(rsp) {
	 	            plsendnum++;

 	            },
 	            error: function(msp){
 	            	 plsendnum++;
 	                if(typeof msp === 'string'){
 	                    var msp = JSON.parse(msp);
 	                }else{
 	                    var	msp= msp;
 	                }
 	                if(msp.sub_code=='subuser.has-no-permission'){
 	                	/* plerror.push("该子帐号无此操作权限，请通过主帐号设置开通相应权限！"); */
 	                }else if(msp.sub_code=='isv.logistics-online-service-error:B02'){
	 	             	plerror.push("您的帐号没有发货的权限!！");
 	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B04'){
		 	  	  	    plerror.push("订单状态不对。您已使用“在线下单”方式对此订单进行发货操作，请前往卖家中心核实：)");
 	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B101'){
 	          			plerror.push("您还没设置默认的退发货地址");
 	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B79'){
 	          			plerror.push("该物流公司揽收或派送范围不支持");
 	          		}else if(msp.sub_code=='isv.logistics-online-service-error:B55'){
 	          			plerror.push("该交易状态不正确，不能发货");
 	          		}else if(msp.msg=='Invalid arguments:sender_id'){
 	          			plerror.push("发货地址异常，请检查您的发货地址！");
 	                }else{
 	                    if(msp.sub_msg){
 	                    	plerror.push(msp.sub_msg);
 	                    }else{
 	                    	plerror.push("未知的发货错误："+JSON.stringify(msp));
 	                    }
 	                }

 	            }
 	        });
 	    }else if('offline'==plmode){
 	        QN.top.invoke({
 	            "cmd": "taobao.logistics.offline.send",
 	            "param":paramx,
 	            "method": "get",
 	            "success" : function(rsp) {
 	            	plsendnum++;
 	            },
 	            error: function(msp){
 	            	 plsendnum++;
 	                if(typeof msp === 'string'){
 	                    var msp = JSON.parse(msp);
 	                }else{
 	                    var	msp= msp;
 	                }
 	                if(msp.sub_code=='subuser.has-no-permission'){
	 	  	            /*  plerror.push("该子帐号无此操作权限，请通过主帐号设置开通相应权限！"); */
 	                }else if(msp.sub_code=='isv.logistics-offline-service-error:B02'){
	 	  				plerror.push("您的帐号没有发货的权限!");
 	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B04'){
	 	      			plerror.push("订单状态不对。您已使用“在线下单”方式对此订单进行发货操作，请前往卖家中心核实：)");
 	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B101'){
 	      				plerror.push("您还没设置默认的退发货地址");
 	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B57'){
 	      				plerror.push("该物流公司不支持自己联系");
 	      			}else if(msp.sub_code=='isv.logistics-offline-service-error:B55'){
 	      				plerror.push("该交易状态不正确，不能发货");
 	      			}else{
 	                    if(msp.sub_msg){
 	                    	plerror.push(msp.sub_msg);
 	                    }else{
 	                    	plerror.push("未知的发货错误："+JSON.stringify(msp));
 	                    }
 	      				
 	                }
 	            }
 	        });
 	    }else if('notsend'==plmode){
 	        QN.top.invoke({
 	            "cmd": "taobao.logistics.dummy.send",
 	            "param":{
 	                tid:tid
 	            },
 	            "method": "get",
 	            "success" : function(rsp) {
 	            	plsendnum++;
 	            },
 	            error: function(msp){
 	            	 plsendnum++;
 	                if(typeof msp === 'string'){
 	                    var msp = JSON.parse(msp);
 	                }else{
 	                    var	msp= msp;
 	                }
	                    if(msp.sub_msg){
	                    	plerror.push(msp.sub_msg);
	                    }else{
	                    	plerror.push("未知的发货错误："+JSON.stringify(msp));
	                    }
 	            }
 	        });
 	    }
	}
	plsendsure(plmode,urlcode,params.length);
	
   
    /*if('online'==plmode){
        var ql='';
        for(var index in params){
        tids =[];
        tids=params[index].split(",");
        var ploutid= $("#plyd"+tids[0]).val();
            ploutid=clearBr(ploutid);
            if(ploutid==''){
                qlfalsh=false;
            }
        ql +='{update taobao.logistics.online.send set out_sid='+ploutid+',company_code='+plcycode+'  where tid='+tids[1]+'}';
        }
    }else if('offline'==plmode){
        var ql='';
        for(var index in params){
        tids =[];
        tids=params[index].split(",");
        var ploutid= $("#plyd"+tids[0]).val();
            ploutid=clearBr(ploutid);
            if(ploutid==''){
                qlfalsh=false;
            }
            ql +='{update taobao.logistics.offline.send set out_sid='+ploutid+',company_code='+plcycode+'  where tid='+tids[1]+'}';
        }
    }else if('notsend'==plmode){
        var ql='';
        for(var index in params){
        tids =[];
        tids=params[index].split(",");
        ql +='{update taobao.logistics.dummy.send where tid='+tids[1]+'}';
        }
    }else{

    }*/
/*	if(liststatus=='detail'){
    	getdetail(gtid);
    }*/
}
/**
 * 批量发货
 * @author Duanhq
 * 批量发货提交后同步查询结果
 */
function plsendsure(plmode,urlcode,len){
	$("#hint").modal('hide');
	setTimeout(function(){
		if(plsendnum<len){
			plsendsure(plmode,urlcode);
		}else{
			var suc=0;
			if(plerror.length==0){
				suc=plsendnum;
			}else{
				suc=plsendnum-plerror.length;
			}
			 	layer.msg('发货完成！一共'+len+'笔交易,其中成功'+suc+'笔订单，失败'+plerror.length+'笔订单',1,1);
			 	if(plerror.length>0){
			 		$("#hints").empty();
				 	for(index in plerror){
				 		$("#hints").append('<p>失败原因('+index+')：'+plerror[index]+'</p>');
				 	}
				 	$("#hint").modal('show');
			 	}
				$('#dfh_list').empty();
				$('#yfh_list').empty();
				$('#all_list').empty();
				getordersta('dfh',gpageno);
				if(lastmodes==plmode&&lasttrade==urlcode){
				}else{
			           		$.ajax({
			             		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tosend',
			             		    type: 'POST',
			             		    dataType:'html',
			             		    data:{nick:user_nick,mode:plmode,offtrade:urlcode},
			             		    timeout:10000,
			     		        	success: function(data, textStatus){
			     		        		var datas = window.localStorage.getItem("compty"+user_nick);
			                		        if(datas.length>3){
			                		        	datas=JSON.parse(datas);
			                		        	for(index in datas){
			                    		        	if(datas[index].mode=='online'){
			                    		        		datas[index].last_way=clearBr(data);
			                    		        		break;
			                    		        	}
			                		        	}
			                		        	datas=JSON.stringify(datas);
			               		        	 window.localStorage.setItem("compty"+user_nick,datas);
			                		        }
			     	        	},
			     	 	       error: function(){

			     	        	}
				      	    });
				}
		}
	},2000);
   
}

/*批量备注*/
	function memomore(index, length, params){
    	tradePoint(user_nick,'批量备注');
            if(vipuser==0){
              	$('#buyvip').modal('show');
              	return;
            }
        	/*if(EV_MsgBox_ID!='')closeMsg('');*/
            var data=$("#plbeiwtext").val();
           /* if(data==''||data==null||data=='null'){
            	layer.msg('备注不能为空！',1,3);
            	return;
            }*/
            if(data.length>500){
            	layer.msg('备注不能超过500字！',1,3);
            	return;
            }
            var seltitle=$(':radio[name="plbeiwf"]:checked').val();
            if(undefined==seltitle){
                seltitle=0;
            }
            if(index<length){
	            QN.top.invoke({
	                "cmd": "taobao.trade.memo.update",
	                "param":{
	                    tid:params[index],
	                    memo:data,
	                    flag:seltitle
	                },
	                "method": "get",
	                "success" : function(rsp) {
	                    if(typeof rsp === 'string'){
	                        var rsp = JSON.parse(rsp);
	                    }else{
	                        var	rsp= rsp;
	                    }
	                    var rsperror=rsp.msg;
	                    if(rsperror==undefined){
	                        memomore(++index, length, params);
	                    }else{
	                        geterrorinfo("taobao.trade.fullinfo.get",rsp);
	                    }
	                },
	                error: function(msp){
	                    if(typeof msp === 'string'){
	                        var msp = JSON.parse(msp);
	                    }
	                    if(msp.sub_code=='subuser.has-no-permission'){
	                    	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');*/
	                    }else{
	                        geterrorinfo("taobao.trade.memo.update",msp);
	                    }
	                }
	            });
            }else{
            	layer.msg('批量备注成功！',1,1);
                getordersta(gsta,gpageno);
            }
           /* if(liststatus=='detail'){
            	getdetail(gtid);
            }*/
        }
      function postmore(index, length, params){
    	  if(EV_MsgBox_ID!='')closeMsg('');
           if(index<length){
           QN.top.invoke({
                "cmd": "taobao.trade.postage.update",
                "param":{
                    tid:Number(params[index]),
                    post_fee:0
                },
                "method": "get",
                "success" : function(rsp) {
                    if(typeof rsp === 'string'){
                        var rsp = JSON.parse(rsp);
                    }else{
                        var	rsp= rsp;
                    }
                    var rsperror=rsp.msg;
                    if(rsperror==undefined){
                        postmore(++index, length, params);

                    }else{
                       /*  if(rsp.sub_msg){
                        	layer.msg('postmore:'+rsp.sub_msg,1,3);
                            
                        }else{
                        	geterrorinfo("taobao.trade.postage.update",rsp);
                        } */
                        geterrorinfo("taobao.trade.postage.update",rsp);
                    }
                },
               error: function(msp){
                   if(typeof msp === 'string'){
                       var msp = JSON.parse(msp);
                   }else{
                       var msp= msp;
                   }
                   if(msp.sub_code=='subuser.has-no-permission'){
                	  /*  layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
                        */
                   }else{
                       /* if(msp.sub_msg){
                    	   layer.msg('postmore_error:'+msp.sub_msg,1,3);
                           
                       }else{
                    	   geterrorinfo("taobao.trade.postage.update",msp);
                       } */
                       geterrorinfo("taobao.trade.postage.update",msp);
                   }
               }
            });
           }else{
        	   layer.msg('批量免邮成功！',1,1);
               
               getordersta(gsta,gpageno);
           }
           if(liststatus=='detail'){
              	getdetail(gtid);
              }
        }
</script>
<!--详情操作 -->
<script>
var gscrlltop=0;
var liststatus='';
function todetails(rtid,sta){
	gtid=rtid;
	liststatus='detail';
	if(sta=='task'){
		$("#detail_back").attr('href',"#all");
		$("#detail_back").attr('onclick','gobackindex("LOL")');
		$(".tab-content #detail ").attr('class','tab-pane active');
		$("#chapfysall").hide();
		$("#all_list").empty()
		/*setTimeout(showlist,200);*/
	}else{
		$("#detail_back").attr('onclick','gobackindex()');
		gscrlltop=document.getElementsByClassName('container')[0].scrollTop;
		document.getElementsByClassName('container')[0].scrollTop=0;
		$("#detail_back").attr('href',"#"+sta);
		$("#chapfys"+sta).hide();
	}
	$("#index_content").hide();
	$("#GoblanBack").hide();
	getdetail(rtid);
}
function gobackindex(dota){
	liststatus='sdlfkjdslkfj';
	$("#index_content").show();
	$("#chapfys"+gsta).show();
	$("#GoblanBack").show();
	if(InterValObj!=''||InterValObj!=null||InterValObj!='null'){/*如果有倒计时操作。停掉倒计时*/
		window.clearInterval(InterValObj);
	}
	typeinfo='';
	SysSecond='';
	InterValObj='';
	if(dota=='LOL'){
		$("#all_list").html('<div class="sui-loading loading-small " style="overflow: hidden;"><i class="sui-icon icon-pc-loading"></i></div>');
		setTimeout(showlist,200);
	}else{
		setTimeout(function(){
			document.getElementsByClassName('container')[0].scrollTop=gscrlltop;
			gscrlltop=0;
		},100);
	}
}
function settaskcl(){
    QN.application.invoke({
        "cmd": "getVersion",
        "error" : function(msg) {
        },
        "success" : function(e) {
            if(typeof  e=== 'string'){
                e = JSON.parse(e);
            }
            var version=e.version.replace(/[.]/g,"");
            version=version.replace(/[N]/g,"");
            if(version>=11200){
                QN.application.invoke({
                    "cmd": "getLoginuser",
                    "success": function (e){
                        if(typeof  e=== 'string'){
                            e = JSON.parse(e);
                        }
                        if(e.sub_user_id==""){
                            uid=e.user_id;
                        }else{
                            uid=e.sub_user_id;
                        }
                        var param={};
                        param.fields="id,receiver_nick,status,biz_id,biz_nick,status,";
                        param.current_page=1;
                        param.biz_type="trade";
                        param.page_size=100;
                        param.receiver_uid=uid;
                        param.status="0,1,3,4,5";
                        param.biz_ids=gtid;
                        QN.top.invoke({
                            "cmd": "taobao.qianniu.tasks.get",
                            "param": param,
                            "method": "get",
                            "success": function (e){
                                if(typeof  e=== 'string'){
                                    e = JSON.parse(e);
                                }
                                var resp=e.qianniu_tasks_get_response.tasks;
                                resp=resp.q_task;
                                if(resp){
                                	$("#tdbtn").append('<button onclick="cltask('+resp[0].id+')" id="clrw" style="margin-left:10px;" class="sui-btn btn-warning">处理任务</button>');
                                }
                            }
                        });
                    }
                });
            }
        }
    });
}
function cltask(id){
    QN.component.invoke({
        category:'qtask_deal',
        param:{
            task_ids:[id]
        },
        error : function(msg, cmd, param) {
        },
        success : function(rsp, cmd, param) {
        	/*layer.msg('任务处理成功！</p>');
          	showMsg('hint');*/
          	layer.msg('任务处理成功！',1,1);
            $("#clrw").hide();
            getordersta(gsta,gpageno);
        }
    });
}
var typeinfo='';
var SysSecond='';
var InterValObj='';
function SetRemainTime() { 	 
	if(SysSecond > 0){ 
		SysSecond = SysSecond-1; 
	   	var second = Math.floor(SysSecond % 60);             // 计算秒     
	   	var minite = Math.floor((SysSecond / 60) % 60);      //计算分 
	   	var hour = Math.floor((SysSecond / 3600) % 24);      //计算小时 
	   	var day = Math.floor((SysSecond / 3600) / 24);        //计算天				  	 
		var info='<h6><font color= red >'+day+'天'+hour+'小时'+minite+'分'+second+'秒</font><font color=#000>'+ typeinfo +'</font></h6>';			  
		$("#gettimeinfo").html(info);							
	}else {//剩余时间小于或等于0的时候，就停止间隔函数 
	   	window.clearInterval(InterValObj); 
	   //这里可以添加倒计时时间为0后需要执行的事件 
	} 
}
function getdetail(atid){
	$("#tdbtn").empty();
	settaskcl();
    /*showmyaddr();*/
    $("#tdbtn").prepend("<a style=\"margin-left:10px;\" class=\"sui-btn btn-primary\" data-toggle=\"modal\" data-target=\"#beiw-table\" data-keyboard=\"false\" onclick=\"onclicktid('beiw-table',"+atid+")\">备注</a>");
    QN.top.invoke({
        "cmd": "taobao.trade.fullinfo.get",
        "param":{
            fields:'invoice_name,timeout_action_time,end_time,consign_time,buyer_rate,commission_fee,point_fee,buyer_cod_fee,real_point_fee,buyer_obtain_point_fee,yfx_fee,credit_card_fee,trade_memo,mark_desc,type,cod_status,seller_cod_fee,trade_from,buyer_alipay_no,promotion_details,seller_flag,seller_memo,end_time,seller_rate,status,seller_nick, buyer_nick,buyer_message,alipay_no,created,pay_time,end_time,payment,receiver_name,receiver_state,receiver_city,receiver_district,receiver_address,receiver_zip,receiver_mobile,orders.oid,receiver_phone,consign_time,shipping_type,orders,total_fee,orders,status,post_fee, created, tid, seller_rate,buyer_flag,adjust_fee',
            tid:atid
        },
        "method": "get",
        error: function(msp){
        /*请求出错处理 */
        /* alert(JSON.stringify(msp));*/
        if(typeof msp === 'string'){
            var	msp = JSON.parse(msp);
        }
        if(msp.sub_code=='subuser.has-no-permission'){
        	/*layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
            showMsg('hint');*/
        }else{
            if(msp.sub_msg){
            	layer.msg(msp.sub_msg,1,3);
                
            }else{
            	geterrorinfo('taobao.trade.fullinfo.get',msp);
            }
        }
        },
        "success" : function(rsp) {
            debugger;
            $("#gettimeinfo").empty().show();
            if(taobaotime==""){
            	taobaotime=GetDateStr(0);
            }
	            if(typeof rsp === 'string'){
	                var rsp = JSON.parse(rsp);
	            }
	            if(rsp.code!=null){
	                if(520==rsp.code){
	                	layer.msg('该订单是三个月前的订单，目前暂不提供查看信息！',1,3);
	                }else{
	                    if(rsp.sub_msg){
	                    	layer.msg(rsp.sub_msg,1,3);
	                    }else{
	                    	geterrorinfo('taobao.trade.fullinfo.get',rsp);
	                    }
	                }
	            }else{
	                var trade=rsp.trade_fullinfo_get_response.trade;   						
					if(trade.status=="TRADE_FINISHED" && trade.seller_rate==false){	/*交易成功，并且卖家木有评价勒！买家已收货，等待买家评论*/	
						typeinfo="后系统将自动好评！";
						var lasttime=gettimes(trade.end_time,15);
						SysSecond=datetime_to_unix(lasttime) - datetime_to_unix(taobaotime);	
						if(SysSecond>0){
							$("#gettimeinfo").html('正在奋力加载数据....');
							InterValObj = window.setInterval(SetRemainTime, 1000); /*间隔函数，1秒执行*/
						}else{$("#gettimeinfo").hide();} 													
				}else if(trade.status=="WAIT_BUYER_CONFIRM_GOODS"){/*卖家已发货，等待买家确认收货*/				
					if(trade.timeout_action_time!=undefined){
						typeinfo="后系统将自动确认收货！";
						SysSecond=datetime_to_unix(trade.timeout_action_time) - datetime_to_unix(taobaotime);	
						SysSecond=Math.abs(SysSecond);
						if(SysSecond>0){
							$("#gettimeinfo").html('正在奋力加载数据....');
							InterValObj = window.setInterval(SetRemainTime, 1000); 
						}else{$("#gettimeinfo").hide();} 	
					}else{$("#gettimeinfo").html('<h6><font color="red">拆单发货,不支持查看!</font></h6>');}							
				}else if(trade.status=="WAIT_BUYER_PAY"){		/*等待用户付款*/						
					typeinfo="后系统将自动关闭该订单！";		
					SysSecond=datetime_to_unix(trade.timeout_action_time) - datetime_to_unix(taobaotime);	
					SysSecond=Math.abs(SysSecond);	
					if(SysSecond>0){
						$("#gettimeinfo").html('正在奋力加载数据....');
						InterValObj = window.setInterval(SetRemainTime, 1000); 
					}else{$("#gettimeinfo").hide();} 																		
				}else{
					$("#gettimeinfo").hide();
				}	
	           	   	var gtdsta = trade.status;
	              	 /* gname=trade.receiver_name;
	                gbuyernick=trade.buyer_nick;
	                gsellernick=trade.seller_nick;
	                gtime=trade.created;*/
	            var tsta='';
	            switch(gtdsta){																
		            case 'TRADE_NO_CREATE_PAY':
			            {
			            	tsta='等待买家付款';
			            	$("#tdbtn").prepend("<a style=\"margin-left:10px;\" class=\"sui-btn btn-primary \" data-toggle=\"modal\" data-target=\"#close-table\" data-keyboard=\"false\" href=\"javascript:void(0);\" onclick=\"showclosetrade("+atid+",'')\">关闭订单</a>");
			            	$("#tdbtn").prepend("<button style=\"margin-left:10px;\" class=\"sui-btn btn-primary\" onclick=\"wwfastpay("+atid+",'"+trade.buyer_nick+"','"+trade.receiver_name+"','"+trade.created+"','"+trade.seller_nick+"')\" title=\"点击发送旺旺消息，提醒买家及时付款，您可在设置里添加自定义催付内容哦！\">旺旺催付</button>");
			            	if(sellertype=='C' || sellertype=='c'){
			            		$("#tdbtn").prepend("<button style=\"margin-left:10px;\" class=\"sui-btn btn-primary\" title=\"由于买家没有绑定支付宝，您暂时无法为其修改价格，请提醒买家先绑定支付宝账户。\">修改价格</button>");
			            	}else{
			            		$("#tdbtn").prepend("<button style=\"margin-left:10px;\" class=\"sui-btn btn-primary\" title=\"由于买家没有绑定支付宝，您暂时无法为其修改运费，请提醒买家先绑定支付宝账户。\">改运费</button>");
			            	}
			            	break;
			            }
		            case 'WAIT_BUYER_PAY':
			            {
			            	tsta='等待买家付款';$("#tdbtn").prepend("<a style=\"margin-left:10px;\" class=\"sui-btn btn-primary \" data-toggle=\"modal\" data-target=\"#close-table\" data-keyboard=\"false\" href=\"javascript:void(0);\" onclick=\"showclosetrade("+atid+",'')\">关闭订单</a>");
			            	$("#tdbtn").prepend("<button style=\"margin-left:10px;\" onclick=\"wwfastpay("+atid+",'"+trade.buyer_nick+"','"+trade.receiver_name+"','"+trade.created+"','"+trade.seller_nick+"')\" title=\"点击发送旺旺消息，提醒买家及时付款，您可在设置里添加自定义催付内容哦！\" class=\"sui-btn btn-primary\">旺旺催付</button>");
			            	if(sellertype=='C' || sellertype=='c'){
			            		$("#tdbtn").prepend("<button class=\"sui-btn btn-primary\" onclick=\"getpricer("+atid+")\" >修改价格</button>");
				            }else{
				            	$("#tdbtn").prepend("<button onclick=\"showeditpost("+atid+")\" class=\"sui-btn btn-primary\">改运费</button>");
				            }
			            	break;
			            }
		            case 'WAIT_SELLER_SEND_GOODS':tsta='买家已付款,等待卖家发货';if( trade.type=='cod'){if('NEW_CREATED'==trade.cod_status){$("#tdbtn").prepend("<a style=\"margin-left:10px;\"  href=\"javascript:void(0);\" onclick=\"showsend("+atid+",'sendcoditem-table')\" class=\"sui-btn btn-primary\">发货</a>");}tsta='买家已确认，等待卖家发货';}else{$("#tdbtn").prepend("<a style=\"margin-left:10px;\" href=\"javascript:void(0);\" onclick=\"showsend("+atid+",'senditem-table')\" class=\"sui-btn btn-primary\">发货</a>");}break;
		            case 'WAIT_BUYER_CONFIRM_GOODS':tsta='卖家已发货,等待买家确认'; wz='已发货';break;
		            case 'SELLER_CONSIGNED_PART':tsta='卖家部分发货';$("#tdbtn").prepend("<a style=\"margin-left:10px;\" href=\"javascript:void(0);\" onclick=\"showsend("+atid+",'senditem-table')\" class=\"sui-btn btn-primary\">发货</a>");break;
		            case 'TRADE_BUYER_SIGNED':tsta='买家已签收 , 回款至卖家'; break;
		            case 'TRADE_FINISHED':tsta='交易成功'; break;
		            case 'TRADE_CLOSED':tsta='交易关闭';break;
		            case 'TRADE_CLOSED_BY_TAOBAO':tsta='交易关闭';break;
	        	}      
	            $("#tdsta").html(tsta);
	            var bmessage='';
	            if(undefined!=trade.buyer_message){
	                bmessage=trade.buyer_message;                       
	                $("#buyercon").html('<p>买家留言：'+bmessage+'</p>');
	            }
	            var sellerf=false;
	            var Vflag="http://cdn.zzgdapp.com/trade/web/images/op_memo_0.png";
	            if(trade.seller_flag==0){
	                if(undefined==trade.seller_memo){
	                }else{
	                    sellerf=true;
	                }
	            }
	            if(trade.seller_flag==1){
	                sellerf=true;
	                Vflag="http://cdn.zzgdapp.com/trade/web/images/op_memo_1.png";
	            }
	            if(trade.seller_flag==2){
	                sellerf=true;
	                Vflag="http://cdn.zzgdapp.com/trade/web/images/op_memo_2.png";
	            }
	            if(trade.seller_flag==3){
	                sellerf=true;
	                Vflag="http://cdn.zzgdapp.com/trade/web/images/op_memo_3.png";
	            }
	            if(trade.seller_flag==4){
	                sellerf=true;
	                Vflag="http://cdn.zzgdapp.com/trade/web/images/op_memo_4.png";
	            }
	            if(trade.seller_flag==5){
	                sellerf=true;
	                Vflag="http://cdn.zzgdapp.com/trade/web/images/op_memo_5.png";
	            }
	            if(sellerf){
	                if(bmessage==''){
	                    if(trade.seller_memo!=undefined){
	                    	$("#buyercon").html('<p>卖家备注：<img src='+ Vflag +' />'+trade.seller_memo+'</p>');
	                    }else{
	                    	$("#buyercon").hide();
	                        }
	                }else{
	                    $("#buyercon").html('<p>卖家备注：<img src='+ Vflag +' />'+trade.seller_memo+'</p><p>买家留言：'+bmessage+'</p>');
	                    $("#buyercon").show();
	                }
	                
	            }else{
	                if(bmessage!=''){
	                    $("#buyercon").show();
	                }else{
	                	$("#buyercon").hide();
	                }
	            }
	            var datas= {};
	            if(sellerf){/*是否有备注*/
	            	datas.sendsmessage=trade.seller_memo;
	         	}else{
	            	 datas.sendsmessage= '';
	         	}	
	            datas.sendbmessage=bmessage;
	            datas.tid = trade.tid;
	            datas.alipay_no = trade.alipay_no;/*支付宝*/
	            datas.created = trade.created;
	            datas.pay_time = trade.pay_time;
	            datas.end_time = trade.end_time;
	           	var trade_from=trade.trade_from.split(',');
		         var textval='';
		         for(var itxet in trade_from){
		            var text=''
		            switch(trade_from[itxet]){
		                case 'WAP':text='手机';break;
		                case 'HITAO':text='嗨淘';break;
		                case 'TOP':text='TOP平台';break;
		                case 'TAOBAO':text='普通淘宝';break;
		                case 'JHS':text='聚划算';break;
		                default :text='';break;
		            }
		             if(itxet<(trade_from.length-1)){
		                textval+=text+',';
		             }else{
		                 textval+=text;
		             }
		         } 
		         var dddd="<span>买家昵称：<a onclick=\"wangwang('"+trade.buyer_nick+"');\" href=\"javascript:void(0);\"><img border=\"0\" src=\"http://amos.alicdn.com/realonline.aw?v=2&uid="+trade.buyer_nick+"&site=cntaobao&s=2&charset=utf-8\"/>"+trade.buyer_nick+"</a></span>"
		         dddd+="<span style=\"margin-left:50px;\">买家支付宝："+trade.buyer_alipay_no+"&nbsp;&nbsp;<a  href=\"#\" onclick=\"goalipay('"+trade.seller_nick+"','"+trade.buyer_alipay_no +"') \">付款给买家</a></span>";
		         dddd+="<span style=\"margin-left:20px;\">订单来源："+textval+"</span>";
		        $("#tbuserifo").html(dddd);
		        
		        var str ="<p>订单编号："+atid+"</p>";
		        if(trade.alipay_no!=undefined){
		        	str+="<p>支付宝交易号："+trade.alipay_no+"</p>";
		        }
		        str+="<p>成交时间："+trade.created+"</p>";
		        if(datas.pay_time!='' && datas.pay_time!=null && datas.pay_time!='null'&&datas.pay_time!=undefined){
					str+="<p>付款时间："+trade.pay_time+"</p>";
		        }
		        if(trade.end_time!='' && trade.end_time!=null && trade.end_time!='null'&& trade.end_time!=undefined){
					str+="<p>确认时间："+trade.end_time+"</p>";
		        }
		        $("#tdbuy").empty().html(str);
				if('TRADE_FINISHED'==trade.status){
	 	           	if(datetime_to_unix(trade.end_time) > datetime_to_unix(GetDateStr(-15))&&trade.seller_rate==false){
	    	           tsta= '待评价';		
	        	       $("#tdbtn").prepend("<a onclick=\"onclicktid('pingjia-table',"+atid+")\" class=\"sui-btn btn-success\">评价</a>");
	         		}else{
	                	tsta= '已成功';
	                }
				}
				datas.tditems=trade.orders.order;
	            var value=datas.tditems.length;
	            gprdetail=0;
	            var tidptil='店铺优惠';
	           /* if(trade.promotion_details){
		            for(var pn in trade.promotion_details.promotion_detail){
		            	var prdetail=trade.promotion_details.promotion_detail[pn];
		                if(trade.tid==prdetail.id){
		   	            	if(1==trade.promotion_details.promotion_detail.length&&trade.orders.order[0].discount_fee!=0){
		                    	gprdetail=0;
		                        break
							}else{
		                    	gprdetail=prdetail.discount_fee;
		                        tidptil=prdetail.promotion_name;
		                        break;
		               		}
		              	}
					}
				}*/
		     	datas.total_fee=trade.total_fee;
		        datas.post_fee=trade.post_fee;
		        var gpost_fee= datas.post_fee;
		        var gtotal_fee= datas.total_fee;
		        var goidarr= new Array();
		        var tadjust_fee = 0;
		        var tdiscount_fee=0;
		        var refstall=true;
		        for(var n in trade.orders.order){
		        	var oid=trade.orders.order[n].oid;
		            goidarr[n]=oid;
		           	tadjust_fee =Number(tadjust_fee) + Number(trade.orders.order[n].adjust_fee);
		            tdiscount_fee =Number(tdiscount_fee) + Number(trade.orders.order[n].discount_fee);
		            var zhe=''
		            if(datas.adjust_fee-datas.discount_fee==0){
		            	datas.tditems[n].zhe='';
		       		}else{
		            	zhe=parseFloat(trade.orders.order[n].price*trade.orders.order[n].num)+parseFloat(trade.orders.order[n].adjust_fee)-trade.orders.order[n].discount_fee;
		                zhe*=10;
		                var pn=trade.orders.order[n].price*trade.orders.order[n].num;
		                zhe/=pn;
		                datas.tditems[n].zhe=zhe.toFixed(2);
		         	}
		            datas.tditems[n].zhe_fee=(parseFloat(trade.orders.order[n].adjust_fee)-parseFloat(trade.orders.order[n].discount_fee)).toFixed(2);
		            datas.tditems[n].itemtotal=pn.toFixed(2);
		            datas.tditems[n].tid= atid;
		            if(trade.promotion_details){
		            	for(var pn in trade.promotion_details.promotion_detail){
		                	var prdetail=trade.promotion_details.promotion_detail[pn];
		                    if(oid==prdetail.id){
		                    	if(1==trade.promotion_details.promotion_detail.length){
		                        	if(trade.orders.order[0].discount_fee!=0){
		                            	datas.tditems[n].oidsptil=" "+prdetail.promotion_name+'：'+prdetail.discount_fee;
		                                break;
		                            }
		                      	}else{
		                        	datas.tditems[n].oidsptil=" "+prdetail.promotion_name+'：'+prdetail.discount_fee;
		                            break;
		                        }
		                  	}else{
		                    	datas.tditems[n].oidsptil='';
		                   	}
						}
					}
		        	if(trade.credit_card_fee!=undefined){
						datas.tditems[n].iscardmoney=trade.credit_card_fee+"元";
		        	}else {datas.tditems[n].iscardmoney="0.00元";}
		            if(datas.tditems[n].status=="WAIT_BUYER_CONFIRM_GOODS"){
		            	datas.tditems[n].iscdsend=false;
		                value--;
		          	}else{
		            	datas.tditems[n].iscdsend=true;
		          	}
		            if(datas.tditems[n].status=="TRADE_NO_CREATE_PAY"||datas.tditems[n].status=="WAIT_BUYER_PAY"){
		            	datas.tditems[n].iscdclose=true;
		           	}else{
		            	datas.tditems[n].iscdclose=false;
		           	}
					if(trade.orders.order[n].refund_id){
		            	if(trade.orders.order[n].refund_status!='CLOSED'){
		                	refstall=false;
		             	}
		          	}
		            if(trade.orders.order[n].refund_id){
		            	datas.tditems[n].rurl='<?php echo APP_WEB_INDEX_ROOT?>/trade/refundinfo?vers=<?php echo REAL_ROOT_VER;?>#refundId='+trade.orders.order[n].refund_id;
		           	}else{
		            	datas.tditems[n].rurl='';
		            }
		            datas.outer_sku_id=trade.orders.order[n].outer_sku_id;
		            datas.outer_iid=trade.orders.order[n].outer_iid;
				}
		        if(refstall){
		        	if('WAIT_BUYER_CONFIRM_GOODS'==trade.status||'SELLER_CONSIGNED_PART'==trade.status){
		            	$("#tdbtn").prepend("<a data-toggle=\"modal\" data-target=\"#shtime-table\" data-keyboard=\"false\" class=\"sui-btn btn-primary\"  onclick=\"showaddtime("+atid+")\">延时收货</a>");
		     		}
		    	}
				if(value==datas.tditems.length){
			    	cdsend=value;
		    	}else{
			    	cdsend=0;
		    	}
		        datas.tadjust_fee = (Number(tadjust_fee)-Number(tdiscount_fee)).toFixed(2);
		        window.gtadjust_fee= datas.tadjust_fee;
		        datas.pricetotal= (Number(datas.tadjust_fee)+ Number(datas.total_fee)+Number(datas.post_fee)-Number(gprdetail)).toFixed(2);
		        /*if(datas.tadjust_fee<0){
		        	if(0==gprdetail){
		            	datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' '+ datas.tadjust_fee+' = '+datas.pricetotal;
		          	}else{
		            	datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' '+ datas.tadjust_fee+' - '+gprdetail+' = '+datas.pricetotal;
		          	}
		     	}else{
		        	if(0==gprdetail){
		            	datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' + '+datas.tadjust_fee+' = '+datas.pricetotal;
		           	}else{
		        	    datas.maijiashifu='买家实付：'+datas.total_fee +' + '+ datas.post_fee +' + '+datas.tadjust_fee+' - '+gprdetail+' = '+datas.pricetotal;
		            }
		        }  */       
		                       
	            /* var source = $("#closelist_template").html();关闭
	            var template=Handlebars.compile(source);
	            var htmlstr = template(datas);
	            $("#closelist").html(htmlstr).trigger('create');*/
	           	source = $("#tditem_template").html();                
	            template=Handlebars.compile(source);
	            htmlstr = template(datas);
	            $("#tditem").empty().html(htmlstr).trigger('create');
	            var clks='';
				if(trade.yfx_fee!=undefined){/*运费险*/
					clks="<p>运费险："+trade.yfx_fee+".00元</p>";
				}
				if(trade.commission_fee!="0.00"){/*交易佣金*/
					clks+="<p>交易佣金"+trade.commission_fee+".00元</p>";
				}	
				if(trade.point_fee!="0.00"){/*买家使用积分*/
					clks+="<p>买家使用积分："+trade.point_fee+"个</p>";
				}					
				if(trade.buyer_cod_fee!="0.00" || trade.seller_cod_fee!="0.00"){/*货到付款费用*/    					
					clks+="<p>货到付款费用："+trade.payment+"元</p>";
				}
				if(trade.real_point_fee!="0.00"){/*实际使用积分*/
					clks+="<p>实际使用积分："+trade.real_point_fee+"个</p>";
				}
				if(trade.buyer_obtain_point_fee!="0.00"){/*买家获得积分*/
					clks+="<p>买家获得积分："+trade.buyer_obtain_point_fee+"个</p>";
				}
				if(trade.invoice_name!=undefined){
					clks+="<p>发票抬头："+trade.invoice_name+"</p>";
				}
	          	$("#tdtid").empty().html(clks).trigger('create');
	            var paymenttext='';
	            var youhui=(Number(datas.total_fee)+Number(datas.post_fee))-Number(trade.payment);
	            youhui=ForDight(youhui,2);
				if(youhui >= 0){
	    	    	paymenttext=datas.total_fee+'+'+datas.post_fee+'-'+youhui+'='+trade.payment+'元';
	       	   	}else{
	        		youhui=Math.abs(youhui);
	            	paymenttext=datas.total_fee+'+'+datas.post_fee+'+'+youhui+'='+trade.payment+'元';
	       		}
			    if(0==gprdetail){						                 
	            	$("#tdprice").html('<p style=\"text-align:right;\" >实收款：<span style=\"color:#f00;\" >'+paymenttext+'</span></p><p style=\"text-align:right;\" ><span style=\"color:gray;\" >实收款 = 原价 + 运费 + 涨价或折扣</span></p>').trigger('create');
	           	}else{
	            	$("#tdprice").html('<p style=\"text-align:right;\" >'+tidptil+'：'+gprdetail+'元</p><p style=\"text-align:right;\" >实收款：<span style=\"color:#f00;\" >'+paymenttext+'</span></p><p style=\"text-align:right;\" ><span style=\"color:gray;\" >实收款 = 原价 + 运费 + 涨价或折扣</span></p>').trigger('create');
	            }
	
	            if(undefined!=trade.seller_cod_fee&&'cod'==trade.type){
	            	$("#codprice").html('<p style=\"text-align:right;\" >卖家承担服务费：'+trade.seller_cod_fee+'元</p>');
	            }else{
	            	$("#codprice").html('');
	            }
	            datas.receiver_name= trade.receiver_name;
	            datas.receiver_state = trade.receiver_state;
	            datas.receiver_city = trade.receiver_city;
	            datas.receiver_district = trade.receiver_district;
	            gmoreshen= trade.receiver_state;
	            gmoreshi=trade.receiver_city;
	            gmorequ=trade.receiver_district;
	            datas.receiver_address = trade.receiver_address;
	            datas.receiver_zip = trade.receiver_zip;
	            datas.receiver_mobile = trade.receiver_mobile;
	            datas.receiver_phone = trade.receiver_phone;
	            datas.consign_time = trade.consign_time;
	            datas.shipping_type = '';
	           /* $("#more_zip").val(trade.receiver_zip);
	            $("#more_name").val(trade.receiver_name);
	            $("#more_address").val(trade.receiver_address);
	            $("#more_phone").val(trade.receiver_phone);
	            $("#more_mobile").val(trade.receiver_mobile);*/
	            /* 可选值：free(卖家包邮),post(平邮),express(快递),ems(EMS),virtual(虚拟发货)，25(次日必达)，26(预约配送)。
	             */
	            switch(trade.shipping_type){
	                case 'free': datas.shipping_type = '卖家包邮';break;
	                case 'post': datas.shipping_type = '平邮';break;
	                case 'express': datas.shipping_type = '快递';break;
	                case 'ems': datas.shipping_type = 'EMS';break;
	                case 'virtual': datas.shipping_type = '虚拟发货';break;
	                case '25': datas.shipping_type = '次日必达';break;
	                case '26': datas.shipping_type = '预约配送';break;
	            }
	            datas.buyer_nick=trade.buyer_nick;
	            datas.seller_nick=trade.seller_nick;
	            user_nick=datas.seller_nick;
	            datas.wlflase = true;
	            datas.wleditt = false;
	            /*var source = $("#pricebd_template").html();
	            var template=Handlebars.compile(source);
	            var htmlstr = template(datas);
	            $("#pricebody").html(htmlstr).trigger('create');*/
				
	            /*var source = $("#pingjiadata_template").html();
	            var template=Handlebars.compile(source);
	            var htmlstr = template(datas);
	            $("#pingjiadata").html(htmlstr).trigger('create');*/
	           
	                /*getmymemo();备注短语*/
	                /*getmypjcon();评价短语*/
	            var source = $("#sendlist_template").html();
	            var template=Handlebars.compile(source);
	            var htmlstr = template(datas);
	            $("#sendlist").html(htmlstr).trigger('create');
	            $("#Dbfselect").hide();
	            /*if(gtdsta=='WAIT_BUYER_CONFIRM_GOODS'||gtdsta=='SELLER_CONSIGNED_PART'){
	            	wz='已发货';
	            }else{
	                wz='';
	            }*/
	            var source = $("#codsendlist_template").html();
	            var template=Handlebars.compile(source);
	            var htmlstr = template(datas);
	            $("#sendcodlist").html(htmlstr).trigger('create');	
	            if('WAIT_BUYER_PAY'==gtdsta||'TRADE_NO_CREATE_PAY'==gtdsta ||'WAIT_SELLER_SEND_GOODS'==gtdsta||'TRADE_CLOSED_BY_TAOBAO'==gtdsta||'TRADE_CLOSED'==gtdsta){
	                if('cod'==trade.type&&'NEW_CREATED'==trade.cod_status){
	                    datas.company_name = '-';
	                    datas.out_sid = '-';
	                    datas.wlflase = false;
	                    if('WAIT_SELLER_SEND_GOODS'==gtdsta){
	                        datas.wleditt = true;
	                    }
	                    var source = $("#tdwuliu_template").html();
	                    var template=Handlebars.compile(source);
	                    var htmlstr = template(datas);
	                    $("#tdwuliu").html(htmlstr).trigger('create');
	                   	/*getcompty(null);*/
	                    $("#wltab").hide();
	                }else{
	                    datas.company_name = '-';
	                    datas.out_sid = '-';
	                    datas.wlflase = false;
	                    if('WAIT_SELLER_SEND_GOODS'==gtdsta){
	                        datas.wleditt = true;
	                    }
	                    var source = $("#tdwuliu_template").html();
	                    var template=Handlebars.compile(source);
	                    var htmlstr = template(datas);
	                    $("#tdwuliu").html(htmlstr).trigger('create');
	                    $("#wltab").hide();
	                    /*Dshowwuliu(datas,atid);*/
	                }
	            }else{
	                $("#wltab").show()
	                Dshowwuliu(datas,atid);
	            }
	        	if('WAIT_SELLER_SEND_GOODS'==gtdsta||'SELLER_CONSIGNED_PART'==gtdsta){
	        		/*getcompty(null);*//*加载默认物流*/
	        		/*$('#comptyid').change(c_offline);*/
	        		/*c_offline();*/
	        	}
	        }/*end 502*/
    	}/*end success*/
    });
}
var gdata={};
function Dshowwuliu(mydatas,atid){
	try{
		gdata=mydatas;
		$("#Dbfselect").empty();
		$("#Dtdwldatas").empty();
    	QN.top.invoke({
    		"cmd": "taobao.logistics.orders.get",
    		"param": {fields:'tid,order_code,seller_nick,buyer_nick,delivery_start,delivery_end,out_sid,item_title,receiver_name,created,modified,status,type,freight_payer,seller_confirm,company_name,sub_tids,is_spilt',tid:atid},
    		"method": "get",
    		"success": function (rsp){
        		
                if(typeof  rsp=== 'string'){
                	rsp = JSON.parse(rsp);
                	} 
                if(rsp.code!=null){
                    if(rsp.sub_msg){
                    	layer.msg(rsp.sub_msg,1,3);
                        
                    }else{
                    	layer.msg('操作失败，请重试！');
                    }
                }else{
                	var orders=rsp.logistics_orders_get_response.shippings.shipping;
                    var datas={};
                    var i=1;
                    var n=0;
                    for(index in orders){
                    	var item=orders[index];
          		    	if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.modified)>=23*60*60+50*60){
          		    		var show_resend=true;
          		    		mydatas.edit_property=false;
        		    	}else{
        			    	var show_resend=true;
        			    	mydatas.edit_property=true;
        		    	}
        		    	if(show_resend&&item.company_name!=null && wz=='已发货'){
        		    		mydatas.isresend=true;
        		    	}else{
        		    		mydatas.isresend=false;
        		    	}
        	         }
                   	if(orders.length<2){
                     	$("#Dbfselect").hide();
                        Dshowwulius(mydatas,atid);/*用于详情的大写D用于标识*/
                   	}else{
                    	mycd=true;
                        $("#Dbfselect").show();
                        var n=0;
                        var i=1;
                       	for(index in orders){
                        	var item=orders[index];
                        	if(item.seller_confirm=="yes"){
                				$("#Dbfselect").append("<option value=\""+index+"\" >包裹"+i+"</option>").trigger("create");
								i++;
     	    	            	if(n==0){
     	 	    	            	n++;
    	                            if(item.company_name!=null&&item.company_name!==''){
      	                            	mydatas.company_name=item.company_name;
      	                         	}
      	                            if(item.out_sid!=null&&item.out_sid!==''){
      	                            	mydatas.out_sid=item.out_sid;
      	                           	}
      		          		    	if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.created)>=23*60*60+50*60){
      		        			    	var show_resend=false;
									}else{
      		        			    	var show_resend=true;
      		        		    	}
      		        		    	if(show_resend&&item.company_name!=null&&wz=='已发货'){
      		        		    		mydatas.isresend=true;
      		        		    	}else{
      		        		    		mydatas.isresend=false;
      		        		    	}
      	       			            var source = $("#tdwuliu_template").html();
      	       			            var template=Handlebars.compile(source);
      	       			            var htmlstr = template(mydatas);
      	       			            $("#tdwuliu").html(htmlstr).trigger('create');
              				 		datas.sub_tid=item.sub_tids.number;
              				 		mysub_tids=datas.sub_tid;
              				 		QN.top.invoke({
              							cmd:"taobao.logistics.trace.search",
              							param:{tid:atid,seller_nick:user_nick,is_split:'1',sub_tid:datas.sub_tid},
              							method:"get",
              							success:function (rsp){
              				            	if(typeof  rsp=== 'string'){
              				            		rsp = JSON.parse(rsp);
              				            	}
              				            	if(rsp.code!=null){
                                            	if(rsp.sub_msg){
                                            		layer.msg(rsp.sub_msg,1,3);
                                            	}else{
                                            		layer.msg('操作失败，请重试！',1,3);
                                            	}
              				            	}else{
             				            	 	var datas= {};
	               			                    mydatas.company_name = rsp.logistics_trace_search_response.company_name;
	               			                    mydatas.out_sid = rsp.logistics_trace_search_response.out_sid;
		               			                mydatas.tracelists = rsp.logistics_trace_search_response.trace_list.transit_step_info;
	               			                    var source = $("#tdwldatas_template").html();
	               			                    var template=Handlebars.compile(source);
	               			                    var htmlstr = template(mydatas);
	               			                    $("#Dtdwldatas").html(htmlstr).trigger('create');
              				            	}
              					    	}
              						});
                             	}/*end n==0*/
                             }/*end confirm==yes*/
                         }/*end for*/
                     }/*end else*/
    			} 
    		},/*----> success*/
            error: function(msp){
                if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }else{
                    var	msp= msp;
                }
                if(msp.sub_code=='subuser.has-no-permission'){
                 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
                    
                }else{
                    if(msp.sub_msg){
                    	layer.msg(msp.sub_msg,1,3);
                       
                    }else{
                   	 	geterrorinfo('taobao.logistics.orders.get',msp);
                    }
                }
            }
    	 });
	}catch(e){
	}
}
function Dshowwulius(datas,atid){/*详情页*/
    QN.top.invoke({
        cmd:"taobao.logistics.trace.search",
        param:{tid:atid,seller_nick:datas.seller_nick},
        method:"get",
        success:function(rsp) {
            
            if(typeof rsp === 'string'){
                var rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
            datas.company_name = rsp.logistics_trace_search_response.company_name;
            datas.out_sid = rsp.logistics_trace_search_response.out_sid;
            var source = $("#tdwuliu_template").html();
            var template=Handlebars.compile(source);
            var htmlstr = template(datas);
            $("#tdwuliu").html(htmlstr).trigger('create');
            datas.tracelists = rsp.logistics_trace_search_response.trace_list.transit_step_info;
            var source = $("#tdwldatas_template").html();
            var template=Handlebars.compile(source);
            var htmlstr = template(datas);
            $("#Dtdwldatas").html(htmlstr).trigger('create');
        },
        error: function(msp){
            
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }else{
                var	msp= msp;
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/*layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
            	 */
            }else{
                if(msp.sub_msg){
                	if(msp.sub_msg=="物流公司不支持流转查询")
					{
						datas.company_name = "亲！物流公司不支持流转查询哦。";
	                    datas.out_sid = false;
	                    var source = $("#tdwuliu_template").html();
	                    var template=Handlebars.compile(source);
	                    var htmlstr = template(datas);
	                    $("#tdwuliu").html(htmlstr).trigger('create');
	                    datas.tracelists = "亲！物流公司不支持流转查询哦。";
	                    datas.wuliuinfo="暂无物流信息！"
	                    var source = $("#tdwldatas_template").html();
	                    var template=Handlebars.compile(source);
	                    var htmlstr = template(datas);
	                    $("#Dtdwldatas").html(htmlstr).trigger('create');	
					}else{ 
						layer.msg(msp.sub_msg,1,3);
                    	
					}
                }else{
                	geterrorinfo('taobao.logistics.trace.search',msp);
                }
            }
        }
    });
}
function ForDight(Dight,How){  /*四舍五入*/
     Dight = Math.round(Dight*Math.pow(10,How))/Math.pow(10,How);  
     return Dight;  
 }  
Handlebars.registerHelper('getFee', function(adjust_fee) {
    return (-Number(adjust_fee)).toFixed(2);
});
Handlebars.registerHelper('refundName', function(person,stam) {
     switch(person){
         case 'WAIT_SELLER_AGREE':{return '退款中';break;}
         case 'WAIT_BUYER_RETURN_GOODS':{return '退款中';break;}
         case 'WAIT_SELLER_CONFIRM_GOODS':{return '退款中';break;}
         case 'SELLER_REFUSE_BUYER':{return '已拒绝退款';break;}
         case 'CLOSED':{return '退款关闭';break;}
         case 'SUCCESS':{return '退款成功';break;}

     }
 switch(stam){
     case 'TRADE_NO_CREATE_PAY': return '待付款'; break;
     case 'WAIT_BUYER_PAY': return '待付款'; break;
     case 'WAIT_SELLER_SEND_GOODS': return '待发货'; break;
     case 'WAIT_BUYER_CONFIRM_GOODS': return '已发货'; break;
     case 'TRADE_BUYER_SIGNED': return '买家已签收'; break;
     case 'TRADE_FINISHED': return '已成功'; break;
     case 'TRADE_CLOSED': return '已取消'; break;
     case 'TRADE_CLOSED_BY_TAOBAO': return '已取消'; break;

 }
});

Handlebars.registerHelper('editpro', function(stam) {
     if(stam=='WAIT_SELLER_SEND_GOODS'){
         return "修改订单属性";
     }else{
         return "";
     }
});
function goalipay(nick,alipayemail){
    var alipayev=encodeURI(alipayemail);
    var urlval="https://lab.alipay.com/life/payment/fill.htm?taobaonick="+nick+"&optEmail="+alipayev;
    window.open(urlval);
}
function Dshowbg(){
	var sel=$("#Dbfselect").find("option:selected").val();
	$("#tdwldatas").empty();
	QN.top.invoke({
		cmd: "taobao.logistics.orders.get",
		param: {fields:'tid,order_code,seller_nick,buyer_nick,delivery_start,delivery_end,out_sid,item_title,receiver_name,created,modified,status,type,freight_payer,seller_confirm,company_name,sub_tids,is_spilt',tid:gtid},
		method: "get",
		success: function (rsp){
            if(typeof  rsp=== 'string'){
            	rsp = JSON.parse(rsp);
            }                
            if(rsp.code!=null){
                if(rsp.sub_msg){
                	layer.msg(rsp.sub_msg,1,3);
                }else{
                	layer.msg('操作失败，请重试！',1,3);
                }
            }else{
            	var orders=rsp.logistics_orders_get_response.shippings.shipping;
                var datas={};
               	for(index in orders){
                	var item=orders[index];
                    if(index==sel){
                    	if(item.company_name!=null&&item.company_name!==''){
                        	gdata.company_name=item.company_name;
                     	}
                        if(item.out_sid!=null&&item.out_sid!==''){
                        	gdata.out_sid=item.out_sid;
                       	}
	          		    if(datetime_to_unix(GetDateStr(0))-datetime_to_unix(item.created)>=23*60*60+50*60){
	        				var show_resend=false;
	        		    }else{
	        				var show_resend=true;
	        		    }
	        		    if(show_resend&&item.company_name!=null&&wz=='已发货'){
	        		    	gdata.isresend=true;
	        		    }else{
	        		    	gdata.isresend=false;
	        		    }
   			            var source = $("#tdwuliu_template").html();
   			            var template=Handlebars.compile(source);
   			            var htmlstr = template(gdata);
   			            $("#tdwuliu").html(htmlstr).trigger('create');
            			datas.sub_tid=item.sub_tids.number;
            			mysub_tids=datas.sub_tid;
            			QN.top.invoke({
            				cmd:"taobao.logistics.trace.search",
            				param: {tid:gtid,seller_nick:user_nick,is_split:'1',sub_tid:datas.sub_tid},
            				method:"get",
            				success:function (rsp){
            					if(typeof  rsp=== 'string'){
            				    	rsp = JSON.parse(rsp);
            				  	}
            				    if(rsp.code!=null){
            				    	layer.msg(JSON.stringify(rsp),1,3);
            					}else{
           				        	var datas= {};
             			            gdata.company_name = rsp.logistics_trace_search_response.company_name;
             			            gdata.out_sid = rsp.logistics_trace_search_response.out_sid;
              			           	gdata.tracelists = rsp.logistics_trace_search_response.trace_list.transit_step_info;
             			            var source = $("#tdwldatas_template").html();
             			            var template=Handlebars.compile(source);
             			            var htmlstr = template(gdata);
             			            $("#Dtdwldatas").html(htmlstr).trigger('create');
            					}
            				}
            			});
                    }
                }
			}
		},
        error: function(msp){
            if(typeof msp === 'string'){
                var msp = JSON.parse(msp);
            }
            if(msp.sub_code=='subuser.has-no-permission'){
            	/*layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
            	showMsg('hint');*/
            }else{
                if(msp.sub_msg){
                	layer.msg(msp.sub_msg,1,3);
                }else{
                	geterrorinfo('taobao.logistics.orders.get',msp);
                }
            }
        }
	 });
}
</script>

<!-- 公共方法集合---index Api -->
<script type="text/javascript">

/**
 * 获取用户信息(无用)_old
 * @author Duanhq
 * @parm user_nick,全局变量-卖家昵称 from top.php
 * @parm version,全局变量-千牛版本号
 * @parm sellertype,全局变量-卖家店铺类型（B，C店）
 */
function get_userinfo_data(){
    QN.application.invoke({
        "cmd": "getLoginuser",
        "success": function (e){
            if(typeof  e=== 'string'){
                e = JSON.parse(e);
            }
            user_nick=decodeURI(e.user_nick);
            if(e.sub_user_id==""){
                taskuid=e.user_id;
            }else{
                taskuid=e.sub_user_id;
            }
            
        }
    });
	version = window.localStorage.getItem("qnversions");/*获取版本信息*/
	if(version==''||version==null||version=='null'){
	    QN.application.invoke({
	        "cmd": "getVersion",
	        "error" : function(msg) {
	            onclicktid('price-table',tid);
	        },
	        "success" : function(e) {
	            if(typeof  e=== 'string'){
	                e = JSON.parse(e);
	            }
	            var versions=e.version.replace(/[.]/g,"");
	            version=versions.replace(/[N]/g,"");
	            window.localStorage.setItem("qnversions",version);
	        }
	    });
	}
	sellertype = window.localStorage.getItem("shoptype"+user_nick);/*获取卖家店铺类型*/
	if(sellertype==''||sellertype==null||sellertype=='null'){
	    QN.top.invoke({
	        cmd: "taobao.user.seller.get",
	        param:{
	            "fields":"type",
	        },
	        method: "get",
	        success: function (rsp){
	            if(typeof rsp === 'string'){
	                var    rsp = JSON.parse(rsp);
	            }else{
	                var	rsp= rsp;
	            }
	            if(rsp.user_seller_get_response){
	                sellertype=rsp.user_seller_get_response.user.type;
	                window.localStorage.setItem("shoptype"+user_nick,sellertype);
	            }
	        }
	    });
	}
}
/**
 * 获取用户信息(无用)_old
 * @author Duanhq
 */
function get_userinfo_data_old(){
    var credit="";
    var rate="";
    var cid="";
    var created="";
    var item_score="";
    var service_score="";
    var delivery_score="";
    var mobile_phone="";
    var contact_name="";
    var addr="";
    var ifhaveaddr="";
    QN.application.invoke({
        "cmd": "getVersion",
        "error" : function(msg) {
            onclicktid('price-table',tid);
        },
        "success" : function(e) {
            if(typeof  e=== 'string'){
                e = JSON.parse(e);
            }
            var versions=e.version.replace(/[.]/g,"");
            version=versions.replace(/[N]/g,"");
            if(version>=versionjr){
                 $("#taskgl").show();
                 $("#addtaskpl").show();
                 $("#ThreeMonthQian").show();
            }
        }
    });
    QN.top.invoke({
        cmd: "taobao.user.seller.get",
        param:{
            "fields":"seller_credit,type",
        },
        method: "get",
        success: function (rsp){
            if(typeof rsp === 'string'){
                var    rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
            if(rsp.user_seller_get_response.user.seller_credit){
                credit=rsp.user_seller_get_response.user.seller_credit.level;
                var total_num =rsp.user_seller_get_response.user.seller_credit.total_num;
                var good_num  =rsp.user_seller_get_response.user.seller_credit.good_num ;
                sellertype=rsp.user_seller_get_response.user.type
                rate=(good_num/total_num).toFixed(2);
            }
            QN.application.invoke({
                "cmd": "getLoginuser",
                "success": function (e){
                    if(typeof  e=== 'string'){
                        e = JSON.parse(e);
                    }
                    nick=decodeURI(e.user_nick);
                    if(e.sub_user_id==""){
                        taskuid=e.user_id;
                    }else{
                        taskuid=e.sub_user_id;
                    }
                    QN.top.invoke({
                        cmd: "taobao.shop.get",
                        param:{
                            "fields":"cid,created,shop_score",
                            "nick":nick,
                        },
                        method: "get",
                        success: function (rsp){
                            /*alert(JSON.stringify(rsp));*/
                            if(typeof rsp === 'string'){
                                var    rsp = JSON.parse(rsp);
                            }else{
                                var	rsp= rsp;
                            }
                            if(rsp.shop_get_response.shop){
                                cid=rsp.shop_get_response.shop.cid;
                                created=rsp.shop_get_response.shop.created;
                                item_score =rsp.shop_get_response.shop.shop_score.item_score;
                                service_score =rsp.shop_get_response.shop.shop_score.service_score;
                                delivery_score  =rsp.shop_get_response.shop.shop_score.delivery_score ;
                                /*alert(cid+"~~"+created+"~~~"+item_score+"~~"+service_score+"~~"+delivery_score);*/
                            }
                            QN.top.invoke({
                                cmd: "taobao.logistics.address.search",
                                param:{
                                    "rdef":"get_def"
                                },
                                method: "get",
                                success: function (rsp){
                                    if(typeof rsp === 'string'){
                                        var rsp = JSON.parse(rsp);
                                    }else{
                                        var	rsp= rsp;
                                    }
                                    if(rsp.logistics_address_search_response){
                                        var addre=rsp.logistics_address_search_response.addresses.address_result[0];
                                        mobile_phone=addre.mobile_phone;
                                        addr=addre.province+addre.city+addre.country+addre.addr;
                                        contact_name =addre.contact_name ;
                                        /*alert(mobile_phone+"~~"+contact_name+"~~"+addr);*/
                                        ifhaveaddr="yes";
                                    }else{
                                        ifhaveaddr="no";
                                    }
                                    save_userinfo(nick,credit,cid,rate,created,item_score,service_score,delivery_score,mobile_phone,contact_name,addr,ifhaveaddr);
                                }
                            });
                        }
                    });
                }
            });

        }
    });
}
function save_userinfo(nick,credit,cid,rate,created,item_score,service_score,delivery_score,mobile_phone,contact_name,addr,ifhaveaddr){
    var data={
        "nick":nick,
        "credit":credit,
        "category":cid,
        "rate":rate,
        "item_score":item_score,
        "service_score":service_score,
        "delivery_score":delivery_score,
        "shop_start_time":created,
        "shop_start_name":contact_name,
        "shop_start_phone":mobile_phone,
        "shop_start_mail":"",
        "shop_start_addr":addr,
        "appkey":"21588210",
        "ifhaveaddr":ifhaveaddr,
    };
    /*
    var svtime=new Date().getTime();
    var svtimes = window.localStorage.getItem("svtime");
    if(svtimes==''||svtimes==null||svtimes=="null"){
	    $.ajax({
	        type: 'POST',
	        url: "<?php echo APP_WEB_INDEX_ROOT;?>/tc/sv",
	        data: data,
	        success:function(e){
	        	window.localStorage.setItem("svtime",svtime);
	        }
	    });
    }
    */
}
/**
 * 公告获取
 * @author wangsx
 */
function gonggao(){
	try{
    	var ggtime = window.localStorage.getItem("ggtime");
     	var timestamp=new Date().getTime();
        if(ggtime=="null"||ggtime==null)ggtime=0;
    	if(timestamp-ggtime>18000000){
            var rzUrl="<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/tradegg";
		            $.get(rzUrl,function(data){
			            if(data==null||data=="null")data="0";
		            	window.localStorage.setItem("ggdata",data);
			            	window.localStorage.setItem("ggtime",timestamp);
			            	if(data!="0"){
			            	var signdata= JSON.parse(data);
			             	$('#indexgg').html(signdata.indextitle);
			             	var toptitle=signdata.toptitle;
			         	  if(signdata.shows==1 && getdatestrs(signdata.endtime)==1){
			                 if(signdata.way==2){
			              	   document.getElementById("indexgg").style.display="";
			                   var link= signdata.link;
			                   var a="browserUrl('"+link+"','"+toptitle+"')";
			                   var a='&nbsp&nbsp&nbsp<a href="javascript:void(0);" onclick="'+a+'">点击查看</a>';
			              	   $("#indexgg").append(a);
			                }else if(signdata.way==1){
			             	   document.getElementById("indexgg").style.display="";
			                 }
			           }else{
			         	  document.getElementById("indexgg").style.display="none";
		           		}
			            }
	     		});
    	     }else{
    	    	 var data = window.localStorage.getItem("ggdata");
    	    	 if(data!="0"){
	    	    	  var signdata= JSON.parse(data);
		              $('#indexgg').html(signdata.indextitle);
		              var toptitle=signdata.toptitle;
		         	  if(signdata.shows==1 && getdatestrs(signdata.endtime)==1){
		                 if(signdata.way==2){
		              	   document.getElementById("indexgg").style.display="";
		                   var link= signdata.link;
		                   var a="browserUrl('"+link+"','"+toptitle+"')";
		                   var a='&nbsp&nbsp&nbsp<a href="javascript:void(0);" onclick="'+a+'">点击查看</a>';
		              	   $("#indexgg").append(a);
			              }else if(signdata.way==1){
			             	   document.getElementById("indexgg").style.display="";
			              }
			           }else{
			         	  document.getElementById("indexgg").style.display="none";
			           }
    	       	 }
    		 }
    }catch(e){
    }
}
/**
 * 免登打开浏览器
 * @author wangsx
 */
function browserUrl(link,toptitle){
	/*$("#tanchuang_tj").append('<img src="http://img.tongji.linezing.com/3371903/tongji.gif"/>');*/
    QN.application.invoke({
  		"cmd" : "browserUrl",
  		"param" : { "url" : link}
  	});
}
/**
 * 计算时间差
 * @author wangsx
 */
function getdatestrs(enddate){     /*计算时间差 */
    var date2=new Date(Date.parse(enddate.replace(/-/g,"/")));
    var s2=date2.getTime();
    var date1=new Date();
    var s1=date1.getTime();
    ms=s2-s1;
    if(ms<0){
       return 0;
    }else{
       return 1;
    }
}
/**
 * 是否显示已关闭的订单
 * @author wangsx
 */
function hideonclick(){
	if(document.getElementById("checkboxhide").checked){
			window.localStorage.setItem("hidelocal","yes");
			$("table[name='hidename']").attr("style","margin-bottom:10px;display:none");
    }else{
    		window.localStorage.setItem("hidelocal","no");
    		$("table[name='hidename']").attr("style","margin-bottom:10px;");
    }
}
/**
 * 淘宝top回调
 * @author wangsx
 */
function huidiao(){
    var seccessrsult={};
    QN.plugin.successResponse(seccessrsult);
}
/**
 * 获取淘宝的系统时间
 * @author wangsx
 */
function gettbtime(){/*获取淘宝的系统时间*/
	 QN.top.invoke({
	        "cmd": "taobao.time.get",
	        "method": "get",
	        "success":function (rsp){
	            if(typeof rsp === 'string'){
	                var    rsp = JSON.parse(rsp);
	            }else{
	                var	rsp= rsp;
	            }
	          taobaotime=rsp.time_get_response.time;
	          },
	        error: function(msp){
	        	taobaotime='';
	        }
	    });
}
/**
 * 获得factor天后的时间：例如2012/12/1 12:12"12 10天后是:2012/12/11 12:12:12
 * @author wangsx
 */
function gettimes(timestr,factor){/*获得factor天后的时间：例如2012-12-1 12:12"12 10天后是:2012-12-11 12:12:12*/
	var msTime = new Date(timestr).getTime();	
	var temptime = new Date();
	temptime.setTime( msTime + parseInt(factor*24*60*60000));
 	return temptime.format( "yyyy-MM-dd hh:mm:ss");;
}
/**
 * 获取买家留言与卖家备注
 * @author Duanhq
 */
function getmemoandmessage(rtid,sta)
{
	QN.top.invoke({
	"cmd": "taobao.trade.fullinfo.get",
    "param": {
        "fields":"seller_memo,buyer_message,timeout_action_time,end_time,status,seller_rate,buyer_nick,receiver_state,receiver_city,receiver_district,receiver_address,buyer_message",
        tid:rtid
    },
    "method": "get",
    "success":function(rsp){
    	if(typeof rsp === 'string'){
            var rsp = JSON.parse(rsp);
        }else{
            var	rsp= rsp;
        }
			var trade=rsp.trade_fullinfo_get_response.trade;
            if(trade.seller_memo!=undefined&&trade.seller_memo!='')
            {
            	var objString = trade.seller_memo.replace(/(^\s*)/g, "");
				if(objString!=""){
	                $("#sellercom"+gsta+rtid).attr("title", trade.seller_memo);
	                $("#sellercoms"+gsta+rtid).attr("title", trade.seller_memo);
                }else{
               		$("#sellercom"+gsta+rtid).attr("title", '暂时没有备忘信息');
                }
                var objLength = objString.length;
                var num = 5;
                if(objLength > num && objString!=""){
                    var i=$("#sellercoms"+gsta+rtid).html(objString.substring(0,5) + "...");
                }else{
                	var j=$("#sellercoms"+gsta+rtid).html(objString);
                }
            }else{
                $("#sellercom"+gsta+rtid).attr("title", '暂时没有备忘信息');
            }

            if(trade.buyer_message!=undefined&&trade.buyer_message!='')
            {
                $("#buyercom"+gsta+rtid).attr("title", trade.buyer_message);
                var bobjString = trade.buyer_message;
                var bobjLength = bobjString.length;
                if(bobjLength > 40){
                    $("#buyercom"+gsta+rtid).html(bobjString.substring(0,40) + "...");
                }else{
                    $("#buyercom"+gsta+rtid).html(bobjString);
                }
            }
            if(vipuser!=0){/*高级版才计算时间*/
				var type=trade.status;
				var buyer_nick=trade.buyer_nick;
				var addr=trade.receiver_state+trade.receiver_city+trade.receiver_district+trade.receiver_address+trade.buyer_message;/*取出地址和留言*/
				addr=addr.replace(/undefined/g,'');
				var dangeraddr='活刷|皇冠|不降权|不扣分|不封店|爆款|刷钻|真实单号|真是运单号|老板您好|掌柜您好|加QQ聊|先做后款|确保安全|店铺|刷信誉|刷销量';
				dangeraddr=dangeraddr.split('|');
				for(var i in dangeraddr){
					if(addr.split(dangeraddr[i]).length>1){
						$("#huitouimg"+gsta+rtid).empty();
						$("#huitouimg"+gsta+rtid).attr('title','危险：检测到该买家可能是刷信誉用户，建议及时关闭订单');
						for(var k=0;k<5;k++){
							$("#huitouimg"+gsta+rtid).append('<img src="http://cdn.zzgdapp.com/trade/web/img/huistar.png" />');
						}
						$("#huitouimg"+gsta+rtid).append('检测到该买家可能是刷信誉用户');
						return;
						break;
					}
				}
				var all_star=5;/*总星数*/
				var reason='安全：检测到该订单不是刷信誉订单Y';/*原因*/
				var sss=0;
				var dangeraddr2='村|镇|乡|旗|屯|自治区|自治州|邮电|邮局|政府|监狱|军区|部队|寺|庙|香港|澳门|台湾|海外';/*特殊地址*/
				dangeraddr2=dangeraddr2.split('|');
				for(var i in dangeraddr2){
					if(addr.split(dangeraddr2[i]).length>1){
						all_star=all_star-1;
						sss=100;
						break;
					}
				}
				if(sss>0){
					reason=reason+'预警：检测到收货地址物流可能无法到达，建议先联系买家核对地址Y';
				}else{
					reason=reason+'安全：检测到地址无异常Y';
				}
				if(type=='WAIT_BUYER_PAY'){/*待付款，已发货的时间*/
					if(trade.timeout_action_time==undefined){
						safenumber(buyer_nick,rtid,addr,'give',all_star,reason,type);
					}else{
						var trade_time=trade.timeout_action_time;
						var date2=new Date(Date.parse(trade_time.replace(/-/g,"/")));
						var s2=date2.getTime();
						var date1=new Date();
						var s1=date1.getTime();
						var ms=s1-s2;
						var h=Math.floor(ms/(3600*1000*24));
						if( h < 0 && (Math.abs(h)<=1)){/*离付款和确认收货小于1天*/
							reason=reason+'预警：距离系统关闭还有1天时间，可使用“旺旺催付”提醒买家付款Y';
							safenumber(buyer_nick,rtid,addr,'give',all_star-1,reason,type);
						}else{
							reason=reason+'安全：距离系统关闭还有'+Math.abs(h)+'天时间，可使用“旺旺催付”提醒买家付款Y';
							safenumber(buyer_nick,rtid,addr,'give',all_star,reason,type);
						}
						
					}
				}else if(type=='WAIT_BUYER_CONFIRM_GOODS'){
					if(trade.timeout_action_time==undefined){
						safenumber(buyer_nick,rtid,addr,'give',all_star,reason,type);
					}else{
						var trade_time=trade.timeout_action_time;
						var date2=new Date(Date.parse(trade_time.replace(/-/g,"/")));
						var s2=date2.getTime();
						var date1=new Date();
						var s1=date1.getTime();
						var ms=s1-s2;
						var h=Math.floor(ms/(3600*1000*24));
						if( h < 0 && (Math.abs(h)<= 3)){/*离付款和确认收货小于3天*/
							reason=reason+'预警：距离系统确认收货还有'+Math.abs(h)+'天，请及时联系买家是否签收Y';
							safenumber(buyer_nick,rtid,addr,'give',all_star-1,reason,type);
						}else{
							reason=reason+'安全：货已经成功发出，可使用“查看物流”跟踪物流动态 Y';
							safenumber(buyer_nick,rtid,addr,'give',all_star,reason,type);
						}
						
					}
				}else if(trade.seller_rate==false && type=='TRADE_FINISHED'){/*卖家未评，且是成功订单--->待评价*/
					var trade_time=gettimes(trade.end_time,15);
					var date2=new Date(Date.parse(trade_time.replace(/-/g,"/")));
					var s2=date2.getTime();
					var date1=new Date();
					var s1=date1.getTime();
					var ms=s1-s2;
					var h=Math.floor(ms/(3600*1000*24));
					if( h < 0 && (Math.abs(h)<= 4)){/*离自动评价还有小于4天*/
						reason=reason+'预警：距离系统评价还有'+Math.abs(h)+'天，请及时联系买家好评哦 Y';
						safenumber(buyer_nick,rtid,addr,'give',all_star-1,reason,type);
					}else{
						reason=reason+'安全：该订单已成功，等待买家评价中Y';
						safenumber(buyer_nick,rtid,addr,'give',all_star,reason,type);
					}
				}else if(type=='TRADE_CLOSED' || type=='TRADE_CLOSED_BY_TAOBAO'){/*关闭状态不操作*/
						
				}else{
					reason=reason+'安全：检测到该订单无异常Y';
					safenumber(buyer_nick,rtid,addr,'give',all_star,reason,type);/*其他它状态*/
				}
			}
		},
        "error":function(rsp){/*请求出错的错误处理*/
        	safenumber(buyer_nick,rtid,addr,'give',5,'安全：检测到该订单不是刷信誉订单\n安全：检测到地址无异常，可以正常发货\n安全：检测到该订单无异常\n',type);
        }
	});
}
/**
 *@author chenlongke 
 * buyer_nick:买家昵称
 * tid 交易编号
 * addr:交易地址
 * type:获取类型
 * all_star:总星星数
 * 递归调用
 */	
try{ 
	function safenumber(buyer_nick,tid,addr,type,all_star,reason,status){
		if(type=="give"){
			$.ajax({
				url:'http://trade.zzgdapp.com/tc/getbadnick',
				type:'POST',
				dataType:'html',
				data:{'nick':buyer_nick},
				error:function(msp){
					safenumber(buyer_nick,tid,addr,'huitouke',all_star,reason,status);/*出错~直接跳到回头客*/
				},
				success:function(rsp){
					if(typeof rsp==='string'){rsp=JSON.parse(rsp);}
					if(rsp.bad_num>1 && rsp.bad_num<5 || rsp.neutral_num>1 && rsp.neutral_num<5){/*发出过中差评但是小于5个*/
						all_star=all_star-1;
						reason=reason+'安全：检测到买家三个月内没有发出过中差评Y';
						safenumber(buyer_nick,tid,addr,'huitouke',all_star,reason,status);/*去检查回头客*/
					}else if(rsp.bad_num>5 || rsp.neutral_num>5){/*发出过中差评大于5个以上*/
						$("#huitouimg"+gsta+tid).empty();
						$("#huitouimg"+gsta+tid).attr('title','危险：检测到该买家三个月内曾发出过中差评 ');
						for(var k=0;k<5;k++){
							$("#huitouimg"+gsta+tid).append('<img src="http://cdn.zzgdapp.com/trade/web/img/huistar.png" />');
						}
						$("#huitouimg"+gsta+tid).append('曾发出过至少五次中差评，请密切关注下哦! ');
						return;
					}else{
						reason=reason+'安全：检测到买家三个月内没有发出过中差评Y';
						safenumber(buyer_nick,tid,addr,'huitouke',all_star,reason,status);
					}
				}
			});
		}else if(type=='huitouke'){
				QN.top.invoke({
					cmd:'taobao.trades.sold.get',
					param:{
						fields:'status', 
						status:'TRADE_FINISHED',
						buyer_nick:buyer_nick
						},
					method:'post',
					error:function(){
						$("#huitouimg"+gsta+tid).empty();
						var huistar=5-all_star;
						for(var j=0;j<all_star;j++){
							$("#huitouimg"+gsta+tid).append('<img src="http://cdn.zzgdapp.com/trade/web/img/liangstar.png" />');/*先追加亮星*/
						}
						var jieshi=reason.replace(/Y/g,'\n');
						$("#huitouimg"+gsta+tid).attr('title',jieshi);
						for(var k=0;k<huistar;k++){
							$("#huitouimg"+gsta+tid).append('<img src="http://cdn.zzgdapp.com/trade/web/img/huistar.png" />');/*追加灰星*/
						}
					},
					success:function(rsp){
						if(typeof rsp==='string'){rsp=JSON.parse(rsp);}/*parse JSON*/
						var tradetotal=rsp.trades_sold_get_response.total_results;/*三个月内成功订单*/
						if(status=='TRADE_FINISHED'){/*当前的状态是已成功状态*/
							if(tradetotal==0||tradetotal==''||tradetotal<0 || tradetotal==1){/*三个月内成交过1笔*/
								reason=reason+'新顾客：这是第1次购买哦';
								all_star=all_star-1;
							}else{
								$("#huitou"+gsta+tid).html('回头客买家，三个月内已成功交易'+(tradetotal)+'笔');
								reason=reason+'回头客：该买家第'+(tradetotal+1)+'次购买哦';
							}
						}else{
							if(tradetotal>0){
								$("#huitou"+gsta+tid).html('回头客买家，三个月内已成功交易'+(tradetotal)+'笔');
								reason=reason+'回头客：该买家第'+(tradetotal+1)+'次购买哦';
							}else{
								reason=reason+'新顾客：首次购买哦  ';
								all_star=all_star-1;
							}
						}
						$("#huitouimg"+gsta+tid).empty();
						if(all_star==5){
							if(status=='TRADE_FINISHED'){
								$("#huitouimg"+gsta+tid).attr('title','安全：检测到该订单不是刷信誉订单\n安全：检测到地址无异常\n安全：检测到该订单无异常\n安全：检测到买家三个月内没有发出过中差评\n回头客：该买家第'+(tradetotal)+'次购买哦');
							}else{
								$("#huitouimg"+gsta+tid).attr('title','安全：检测到该订单不是刷信誉订单\n安全：检测到地址无异常\n安全：检测到该订单无异常\n安全：检测到买家三个月内没有发出过中差评\n回头客：该买家第'+(tradetotal+1)+'次购买哦');
							}
							for(var j=0;j<all_star;j++){
								$("#huitouimg"+gsta+tid).append('<img src="http://cdn.zzgdapp.com/trade/web/img/liangstar.png" />');
							}
						}else{
							var jieshi=reason.replace(/Y/g,'\n');/*将所有的Y替换为换行符*/
							$("#huitouimg"+gsta+tid).attr('title',jieshi);
							var huistar=5-all_star;
							for(var j=0;j<all_star;j++){
								$("#huitouimg"+gsta+tid).append('<img src="http://cdn.zzgdapp.com/trade/web/img/liangstar.png" />');
							}
							for(var k=0;k<huistar;k++){
								$("#huitouimg"+gsta+tid).append('<img src="http://cdn.zzgdapp.com/trade/web/img/huistar.png" />');
							}
						}
					}
				});
			}
		}
	}catch(e){
			console.log(e);
	}
/**
 * 订单翻页
 */
function  getlistdata(pageno)
{
    var sta =gsta;
    getordersta(sta,pageno);
}
/******************************字符串清楚特殊字符*************************************/
function clearBr(key)
{
    key = key.replace(/<\/?.+?>/g,"");
    key = key.replace(/[\r\n]/g, "");
    key=key.replace(/(^\s*)|(\s*$)/g,""); /*消除首尾空格*/
    return key;
}
function copyaddr(name){/*复制功能，可以用于所有的复制功能*/
	var clipboard = workbench.platform.clipboard;
	clipboard.setData(0,name);
	layer.msg('复制成功!',1,1);
	
}
/**
 * 全选/反选订单
 */
/* $(".tradeqx").click(function(){老版
     if($(this).attr("checked")){
          $("."+gsta+"check").attr("checked",true);
     }else{
          $("."+gsta+"check").attr("checked",false);
     }
}); */
 $(".tradeqx").click(function(){/*新版*/
     if(this.checked){
    	 $("."+gsta+"check").parent('label').checkbox('check');
    	 $("."+gsta+"check").parent('label').checkbox('check');
     }else{
    	 $("."+gsta+"check").parent('label').checkbox('uncheck');
    	 $("."+gsta+"check").parent('label').checkbox('uncheck');
     }
});
/**
 * 跳转到商品详情
 */
function changetosp(num_id){
     QN.plugin.invoke({
          "cmd": "itemDetail",
          "param": {
           iid:num_id
          },
        "category": "shangpinguanli"
    });
}
/**
 * 一键显示用户订单
**/
function shownicklist(buyernick){
        $("#sselectnick").val(buyernick);
        /*$("#sselectsta option[value='"+gsta+"']").attr("selected","selected");*/
        $("#sselectsta li").attr('class','');/*清掉class*/
        $("#sselectsta").siblings('a').children('input').val(gsta);/*input hiddden添加值*/
        $("#sselectsta").siblings('a').children('span').html($("#sselectsta li a[value='"+gsta+"']").html());/*上一层的span.改变文字*/
        $("#sselectsta li a[value='"+gsta+"']").parent('li').attr('class','active');/*添加active*/
        sselect();
}
</script>
<!--
	作者：306800838@qq.com
	时间：2014-05-15
	描述：废弃的，暂时无用的方法
-->
<script>
function showpingjia(){
    var ql='';
    $("."+gsta+"check").each(function(){
        var   pltid=$(this).val();
        ql+='{select tid,nick,result,content,oid from traderates where  tid ='+pltid+' and rate_type=get and role=buyer}';
    });
    if(ql!=''){
        QN.top.invoke({
            "cmd":"tql",
            "param":{"ql":ql},
            "method":"post",
            "success":function (rsp){
                if(typeof rsp === 'string'){
                    var rsp = JSON.parse(rsp);
                }else{
                    var	rsp= rsp;
                }
                if(rsp[0].error_response){
                    if(rsp[0].error_response.sub_code=='subuser.has-no-permission'){
                    	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
             	         */
                    }else{
                        if(rsp[0].error_response.sub_msg){
                        	/*layer.msg('显示评价：'+rsp[0].error_response.sub_msg+'</p>');
                 	        */
                        }else{
                        	geterrorinfo("tql",rsp);
                        }
                    }
                }else{
                    for(index in rsp){
                        var pjtotal=rsp[index].traderates_get_response.total_results;
                        if(pjtotal!=0){
                        var pjval=rsp[index].traderates_get_response.trade_rates.trade_rate;
                            for(var a in pjval){
                               var oresult =pjval[a].result;
                               var ocontent=pjval[a].content;
                                var resulttil='';
                                var resultname='';
                                    switch(oresult)
                                    {
                                        case 'good':resulttil='好评';resultname='good'; break;
                                        case 'neutral':resulttil='中评';resultname='neutral';break;
                                        case 'bad':resulttil='差评';resultname='bad'; break;
                                    }
                               var ooid=pjval[a].oid;
                                $("#pingjia"+gsta+ooid).attr("title", ocontent);
                                if(ocontent.length>15){
                                    ocontent=ocontent.substring(0,15) + "...";
                                }
                               $("#pingjia"+gsta+ooid).html('<img src=\"http://cdn.zzgdapp.com/trade/web/images/'+resultname+'.png\" width="16" alt=\"'+resulttil+'\">'+ocontent).trigger('create');
                            }
                        }
                    }
                }
            },
            error: function(msp){
                if(typeof msp === 'string'){
                    var msp = JSON.parse(msp);
                }else{
                    var	msp= msp;
                }
                if(msp.sub_code=='subuser.has-no-permission'){
                	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！</p>');
         	         */
                }else{
                    /*if(msp.sub_msg){
                    	layer.msg('显示评价错误：'+msp.sub_msg+'</p>');
             	        
                    }else{
                    	layer.msg('显示评价错误：操作失败，请重试！</p>');
             	        
                    }*/
                }
            }
        });
    }
}	
function twopostfree(){
            $("#postval").val('0');
            changepost();
        }
        function changepost()
        {
            var postfee=$("#postval").val();
         	if(isNaN(postfee)==false){
            var  oids='';
            var  vtadjust_fee=0;
            for(var i=0;i<goidarr.length;i++){
                var  oids=goidarr[i];
                vtadjust_fee=Number(vtadjust_fee)+Number($("#slider-"+oids).val());
            }
            var vpricetotal= (Number(vtadjust_fee)+ Number(gtotal_fee)+Number(postfee)-Number(gprdetail)).toFixed(2);
            if(vtadjust_fee<0){
              if(0==gprdetail)  {
                var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' '+ vtadjust_fee.toFixed(2)+' = '+ vpricetotal;
              }else{
                  var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' '+ vtadjust_fee.toFixed(2)+' - '+gprdetail+' = '+ vpricetotal;
               }
            }else{
                if(0==gprdetail){
                var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' + '+vtadjust_fee.toFixed(2)+' = '+ vpricetotal;
                }else{
                    var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' + '+vtadjust_fee.toFixed(2)+' - '+gprdetail+' = '+ vpricetotal;
                }
            }
            $("#maijiashifu").empty();
            $("#maijiashifu").html(maijiashifu).trigger('create');
        }else{
            $("#postval").val('0');
            layer.msg('亲，输入的内容必须是数字!',1,3);
            
        }
        }
        function changezhefee(oid,zhe_fee)
        {
            var sval= $("#slider-"+oid).val();
            if(isNaN(sval)==false){
                $("#rebate-"+oid).val('');
                var postfee=$("#postval").val();
                var  oids='';
                var  vtadjust_fee=0;
                for(var i=0;i<goidarr.length;i++){
                    var  oids=goidarr[i];
                    vtadjust_fee=Number(vtadjust_fee)+Number($("#slider-"+oids).val());
                }
                var vpricetotal= (Number(vtadjust_fee)+ Number(gtotal_fee)+Number(postfee)-Number(gprdetail)).toFixed(2);
                if(vtadjust_fee<0){
                    if(0==gprdetail){
                    var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' '+ vtadjust_fee.toFixed(2)+' = '+ vpricetotal;
                    }else{
                        var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' '+ vtadjust_fee.toFixed(2)+' - '+gprdetail+' = '+ vpricetotal;
                    }
                }else{
                    if(0==gprdetail){
                    var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' + '+vtadjust_fee.toFixed(2)+' = '+ vpricetotal;
                    }else{
                        var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' + '+vtadjust_fee.toFixed(2)+' - '+gprdetail+' = '+ vpricetotal;
                    }
                }
                $("#maijiashifu").empty();
                $("#maijiashifu").html(maijiashifu).trigger('create');
            }else{
                $("#slider-"+oid).val('0');
                layer.msg('亲，输入的内容必须是数字!',1,3);
                
            }
        }
        function changezhe(oid,price,num,zhe_fee)
        {
            var rval=$("#rebate-"+oid).val();
            if(isNaN(rval)==false){
                if(0==rval||''==rval||rval<0||rval>10){
                    $("#slider-"+oid).val('0');
                    $("#rebate-"+oid).val('0');
                    }else{
                    	var sval= Number(rval)*Number(price)/10-Number(num)*Number(price);
                    	$("#slider-"+oid).val(sval.toFixed(2));
                }
                var postfee=$("#postval").val();
                var oids='';
                var vtadjust_fee=0;
            for(var i=0;i<goidarr.length;i++){
              	var  oids=goidarr[i];
                vtadjust_fee=Number(vtadjust_fee)+Number($("#slider-"+oids).val());
            	}
             	var vpricetotal= (Number(vtadjust_fee)+ Number(gtotal_fee)+Number(postfee)-Number(gprdetail)).toFixed(2);
                if(vtadjust_fee<0){
                    if(0==gprdetail){
                    var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' '+ vtadjust_fee.toFixed(2)+' = '+ vpricetotal;
                    }else{
                        var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' '+ vtadjust_fee.toFixed(2)+' - '+gprdetail+' = '+ vpricetotal;
                    }
                }else{
                    if(0==gprdetail){
                    var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' + '+vtadjust_fee.toFixed(2)+' = '+ vpricetotal;
                    }else{
                        var maijiashifu='买家实付：'+gtotal_fee +' + '+ postfee +' + '+vtadjust_fee.toFixed(2)+' - '+gprdetail+' = '+ vpricetotal;
                    }
                }
                $("#maijiashifu").empty();
                $("#maijiashifu").html(maijiashifu).trigger('create');
        }else{
            $("#rebate-"+oid).val('0');
            layer.msg('亲，输入的内容必须是数字!',1,3);
            
        }
        }
        /**
         * Created with need.
         * User: wangsx
         * Date: 14-7-10
         * Time: 15:30
         * 初始化数据库
         */
        function initDataBase()
        {
        	/*查询数据库里面的所有表*/
        	html5sql.process( "select name from sqlite_master where type='table'",
        		function(transaction, results){
        			var isCreateTable = true;
        		    for (var i = 0; i < results.rows.length; i++) 
        		    {
        		    	if( results.rows.item(i)['name'] == "priceset" ) 
        		        {
        	            	isCreateTable = false;
        		            break;
        	            }
        			}
        			/*同步数据*/
            		var page_no = 0;
                	/*没有表 创建表  获取数据*/
                	if( isCreateTable ) 
                	{
                    	console.log('没有表 创建表  获取数据');
                    	execute( "CREATE TABLE if not exists [priceset] ([id] INTEGER PRIMARY KEY, [title] TEXT, [nick] TEXT, [num_iid] TEXT, [properties] TEXT, [price] TEXT, [width] TEXT)" );
                    	console.log('创建了表  根据用户名查询数据');
                		executeQuery( "select count(*) as total from priceset where nick='" + user_nick + "'",
                		function(transaction, results){
                			var total = results.rows.item(0)['total'];
                			if( ! total ) { 
        						synchronous(1,100);
                			}else{
                				$("#batchstu").show();
                    			}
                		});
                    	/*synchronous(1,100);*/
                	}
                	else /*创建了表  根据用户名查询数据*/
                	{
                    	console.log('创建了表  根据用户名查询数据');
                		executeQuery( "select count(*) as total from priceset where nick='" + user_nick + "'",
                		function(transaction, results){
                			var total = results.rows.item(0)['total'];
                			if( ! total ) { 
        						synchronous(1,100);
                			}else{
                				$("#batchstu").show();
                    			}
                		});
                	}
        		},
        		function(error, statement){
                    console.error("sql: "+sql+" Error: " + error.message + " when processing " + statement );
                }
        	);
        }
        function synchronous( page_no, size) 
        {
        	$.ajax({
        		url : "<?php echo APP_WEB_INDEX_ROOT?>/iytrade/synchronous",
        		type : 'post',
        		data : { 'nick' : user_nick,'page_no' : page_no,'size': size },
        		success : function(data) {
        			/*console.log( data );*/
        			var obj = JSON.parse(data);
        			var total = obj.total_results;
        			data = obj.data;
        			var sql =[];
        			for( var index in data )
        			{
        				sql[sql.length] = "insert into priceset(nick,title,num_iid,properties,price,width) values('" + user_nick + "','"+ data[index].title + "','" + data[index].num_iid + "','" + data[index].properties + "','" + data[index].price + "','" + data[index].width + "')";
        			}
        			execute( sql );
        			if( page_no * size < total ) {
        				synchronous( page_no + 1, size);
        			}
        		},
        		error : function(e) {
        			console.error( e );
        		}
        	});
        }
        /**
         * Created with need.
         * User: wangsx
         * Date: 14-7-10
         * Time: 16:00
         * 执行SQL语句
         */
        function execute( sql ){
        	if( typeof(sql)!='object' && sql.indexOf('CREATE TABLE')==-1){
        		var db = html5sql.database;
        		db.transaction( function(tx) { 
        		tx.executeSql(
        			sql,
        			[], 
        			function(tx,result){
        				console.log('succee OH YEAH');
        			}, 
        			function(tx, error){ console.error('执行'+sql+'语句失败:' + error.message); });
        		});
        	}else if(sql==''){
        			return;
        	}else{
        		html5sql.process(
        	    	sql,
        	    function(){
        	       		console.log("执行成功");
        	    },
        	    function(error, statement){
        	        console.error( sql );
        	        console.error("Error: " + error.message + " when processing " + statement);
        	    });
        	}
        }
/**
 * 执行查询语句
 * @param sql sql语句
 * @param callbackFun 成功的回调方法 两个参transaction, results  失败的木有处理
 */
function executeQuery( sql, callbackFun)
{
	html5sql.process(
        sql,
        callbackFun,
        function(error, statement){
            console.error( sql );
            console.error("Error: " + error.message + " when processing " + statement);
        }
    );
}
/**
 * 跳到商品首页
 */
function goToItemIndexSetPrice()
{
	QN.plugin.invoke({
		'category' : 'shangpinguanli',
		'cmd' : 'itemList',
		'param' : {itemStatus:'onsale'}
	});
}
/**
 * Created with need.
 * User: wangsx
 * Date: 14-6-19
 * Time: 15:00 
 * 获取用户常用物流公司
 */	
function openwuliu(tid){
	getwlinfo(tid);
	$("#faddr_up").html($("#addr"+tid).html());
	showMsg('wuliuup');	
}
/**
 * Created with need.
 * User: wangsx
 * Date: 14-6-15
 * Time: 14:00 
 * 获取用户常用物流公司
 */	
function getwlinfo(tid){
	getNumiid(tid);
	 var comptys=window.localStorage.getItem("compty"+user_nick);
	 if(comptys==''|| comptys==null){
		 $.ajax({
			    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/getsend',
			    type: 'POST',
			    dataType:'html',
			    data:{nick:user_nick},
			    timeout:10000,
			    success: function(data){
			    	 	window.localStorage.setItem("compty"+user_nick,data);   			
			    	 	var data=JSON.parse(data);
			    	 	getwlinfos(data[0].name);
			     },
			    error: function(e){
		        },
			 });
	 }else{
		 	var data=JSON.parse(comptys);
		 	getwlinfos(data[0].name);
		 }
}
/**
 * Created with need.
 * User: wangsx
 * Date: 14-7-11
 * Time: 11:30 
 * 获取订单中宝贝信息。
 */	
function getNumiid(tid){
	QN.top.invoke({
        "cmd": "taobao.trade.fullinfo.get",
        "param": {
            "fields":"orders.num_iid,orders.sku_properties_name,orders.num",
             "tid":tid
        },
        "method": "get",
        "success": function (rsp){
            if(typeof rsp === 'string'){
                var rsp = JSON.parse(rsp);
            }else{
                var	rsp= rsp;
            }
            var trade = rsp.trade_fullinfo_get_response.trade.orders.order;
            var upWidth=0;
            for(var index in trade){
            	upWidth=Number(upWidth)+Number(getwebdata(trade[index].num_iid,trade[index].sku_properties_name));
            	var hahahaha=getwebdata(trade[index].num_iid,trade[index].sku_properties_name);
            	alert(trade[index].sku_properties_name);
                }
            if(upWidth<1)upWidth=1;
            alert(upWidth);
        }
	});
    }
	/**
	 * Created with need.
	 * User: wangsx
	 * Date: 14-7-11
	 * Time: 11:40 
	 * 计算物流费。
	 */	
    function getwebdata(num_iid,sku_properties_name){
        var width=0;
	    	var sql = "select properties,price from priceset where nick='$nick' and num_iid='$num_iid' and price<>''".replace('$nick', user_nick).replace('$num_iid', num_iid);
			executeQuery( sql,function(transaction, results){
			if(results.rows.length>0){
				var width_tab = results.rows.item(0)['width'].split('|X|');
				var width_tabs=''; 
				for(var index in width_tab){
					width_tabs=width_tab[index].split('|Y|');
					if(sku_properties_name==width_tabs[0]){
						width=width_tabs[1];
						break;
					}
				}
				return width;
			}else return width;
		});
        }
/**
 * Created with need.
 * User: wangsx
 * Date: 14-6-15
 * Time: 15:00 
 * 获取推荐物流公司
 */	
function getwlinfos(wldatas){
	var showcywl=window.localStorage.getItem("showcywl");
	if(showcywl=='yes')document.getElementById("wlcheckboxhide").checked = true;
	$("#wlbody_up").empty();
	var source_id=getwlcode('上海','上海市','虹口区');
	var target_id=getwlcode('山东省','济南市','历下区 ');
    QN.top.invoke({
        "cmd": "taobao.logistics.partners.get",
        "param": {
            "service_type":'online',
            "source_id":source_id,//371123
            "target_id":target_id,//410526
            "is_need_carriage":true
        },
        "method": "get",
        "success":function (rsp){
                if(typeof rsp === 'string') var rsp = JSON.parse(rsp);
                $("#fy_up").hide();
                //alert(JSON.stringify(rsp));
                var partner=rsp.logistics_partners_get_response.logistics_partners.logistics_partner;
                //alert(JSON.stringify(partner[0].partner.company_name));
                if(partner!=undefined){
	                for(var index in partner){
		                var datas={};
			    	    datas.company_name=partner[index].partner.company_name;
			    	    if(wldatas.indexOf(datas.company_name)>-1)datas.wlhidename='';else datas.wlhidename='wlhidename';
		                if(showcywl=='yes'&&wldatas.indexOf(datas.company_name)==-1)datas.showcywls='display:none;';else datas.showcywls='';
			    	    datas.initial_fee=partner[index].carriage.initial_fee;
			    	    datas.way_day=partner[index].carriage.way_day;
			    	    datas.way_day=datas.way_day.replace('天',"")+'天';
			            datas.got_time=partner[index].carriage.got_time;
			            datas.initial_weight=partner[index].carriage.initial_weight;
			    	    datas.initial_fee=partner[index].carriage.initial_fee;
			    	    datas.add_weight=partner[index].carriage.add_weight;
			            datas.add_fee=partner[index].carriage.add_fee;
			            datas.cover_remark=partner[index].cover_remark;
			            datas.uncover_remark=partner[index].uncover_remark;
			            var source = $("#wuliuup-template").html();
			            var template=Handlebars.compile(source);
			            var htmlstr = template(datas);
			            $("#wlbody_up").append(htmlstr);
	                }
                }else{
                	$("#fy_up").html("没有可以推荐的物流！");
                    }
        },
        error: function(msp){
                
        }
    });
}
/**
 * Created with need.
 * User: wangsx
 * Date: 14-6-17
 * Time: 10:00 
 * 控制显示常用物流公司
 */	
function showcywl(){
	if(document.getElementById("wlcheckboxhide").checked){
		window.localStorage.setItem("showcywl","yes");
		$("tr[name='wlhidename']").attr("style","display:none");
	}else{
			window.localStorage.setItem("showcywl","no");
			$("tr[name='wlhidename']").attr("style","");
	}
}
/**
 * Created with need.
 * User: wangsx
 * Date: 14-6-18
 * Time: 14:22 
 * 获取地区code
 */	
function getwlcode(shen,shi,qu){
	var areadata = window.localStorage.getItem("areadata");
    var object = eval("(" + areadata + ")");
    var provinces = object['province'];
    var procode ='';
    for(var i=0;i<provinces.length;i++)
    {
        if(provinces[i]['address']==shen)
        {
            procode = provinces[i]['addcode'];
        }
    }
    var citys = object['citys'][procode];
    var citycode = '';
    for(var i=0;i<citys.length;i++)
    {
        if(citys[i]['address']==shi)
        {
            citycode = citys[i]['addcode'];
        }

    }
    var districts = object['districts'][citycode];
    var areacode='';
    for(var i=0;i<districts.length;i++)
    {
        if(districts[i]['address']==qu)
        {
            areacode=districts[i]['addcode'];
        }else if(districts[i]['address']=='其它区'){
            areacode=districts[i]['addcode'];
        }else{
            areacode='';
        }
    }
    if(areacode==''){
        areacode=citycode;
    }
    return areacode;
}
function sss()
{
	$('[pointstu="pointstu"]').attr("class",'');
	$("#pointdfh").attr("class",'active');
	$("#pointval").html("待发货");
}

</script>
<!--<script src="http://cdn.zzgdapp.com/trade/web/js/html5sql.js"></script>--><!-- web sql -->
<script id="selectaddr_template" type="text/x-handlebars-template">
	<option value="{{contact_id}}" {{#if get_def}}selected{{/if}}>{{province}},{{city}},{{country}},{{addr}},{{zip_code}},{{contact_name}},{{phone}},{{mobile_phone}}</option>
</script>
<script id="selectbackaddr_template" type="text/x-handlebars-template">
	<option value="{{contact_id}}" {{#if cancel_def}}selected{{/if}}>{{province}},{{city}},{{country}},{{addr}},{{zip_code}},{{contact_name}},{{phone}},{{mobile_phone}}</option>
</script>
<!--<script id="selectbackaddr_template" type="text/x-handlebars-template">
<li role="presentation" {{#if cancel_def}} class="active" {{/if}}><a role="menuitem" tabindex="-1" href="javascript:void(0);" value="{{contact_id}}">{{province}},{{city}},{{country}},{{addr}},{{zip_code}},{{contact_name}},{{phone}},{{mobile_phone}}</a></li> 
</script>-->
<script id="addtask" type="text/x-handlebars-template">
<div id="addtasks{{tid}}" style="float:right;">
	{{#if taskis}}
		<span style="float:right;" title="添加任务"><a href="javascript:void(0);" onclick="tasktj('{{tid}}','{{buyer_nick}}');" ><img src="http://cdn.zzgdapp.com/trade/web/images/tj.png"></img></a></span>
		{{#if iscks}}
			<span style="float:right;margin-right:5px;" title="查看历史任务"><a href="<?php echo APP_WEB_INDEX_ROOT?>/trade/details_page#dataid={{iscksid}}&sta={{gsta}}"><img src="http://cdn.zzgdapp.com/trade/web/images/ck.png"></img></a></span>
		{{/if}}
	{{/if}}
	{{#if task}}
		<span style="float:right;margin-right:5px;" title="处理任务"><a href="javascript:void(0);" onclick="taskcl('{{idTask}}')" ><img src="http://cdn.zzgdapp.com/trade/web/images/cl.png"></img></a></span>
		<span style="float:right;margin-right:5px;" title="转交任务"><a href="javascript:void(0);" onclick="taskzj('{{dataid}}')" ><img src="http://cdn.zzgdapp.com/trade/web/images/zj.png"></img></a></span>
	{{/if}}
	{{#if isck}}
		{{#if task}}
			<span style="float:right;margin-right:5px;" title="查看任务"><a href="<?php echo APP_WEB_INDEX_ROOT?>/trade/details_page#dataid={{dataid}}&sta={{gsta}}"><img src="http://cdn.zzgdapp.com/trade/web/images/ck.png"></img></a></span>
		{{else}}
			<span style="float:right;margin-right:5px;" title="不是自己处理的任务哦，可点击查看"><a href="<?php echo APP_WEB_INDEX_ROOT?>/trade/details_page#dataid={{dataid}}&sta={{gsta}}"><img src="http://cdn.zzgdapp.com/trade/web/images/ck.png"></img></a></span>
		{{/if}}
	{{/if}}
</div>
</script>
<script id="list_template" type="text/x-handlebars-template" >
	<table class="sui-table table-striped table-bordered " name="{{hidename}}" style="margin-bottom:10px;{{hidenone}}" id='table{{tradeid}}'>
    	<thead >
        	<tr style="font-size: 12px;">
              	<th colspan='2' id="{{sta}}task{{tid}}">
					<label class="checkbox-pretty inline"><input type="checkbox"  id="check{{tradeid}}" name="onsale_bb" value="{{tid}}" class="{{sta}}check" /><span></span></label>
					<span style="margin-left:-10px;padding: 5px 10px;font-size: 13px;{{bgcolor}}" id="stascal{{sta}}{{tid}}" class="sui-label label-{{stacla}}">{{dstatus}}</span>
					<span><a style="font-size:14px;color:#37a7ec;" onclick="wangwang('{{buyer_nick}}');" href="javascript:void(0);"><img border="0" src="http://amos.alicdn.com/realonline.aw?v=2&uid={{buyer_nick}}&site=cntaobao&s=2&charset=utf-8"/>{{buyer_nick}}</a>&nbsp;<a href="#" onclick="shownicklist('{{buyer_nick}}');" title="查看该买家订单"><img src="http://cdn.zzgdapp.com/trade/web/img/ckmjdd.png" width="12" height="12" alt="查看该买家订单"></a></span>		
					<span style="margin-left:-10px;" >编号:{{tid}}&nbsp;&nbsp;<a href="javascript:copyaddr('{{tid}}')"><img src="http://cdn.zzgdapp.com/trade/web/img/copyimg.png" alt="复制订单编号" title="复制订单编号" /></a></span>
					<span style="margin-left:-10px;" id="created{{tid}}">{{created}}</span>
           	 		<a data-toggle="modal" data-target="#beiw-table" data-keyboard="false" href="javascript:void(0);" onclick="onclicktid('beiw-table',{{tid}})" ><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_{{seller_flag}}.png" width="12" title=""  id="sellercom{{sta}}{{tid}}" >&nbsp;&nbsp;<span style="color:#37a7ec;" title="" id="sellercoms{{sta}}{{tid}}" ></span></a>
               		<span style="float:right;color:#989898;"  id="{{sta}}taskts{{tid}}" >任务加载中...</span>
               	</th>
         	</tr>
		</thead>
			<tbody id="{{tradeid}}">
            <tr>
				<td width="68%">
                	<div style="margin:-5px 0;">
                    	<div class="sui-row-fluid" style="margin:5px 0;">
                            <div class="span2" style="text-align:center;">
                              <a href="javascript:void(0);" onclick="changetosp('{{num_iid}}')">
									{{#if pic_path}}
										<img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" align="middle" style="height:60px;" /></a>
									{{else}}
										<img alt="商品图片" src="http://cdn.zzgdapp.com/trade/web/images/imgnull.gif" width="60" align="middle" /></a>
									{{/if}}
                                {{#if tkflash}}
                                	<p style="margin:0; padding:0; text-decoration:underline;"><a href="javascript:void(0);"  onclick="torefund('{{refund_id}}','{{tid}}','{{oid}}')"><font color="red">退款中</font></a></p>
                                {{else}}
                                	<p style="margin:0;padding:0;color:red;"><span id="restas{{sta}}{{oid}}">{{refund_status}}<span></p>
                                {{/if}}
                            </div>
                            <div class="span10">
                                <p style=" margin:0;padding:0;"><a style="font-size:14px;color:#37a7ec;" title="点击打开默认商品插件编辑宝贝"  href="javascript:void(0);" onclick="changetosp('{{num_iid}}')">{{title}}</a></p>
								{{#if tradePhone}}
                                	<span style="margin:0;padding:0;float: right;" title="手机订单"><img src="http://cdn.zzgdapp.com/trade/web/images/sjdd.png" /></span>
								{{/if}}
								{{#if sku_properties_name}}
                               		 <p style="font-size:13px;margin:0;padding:0;" >
										{{#if editpro}}
                        					{{sku_properties_name}}
						 				 	<a  href="javascript:void(0);" onclick="editsku('{{toid}}','{{num_iid}}','{{pic_path}}','{{title}}','{{price}}','{{xnum}}','{{sku_properties_name}}');" class="delsends"><img height="20px" src="http://cdn.zzgdapp.com/trade/web/img/update.png" title="修改订单属性" /></a>
										{{else}}
											<span >{{sku_properties_name}}</span>
										{{/if}}
                               		 </p>
                                {{/if}}
								{{#if outer_id}}
									<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_id}}<b class="pull-right" >{{price}}元 x <span style="color:red;font-size:14px">{{xnum}}</span></b></p>
								{{else}}
									<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_id}}<b class="pull-right" >{{price}}元 x <span style="color:red;font-size:14px">{{xnum}}</span></b></p>	
								{{/if}}
                                </p>
                            </div>
                        </div>
                    </div>
                </td>
                <td width="32%" rowspan="{{rowspan}}" id="tabletd{{sta}}{{tid}}">
					<div style="float:left;">
						<span style="float:left;color:red; font-weight:700;" id="listpay{{sta}}{{tid}}">实付：{{payment}}元
						{{#if xingyongka}}					
							<img title="信用卡支付" src="http://cdn.zzgdapp.com/trade/web/images/xyk.png" />
						{{/if}}	
						{{#if tradecod}}
                  			 <img title="货到付款" src="http://cdn.tbmj.net/trade/web/img/cod-icon.png" alt="货到付款" ></span>
                        {{/if}}</span></br>
						<span style="float:left;" id="listpost{{sta}}{{tid}}">(含运费{{post_fee}})</span></br>
						<!--<span style="float:left;"><a href="<?php echo APP_WEB_INDEX_ROOT?>/trade/tradedetail?vers=<?php echo REAL_ROOT_VER;?>#tid={{tid}}">查看详情</a></span></br>-->
						<span style="float:left;"><a style="font-size:14px;color:#37a7ec;" data-toggle="tab" href="#detail" onclick="todetails('{{tid}}','{{sta}}')">查看详情</a></span></br>
					</div>
					<div style="float:right;">
						{{#if ppflash}}
                        	{{#if sellertype}}
								{{#if nocreated}}
									<span style="float:right;margin-top: 5px;" id="pricebut{{sta}}{{tid}}"><a  href="javascript:void(0);" title ="由于买家没有绑定支付宝，您暂时无法为其修改运费，请提醒买家先绑定支付宝账户。" class="sui-btn  btn-warning">改&nbsp;运&nbsp;费</a></span><br/>
									<span style="float:right;margin-top: 5px;{{showprice}}" id="postbut{{sta}}{{tid}}"> <a  href="javascript:void(0);" title="由于买家没有绑定支付宝，您暂时无法为其免邮，请提醒买家先绑定支付宝账户。" class="sui-btn  btn-success">一键免邮</a></span><br/>
									<span style="float:right;margin-top: 5px;" id="wangwang{{sta}}{{tid}}"><a  href="javascript:void(0);" onclick="wwfastpay('{{tid}}','{{buyer_nick}}','{{receiver_name}}','{{tcreated}}','{{sellernick}}')" class="sui-btn  btn-info" title="点击发送旺旺消息，提醒买家及时付款，您可在设置里添加自定义催付内容哦！">旺旺催付</a></span><br/>
									<span style="float:right;margin-top: 5px;" id="closetrade{{sta}}{{tid}}"><a style="font-size:14px;" data-toggle="modal" data-target="#close-table" data-keyboard="false"  id="closebut{{sta}}{{tid}}"  href="javascript:void(0);" onclick="showclosetrade({{tid}},{{mytidorder}})">关闭订单</a></span>
								{{else}}
									<span style="float:right;margin-top: 5px;" id="pricebut{{sta}}{{tid}}"><a  href="javascript:void(0);" onclick="showeditpost('{{tid}}')" class="sui-btn  btn-warning">改&nbsp;运&nbsp;费</a></span><br/>
									<span style="float:right;margin-top: 5px;{{showprice}}" id="postbut{{sta}}{{tid}}"> <a data-toggle="modal" data-target="#postfree-table" href="javascript:void(0);" onclick="openpostfree({{tid}})" class="sui-btn  btn-success">一键免邮</a></span><br/>
									<span style="float:right;margin-top: 5px;" id="wangwang{{sta}}{{tid}}"><a  href="javascript:void(0);" onclick="wwfastpay('{{tid}}','{{buyer_nick}}','{{receiver_name}}','{{tcreated}}','{{sellernick}}')" title="点击发送旺旺消息，提醒买家及时付款，您可在设置里添加自定义催付内容哦！" class="sui-btn  btn-info">旺旺催付</a></span><br/>	
									<span style="float:right;margin-top: 5px;"id="closetrade{{sta}}{{tid}}"><a style="font-size:14px;" data-toggle="modal" data-target="#close-table" id="closebut{{sta}}{{tid}}"  href="javascript:void(0);" onclick="showclosetrade({{tid}},{{mytidorder}})">关闭订单</a></span>
								{{/if}}
						 	 {{else}}
								{{#if nocreated}}
									<span style="float:right;margin-top: 5px;" id="pricebut{{sta}}{{tid}}"><a  href="javascript:void(0);" class="sui-btn  btn-warning" title="由于买家没有绑定支付宝，您暂时无法为其修改价格，请提醒买家先绑定支付宝账户。">修改价格</a></span><br/>
									<span style="float:right;margin-top: 5px;{{showprice}}" id="postbut{{sta}}{{tid}}"> <a  href="javascript:void(0);" class="sui-btn  btn-success" title="由于买家没有绑定支付宝，您暂时无法为其免邮，请提醒买家先绑定支付宝账户。">一键免邮</a></span><br/>
									<span style="float:right;margin-top: 5px;" id="pricebut{{sta}}{{tid}}"><a  href="javascript:void(0);" class="sui-btn  btn-info" onclick="wwfastpay('{{tid}}','{{buyer_nick}}','{{receiver_name}}','{{tcreated}}','{{sellernick}}')" title="点击发送旺旺消息，提醒买家及时付款，您可在设置里添加自定义催付内容哦！" >旺旺催付</a></span><br/>
									<span style="float:right;margin-top: 5px;"id="closetrade{{sta}}{{tid}}"><a style="font-size:14px;" data-toggle="modal" data-target="#close-table" id="closebut{{sta}}{{tid}}"  href="javascript:void(0);" onclick="showclosetrade({{tid}},{{mytidorder}})">关闭订单</a></span>
								{{else}}
									<span style="float:right;margin-top: 5px;" id="pricebut{{sta}}{{tid}}"><a  href="javascript:void(0);" class="sui-btn  btn-warning" onclick="getpricer('{{tid}}')" >修改价格</a></span><br/>
									<span style="float:right;margin-top: 5px;{{showprice}}" id="postbut{{sta}}{{tid}}"> <a  data-toggle="modal" data-target="#postfree-table" href="javascript:void(0);" class="sui-btn  btn-success" onclick="openpostfree({{tid}})" >一键免邮</a></span><br/>	
									<span style="float:right;margin-top: 5px;" id="wangwang{{sta}}{{tid}}"><a  href="javascript:void(0);" class="sui-btn  btn-info"    onclick="wwfastpay('{{tid}}','{{buyer_nick}}','{{receiver_name}}','{{tcreated}}','{{sellernick}}')" title="点击发送旺旺消息，提醒买家及时付款，您可在设置里添加自定义催付内容哦！">旺旺催付</a></span><br/>	
									<span style="float:right;margin-top: 5px;"id="closetrade{{sta}}{{tid}}"><a style="font-size:14px;color:#37a7ec;" data-toggle="modal" data-target="#close-table" id="closebut{{sta}}{{tid}}"  href="javascript:void(0);" onclick="showclosetrade({{tid}},{{mytidorder}})">关闭订单</a></span>						
								{{/if}}
                       	 	{{/if}}
				  		{{/if}}
							{{#if tkflash}}
								<span style="float:right;margin-top: 32px;margin-right: 0px;"><a href="javascript:void(0);"  onclick="torefund('{{refund_id}}','{{tid}}','{{oid}}')" class="sui-btn  btn-danger">退款信息</a></span>
							{{/if}}	
						{{#if isclick}}
							<span style="float:right;margin-top: 32px;margin-right: 7px;"><a href="javascript:showIndexsucRate('{{tid}}','{{sellerrate}}','{{buyerrate}}')">{{isdoubleRate}}<a/></span></br>	
						{{else}}
							{{#if isdoubleRate}}
								<span style="float:right;margin-top: 32px;margin-right: 7px;">{{isdoubleRate}}</span></br>
							{{/if}}
						{{/if}}
						{{#if pjflash}}
                   			<span style="float:right;margin-top: 7px;"><a  onclick="onclicktid('pingjia-table',{{tid}})" class="sui-btn  btn-success">评&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;价</a></span>
                    	{{/if}}
   					 {{#if tshflash}}
                   	 		{{#if tkzz}}
							{{else}}                                         
                        		<span style="float:right;margin-top: 7px;"><a data-toggle="modal" data-target="#shtime-table" data-keyboard="false" class="sui-btn "  onclick="showaddtime({{tid}})">延时收货</a></span>
							{{/if}}
                    {{/if}}
						{{#if fhflash}}
                        	{{#if tradecod}}
								 <!--<span style="float:right;margin-top: 52px;"><a href="javascript:openwuliu({{tid}});" class="btn btn-mini btn-success">推荐物流</a></span>-->
                        	{{else}}
								 <!--<span style="float:right;margin-top: 52px;"><a href="javascript:openwuliu({{tid}});" class="btn btn-mini btn-success">推荐物流</a></span>-->
                       		{{/if}}
                    	{{/if}}
					</div>
                </td>
            </tr>  
		</tbody>
		<tfoot>
            <tr>
                <td colspan="2">
					<div class="sui-row-fluid">
						<div class="span10">
					{{#if tpmemo}}
							<span margin:0;padding:0;">买家留言：<span id="buyercom{{sta}}{{tid}}" style="color:#F00;"></span></span><br/>
           		 	{{/if}}  
						{{#if fhflash}}
							<span style="float:left;margin:0;padding:0;font-size:13px;">收货地址：<span id="addr{{tid}}" {{#if dangeraddr}} style="color:#FFF;background: red;" title="地址中含有您设置的特殊地址，建议联系买家确认发货物流。" {{else}} title="请使用Ctrl+C复制，Ctrl+V粘帖。"{{/if}}>{{receiver_name}} ，{{receiver_mobile}} ，{{receiver_phone}} ， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}} ，{{receiver_zip}}</span>
							<a data-toggle="modal" data-target="#addr-table" data-keyboard="false" href="javascript:void(0);" onclick="editadrr('{{tid}}','{{receiver_name}}','{{receiver_mobile}}','{{receiver_phone}}','{{receiver_state}}','{{receiver_city}}','{{receiver_district}}','{{receiver_address}}','{{receiver_zip}}');"title="点击修改买家收货地址" data-toggle="modal"><img style="height:20px" src="http://cdn.zzgdapp.com/trade/web/img/update.png" /></a>
						{{else}}
							<span style="float:left;margin:0;padding:0;font-size:13px;">收货地址：<span id="addr{{tid}}" {{#if dangeraddr}} style="color:#FFF;background: red;" title="地址中含有您设置的特殊地址，建议联系买家确认发货物流。" {{else}} title="请使用Ctrl+C复制，Ctrl+V粘帖。"{{/if}}>{{receiver_name}} ，{{receiver_mobile}} ，{{receiver_phone}} ， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}} ，{{receiver_zip}}</span>
						{{/if}}	
							<a style="margin-left:10px;color:#37a7ec;" href="javascript:copyaddr('{{receiver_name}} ，{{receiver_mobile}} ，{{receiver_phone}}， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}}，{{receiver_zip}}')">复制收货地址</a>
							{{#if wlflash}}
								<span style="margin-left:10px;"><a style="color:#37a7ec;" href="javascript:onclicktid('wldata-table',{{tid}})">查看物流</a></span>
							{{/if}}
						{{#if sendsms}}<span style="margin-left:10px;"><a style="color:#37a7ec;" href="javascript:sendsms_dialog('{{receiver_name}}','{{receiver_mobile}}','{{buyer_nick}}','{{tid}}','{{status}}');">发送短信</a></span>{{/if}}
						</span>
					</div>
						<div class="span2">
							{{#if fhflash}}
                        		{{#if tradecod}}
									<span style="float:right;"><a style="background:#006BCC;" href="javascript:void(0);" id="sendcodbut{{sta}}{{tid}}" onclick="showsend({{tid}},'sendcoditem-table')" class="sui-btn "><font color="#FFF">发　　货</font></a></span><br/>
                        		{{else}}
									<span style="float:right;"><a style="background:#006BCC;" href="javascript:void(0);" id="sendbut{{sta}}{{tid}}" onclick="showsend({{tid}},'senditem-table')" class="sui-btn "><font color="#FFF">发　　货</font></a></span><br/>
                       			{{/if}}
                    		{{/if}}
								<span {{#if fhflash}}style="float:right;margin-top: 10px;margin-right: -78px;{{else}}style="float:right;"{{/if}}"><a href="javascript:void(0);" class="sui-btn  btn-info" onclick="wangwangPC_vip('{{buyer_nick}}','亲！请核对下地址哦:\r\n{{receiver_name}} ，{{receiver_mobile}} ，{{receiver_phone}} ， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}} ，{{receiver_zip}}/:^_^');" title="点击复制收货地址到旺旺聊天窗口">核对地址</a></span>
						</div>
					</div>
				</td>
            </tr>
		{{#if viptd}}
			<tr>
				<td colspan="2">
					安全指数：<span id="huitouimg{{sta}}{{tid}}"></span>&nbsp;&nbsp;&nbsp;<span id="huitou{{sta}}{{tid}}"></span>
				</td>
			</tr>
		{{/if}}
	</tfoot>
        </table>
  		<input type="hidden"  id="addrinfo{{tradeid}}"  value="{{addr}}"/>
        <input type="hidden"  id="nickinfo{{tradeid}}"  value="{{buyer_nick}}"/>
</script>

<script id="list2_template" type="text/x-handlebars-template">
	<tr>
		<td>
        	<div class="sui-row-fluid" style="margin:5px 0;">
           		<div class="span2" style="text-align:center;">
                	<a href="javascript:void(0);" onclick="changetosp('{{xnum_iid}}')"> <img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" height="60px" align="middle" /></a>
                {{#if tkflash}}
                	<p style="margin:0; padding:0; text-decoration:underline; color:red;"><a href="javascript:void(0);" onclick="torefund('{{refund_id}}','{{tid}}','{{oid}}')">{{refund_status}}</a></p>
                {{else}}
               		<p style="margin:0;padding:0;color:red;"><span id="restas{{sta}}{{oid}}">{{refund_status}}</span></p>
                {{/if}}
            </div>
            <div class="span10">
                <p style="margin:0;padding:0;"><a style="font-size:14px;color:#37a7ec;" title="点击打开默认商品插件编辑宝贝" href="javascript:void(0);" onclick="changetosp('{{xnum_iid}}')">{{title}}</a></p>
					{{#if tradePhone}}
                    	<span style="margin:0;padding:0;color:gray;float: right;" title="手机订单"><img src="http://cdn.zzgdapp.com/trade/web/images/sjdd.png" /></span>
					{{/if}}
			{{#if sku_properties_name}}
                <p style="margin:0;padding:0;font-size:13px;" >
					{{#if editpro}}
                         {{sku_properties_name}}
						 <a href="javascript:void(0);" onclick="editsku('{{oid}}','{{xnum_iid}}','{{pic_path}}','{{title}}','{{price}}','{{xnum}}','{{sku_properties_name}}');" class="delsends"><img height="20px;" src="http://cdn.zzgdapp.com/trade/web/img/update.png" title="修改订单属性" /></a>
					{{else}}
						<span>{{sku_properties_name}}</span>
					{{/if}}
                </p>
			{{/if}}
				{{#if outer_iid}}
					<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_iid}}<b class="pull-right" >{{price}}元 x <span style="color:red">{{xnum}}</span></b></p>
				{{else}}
					<p style="margin:0;padding:0;color:gray;" ><b class="pull-right" >{{price}}元 x <span style="color:red;font-size:14px;">{{xnum}}</span></b></p>
				{{/if}}
            </div>
        </div>
	</td>
</tr>
</script>
<script id="pingjiadata_template" type="text/x-handlebars-template">
	{{#each tditems}}
    	<table class="sui-table table-bordered" >
        	<tr>
                <td width="20%"><img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" align="middle" /></td>
                <td class="80%"><h3 style="font-size:12px; margin:0; padding:0; line-height:14px;">{{title}}</h3>
                    <p style="margin:0; padding:0;">{{price}} x{{num}}</p>
                    <p style="margin:0; padding:0;">{{sku_properties_name}}</p>
                    {{#if outer_sku_id}}
                    	<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_sku_id}}</p>
                    {{else}}
                    	<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_iid}}</p>
                    {{/if}}
                </td>
            </tr>
        </table>
        <input style="margin-left: 20px" type="radio" name="rate{{oid}}" value="good" checked/><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/good.png" width="12" alt="好评"></span>
        <input style="margin-left: 20px" type="radio" name="rate{{oid}}" value="neutral" /><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/neutral.png" width="12" alt="中平"></span>
        <input style="margin-left: 20px" type="radio" name="rate{{oid}}" value="bad" /><span class="lbl"><img src="http://cdn.zzgdapp.com/trade/web/images/bad.png" width="12" alt="差评"></span>
        <span>&nbsp;&nbsp;&nbsp;&nbsp;选择评语:&nbsp;&nbsp;</span>
        <select onchange="Pconchoice('{{oid}}')" style="width: 260px;" class="conpj" id ="conpj{{oid}}">
        </select>
        <textarea class="span12" id="trate{{oid}}" placeholder=""   style="margin-top: 5px;width:500px" name="initpcon"></textarea>
	{{/each}}
</script>
    <script id="closelist_template" type="text/x-handlebars-template"> 
        {{#each tditems}}
{{#if iscdclose}}
        <tr id="close_{{oid}}">
            <td width="5%"><input type="checkbox" name="closecheckcheckbox" checked=true value="{{oid}}" /></td>
            <td width="20%"><img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" align="middle" /></td>
            <td class="80%"><h3 style="font-size:12px; margin:0; padding:0; line-height:14px;">{{title}}</h3>
                <p style="margin:0; padding:0;">{{price}} x{{num}}</p>
                <p style="margin:0; padding:0;">{{sku_properties_name}}</p>
                {{#if outer_sku_id}}
                	<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_sku_id}}</p>
                {{else}}
                	<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_iid}}</p>
                {{/if}}
            </td>
        </tr>
{{/if}}
        {{/each}}
    </script>
   
    <script id="sendlist_template" type="text/x-handlebars-template">
        {{#each tditems}}
{{#if iscdsend}}
        <tr>
            <td width="5%"><input type="checkbox" name="batchcheckbox" checked=true value="{{oid}}" /></td>
            <td width="20%"><img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" align="middle" /></td>
            <td class="80%"><h3 style="font-size:12px; margin:0; padding:0; line-height:14px;">{{title}}</h3>
                <p style="margin:0; padding:0;">{{price}} x{{num}}</p>
                <p style="margin:0; padding:0;">{{sku_properties_name}}</p>
                {{#if outer_sku_id}}
                <p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_sku_id}}</p>
                {{else}}
                <p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_iid}}</p>
                {{/if}}
            </td>
        </tr>
{{/if}}
        {{/each}}
        <tr>
            <td colspan="3"><p class="font_wsl" style="margin:0; padding:0; line-height:1.2em">收货地址：<a onclick="wangwang('{{buyer_nick}}');"  href="javascript:void(0);"><img border="0" src="http://amos.alicdn.com/realonline.aw?v=2&uid={{buyer_nick}}&site=cntaobao&s=2&charset=utf-8"/>{{buyer_nick}}</a>&nbsp;,{{receiver_name}} ，{{receiver_phone}} ，{{receiver_mobile}} ， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}} ，{{receiver_zip}}</p></td>
        </tr>
        {{#if seller_memo}}
            <tr>
                <td colspan="3">
                    	<p ><b>卖家备注：</b><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_{{seller_flag}}.png" width="12"/>{{seller_memo}}</p>
                    {{#if buyer_message}}
                    	<p ><b>买家留言：</b>{{buyer_message}}</p>
                    {{/if}}
                </td>
            </tr>
        {{else}}
            {{#if buyer_message}}
            <tr>
                <td colspan="3">
                    <p ><b>买家留言：</b>{{buyer_message}}</p>
                </td>
            </tr>
            {{/if}}
        {{/if}}
    </script>
    <script id="codsendlist_template" type="text/x-handlebars-template">
        {{#each tditems}}
        {{#if iscdsend}}
        <tr>
            <td width="20%"><img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" align="middle" /></td>
            <td class="80%"><h3 style="font-size:12px; margin:0; padding:0; line-height:14px;">{{title}}</h3>
                <p style="margin:0; padding:0;">{{price}} x{{num}}</p>
                <p style="margin:0; padding:0;">{{sku_properties_name}}</p>
                {{#if outer_sku_id}}
                <p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_sku_id}}</p>
                {{else}}
                <p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_iid}}</p>
                {{/if}}
            </td>
        </tr>
        {{/if}}
        {{/each}}
        <tr>
            <td colspan="3"><p class="font_wsl" style="margin:0; padding:0; line-height:1.2em">收货地址：<a onclick="wangwang('{{buyer_nick}}');"  href="javascript:void(0);"><img border="0" src="http://amos.alicdn.com/realonline.aw?v=2&uid={{buyer_nick}}&site=cntaobao&s=2&charset=utf-8"/>{{buyer_nick}}</a>&nbsp;,{{receiver_name}} ，{{receiver_phone}} ，{{receiver_mobile}} ， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}} ，{{receiver_zip}}</p></td>
        </tr>
          {{#if seller_memo}}
            <tr>
                <td colspan="3">
                    	<p ><b>卖家备注：</b><img src="http://cdn.zzgdapp.com/trade/web/images/op_memo_{{seller_flag}}.png" width="12"/>{{seller_memo}}</p>
                    {{#if buyer_message}}
                    	<p ><b>买家留言：</b>{{buyer_message}}</p>
                    {{/if}}
                </td>
            </tr>
        {{else}}
            {{#if buyer_message}}
            <tr>
                <td colspan="3">
                    <p ><b>买家留言：</b>{{buyer_message}}</p>
                </td>
            </tr>
            {{/if}}
        {{/if}}
    </script>
    <script id="pricebd_template" type="text/x-handlebars-template">
        <p style="margin:0; padding:0;">订单原价（不含运费）：{{total_fee}}元</p>
        <div class="sui-row-fluid">
            <div class="span2">邮费（元）:</div>
            <div class="span10">
                <div class="input-append">
                    <input type="text" id="postval" value="{{post_fee}}"  onchange="changepost();"  /><button class="btn btn-warning" type="button" onclick="twopostfree();">免运费</button>
                </div>
            </div>
        </div>
        <p style="color:#999; margin:0; padding:0;">收货地址：{{receiver_name}} ，{{receiver_phone}} ，{{receiver_mobile}} ， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}} ，{{receiver_zip}}</p>
        <table class="sui-table table-striped table-bordered table-hover" style="margin-top:10px;">
            <thead >
            <tr>
                <th  width="50%">宝贝</th>
                <th width="20%">单价（元）*数量</th>
                <th width="30%">涨价或折扣</th>
            </tr>
            </thead>
            {{#each tditems}}
            <tr>

                <td>{{title}}
                    <p style="margin:0; padding:0; color:#999;">{{sku_properties_name}}</p>
                    {{#if outer_sku_id}}
                    <p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_sku_id}}</p>
                    {{else}}
                    <p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_iid}}</p>
                    {{/if}}
                </td>
                <td style="text-align:center;">{{price}}* {{num}}
                    <p style="margin:0; padding:0;">= <span style="font-size:14px; font-weight:800; color:#ff0000;">{{itemtotal}}</span></p></td>
                <td>
                    <input  type="text" id="rebate-{{oid}}" size="4"  onchange="changezhe('{{oid}}','{{price}}','{{num}}',{{zhe_fee}});" value="{{zhe}}" style="width:40px;"/>折=<input  type="text" name="slider-{{oid}}" id="slider-{{oid}}"  size="5" value="{{zhe_fee}}"  onchange="changezhefee('{{oid}}',{{zhe_fee}});" style="width:40px;"/>
                </td>
            </tr>
            {{/each}}
        </table>
        <p style="margin:0; padding:0;" id="maijiashifu">{{maijiashifu}}</p>
        <div class="alert" style="text-align:left;">
            <p style="margin:0; padding:0;">买家实付 =原价 + 运费 + 涨价或折扣 + 店铺优惠</p>
            <p style="margin:0; padding:0;">邮费为0时货到付款服务费将由卖家承担。</p></div>

    </script>

    <script id="tdwldatas_template" type="text/x-handlebars-template">
        <p>物流公司名称：{{company_name}}
            {{#if isresend}}
            	<button class="suibtn btn-primary" data-ok="modal" onclick="toresend('{{company_name}}');" id="resend">发货修改</button>
            {{/if}}
        </p>
        <p>运单号：{{out_sid}}</p>
        <h4>物流动态</h4>
        {{#each tracelists}}
        	<p class="intro">{{status_time}} {{status_desc}}</p>
        {{/each}}
    </script>
<script id="skudata_template" type="text/x-handlebars-template">
    <table class="sui-table table-bordered" >
        <tr>
			<td>
				<div class="sui-row-fluid">
                	<div class="span2" style="text-align:center;"><a href="javascript:void(0);" onclick="changetosp('{{num_iid}}')"><img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" align="middle" /></a>
                	</div>
                	<div class="span10"><p style="font-size:14px; margin:0;padding:0;"><a href="javascript:void(0);" onclick="changetosp('{{num_iid}}')">{{title}}</a></p>
                    	<p style="margin:0;padding:0;color:gray;" >{{properties}}&nbsp;&nbsp;<b>{{price}} x{{num}}</b></p>
                	</div>
				</div>
            </td>
        </tr>
        <tr>
			<td>
				<div class="sui-row-fluid">
                	<div class="span10">
                    	<b>请选择新的属性：</b><br/>
                   	 	<!--<select id="selectsku"  onchange="radclick();">
                    		{{#each skus}}
                        		<option value="{{properties}},{{price}},{{quantity}}" {{isprosku}}>{{properties_name}}</option>
                    		{{/each}}
                     	</select>-->
						<span class="sui-dropdown dropdown-bordered select">
							<span class="dropdown-inner">
								<a role="button" href="javascript:void(0);" data-toggle="dropdown" class="dropdown-toggle">
									{{#each skus}}
										{{#if isprosku}}
											<input onchange="radclick();" value="{{properties}},{{price}},{{quantity}}" type="hidden">
												<i class="caret"></i>
       											<span>{{properties_name}}</span>
										{{/if}}
									{{/each}}
       							</a>
        					<ul role="menu" aria-labelledby="drop4" class="sui-dropdown-menu" id="selectsku" style="max-height: 114px;overflow-y: auto;">
								{{#each skus}}
									<li role="presentation" {{#if isprosku}} class="active" {{/if}}><a  role="menuitem" tabindex="-1" value="{{properties}},{{price}},{{quantity}}" href="javascript:void(0);">{{properties_name}}</a></li>
								{{/each}}
        					</ul>
					</span>
				</span> 
                    	<p><b>价格：</b><span id="skuprice">0.00</span></p>
                    	<p><b>库存：</b><span id="skunum">0</span></p>
                	</div>
				</div>
            </td>
        </tr>
    </table>
</script>
<script id="index_buyerrate_success-template" type="text/x-handlebars-template">
{{#if issller}}
	<p style="color:#666;margin-left: 20px">卖家评价：</p>
       <p style="margin-left: 20px"><img title="{{result}}" src='http://cdn.zzgdapp.com/trade/web/images/{{result}}.png' width="12" alt='好评'/>{{content}}
         	<br>
         	<span style="color:#666">{{created}}</span>
	</p>
{{else}}
	<p style="color:#666;margin-left: 20px">买家评价：</p>
       <p style="margin-left: 20px"><img title="{{result}}" src='http://cdn.zzgdapp.com/trade/web/images/{{result}}.png' width="12" alt='好评'/>{{content}}</p>
			{{#if reply}}
         		<p style="margin-left: 20px">卖家解释：{{reply}}</p>
			{{/if}}
		<p style="color:#666;margin-left: 20px">买家昵称：{{nick}}<a href="javascript:void(0);" onclick="wangwang('{{nick}}');"><img border="0" src="http://amos.alicdn.com/realonline.aw?v=2&uid={{nick}}&site=cntaobao&s=2&charset=utf-8"/></a>
         	<br>
         	<span style="color:#666">{{created}}</span>
   		</p>
{{/if}}
</script>
<script id="wuliuup-template" type="text/x-handlebars-template">
<tr name="{{wlhidename}}" style="{{showcywls}}"><td>{{company_name}}</td><td title="首重{{initial_weight}}千克 首费{{initial_fee}}元  续重{{add_weight}}千克 续费{{add_fee}}元">{{initial_fee}}元</td><td>{{way_day}}</td><td title="{{cover_remark}} {{uncover_remark}}">{{got_time}}</td><td><a href="javascript:void(0);" onclick="showsend(688802491385078,'sendcoditem-table')" class="btn  btn-primary">发货</a></td></tr>
</script>
   <script id="tditem_template" type="text/x-handlebars-template">
        <thead>
        <tr>
            <th width="62%" colspan="2">宝贝</th>
            <th width="16%">状态</th>
            <th width="23%">优惠</th>
        </tr>
        </thead>
        {{#each tditems}}
        <tr>
            <td width="15%" style="text-align:center;"><a href="javascript:void(0);" onclick="changetosp('{{num_iid}}')">
					{{#if pic_path}}
						<img alt="商品图片" src="{{pic_path}}_80x80.jpg" width="60" align="middle" /></a>
					{{else}}
						<img alt="商品图片" src="http://cdn.zzgdapp.com/trade/web/images/imgnull.gif" width="60" align="middle" /></a>
						{{/if}}
            </td>
            <td><p style="font-size:14px; margin:0;padding:0;"><a href="javascript:void(0);" onclick="changetosp('{{num_iid}}')">{{title}}</a></p>
                <p style="margin:3px 0 0 0;padding:0;"><b>{{price}} x{{num}}</b></p>
                {{#if sku_properties_name}}
                <p style="margin:0;padding:0;color:gray;" >{{sku_properties_name}}
                    &nbsp;&nbsp; <a href="javascript:void(0);" onclick="editsku('{{oid}}','{{num_iid}}','{{pic_path}}','{{title}}','{{price}}','{{num}}','{{sku_properties_name}}');">{{editpro  status}}</a>
                </p>
                {{/if}}
				{{#if outer_sku_id}}
				<p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_sku_id}}</p>
				{{else}}
                <p style="margin:0;padding:0;color:gray;" >商家编码:{{outer_iid}}</p>
				{{/if}}
				</td>
            <td><p style="margin:0;padding:0;color:red;" >{{refundName refund_status status}}</p>
            {{#if rurl}}
              <br/> <a href="{{rurl}}" class="sui-btn but-small btn-primary">退款信息</a>
             {{/if}}
            </td>
            <td><p>卖家优惠：{{getFee adjust_fee}}</p>
				<p>{{oidsptil}}</p>
				<p>信用卡支付：<font color="red">{{iscardmoney}}</font></p>
			</td>
        </tr>
            {{/each}}		
    </script>
         <script id="tdwuliu_template" type="text/x-handlebars-template">
        <h5 >收货和物流信息&nbsp;&nbsp;
            {{#if wlflase}}
            <button class="sui-btn btn-primary"  onclick="sendwuliuww('{{buyer_nick}}','{{company_name}},{{out_sid}}');" >发送物流信息到旺旺</button>
            {{/if}}
        </h5>
        <p><span title="请使用Ctrl+C复制，Ctrl+V粘帖。">收货地址：    {{receiver_name}} ，{{receiver_mobile}} ，{{receiver_phone}} ， {{receiver_state}} {{receiver_city}} {{receiver_district}} {{receiver_address}} ，{{receiver_zip}}</span>
            {{#if wleditt}}
				<a data-toggle="modal" data-target="#addr-table" data-keyboard="false" class="sui-btn btn-primary" title="点击修改买家收货地址" onclick="editadrr('{{tid}}','{{receiver_name}}','{{receiver_mobile}}','{{receiver_phone}}','{{receiver_state}}','{{receiver_city}}','{{receiver_district}}','{{receiver_address}}','{{receiver_zip}}');">发货修改</a>
            {{/if}}
        </p>
        <p>运送方式：  {{shipping_type}}</p>
        <p>物流公司名称：  {{company_name}}
			{{#if isresend}}
            	<button class="sui-btn btn-primary" onclick="toresend('{{company_name}}');" id="resend">发货修改
            </button>
            {{/if}}</p>
			{{#if out_sid}}
       		 	<p>运单号：    {{out_sid}}
			{{/if}}
        </p>
    </script>

    <!--<script id="tdwldatas_template" type="text/x-handlebars-template">
        <h5 >物流动态</h5>
		{{#if wuliuinfo}}
				<p class="dintro">{{wuliuinfo}}</p>
			{{/if}}
		{{#each tracelists}}
        <p class="dintro">{{status_time}} {{status_desc}}</p>
		{{/each}}
    </script>-->
<script>
function encode(str)
{
    var len = str.length;
    var encode=str;
    var code = ["H","J","K","Q","W","R","T","Y","U","O"];
    for(i=0;i<10;i++){
            encode = encode.replace(new RegExp(i,"gm"),code[i]); 
    }
    encode = encode.replace(new RegExp("%","gm"),"LL");
    return  encode;
}
function sendaddr(){
	var isok=window.localStorage.getItem(user_nick+'sendaddr');
	if(isok=='yes'){
		return;
	}
	   	QN.top.invoke({
   		 "cmd": "taobao.logistics.address.search",
  		 "method": "get",
  		 "success": function(rsp){
  			 if(typeof  rsp=== 'string'){
  				rsp = JSON.parse(rsp);
  			}
  			if(rsp.logistics_address_search_response){
  				if(rsp.logistics_address_search_response.addresses.address_result){
					rsp.logistics_address_search_response.addresses.nick=user_nick;
  					var address_result=rsp.logistics_address_search_response.addresses;
  					var json_res=encode(encodeURIComponent(JSON.stringify(address_result)));
                    sendtomcs(json_res);
  				}

  			}
  	},
  	error: function(msp){
    	}
	});
}
function sendtomcs(json_res){
	$.ajax({
		url: 'http://mcs.zzgdapp.com/trade/add',
		type: 'post',
		data:{text:json_res},
		timeout:10000,
		success: function(data){
			window.localStorage.setItem(user_nick+'sendaddr','yes');
			console.log('yes');
		},
		error: function(){
			console.log('no');
		}
	});
}
</script>
<script>
function checkbox_change(obj){
	if(obj.checked){
		obj.value='on';
	}else{
		
		obj.value='off';
	}
}
function checkbox_change2(obj){
	if(obj=='sys'){
		$("#black_tr").show();
		document.getElementById("public_check").disabled=true;
	   	document.getElementById("credit_check").disabled=true;
	   	document.getElementById("regday_check").disabled=true; 
	   	document.getElementById("bigmoney_check").disabled=true;
	   	document.getElementById("smalmoney_check").disabled=true;
	   	document.getElementById("goodrate_check").disabled=true;
	   	/********************去掉选中*************************/
	   	document.getElementById("public_check").checked=false;
	   	document.getElementById("credit_check").checked=false;
	   	document.getElementById("regday_check").checked=false; 
	   	document.getElementById("bigmoney_check").checked=false;
	   	document.getElementById("smalmoney_check").checked=false;
	   	document.getElementById("goodrate_check").checked=false;
	   	/*****************禁用文本框********************/
	   	document.getElementById("creadit").disabled=true;
	   	document.getElementById("regday").disabled=true;
	   	document.getElementById("thebigmoeny").disabled=true;
	   	document.getElementById("smallmoney").disabled=true;
	   	document.getElementById("goodsrate").disabled=true;
	}else{/*自定义*/
		$("#black_tr").hide();
		document.getElementById("public_check").disabled=false;
	   	document.getElementById("credit_check").disabled=false;
	   	document.getElementById("regday_check").disabled=false; 
	   	document.getElementById("bigmoney_check").disabled=false;
	   	document.getElementById("smalmoney_check").disabled=false;
	   	document.getElementById("goodrate_check").disabled=false;
	   	/*****************启用用文本框********************/
	   	document.getElementById("creadit").disabled=false;
	   	document.getElementById("regday").disabled=false;
	   	document.getElementById("thebigmoeny").disabled=false;
	   	document.getElementById("smallmoney").disabled=false;
	   	document.getElementById("goodsrate").disabled=false;
	}
}
function saveandcontinue(){/*差评师拦截保存按钮*/
	var info={};/*定义数组。ajax==>data:info,*/
	info.usernick=user_nick;/*用户昵称*/
	var pattern = /^[0-9]\d{0,7}$/; 
	var goodreg=/^(([1-9]+)|([0-9]{1,2}\.?[0-9]{1,2}))$/;
	info.denfenon='on';/*拦截开关*/
	if(document.getElementById('index_default').checked){/*如果是自定义的*/
		info.Tzhongpingoff=$("#neutralrate_check").val();/*给过我中评的*/
		info.Tchapingoff=$("#badrate_check").val();/*给过我差评的*/
		info.publicon=$("#public_check").val();/*公共库*/
		if($("#goodrate_check").val()=='on'){/*好评率*/
			if(goodreg.test($("#goodsrate").val()) && $("#goodsrate").val() < 100){
				info.Tgoodvalues="on;"+$("#goodsrate").val();
			}else{
				layer.msg('输入正确的好评率哦~~', 1,3);
				return;
			}	
		}else if($("#goodrate_check").val()=='off'){
			info.Tgoodvalues="off;";
		}
		if($("#conditionKey_check").val()=='on'){
			info.condikey='on|Y|'+$("#conKyes").val().replace(/，/g,',');/*关键字*/
		}else{
			info.condikey='off|Y|';
		}  
		if($("#credit_check").val()=='on'){/*信用分数*/
			if(pattern.test($("#creadit").val())){
				info.crevalues="on;"+$("#creadit").val();
			}else{
				layer.msg('信用分数格式错误!', 1,3);
				return;
			}
		}else if($("#credit_check").val()=='off'){
			info.crevalues="off;"+$("#creadit").val();
		}
		if($("#regday_check").val()=='on'){/*注册天数*/
			if(pattern.test($("#regday").val())){
				info.Tregdayvalues="on;"+$("#regday").val();
			}else{
				layer.msg('注册天数格式错误!', 1,3);
				return;
			}
		}else if($("#regday_check").val()=='off'){
				info.Tregdayvalues="off;";
		}
		if($("#bigmoney_check").val()=='on'){/*最大金额*/
			if(goodreg.test($("#thebigmoeny").val()) && parseInt($("#thebigmoeny").val()) < 999999){
				info.Tbigmoney='on;'+$("#thebigmoeny").val();
			}else{
				layer.msg('请输入正确大于的金额哦~~', 1,3);
				return;
			}
		}else if($("#bigmoney_check").val()=='off'){
			info.Tbigmoney='off;';
		}
		if($("#smalmoney_check").val()=='on'){/*最小金额*/
			if(goodreg.test($("#smallmoney").val()) && parseInt($("#smallmoney").val()) < 99999){
				info.Tsmallmoney='on;'+$("#smallmoney").val();
			}else{
				layer.msg('请输入输入正确小于的金额哦~~', 1,3);
				return;
			}
		}else if($("#smalmoney_check").val()=='off'){
			info.Tsmallmoney='off;';
		} 
	}else{/*选择了系统默认的选项*/
		info.Tzhongpingoff=$("#neutralrate_check").val();/*给过我中评的*/
		info.Tchapingoff=$("#badrate_check").val();/*给过我差评的*/
		if($("#conditionKey_check").val()=='on'){
			info.condikey='on|Y|'+$("#conKyes").val().replace(/，/g,',');/*关键字，将说有的中文逗号替换为英文逗号*/
		}else{
			info.condikey='off|Y|'+$("#conKyes").val().replace(/，/g,',');
		}  
	}
		
	if($("#closetent").val()==''|| $("#closetent").val()==null){
		info.Tclosetent='订单状态错误，请联系售后客服';
	}else{
		var closetext=$("#closetent").val();
		if(closetext.length > 14 || closetext.length < 6 ){
			layer.msg('卖家解释设置在6到14个汉字之间~',1,3);
			return;
		}else{
			info.Tclosetent=$("#closetent").val();
		}
	}
	 $.ajax({/*获取授权信息*/
	        type: "POST",
		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/zdrate',
		    data:{'nick':user_nick},
		    timeout:1000,
		    success: function(data){
			    if(data=='off'){/*需要授权*/
			    	QN.application.invoke({
						 "cmd": "translateUrl",
						 "param":{'url':"https://oauth.taobao.com/authorize?response_type=code&client_id=21085840&redirect_uri=<?php echo APP_WEB_INDEX_ROOT;?>/tc/trades?scope=item&view=web&state=ActBdefen"},
						 "success": function (e){
							 if(typeof  e=== 'string'){
					            	e = JSON.parse(e);
					            }
							layer.confirm('该功能是自动运行功能，需授权后使用，授权成功后请重新点击“开启”使用。', function(){
								    layer.close(layer.index);
								    window.location.href=e.url;
								});
						 }
					});
					return;
				}else{/*无需授权.开启推送*/
					QN.top.invoke({
						cmd:'taobao.tmc.user.permit',/*为用户开通推送消息*/
						method:'GET',
						error:function(msp){
							msp=JSON.parse(msp);
							if(msp.sub_code=='subuser.has-no-permission'){
								layer.msg('子账号不能使用差评师拦截功能', 1,3);
								return;
							}
							layer.msg('保存失败，请重试', 1,3);
							return;
						},
						success:function(rsp){/*开启成功.保存差评师拦截信息*/
							$.ajax({
								url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/savedefenserate',type:'POST',dataType:'html',data:info,timeout:10000,
								error:function(msp){layer.msg('与服务器数据库连接失败，请稍候重试!', 1,3);},
								success:function(rsp){closerateActB(3);}});
						}
					});
				}
			}, 
			error: function(){
				layer.msg('保存失败，请重试', 1,3);
			}
		});
}
/**************************************************/
/******************一键导入中差评**********************/
var neutral = new Array();
var bad = new Array(); 
var neutralnums=0;
var badnums=0;
function gettraderates(page_no,result){
	if(page_no==1){
		neutralnums=0;
		badnums=0;
	}
	var loadi=layer.load(5);
	if(result=='neutral'){
		QN.top.invoke({
		   	 "cmd": "taobao.traderates.get",
		   	 "param": {'fields':"nick",
			             'rate_type':'get',
			             'role':'buyer',
			             'result':result,
			             'page_no':page_no,
			             'page_size':40,
			             'use_has_next':true},
		   	 "method": "get",
		   	 "success": function(e){
		   		 if(typeof  e=== 'string'){
			            	e = JSON.parse(e);
			            }
		   	 	var has_next = e.traderates_get_response.has_next;
			   	 if(e.traderates_get_response.trade_rates!=null){
				   		for(index in e.traderates_get_response.trade_rates.trade_rate){
					   		var rsp=e.traderates_get_response.trade_rates.trade_rate[index];
					   		if(neutral.length>0){
					   			if(inArray(rsp.nick,neutral,false)){
					   			}else{
							   		neutral[neutralnums]=rsp.nick;
							   		neutralnums++;
					   			}
					   		}else{
						   		neutral[neutralnums]=rsp.nick;
						   		neutralnums++;
					   		}
				   		}
				   		if(has_next==false){
				   			layer.close(layer.index);
				   			var sum=parseInt(neutral.length)+parseInt(bad.length)
					   		if(sum==0){
						   		layer.msg("恭喜亲，六个月以内亲并没有收到任何中差评，无需导入。", 1,3);
					   		}else{
					   			layer.confirm('亲，六个月以内的中差评买家共计有'+sum+'人（重复评价不记录），其中差评买家'+bad.length+'人，中评买家'+neutral.length+'人。', function(){
								    
								    importing();
								});
					   			
					   		}
				   			
				   		}else{
				   			page_no++;
				   			gettraderates(page_no,'neutral')
				   		}
			   	 }else{
			   	 	layer.close(layer.index);
			   			var sum=parseInt(neutral.length)+parseInt(bad.length)
				   		if(sum==0){
				   			layer.msg('恭喜亲，六个月以内亲并没有收到任何中差评，无需导入。', 1,3);
				   		}else{
				   			layer.confirm('亲，六个月以内的中差评买家共计有'+sum+'人（重复评价不记录），其中差评买家'+bad.length+'人，中评买家'+neutral.length+'人。', function(){
								    
								    importing();
								});
				   		}
			   	 }
		   	 },
		   	 error: function(msp){
		            if(typeof msp === 'string'){
		                var msp = JSON.parse(msp);
		            }else{
		                var	msp= msp;
		            }
		            if(msp.sub_code=='subuser.has-no-permission'){
		            	/* layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
			    	     */
		           }else{
			    	   layer.msg('操作失败，请重试！', 1,3);
		            }
		        }
			        	 
		   	 });
	}else if(result=='bad'){
		QN.top.invoke({
		   	 "cmd": "taobao.traderates.get",
		   	 "param": {'fields':"nick",
			             'rate_type':'get',
			             'role':'buyer',
			             'result':result,
			             'page_no':page_no,
			             'page_size':40,
			             'use_has_next':true},
		   	 "method": "get",
		   	 "success": function(e){
		   		 if(typeof  e=== 'string'){
			            	e = JSON.parse(e);
			            }
		   	 	var has_next = e.traderates_get_response.has_next;
			   	 if(e.traderates_get_response.trade_rates!=null){
				   		for(index in e.traderates_get_response.trade_rates.trade_rate){
					   		var rsp=e.traderates_get_response.trade_rates.trade_rate[index];
					   		if(neutral.length>0){
					   			if(inArray(rsp.nick,bad,false)){
					   			}else{
							   		bad[badnums]=rsp.nick;
							   		badnums++;
					   			}
					   		}else{
					   			bad[badnums]=rsp.nick;
						   		badnums++;
					   		}
				   		}
				   		if(has_next==false){
				   			gettraderates(1,'neutral');
				   		}else{
				   			page_no++;
				   			gettraderates(page_no,'bad')
				   		}
			   	 }else{
				   	 /*没有评价信息*/
				   	gettraderates(1,'neutral');
			   	 }
		   	 },
		   	 error: function(msp){
		            if(typeof msp === 'string'){
		                var msp = JSON.parse(msp);
		            }else{
		                var	msp= msp;
		            }
		            if(msp.sub_code=='subuser.has-no-permission'){
		            /* 	layer.msg('该子帐号无此操作权限，请通过主帐号设置开通相应权限！',1,3);
		                 */
		           }else{
		        	   layer.msg('操作失败，请重试！', 1,3);
		            }
		        }
			        	 
		   	 });
	}
	
}
function importing(){
	layer.close(layer.index);
	var neutrals=neutral;
	if(neutral.length==0){
		neutrals=0;
	}
	var bads=bad;
	if(bad.length==0){
		bads=0;
	}
	$.ajax({
		   type: "POST",
		   url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/blackrates',
		   data:{ neutral:neutrals,bad:bads,nick:user_nick},
		   dataType: "json",
		   success: function(data){
		   	layer.msg('操作成功', 1, 1);
			},
	       error: function(){
	       	layer.msg('与服务器数据库连接失败，请稍候重试!', 1,3);
		},
		   async:false
		  });
}
/*********判断数组内是否存在某值**********/
function inArray(needle,array,bool){  
    if(typeof needle=="string"||typeof needle=="number"){    
        var len=array.length;    
        for(var i=0;i<len;i++){    
            if(needle===array[i]){    
                if(bool){    
                    return i;
                }    
                return true;    
            }    
        }    
        return false;    
    }    
}
function closerateActB(page){
	closeMsg('');
	showaaa(page);
}
function saveActBzdrate(){
	var loadi=layer.load(5);
		 $.ajax({/*获取授权信息*/
	        type: "POST",
		    url: '<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/zdrate',
		    data:{'nick':user_nick},
		    timeout:1000,
		    success: function(data){
		    	layer.close(layer.index);
			    if(data=='off'){/*需要授权*/
			    	QN.application.invoke({
						 "cmd": "translateUrl",
						 "param":{'url':"https://oauth.taobao.com/authorize?response_type=code&client_id=21085840&redirect_uri=<?php echo APP_WEB_INDEX_ROOT;?>/tc/trades?scope=item&view=web&state=ActBzdrate"},
						 "success": function (e){
							 if(typeof  e=== 'string'){
					            	e = JSON.parse(e);
					            }
					            layer.confirm('该功能是自动运行功能，需授权后使用，授权成功后请重新点击“开启”使用。', function(){
								    layer.close(layer.index);
								    window.location.href=e.url;
								});
							 
						 }
					});
					return;
				}else{/*无需授权.开启推送*/
					QN.top.invoke({
						cmd:'taobao.tmc.user.permit',/*为用户开通推送消息*/
						method:'GET',
						error:function(msp){
							msp=JSON.parse(msp);
							if(msp.sub_code=='subuser.has-no-permission'){
								layer.msg('子账号不能开启自动评价', 1,3);
								return;
							}
							layer.msg('保存失败，请重试', 1,3);
							return;
						},
						success:function(rsp){/*开启成功.保存差评师拦截信息*/
							
							var radio = document.getElementsByName("optionsRadios");
							 var radioLength = radio.length;
							 var radioValue='';
							 for(var i = 0;i < radioLength;i++){
							    if(radio[i].checked){
							     	radioValue = radio[i].value;
						
							   }
							}
							
							checkboxhmd = document.getElementById("checkboxhmd");
							var isblackbuyer=0;
							if(checkboxhmd.checked==true){
								isblackbuyer=1;
							}else{
								isblackbuyer=0;
							}
							
							checkboxhmd = document.getElementById("checkboxhmd2");
							var zdblack=0;
							if(checkboxhmd.checked==true){
								zdblack=1;
							}else{
								zdblack=0;
							}
							
							checkboxhmd = document.getElementById("checkboxhmd3");
							var checkfm=0;
							if(checkboxhmd.checked==true){
								checkfm=1;
							}else{
								checkfm=0;
							}
							
							
							var houser=$('#houser').find("option:selected").val();
							var day2=$('#day2').find("option:selected").val();
							var houser2=$('#houser2').find("option:selected").val();
							
							var datas={};
							datas.nick=user_nick;
							datas.alreadyrate=radioValue;
							datas.blackrate=isblackbuyer;
							datas.zdblackrate=zdblack;
							datas.emailrate=checkfm;
							datas.robhouser=houser;
							datas.timingday=day2;
							datas.timinghouser=houser2;
							
							
							$.ajax({
								url:'<?php echo APP_WEB_INDEX_ROOT;?>/iytrade/saveActBzdrate',type:'POST',dataType:'html',data:datas,timeout:10000,
								error:function(msp){layer.msg('与服务器数据库连接失败，请稍候重试!', 1,3);},
								success:function(rsp){closerateActB(2);}});
						}
					});
				}
			}, 
			error: function(){
				layer.close(layer.index);
				layer.msg('保存失败，请重试', 1,3);
			}
		});
}
</script>
<!--<script type="text/javascript" src="http://cdn.zzgdapp.com/yunying/trade/advertisement/guanggaotiao.js" ></script>-->
<?php require_once ("app/views/public/footer.php");?>
</body>
</html>
